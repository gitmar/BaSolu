@using System.Reflection
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using GxShared.GlobModels

<!-- StringComponent.razor -->
@* style="@($"width:{Width};")" *@
<InputText @bind-Value="CurrentValue"
           @oninput="HandleInput"
           class="@GetCssClass()"
           placeholder="@($"Enter {Placeholder}")">
</InputText>
<style>
    .small-text {
        font-size: 0.8rem;
    }

    .medium-text {
        font-size: 1rem;
    }

    .large-text {
        font-size: 1.2rem;
    }

    .width-small {
        width: 100px;
    }

    .width-medium {
        width: 150px;
    }

    .width-large {
        width: 200px;
    }

    .width-full {
        width: 100%;
    }

</style>
@code {
    [Parameter] public object Obj { get; set; }
    [Parameter] public string PropertyName { get; set; }
    [Parameter] public EventCallback<object> ObjChanged { get; set; }
    [Parameter] public string Placeholder { get; set; }
    [Parameter] public string Class { get; set; }
    [Parameter] public string Style { get; set; }
    [Parameter]
    public TextAlignment TextAlign { get; set; } = TextAlignment.Left;
    [Parameter]
    public Size TextSize { get; set; } = Size.Medium;
    [Parameter]
    public ControlWidth Width { get; set; } = ControlWidth.Medium;

    private string _currentValue = "";

    protected override void OnInitialized() => _currentValue = GetCurrentValue();

    private async void HandleInput(ChangeEventArgs e)
    {
        _currentValue = e.Value?.ToString() ?? "";
        SetPropertyValue(Obj, PropertyName, _currentValue);
    }

    private string CurrentValue
    {
        get => _currentValue;
        set => _currentValue = value;
    }

    private string GetCurrentValue()
    {
        if (Obj != null && !string.IsNullOrEmpty(PropertyName))
        {
            var prop = Obj.GetType().GetProperty(PropertyName);
            return prop?.GetValue(Obj)?.ToString() ?? "";
        }
        return "";
    }

    private async void SetPropertyValue(object obj, string propName, string value)
    {
        var prop = obj?.GetType().GetProperty(propName);
        if (prop != null && prop.PropertyType == typeof(string))
        {
            prop.SetValue(obj, value);
            Console.WriteLine($"String prop {propName} set to {value}");

            // Notify the parent
            await ObjChanged.InvokeAsync(obj);
        }
    }
    //CSS class and style
    private string GetCssClass()
    {
        var widthCssClass = Width switch
        {
            ControlWidth.Small => "width-small",
            ControlWidth.Medium => "width-medium",
            ControlWidth.Large => "width-large",
            ControlWidth.Full => "width-full",
            _ => "width-medium"
        };
        var alignmentClass = TextAlign switch
        {
            TextAlignment.Left => "text-start",
            TextAlignment.Center => "text-center",
            TextAlignment.Right => "text-end",
            TextAlignment.Justify => "text-justify",
            _ => "text-start"
        };
        var sizeClass = TextSize switch
        {
            Size.Small => "small-text",
            Size.Medium => "medium-text",
            Size.Large => "large-text",
            _ => "medium-text"
        };

        // Combine widthCssClass with other classes
        return $"{widthCssClass} {alignmentClass} {sizeClass}";
    }
}

@* <InputText @bind-Value="CurrentValue"
           @oninput="HandleInput"
           placeholder="@($"Enter {Placeholder}")">
</InputText>

@code {
    [Parameter] public object Obj { get; set; }
    [Parameter] public string PropertyName { get; set; }
    [Parameter] public string Placeholder { get; set; }

    private string _currentValue = "";

    protected override void OnInitialized() => _currentValue = GetCurrentValue();

    private void HandleInput(ChangeEventArgs e)
    {
        _currentValue = e.Value?.ToString() ?? "";
        SetPropertyValue(Obj, PropertyName, _currentValue);
    }

    private string CurrentValue
    {
        get => _currentValue;
        set => _currentValue = value;
    }

    private string GetCurrentValue()
    {
        if (Obj != null && !string.IsNullOrEmpty(PropertyName))
        {
            var prop = Obj.GetType().GetProperty(PropertyName);
            return prop?.GetValue(Obj)?.ToString() ?? "";
        }
        return "";
    }

    private void SetPropertyValue(object obj, string propName, string value)
    {
        var prop = obj?.GetType().GetProperty(propName);
        if (prop != null && prop.PropertyType == typeof(string))
        {
            prop.SetValue(obj, value);
            Console.WriteLine($"String prop {propName} set to {value}");
        }
    }
} *@

@* 
      // Console.WriteLine("Render 3");
        // Type typeOfObj = obj.GetType();
        // PropertyInfo propertyInfo = typeOfObj.GetProperty(propname);
        // if (propertyInfo != null)
        // {
        //     try
        //     {
        //         if (val == null || val.Trim() == "")
        //             throw new Exception("Cannot assign null or empty value");
        //         else
        //             propertyInfo.SetValue(obj, val);
        //     }
        //     catch (Exception ex)
        //     {
        //         Console.WriteLine(ex.Message);
        //     }
        // }

        //Console.WriteLine("Render 4");
        //Type typeOfObj = Obj.GetType();
        //PropertyInfo propertyInfo = typeOfObj.GetProperty(PropertyName);
        //Console.WriteLine($"Render 4.1 : {propertyInfo?.GetValue(Obj)?.ToString() ?? ""}");
        //return propertyInfo?.GetValue(Obj)?.ToString() ?? "";
        // StateHasChanged();
    //}
// //     [Parameter]
// //     public object Obj { get; set; }

// //     [Parameter]
// //     public string PropertyName { get; set; }

// //     //[Parameter]
// //     public string Placeholder { get; set; }

// //     private string CurrentValue;

// //     protected override void OnInitialized()
// //     {
// //         CurrentValue = GetCurrentValue();
// //         StateHasChanged(); // Ensure initial state is rendered.
// //         Console.WriteLine("Initial Value: " + CurrentValue);

// //         // Optional: Check for nulls here.
// //         if (string.IsNullOrEmpty(CurrentValue))
// //             Console.WriteLine("Initial Value was empty.");

// //         else
// //             Console.WriteLine("Initial Value was populated.");




// //     }

// //     private void OnChange(ChangeEventArgs e)
// //     {

// //         var newValue = e.Value?.ToString();
// //         Console.WriteLine("New Input: " + newValue);

// //         CurrentValue = newValue;
// //         SetCurrentValue(newValue); // Update object's property

// //     }

// //     private void SetPropertyValue(object obj, string propname, string val)
// //     {
// // #if DEBUG

// // #endif

// //         Type typeOfObj = obj.GetType();
// //         PropertyInfo propertyInfo = typeOfObj.GetProperty(propname);
// //         propertyInfo?.SetValue(obj, val);

// //         StateHasChanged();
// //     }

// //     protected override bool ShouldRender()
// //     {
// //         return base.ShouldRender();
// //     }

// //     private string GetPropertyValue(object obj, string propname)
// //     {
// //         Type typeOfObj = obj.GetType();
// //         PropertyInfo propertyInfo = typeOfObj.GetProperty(propname);
// //         return propertyInfo?.GetValue(obj)?.ToString() ?? "";
// //     }

// //     private void SetPropertyValue(object obj, string val)
// //     {
// // #if DEBUG

// // #endif

// //         Type typeOfObj = obj.GetType();
// //         //Console.WriteLine(typeOfObj.FullName);
// //         PropertyInfo[] properties = typeOfObj.GetProperties();

// //         foreach (PropertyInfo p in properties)
// //         {
// //             p.SetValue(obj, val);
// //             StateHasChanged();
// //         }


// //     }

    // protected override void OnInitialized()
    // {
    //     CurrentValue = GetCurrentValue();
    // }

    // private void OnChange(ChangeEventArgs e)
    // {
    //     string newValue = e.Value?.ToString();
    //     CurrentValue = newValue;
    //     SetCurrentValue(newValue); // Update object's property
    // }
    private void SetCurrentValue(string value)
    {
#if DEBUG
#endif

        Type typeOfObj = Obj.GetType();
        PropertyInfo propertyInfo = typeOfObj.GetProperty(PropertyName);
        propertyInfo?.SetValue(Obj, value);

        StateHasChanged();
    }

    // protected override bool ShouldRender()
    // {
    //     return base.ShouldRender();
    // }

    // private string GetCurrentValue()
    // {
    //     Type typeOfObj = Obj.GetType();
    //     PropertyInfo propertyInfo = typeOfObj.GetProperty(PropertyName);
    //     return propertyInfo?.GetValue(Obj)?.ToString() ?? "";
    // }
} *@
