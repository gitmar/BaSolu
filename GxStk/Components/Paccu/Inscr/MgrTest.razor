@page "/mgrtest"

@using Microsoft.OData.Client
@using System.Security.Claims
@using Blazored.LocalStorage
@using GxStk.Services
@using GxWapi.DaModels

@inject Default.Container _vcontext
@inject ILocalStorageService _localStorage

<h3>MgrTest</h3>
@foreach(var untie in _lsTiws)
{
    <div>@untie.Nom</div>
    <div>@untie.Pnom</div>
}

@code
{
    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }
    private ClaimsPrincipal authUser;
    private bool isAuthenticated = false;
    public int _UorgId = 0, _curOrga = 0;

    //private EntityManager _entityManager;
    public IEnumerable<Tiewel> ResTiw;
    private IEnumerable<Tiewel> _lsTiws = new List<Tiewel>();  

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthState;
            authUser = authState.User;
            isAuthenticated = authUser.Identity.IsAuthenticated;
            if (!isAuthenticated)
            {
                Console.WriteLine("Authentication ECHEC");
                return;
            }
            
            // Get manager with token
            //_entityManager = await _myentProvider.GetManager();
            // Check authorization first
            //if (!await _myentManager.CheckAuthorizationAsync())
            //{
            //    throw new InvalidOperationException("Not authorized to make this request");
            //}
            //var query = new EntityQuery<Tiewel>("tieenrol");
            //.Where(o => o.Eta == 1)
                //.Expand("Tiwatrs");
            // Debug check for auth headers
            // var auth = manager.DataService.DefaultHeaders.Authorization;
            // if (auth != null)
            // {
            //     Console.WriteLine($"Auth scheme: {auth.Scheme}, Parameter: {auth.Parameter.Substring(0, 10)}...");
            // }
            var result = await _vcontext.Tiewels.ExecuteAsync();
            ResTiw = result;
            _lsTiws = ResTiw.ToList();
            //myOrga = result.FirstOrDefault();

            // if (myOrga != null)
            // {
            //     foreach (var pln in myOrga.Plngens)
            //     {
            //         // Handle plan properties
            //         // Note: Use PascalCase property names
            //     }
            // }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Query failed: {ex.Message}");
        }
    }

    private async Task SaveChanges()
    {
        var addenties = _vcontext.Entities.Where(ute => ute.State == EntityStates.Added);
        var modenties = _vcontext.Entities.Where(ute => ute.State == EntityStates.Modified);
        var delenties = _vcontext.Entities.Where(ute => ute.State == EntityStates.Deleted);
        Console.WriteLine("In Updating");
        if (addenties.Any() || modenties.Any() || delenties.Any())
        {
            try
            {
                await _vcontext.SaveChangesAsync(SaveChangesOptions.BulkUpdate); // Sends PATCH
                // Handle successful save
            }
            catch (Exception ex)
            {
                // Handle save errors
                Console.Error.WriteLine($"Save error: {ex.Message}");
            }
        }
    }
}