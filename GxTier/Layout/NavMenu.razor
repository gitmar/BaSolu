@using GxTie.Services
@using GxShared.Sess
@using System.Security.Claims
@using BlazorBootstrap

@inject NavigationManager _navManager

<div class="top-row mb-0 navbar navbar-dark bg-success shadow-sm bg-opacity-25 mt-0 navbar-slim">
    <a class="navbar-brand text-white fw-bold" href="">
        <i class="bi bi-gear-fill me-1"></i> Gx-Solutions <span class="text-warning fw-bold">(Person)</span>
    </a>
    <button class="navbar-toggler btn btn-sm" type="button" @onclick="ToggleNavMenu">
        <span class="navbar-toggler-icon"></span>
    </button>
</div>

<div class="@NavMenuCssClass bg-dark text-light vh-100" style="overflow-y: auto;">
    <nav class="nav flex-column">

        <!-- HOME -->
        <NavLink class="nav-link nav-main text-light small" href="" Match="NavLinkMatch.All">
            <i class="bi bi-house-door-fill me-2"></i> Home
        </NavLink>

        <AuthorizeView>
            <Authorized>

                <!-- RHUMAINES -->
                <NavLink class="nav-link nav-main text-light small" @onclick="ToggleSubManag">
                    <i class="bi bi-people-fill me-2"></i> Rhumaines
                </NavLink>

                <div class="submenu @(isSubManagVisible ? "open" : "")">
                    <nav class="nav flex-column">

                        <NavLink class="nav-link nav-sub text-light small" href="enrolmenu">
                            <i class="bi bi-person-plus-fill me-2"></i> Enrollement
                        </NavLink>

                        <NavLink class="nav-link nav-sub text-light small" href="carrimenu">
                            <i class="bi bi-person-lines-fill me-2"></i> Carrière
                        </NavLink>

                        <NavLink class="nav-link nav-sub text-light small" href="subitem3">
                            <i class="bi bi-file-earmark-text-fill me-2"></i> Editions
                        </NavLink>

                    </nav>
                </div>

                <!-- OPERATIONS -->
                <NavLink class="nav-link nav-main text-light small" @onclick="ToggleSubOper">
                    <i class="bi bi-gear-fill me-2"></i> Operations
                </NavLink>

                <div class="submenu @(isSubOperVisible ? "open" : "")">
                    <nav class="nav flex-column">

                        <NavLink class="nav-link nav-sub text-light small" href="saieactlnes">
                            <i class="bi bi-ui-checks-grid me-2"></i> Saisies
                        </NavLink>

                        <NavLink class="nav-link nav-sub text-light small" href="calcreslnes">
                            <i class="bi bi-calculator-fill me-2"></i> Calculs
                        </NavLink>

                        <NavLink class="nav-link nav-sub text-light small" href="subitem3">
                            <i class="bi bi-printer-fill me-2"></i> Editions
                        </NavLink>

                    </nav>
                </div>

            </Authorized>
        </AuthorizeView>

        <!-- ANALYSES -->
        <NavLink class="nav-link nav-main text-light small" href="about">
            <i class="bi bi-graph-up-arrow me-2"></i> Analyses
        </NavLink>

        <!-- AGENDAS -->
        <NavLink class="nav-link nav-main text-light small" href="about">
            <i class="bi bi-calendar3 me-2"></i> Agendas
        </NavLink>

        <!-- ABOUT -->
        <NavLink class="nav-link nav-main text-light small" href="about">
            <i class="bi bi-info-circle-fill me-2"></i> About
        </NavLink>

    </nav>
</div>


<style>
    .top-row.navbar {
        padding-left: 0 !important;
        padding-right: 0 !important;
        --bs-navbar-padding-y: 0.25rem; /* reduce vertical padding */
    }

    .top-row .navbar-brand {
        margin-left: 0 !important;
        padding-left: 0 !important;
        font-size: 0.9rem; /* smaller text */
        line-height: 1.2; /* tighter line spacing */
    }
    /* ========== SUBMENU ANIMATION ========== */
    .submenu {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: max-height 0.35s ease-out, opacity 0.25s ease-out, padding-left 0.3s ease-out;
        padding-left: 0rem;
    }

        /* When open, expand submenu */
        .submenu.open {
            max-height: 500px; /* Enough for many items */
            opacity: 1;
            padding-left: 0.5rem;
        }

    /* Style submenu links */
    .nav-sub {
        padding-left: 1.5rem !important;
        transition: padding-left 0.25s ease;
    }

        /* Hover effect on submenu items */
        .nav-sub:hover {
            padding-left: 1.7rem !important;
            background-color: rgba(255, 255, 255, 0.08);
            border-radius: 4px;
        }

    /* ========== ARROW ANIMATION (optional) ========== */
    /* Place an arrow icon inside main menu items if needed */
    .nav-main .arrow {
        transition: transform 0.3s ease;
        font-size: 0.8rem;
    }

    /* Rotate arrow when submenu is open */
    .submenu.open ~ .nav-main .arrow,
    .nav-main.open .arrow {
        transform: rotate(90deg);
    }
</style>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }
    private ClaimsPrincipal authUser;
    private bool isAuthenticated = false;
    private bool success, errors, isSubmitting = false;
    private string[] errorList = [];
    private bool collapseNavMenu = false;
    private string? NavMenuCssClass => collapseNavMenu ? "collapse" : null;

    private bool siOpera=false, siAdmin = false, siStock = true;
    private int IMyAcc = 2;
    private bool isSubManagVisible = false;
    private bool isSubSecuVisible = false;
    private bool isSubOperVisible = false;
    private bool isSubParaVisible = false;
    private bool isSubProgVisible = false;
    //private void ToggleNavMenu() => collapseNavMenu = !collapseNavMenu;
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthState;
        authUser = authState.User;
        isAuthenticated = authUser.Identity.IsAuthenticated;
        if (!isAuthenticated)
        {
            Console.WriteLine("Authentication Utilisateur ECHEC");
            return;
        }
        else
        {
            Console.WriteLine("Authentication MainMenu SUCCESS");
        }
        //_appState.OnChange += StateHasChanged;
    }
    private void ToggleNavMenu()
    {
        collapseNavMenu = !collapseNavMenu;
    }
    private void ToggleSubManag()
    {
        isSubManagVisible = !isSubManagVisible;
    }
    private void ToggleSubSecu()
    {
        isSubSecuVisible = !isSubSecuVisible;
    }
    private void ToggleSubOper()
    {
        isSubOperVisible = !isSubOperVisible;
    }

    //Admin
    private void ToggleSubPara()
    {
        isSubParaVisible = !isSubParaVisible;
    }
    private void ToggleSubProg()
    {
        isSubProgVisible = !isSubProgVisible;
    }
    private bool Entest = false;
    public void Dispose()
    {
        //_appState.OnChange -= StateHasChanged;
    }
    // protected override async Task OnAfterRenderAsync(bool firstRender)
    // {
    //     Entest = false;
    // }
}
