@using System.Reflection
@using Microsoft.AspNetCore.Components.Forms
@using GxShared.Sess
@using GxShared.Others
@using GxWapi.DaModels

<!-- TabselComponent.razor -->

<InputSelect class=" @GetCssClass()" @bind-Value="SelectedValue">
    <option value="">Select @Title</option>
    @foreach (var item in FilteredOptions)
    {
        <option value="@item.Pele">@item.Liba</option>
    }
</InputSelect>

@code {
    [Parameter] public object Obj { get; set; }
    [Parameter] public string PropertyName { get; set; }
    [Parameter] public EventCallback<object> ObjChanged { get; set; }

    [Parameter] public int? Ztbl { get; set; }
    [Parameter] public List<Gsglne> TbElems { get; set; }
    [Parameter] public string Title { get; set; }
    [Parameter] public int? ParentTableValue { get; set; }
    [Parameter] public string Class { get; set; }
    [Parameter] public string Style { get; set; }
    [Parameter] public TextAlignment TextAlign { get; set; } = TextAlignment.Left;
    [Parameter] public Size TextSize { get; set; } = Size.Medium;
    [Parameter] public ControlWidth Width { get; set; } = ControlWidth.Medium;

    private string _selectedValue;
    private int nbx => FilteredOptions.Count();

    protected override void OnInitialized() => UpdateSelection();

    protected override void OnParametersSet() => UpdateSelection();

    private string SelectedValue
    {
        get => _selectedValue;
        set
        {
            if (_selectedValue != value)
            {
                _selectedValue = value;
                SetPropertyValue(value);
            }
        }
    }

    private IEnumerable<Gsglne> FilteredOptions =>
        ParentTableValue.HasValue
            ? TbElems.Where(ita => ita.Pele == Ztbl && ita.Ydpd == ParentTableValue.Value)
            : TbElems.Where(ita => ita.Pele == Ztbl);

    private void UpdateSelection()
    {
        if (Obj != null && !string.IsNullOrEmpty(PropertyName))
        {
            var prop = Obj.GetType().GetProperty(PropertyName,
                       BindingFlags.Public | BindingFlags.Instance);
            _selectedValue = prop?.GetValue(Obj)?.ToString() ?? "";
        }
    }

    private async void SetPropertyValue(string value)
    {
        if (Obj != null && !string.IsNullOrEmpty(PropertyName))
        {
            var prop = Obj.GetType().GetProperty(PropertyName,
                       BindingFlags.Public | BindingFlags.Instance);
            if (prop != null && prop.CanWrite)
            {
                try
                {
                    object convertedValue;
                    var targetType = prop.PropertyType;

                    // Handle nullable types
                    var underlyingType = Nullable.GetUnderlyingType(targetType);
                    if (underlyingType != null)
                    {
                        // If value is null or empty, set to null
                        convertedValue = string.IsNullOrEmpty(value)
                            ? null
                            : Convert.ChangeType(value, underlyingType);
                    }
                    else
                    {
                        convertedValue = Convert.ChangeType(value, targetType);
                    }

                    prop.SetValue(Obj, convertedValue);

                    // Notify parent about change
                    await ObjChanged.InvokeAsync(Obj);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error setting {PropertyName}: {ex.Message}");
                }
            }
        }
        StateHasChanged();
    }
    //CSS class and style
    private string GetCssClass()
    {
        var widthCssClass = Width switch
        {
            ControlWidth.Small => "width-small",
            ControlWidth.Medium => "width-medium",
            ControlWidth.Large => "width-large",
            ControlWidth.Full => "width-full",
            _ => "width-medium"
        };
        var alignmentClass = TextAlign switch
        {
            TextAlignment.Left => "text-start",
            TextAlignment.Center => "text-center",
            TextAlignment.Right => "text-end",
            TextAlignment.Justify => "text-justify",
            _ => "text-start"
        };
        var sizeClass = TextSize switch
        {
            Size.Small => "small-text",
            Size.Medium => "medium-text",
            Size.Large => "large-text",
            _ => "medium-text"
        };

        // Combine widthCssClass with other classes
        return $"{widthCssClass} {alignmentClass} {sizeClass}";
    }
}