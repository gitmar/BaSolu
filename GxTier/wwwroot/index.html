<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GxTie</title>
    <base href="/" />

    <!-- Styles -->
    <link rel="stylesheet" href="css/app.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="GxTie.styles.css" rel="stylesheet" />
    <link href="manifest.webmanifest" rel="manifest" />
    <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link href="_content/Blazor.Bootstrap/blazor.bootstrap.css" rel="stylesheet" />

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />
</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="." class="reload">Reload</a>
        <span class="dismiss">ðŸ—™</span>
    </div>

    <!-- ðŸ”„ Version Check and Cache Clear -->
    <script>
    (async function () {
            if (window.location.search.includes("forceClear=true")) {
                localStorage.removeItem("appVersion");
            }

            const response = await fetch('version.json', { cache: 'no-store' });
            const currentVersion = await response.text();
            const storedVersion = localStorage.getItem('appVersion');

            console.log("Current version:", currentVersion, "Stored version:", storedVersion);

            if (storedVersion !== currentVersion) {
                // Clear service worker cache
                const keys = await caches.keys();
                for (const key of keys) {
                    await caches.delete(key);
                }

                // Clear cookies
                document.cookie.split(';').forEach(function (c) {
                    document.cookie = c.trim().split('=')[0] + '=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/';
                });

                // Clear storage
                localStorage.clear();
                sessionStorage.clear();

                // Delete IndexedDB
                if (indexedDB.databases) {
                    const dbs = await indexedDB.databases();
                    for (const db of dbs) {
                        indexedDB.deleteDatabase(db.name);
                    }
                }

                localStorage.setItem('appVersion', currentVersion);
                location.reload();
            }
        })();</script>

    <!-- Blazor & Dependencies -->
    <script src="_content/Microsoft.AspNetCore.Components.WebAssembly.Authentication/AuthenticationService.js"></script>
    <script src="_framework/blazor.webassembly.js"></script>
    <script src="lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="_content/Blazor.Bootstrap/blazor.bootstrap.js"></script>
    <script src="interop.js"></script>
    <script src="js/pouchblazor.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="js/printHelper.js"></script>

    <!-- ðŸ›¡ï¸ Safe Service Worker Registration -->
    <script>
    window.addEventListener('load', () => {
            navigator.serviceWorker.register('service-worker.js');
        });</script>
</body>
</html>