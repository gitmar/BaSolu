@page "/inscrtiw"
@layout EnrolMenu

@using System
@using System.ComponentModel.DataAnnotations
@using System.Dynamic
@using System.Net.Http.Headers
@using System.Reflection
@using System.Text
@using System.Text.Json
@using System.Web
@using BlazorBootstrap
@using GxShared.Sess
@using GxShared.Others
@using GxTie.ClieModels
@using GxTie.Services
@using GxTie.Components.Paccu.RtPer
@using GxTie.Services.Mform
@using GxWapi.DaModels
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.OData.Client
@using Newtonsoft.Json

@inject NavigationManager _navmanager
@inject HttpClientService _cliemanager

<!-- InscTiewComponent.razor -->
<PageTitle>RECEPTION</PageTitle>
@* <h3>Formulaire INSCRIPTION</h3> *@ 
@* <div>
    @strmeta
</div>  *@
<div>
    @Imessage
</div>
@if (isLoading)
{
    <Progress class="progress mb-3">
        <ProgressBar Width="100" Label="Persos/Accueil Loading..." Type="ProgressType.StripedAndAnimated" Color="ProgressColor.Primary" />
    </Progress>
}
@* @if (allEnable)
{
        <div>
            &nbsp;&nbsp;
            <button class="btn btn-warning btn-sm" @onclick="() => OuvrirFiche(1)">OuvrirRe</button>
        </div>
} *@
@* <!--VISIBLE SAISIE-->
@if (isFicheVisible)
{
    
} *@
<!--downmodal-->
@if (curTiw != null && isModalVisible == true)
{
    <GlobModal IsVisible="@isModalVisible"
               IsVisibleChanged="@OnModalVisibilityChanged"
               Title="Chargement des documents"
               EntyTiw="@curTiw"
               EntyTie="null"
               LsmVars="@LsVars"
               LsmFixes="@LsFixes"
               OnTiwSave="@HandleSave"
               Oparent="2">
    </GlobModal>
}

@* <input type="text" @bind="Curtie.Nom" placeholder="Name" />
    <input type="text" @bind="Curtie.Pnom" placeholder="Description" /> *@
<div class="d-flex flex-column">
    <div class="container row">
        <div class="d-flex flex-column">
            @if (success)
            {
                <div class="alert alert-success">@successmsg</div>
            }
            @if (errors)
            {
                foreach (var error in errorList)
                {
                    <div class="alert alert-danger">@error</div>
                }
            }
            @if (yainfo)
            {
                <div class="alert alert-info">
                    @infomess
                </div>
            }
        </div>
    </div>
    <div class="my-container">
        @if (toChild != null)
        {
            @ChildContent
        }
    </div>
    @if (!isLoading)
    {
        @if (curTiw != null && TbElems.Any() && LsCols.Any())
        {
            <AuthorizeView>
                <Authorized Context="authtiwcontext">
                    <EditForm EditContext="edTiwContext" @key="curTiw">
                        <DataAnnotationsValidator />
                        <ValidationSummary />
                        <div class="container row">
                            <div class="row">
                                <ul class="nav nav- flex-nowrap" id="cltabs" role="tablist">
                                    <li class="nav-item" role="tab">
                                        <a class="nav-link show active" id="cdt" data-bs-toggle="tab"
                                           href="#nav-cdts" role="tab" aria-controls="nav-cdts"
                                           aria-selected="false">
                                            Candidature
                                        </a>
                                    </li>
                                    <li class="nav-item" role="tab">
                                        <a class="nav-link" id="det" data-bs-toggle="tab"
                                           href="#nav-details" role="tab" aria-controls="nav-details"
                                           aria-selected="true">
                                            Details
                                        </a>
                                    </li>
                                    <li class="nav-item" role="tab">
                                        <a class="nav-link" id="vrf" data-bs-toggle="tab"
                                           href="#nav-verfs" role="tab" aria-controls="nav-verfs"
                                           aria-selected="true">
                                            Verification
                                        </a>
                                    </li>
                                    @* <li class="nav-item" role="tab">
                                        <a class="nav-link" id="fic" data-bs-toggle="tab"
                                           href="#nav-fiches" role="tab" aria-controls="nav-fiches"
                                           aria-selected="true">
                                            Recepisse
                                        </a>
                                    </li> *@
                                </ul>
                                <div class="tab-content" id="tab-contenu">
                                    <!--Reception des candidatures-->
                                    <div class="row tab-pane fade show active" id="nav-cdts" role="tabpanel" aria-labelledby="cdt">
                                        <div class="form-group">
                                            @if (allEnable)
                                            {
                                                @if (AddVue)
                                                { //
                                                  <button class="btn btn-primary btn-sm" @onclick="() => PrepareAddTiw()">
                                                      ➕ Add
                                                  </button>
                                                  <span>&nbsp;&nbsp;</span>
                                                }
                                                @if (IncludeVue)
                                                { //sinwTiw && curTiw.Xadd1 == -1
                                                  <span>&nbsp;&nbsp;</span>
                                                  <button class="btn btn-sm btn-success" @onclick="() => IncludeTiw(curTiw)">
                                                      <span class="me-1">💾</span> Inclure
                                                  </button>
                                                  <span>&nbsp;&nbsp;</span>
                                                  <button class="btn btn-sm btn-secondary" @onclick="() => CancelAddTiw()">
                                                      ❎ Annuler
                                                  </button>
                                                }
                                                else
                                                @if (EdtDelVue && AddingTiwRowGuid == Guid.Empty)
                                                {//curTiw.Xadd1 != -2
                                                 <button class="btn btn-sm btn-warning me-1 @(EdtDelDisable ? "" : "disabled-action")"
                                                         @onclick="() => BeginTiwEdit()">
                                                     ✏️ Edit
                                                 </button>
                                                 <button class="btn btn-sm btn-outline-danger @(EdtDelDisable ? "" : "disabled-action")"
                                                         @onclick="() => PromptTiwDelete()">
                                                     🗑️ Delete
                                                 </button>
                                                }
                                                else if (ConfirmingTiwDeleteRowGuid == curTiw.Rowguid)
                                                {
                                                    <button class="btn btn-sm btn-success" @onclick="() => ConfirmTiwDelete()">
                                                        ✅ Confirm
                                                    </button>
                                                    <button class="btn btn-sm btn-secondary" @onclick="CancelTiwDelete">
                                                        ❌ Cancel
                                                    </button>
                                                }
                                                @if (AddingTiwRowGuid == curTiw.Rowguid || EditingTiwRowGuid == curTiw.Rowguid)
                                                {
                                                    <span>&nbsp;&nbsp;</span>
                                                    <button type="button" class="btn btn-lnk btn-sm btn-info bg-opacity-50" @onclick="ShowModal">piece(s)</button>
                                                }
                                            }
                                        </div>
                                        <div class="p-1 grid-container" style="max-height: 400px; overflow-y: auto;">
                                            @if (curTiw != null)
                                            {
                                                <div class="grid-row">
                                                    <label><b>Dossier :</b></label>
                                                    <InputText class="standard-width" @bind-Value="curTiw.Xmatri" placeholder="no dossier" />
                                                </div>
                                                @foreach (var ucol in LsCols.Where(uv => uv.Totyp == Ugpe && uv.Tstyp == 1 && uv.Jacc == 1
                                                                                    && uv.Elea != 3 && uv.Elea != 4).ToList())
                                                {
                                                    <div class="grid-row">
                                                        <div>
                                                            <label><b>@ucol.Liba :</b></label>
                                                        </div>
                                                        <div>
                                                            @if (ucol.Sitb == 1) //table-numerique
                                                            {
                                                                <TabselComponent Obj=@curTiw PropertyName="@ucol.Scdrub" Ztbl="@ucol.Ztbl" Title="@ucol.Liba" tbElems="@TbElems" Width="@ControlWidth.Large" ParentTableValue="@ucol.Zdpd" />
                                                            }
                                                            else
                                                            {
                                                                @switch (ucol.Ztyp)
                                                                {
                                                                    case 1:
                                                                        <StringComponent Obj=@curTiw PropertyName="@ucol.Scdrub" Width="@ControlWidth.Large" Placeholder="@($" {ucol.Liba}")" />
                                                                        break;
                                                                    case 2:
                                                                    case 3:
                                                                    case 4:
                                                                    case 5:
                                                                        <NumberComponent Obj=@curTiw PropertyName="@ucol.Scdrub" Placeholder="@($" {ucol.Liba}")" Width="ControlWidth.Small" TextAlign="TextAlignment.Right" />
                                                                        break;
                                                                    case 6:
                                                                        <BoolComponent Obj=@curTiw PropertyName="@ucol.Scdrub" Placeholder="@($" {ucol.Liba}")" />
                                                                        break;
                                                                    case 7:
                                                                        <DateComponent Obj=@curTiw PropertyName="@ucol.Scdrub" Placeholder="@($" {ucol.Liba}")" />
                                                                        break;
                                                                    default:
                                                                        <StringComponent Obj=@curTiw PropertyName="@ucol.Scdrub" Placeholder="@($" {ucol.Liba}")" />
                                                                        break;
                                                                }
                                                            }
                                                        </div>
                                                    </div>
                                                }
                                            }
                                            <div class="grid-row p-1">
                                                <label><b>Service :</b>:</label>
                                                @if (_lsDivs.Count > 0)
                                                {
                                                    <select class="standard-width" id="TypDiv" @bind="curTiw.Idhie">
                                                        <option value="0">Aucun</option>
                                                        @foreach (var divo in _lsDivs)
                                                        {
                                                            <option value="@divo.Khie">@divo.Liba</option>
                                                        }
                                                    </select>
                                                }
                                            </div>
                                            <div class="grid-row p-1">
                                                <label><b>Poste :</b></label>
                                                @if (_lsPsts.Count > 0)
                                                {
                                                    <select class="standard-width" id="TypPst" @bind="curTiw.Idpst">
                                                        <option value="0">Aucun</option>
                                                        @foreach (var divo in _lsPsts)
                                                        {
                                                            <option value="@divo.Kpst">@divo.Liba</option>
                                                        }
                                                    </select>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                    <!--Details des candidatures-->
                                    <div class="row tab-pane fade" id="nav-details" role="tabpanel" aria-labelledby="det">
                                        @if (Ugpe != 0 && curTiw != null)
                                        {
                                            <!--Ityp(exist?)-->
                                            var eligibleUfls = TUafls.Where(ufl => ufl.Ityp == 1 && ufl.Etyp != 1 && ufl.Etyp != 0).ToList();
                                            <Tabs @bind-ActiveTabIndex="activeTabIndex" EnableFadeEffect="true">
                                                @foreach (var ufl in eligibleUfls)
                                                {
                                                    var jsliba = ufl.Sliba + (ufl.Elea == 1 ? "(es)" : "(s)");
                                                    <Tab Title="@jsliba">
                                                        <Content>
                                                            @* <span>@ufl.Totyp @ufl.Liba @curOrga.Sigle @ufl.Etyp @Ugpe</span> *@
                                                            @if (curOrga != null && curTiw != null && ufl != null && toChild != null && Ugpe != 0 && ufl.Totyp != 0 && TbElems.Any())
                                                            {
                                                                if (curTiw.Utyp != 0 && TUafls.Any())
                                                                {
                                                                    <!--pour chqe existant dans table //Etp <-> tab// -->
                                                                    <div class="form-group">
                                                                        @if (AddRubVue)
                                                                        { //allEnable && AddStep[ufl.Etyp] != -1
                                                                          <button class="btn btn-primary btn-sm" @onclick="() => PrepareAddAfl(curTiw, ufl.Etyp)">
                                                                              ➕ Add
                                                                          </button>
                                                                          <span>&nbsp;&nbsp;</span>
                                                                        }
                                                                        @if (IncludeRubVue)
                                                                        { //allEnable && sinwAfl && AddStep[ufl.Etyp] == -1
                                                                          <button class="btn btn-sm btn-success" @onclick="() => IncludeAfl(curAfl)">
                                                                              <span class="me-1">💾</span> Inclure
                                                                          </button>
                                                                          <span>&nbsp;&nbsp;</span>
                                                                          <button class="btn btn-sm btn-secondary" @onclick="() => CancelAddAfl()">
                                                                              ❎ Annuler
                                                                          </button>
                                                                        }
                                                                    </div>
                                                                    foreach (var dafl in @curTiw.Tiwafls.Where(tw => tw.Tyafl == ufl.Etyp).ToList())
                                                                    {
                                                                        @if (allEnable)
                                                                        {
                                                                            <div class="input-group">
                                                                                @if (EdtDelRubVue && AddingAflRowGuid == Guid.Empty)
                                                                                {//curTiw.Xadd1 != -2
                                                                                 <button class="btn btn-sm btn-warning me-1 @(EdtDelRubDisable ? "" : "disabled-action")"
                                                                                         @onclick="() => BeginAflEdit(dafl)">
                                                                                     ✏️ Edit
                                                                                 </button>
                                                                                 <button class="btn btn-sm btn-outline-danger @(EdtDelRubDisable ? "" : "disabled-action")"
                                                                                         @onclick="() => PromptAflDelete(dafl)">
                                                                                     🗑️ Delete
                                                                                 </button>
                                                                                }
                                                                                @if (EditingAflRowGuid == dafl.Rowguid)
                                                                                { //IsAflEditing(dafl) && AddStep[ufl.Etyp] != -1
                                                                                  <button class="btn btn-sm btn-success" @onclick="() => ConfEdingAfl(draftAfl)">
                                                                                      💾 Accept
                                                                                  </button>
                                                                                  <button class="btn btn-sm btn-secondary" @onclick="() => CancEdingAfl(draftAfl)">
                                                                                      ❎ Cancel
                                                                                  </button>
                                                                                }
                                                                                else if (ConfirmingAflDeleteRowGuid == dafl.Rowguid)
                                                                                {
                                                                                    @* <button class="btn btn-sm btn-outline-danger" @onclick="() => PromptAflDelete(item)">
                                                                                                🗑️ Delete
                                                                                            </button> *@
                                                                                    <button class="btn btn-sm btn-success" @onclick="() => ConfirmAflDelete(dafl)">
                                                                                        ✅ Confirm
                                                                                    </button>
                                                                                    <button class="btn btn-sm btn-secondary" @onclick="CancelAflDelete">
                                                                                        ❌ Cancel
                                                                                    </button>
                                                                                }
                                                                            </div>
                                                                        }
                                                                        <div class="p-1 @DisabledClass" style="max-height: 400px; overflow-y: auto;">
                                                                            @foreach (var ucol in LsCols.Where(uv => uv.Totyp == Ugpe && uv.Tstyp == ufl.Etyp && uv.Jacc == 1).ToList())
                                                                            {
                                                                                @if (EditingAflRowGuid == dafl.Rowguid)
                                                                                {
                                                                                    <div class="d-flex flex-row flex-fill">
                                                                                        <div>
                                                                                            <label><b>@ucol.Liba :</b></label>
                                                                                        </div>
                                                                                        <div>
                                                                                            @if (ucol.Sitb == 1) //table-numerique
                                                                                            {
                                                                                                <TabselComponent Obj=@dafl PropertyName="@ucol.Scdrub" Ztbl="@ucol.Ztbl" Title="@ucol.Liba" tbElems="@TbElems" Width="@ControlWidth.Large" ParentTableValue="@ucol.Zdpd" />
                                                                                            }
                                                                                            else
                                                                                            {
                                                                                                @switch (ucol.Ztyp)
                                                                                                {
                                                                                                    case 1:
                                                                                                        <StringComponent Obj=@dafl PropertyName="@ucol.Scdrub" Width="@ControlWidth.Large" Placeholder="@($" {ucol.Liba}")" />
                                                                                                        break;
                                                                                                    case 2:
                                                                                                    case 3:
                                                                                                    case 4:
                                                                                                    case 5:
                                                                                                        <NumberComponent Obj=@dafl PropertyName="@ucol.Scdrub" Placeholder="@($" {ucol.Liba}")" Width="ControlWidth.Small" TextAlign="TextAlignment.Right" />
                                                                                                        break;
                                                                                                    case 6:
                                                                                                        <BoolComponent Obj=@curTiw PropertyName="@ucol.Scdrub" Placeholder="@($" {ucol.Liba}")" />
                                                                                                        break;
                                                                                                    case 7:
                                                                                                        <DateComponent Obj=@curTiw PropertyName="@ucol.Scdrub" Placeholder="@($" {ucol.Liba}")" />
                                                                                                        break;
                                                                                                    default:
                                                                                                        <StringComponent Obj=@curTiw PropertyName="@ucol.Scdrub" Placeholder="@($" {ucol.Liba}")" />
                                                                                                        break;
                                                                                                }
                                                                                            }
                                                                                        </div>
                                                                                    </div>
                                                                                }
                                                                                else
                                                                                {

                                                                                }
                                                                            }
                                                                        </div>
                                                                    }
                                                                    <!--Place Grid-->
                                                                }
                                                            }
                                                        </Content>
                                                    </Tab>
                                                }
                                            </Tabs>
                                        }
                                    </div>
                                    <!--Verification des candidatures-->
                                    <div class="row tab-pane fade" id="nav-verfs" role="tabpanel" aria-labelledby="vrf">
                                        <div style="max-height: 300px; overflow-y: auto;">
                                            <Grid TItem="Tiewel"
                                                  Data="@ensTiws.Where(t=>t.Jwlc < 4)"
                                                  AllowRowClick="true"
                                                  OnRowClick="OnTiwRowClick"
                                                  AllowPaging="true"
                                                  Responsive="true">
                                                <GridColumns>
                                                    <GridColumn TItem="Tiewel" HeaderText="Accord?">
                                                        <HeaderContent>
                                                            <label>Verf?</label>
                                                            <InputCheckbox Value="@IsGlobalT1Checked"
                                                                           ValueChanged="(bool val) => OnTAccAll(new ChangeEventArgs { Value = val }, 1)"
                                                                           ValueExpression="@(() => IsGlobalT1Checked)"
                                                                           class="form-check-input"
                                                                           disabled="@(!allEnable)">
                                                            </InputCheckbox>
                                                        </HeaderContent>
                                                        <ChildContent Context="item">
                                                            <div @key="item.Rowguid"></div>
                                                            <InputCheckbox @bind-Value="item.IsJaccChecked"
                                                                           @onchange="e => { item.Jacc = (bool)e.Value ? 1 : 0; }"
                                                                           class="form-check-input"
                                                                           disabled="@(!allEnable)">
                                                            </InputCheckbox>
                                                        </ChildContent>
                                                    </GridColumn>
                                                    <GridColumn TItem="Tiewel" HeaderText="Rejet?">
                                                        <HeaderContent>
                                                            <label>Rjt?</label>
                                                            <InputCheckbox Value="@IsGlobalT2Checked"
                                                                           ValueChanged="(bool val) => OnTAccAll(new ChangeEventArgs { Value = val }, 2)"
                                                                           ValueExpression="@(() => IsGlobalT2Checked)"
                                                                           class="form-check-input"
                                                                           disabled="@(!allEnable)">
                                                            </InputCheckbox>
                                                        </HeaderContent>
                                                        <ChildContent Context="item">
                                                            <InputCheckbox @bind-Value="item.IsJrejChecked"
                                                                           @onchange="e => { item.Jrej = (bool)e.Value ? 1 : 0; }"
                                                                           class="form-check-input"
                                                                           disabled="@(!allEnable)">
                                                            </InputCheckbox>
                                                        </ChildContent>
                                                    </GridColumn>
                                                    <GridColumn TItem="Tiewel" HeaderText="Notif?">
                                                        <HeaderContent>
                                                            <label>Ntf?</label>
                                                            <InputCheckbox Value="@IsGlobalT3Checked"
                                                                           ValueChanged="(bool val) => OnTAccAll(new ChangeEventArgs { Value = val }, 3)"
                                                                           ValueExpression="@(() => IsGlobalT3Checked)"
                                                                           class="form-check-input"
                                                                           disabled="@(!allEnable)">
                                                            </InputCheckbox>
                                                        </HeaderContent>
                                                        <ChildContent Context="item">
                                                            <InputCheckbox @bind-Value="item.IsJnotChecked"
                                                                           @onchange="e => { item.Jrej = (bool)e.Value ? 1 : 0; }"
                                                                           class="form-check-input"
                                                                           disabled="@(!allEnable)">
                                                            </InputCheckbox>
                                                        </ChildContent>
                                                    </GridColumn>
                                                    <GridColumn TItem="Tiewel" HeaderText="Dossier">
                                                        <ChildContent Context="item">
                                                            @item.Xmatri
                                                        </ChildContent>
                                                    </GridColumn>
                                                    <GridColumn TItem="Tiewel" HeaderText="Nom">
                                                        <ChildContent Context="item">
                                                            @item.Nom
                                                        </ChildContent>
                                                    </GridColumn>
                                                    <GridColumn TItem="Tiewel" HeaderText="Pnom">
                                                        <ChildContent Context="item">
                                                            @item.Pnom
                                                        </ChildContent>
                                                    </GridColumn>
                                                    <GridColumn TItem="Tiewel" HeaderText="Actions">
                                                        <HeaderContent>
                                                            <!-- Accepter-->
                                                            <!-- Rejeter-->
                                                            <!-- Notifier-->
                                                        </HeaderContent>
                                                        <ChildContent Context="item">
                                                            @if (!(curODContext.GetEntityState(item) == EntityStates.Added))
                                                            {
                                                                @if (curODContext.GetEntityState(item) == EntityStates.Modified)
                                                                {
                                                                    <span>&nbsp;&nbsp;</span>
                                                                }
                                                            }
                                                        </ChildContent>
                                                    </GridColumn>
                                                    <GridColumn TItem="Tiewel" HeaderText="Actions">
                                                        <ChildContent Context="item">
                                                            <div class="col-2">
                                                                <button class="btn btn-warning btn-sm" @onclick="() => OuvrirFiche(1)">Recepisse</button>
                                                            </div>
                                                        </ChildContent>
                                                    </GridColumn>
                                                </GridColumns>
                                            </Grid>
                                        </div>
                                    </div>
                                    @if (isRecptVisible)
                                    {
                                        <div class="row">
                                            <RtW11Fic @ref="myftiw"
                                                      curOrga="@curOrga"
                                                      toChild="@toChild"
                                                      curODContext="@curODContext"
                                                      curTiw="@rselTiw">
                                                <ChildContent>
                                                    @* <h2 class="child-box">Fiche d'Inscription</h2> *@
                                                </ChildContent>
                                            </RtW11Fic>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </EditForm>
                </Authorized>
            </AuthorizeView>
        } else {
            <p>no data available</p>
        }
    }
</div>
<style>
    .inputfl {
        opacity: 0;
        width: 0.1;
        height: 0.1;
        position: absolute;
    }

    .disabled {
        pointer-events: none; /* Prevents clicking */
        opacity: 0.5; /*visual cue for disabled state */
    }

    .gpe-select {
        font-size: 24px;
        font-weight: bold;
    }

        .gpe-select option {
            font-size: 18px;
            font-weight: bold;
        }

    .my-container {
        background-color: yellow;
    }

    .maxh-400 {
        max-height: 400px;
        overflow-y: auto;
    }

    .disabled-action {
        pointer-events: none;
        opacity: 0.5;
    }

    .grid-container {
        display: grid;
        grid-template-columns: max-content minmax(max-content, auto);
        gap: 8px 16px;
    }

    .grid-row {
        display: contents; /* makes children participate directly in the grid */
    }

    .grid-container label {
        grid-column: 1;
        font-weight: bold;
        white-space: nowrap;  /* prevent label wrap */
    }

    .grid-container > div {
        grid-column: 2;
    }

    .standard-width {
        width: 200px; /* or any fixed width like 150px, 100%, etc */
        max-width: 100%;
    }
</style>

@code {
    private bool isLoading = true;
    private bool allEnable = false;
    private bool isRecptVisible = false;
    // private AccuAfil myafl;

    private string Imessage = "", Jmessage = "";
    [Parameter]
    public RenderFragment ChildContent { get; set; }
    [Parameter]
    public MyODataContext curODContext { get; set; }
    [Parameter]
    public Gxorga curOrga { get; set; }
    [Parameter]
    public MyShareVars toChild { get; set; }
    [Parameter]
    public int? Tgpe { get; set; }
    [Parameter]
    public int? Ugpe { get; set; }

    private EditContext? edTiwContext;

    //tiers non integrer, non rejeter et non accepter
    public List<Tiewel> ensTiws = new();

    private List<Gpdivh> _lsDivs = new List<Gpdivh>();
    private List<Divpst> _lsPsts => _lsDivs.Where(dv => dv.Ihie == curTiw.Idhie).SelectMany(dp => dp.Divpsts).ToList();

    private RtW11Fic myftiw { get; set; }

    public string Title { get; set; }
    public List<Gpvar> TUafls = new();
    string gpeLiba = "";
    private int chxTab = 0;
    private Tiewel? curTiw = new();
    private Tiwafl? curAfl = new();
    private Tiewel? rselTiw = new();
    private bool sinwTiw = false, sinwAfl = false;
    private int _lgcdu = 0;
    private bool IsGlobalT1Checked { get; set;} = false;
    private bool IsGlobalT2Checked { get; set; } = false;
    private bool IsGlobalT3Checked { get; set; } = false;

    public List<Gpfixe> LsFixes { get; set; }
    public List<Gpfixe> LsTgpes { get; set; }
    public List<Gpvar> LsVars { get; set; }
    public List<Gsglne> LsCols = new();
    public List<Gsglne> TbElems = new();
    private EditContext tiwContext;
    //liste attente de save
    private List<Tiewel> LsTAtts = new List<Tiewel>();
    //private SndmModel envModel = new SndmModel();
    private UsrMail _usrMail = new UsrMail();

    private bool success, errors, yaEnreg = false, yainfo = false;
    private string successmsg = "", infomess = "", searchstr = "", strPoint = "";
    private List<string> errorList = new List<string>();
    private ProgressBar progressBar;
    private string strmeta = "";
    private bool chkAll { get; set; }

    //public EntityManager _twentityManager;
    //private Userbag _usrBag = new Userbag();
    //private Usaibag _uclBag = new Usaibag();

    private int? Siphone = 0;

    // Operation VUE
    [Parameter]
    public bool ParentOK { get; set; }
    [Parameter]
    public bool ParentEDT { get; set; }

    private Guid? AddingTiwRowGuid = Guid.Empty;
    private Guid? EditingTiwRowGuid = Guid.Empty;
    private Guid? ConfirmingTiwDeleteRowGuid = Guid.Empty;
    private Guid? AddingAflRowGuid = Guid.Empty; //pmodal
    private Guid? EditingAflRowGuid = Guid.Empty;
    private Guid? ConfirmingAflDeleteRowGuid = Guid.Empty;

    private bool AddVue => ParentOK && ParentEDT;
    private bool IncludeVue => AddVue && AddingTiwRowGuid != null;
    private bool ValiderVue => (EditingTiwRowGuid != null || ConfirmingTiwDeleteRowGuid != null);
    private bool EdtDelVue => !IncludeVue || !ValiderVue;
    private bool EdtDelDisable => curTiw == null || !ParentEDT;
    private bool AddRubVue => curTiw != null && ParentEDT;
    private bool IncludeRubVue => AddRubVue && AddingAflRowGuid != null;
    private bool ValiderRubVue => (EditingAflRowGuid != null || ConfirmingAflDeleteRowGuid != null);
    private bool EdtDelRubVue => !IncludeRubVue || !ValiderRubVue;
    private bool EdtDelRubDisable => curAfl == null || !ParentEDT;
    //private bool isDisabled = true;
    private string DisabledClass => !EdtDelVue ? "disabled" : "";

    //modals
    private bool isModalVisible = false;

    //pere-editing/adding/deleting
    private bool isTiwInEditing = false;

    private bool IsTiwAdding(Tiewel item) => AddingTiwRowGuid == item.Rowguid;
    private bool IsTiwEditing(Tiewel item) => EditingTiwRowGuid == item.Rowguid;


    private int activeTabIndex { get; set; } = 0;


    private bool IsAflAdding(Tiwafl item) => AddingAflRowGuid == item.Rowguid;
    private bool IsAflEditing(Tiwafl item) => EditingAflRowGuid == item.Rowguid;

    // other relevant code and methods here...
    //variables Rub

    Tiwafl draftAfl = new();
    Tiwafl? editingAfl = null;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        //transmis par 2
        LsVars = toChild.LsVars;
        //Ityp=1exist/Itb=6ou7/Totyp=1cible2operat3client....
        TUafls = LsVars.Where(tu => tu.Gvars == 3 && tu.Itb == 6 && tu.Totyp == Ugpe && tu.Ityp == 1).ToList();
        //Console.WriteLine($"TUafls {TUafls.Count} // {Ugpe}");
        LsFixes = toChild.LsFixes;
        //LsPlans = toChild.LsPlans.Where(pl => pl.Ptyp == 4).ToList();
        LsCols = toChild.LsCols;
        TbElems = toChild.TbElems;
        _lgcdu = 3;
        var noslims = LsVars.Where(uv => uv.Idhie == 0 && uv.Gvars == 21 && uv.Itb == 1 && uv.Elea == 1);
        if (noslims.Any()) _lgcdu = noslims.FirstOrDefault().Ivala;
        //await LoadOrgParas();
       // await ChargeParentData();
        
        _lsDivs = toChild.LsDivs.Where(uh => uh.Sidiv == 1).ToList();
        //Console.WriteLine($"Authentication ENTREE curtiw {curTiw.Nom} nbele :{TbElems.Count} et nbcols : {LsCols.Count}");
    }
    // private async Task LoadOrgParas()
    // {
    //     // _usrBag = await _dbusrManager.GetMyDataAsync(toChild.Usrid, toChild.Idorg);
    //     // //pita = 5;
    //     // //Console.WriteLine($"RETOUR UserBag...{_usrBag.Ufixes.Count()}");
    //     // if ((!_usrBag.Ufixes.Any()) ||
    //     //        _usrBag.Yauser == false)
    //     // {
    //     //     Console.WriteLine("Echec Invite, recommencez.login/support...");
    //     // }
    // }
    // private async Task ChargeParentData()
    // { //programmes
        
    //     //Console.WriteLine($"Tiers accueil recu {curTiw?.Nom}/{curTiw?.Pnom}");
    // }
    protected override async void OnParametersSet()
    {
        LsTgpes = LsFixes.Where(iv => iv.Gvars == 53 && iv.Itb == 2 && iv.Elea != 0).ToList(); //cible/operat...
        // = "Gpe//" + Ugpe.ToString();
        ensTiws = curOrga.Tiewels.Where(t => t.Jwlc < 4).ToList();
        curTiw = ensTiws.FirstOrDefault();
        // Ensure EditContext is always initialized, even if model is null
        if (curTiw != null)
        {
            ResetEditContext(curTiw);
        }
        else
        {
            // fallback dummy model
            ResetEditContext(new Tiewel());
        }

        _navmanager.LocationChanged += OnLocationChanged;
        // if (curTiw != null)
        // {
        //     edTiwContext = new EditContext(curTiw);
        //     edTiwContext.OnFieldChanged += HandleFieldChanged;
        // }
        // else
        // {
        //     // fallback: initialize with a dummy object to avoid null reference
        //     edTiwContext = new EditContext(new Tiewel());
        // }
        //_navmanager.LocationChanged += OnLocationChanged;
        //edTiwContext = new EditContext(curTiw);
        //edTiwContext.OnFieldChanged += HandleFieldChanged;
        isLoading = false;
    }
    void OnTiwRowClick(GridRowEventArgs<Tiewel> args)
    {
        Console.WriteLine($"OnTiwRowClick Triggered : {args.Item.Id}");
        rselTiw = args.Item; //get gRubsMap
        Console.WriteLine($"X1seq {rselTiw.Id}");
        if (rselTiw == null || rselTiw.Id == 0)
        {
            return;
        }
        StateHasChanged();
    }
    // CheckBoxes
    private bool isChecked
    {
        get => curTiw.Jacc == 1;
        set => curTiw.Jacc = value ? 1 : 0;
    }
    //CRUD Tiewel
    private EntityStates? GetState(object entity)
    {
        return curODContext?.GetEntityState(entity);
    }
    void PrepareAddTiw()
    {
        //curTiw = new();
        Tiewel mytier = AddNewTiwRow();
        if (mytier != null)
        {
            curTiw = mytier;  //mytier;
            AddingTiwRowGuid = curTiw.Rowguid;
            sinwTiw = true;
            StateHasChanged();
        } else
        {
            curTiw = new();
        }
    }
    void PrepareAddAfl(Tiewel mytier, int mySTyp)
    {
        //calc next Seq
        Console.WriteLine($" le type : {mySTyp}");
        int nextSeq = 1;
        Tiwafl myafl = AddNewAflRow(mytier, mySTyp, nextSeq);
        if (myafl != null)
        {
            curAfl = myafl;
            //AddStep[mySTyp] = -1;
            curTiw.Tiwafls.Add(myafl);
            AddingAflRowGuid = myafl.Rowguid;
            sinwAfl = true;
            StateHasChanged();
        }
    }
    Tiewel AddNewTiwRow()
    {
        if (curOrga == null || allEnable == false)
        {
            Imessage = "REFUS, Creation Orga indisponible";
            //Yames = true;
            return new Tiewel();
        }
        try
        {
            Console.WriteLine("In Adding");
            return new Tiewel
            {
                //Rowguid = Guid.NewGuid(),
                Idorg = curOrga.Idorg,

                Utyp = Ugpe,
                Nom = "Martin ESSEC",
                Pnom = "Simpore",
                Datc = DateTime.Now,
                Xadd1 = -1,
            };
        }catch(Exception ex)
        {
            Console.WriteLine($"ici : error exception : {ex.Message}");
        }
        return new Tiewel();
    }
    Tiwafl AddNewAflRow(Tiewel mytier, int mytst, int nextSeq)
    {
        if (mytier == null || allEnable == false)
        {
            Imessage = "REFUS, Creation Tiers indisponible";
            //Yames = true;
            return new Tiwafl();
        }
        try
        {
            Console.WriteLine("In Adding");
            return new Tiwafl
            {
                //Rowguid = Guid.NewGuid(),
                Itie = curTiw.Id,
                Ttyp = Ugpe,
                Tyafl = mytst,
                Irang = nextSeq,
                Nom = "Fils Martin",
                Pnom = "Ilboudo",
                Datc = DateTime.Now,
                Xadd1 = -1,
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ici : error exception : {ex.Message}");
        }
        return new Tiwafl();
    }
    async Task IncludeTiw(Tiewel aglne)
    {
        // Use parent Idrub as key to gRubsMap dictionary
        var parentId = curOrga.Idorg;
        bool YaTiw = false;
        YaTiw = await IsTiwValid(aglne);
        if (!YaTiw) return;
        Imessage = "";
        if (!curODContext.IsEntityTracked(aglne))
        {
            curTiw.Xadd1 = -2;  //fin adding to be tracked in loaded rubfmts wait for new add
            aglne.Xadd1 = 0;
            curODContext.AddObject<Tiewel>("Tiewels", aglne);
            sinwTiw = false;
            AddingTiwRowGuid = Guid.Empty;
            curOrga.Tiewels.Add(aglne);
            ensTiws.Add(aglne);
            StateHasChanged();
            Imessage = "Success... programme ajoute";
        }
        else
        {
            aglne.Xadd1 = 0;
            Imessage = "Deja ajoute";
        }
        sinwTiw = false;
    }
    void IncludeAfl(Tiwafl myafl)
    {
        var parentId = curTiw.Rowguid;
        //bool YaChild = IsChildValid(aglne); // Make sure this returns true if aglne is valid to add
        if (!curODContext.IsEntityTracked(myafl)) // && YaChild)
        {
            try
            {
                myafl.Xadd1 = -2;  // Mark as being added

                if (!curODContext.IsEntityTracked(curTiw))
                {
                    curODContext.AttachTo("Tiewels", curTiw);
                }

                int instp = Convert.ToInt16(myafl.Tyafl);
                //AddStep[instp] = -2;
                //myafl.Xadd1 = -2;  //fin adding to be tracked in loaded rubfmts wait for new add
                curODContext.AddRelatedObject(curTiw, "Tiwafls", myafl);
                //curAfl.Xadd1 = -2;
                sinwAfl = false;
                AddingAflRowGuid = Guid.Empty;
                curTiw.Tiwafls.Add(myafl);
                //siAflAdding = true;
                Imessage = "Success... Rubrique ajoutee";
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Erreur addrelatedobject : {ex.Message}");
            }
            StateHasChanged();
        }
        else
        {
            myafl.Xadd1 = 0;
            Imessage = "Deja ajoute";
        }

        //isAdetCodeValid = false;
        sinwAfl = false; // Consider moving this flag reset based on your UI state management needs
    }
    private async Task CancelAddTiw()
    {
        if (curODContext.IsEntityTracked(curTiw))
        {
            curODContext.Detach(curTiw);
            //LsTAtts.Remove(curTiw);
            Imessage = "Annulee... Creation Personne";
        }
        else
        {
            curTiw = new Tiewel();
            Imessage = "Deja annule";
        }
        //added or included
        var ya1Tiw = LsTAtts.Where(t => t.Xadd1 == -1 || t.Xadd1 == -2).FirstOrDefault();
        if (ya1Tiw != null)
        { //Xadd1 est parti
            LsTAtts.Remove(ya1Tiw);
            ensTiws.Remove(ya1Tiw);
        } 
        AddingTiwRowGuid = Guid.Empty;
        sinwTiw = false;
        StateHasChanged();
    }
    private async Task CancelAddAfl()
    {
        if (curODContext.IsEntityTracked(curAfl))
        {
            curODContext.Detach(curAfl);
            //curTiw.Tiwafls.Remove(curAfl);
            Imessage = "Annulee... Creation Affilie";
        }
        else
        {
            curAfl = new Tiwafl();
            Imessage = "Deja annule";
        }
        //added or included
        var ya1Afl = curTiw.Tiwafls.Where(a => a.Xadd1 == -1 || a.Xadd1 == -2).FirstOrDefault();
        if (ya1Afl != null)
        { //curAfl.Xadd1 est parti
            curTiw.Tiwafls.Remove(ya1Afl);
        }
        int custp = Convert.ToInt16(curAfl.Tyafl);
        //AddStep[custp] = 0;
        AddingAflRowGuid = Guid.Empty;
        sinwAfl = false;
        StateHasChanged();
    }
    //EDITION/DELETE - Tiewel
    void BeginTiwEdit()
    {
        EditingTiwRowGuid = curTiw.Rowguid;
    }
    private void CancelTiwEdit()
    {
        // if (_originalTiwSnapshots.TryGetValue(curTiw.Rowguid, out var original))
        // {
        //     RestoreTiwValues(curTiw, original);
        //     _originalTiwSnapshots.Remove(curTiw.Rowguid);
        // }
        StateHasChanged();
        EditingTiwRowGuid = Guid.Empty;
    }
    private void PromptTiwDelete()
    {
        ConfirmingTiwDeleteRowGuid = curTiw.Rowguid;
    }
    private void CancelTiwDelete()
    {
        ConfirmingTiwDeleteRowGuid = Guid.Empty;
    }
    private void ConfirmTiwDelete()
    {
        var parent = curOrga;
        if (parent == null)
            return;
        Console.WriteLine($"del parent {parent.Raison} and row id : {parent.Idorg}");
        Tiewel svRow = curTiw;
        // For existing rows: mark for OData deletion and remove locally
        if (curODContext.IsEntityTracked(curTiw))
        {
            curODContext.DeleteObject(curTiw); // Mark for deletion in OData context
        }
        else
        {
            curODContext.Detach(curTiw); // Mark for deletion in OData context
        }
        //curOrga.Rubvars.ToList().RemoveAll(rf => rf.Idpln == svRow.Idpln);
        //curOrga.Plngens.Remove(svRow); // Remove from tracked collection
        EditingTiwRowGuid = Guid.Empty;
        ConfirmingTiwDeleteRowGuid = Guid.Empty;
        StateHasChanged(); // Notify UI about changes
    }
    private async Task DelTiwAsync(Tiewel mytiw)
    {
        Console.WriteLine("In Deleting");
        curTiw = mytiw;
    }
    //EDITION Tiwafl
    void BeginAflEdit(Tiwafl myafl)
    {
        EditingAflRowGuid = myafl.Rowguid;
    }
    void PromptAflEdit(Tiwafl myafl)
    {
        myafl.Xedt1 = 0;
        editingAfl = myafl;

        draftAfl = new Tiwafl();

        // List of property names to copy, e.g. from your available names
        var propertyNamesToCopy = new List<string>();
        foreach (var ucol in LsCols.Where(uv => uv.Totyp == Ugpe && uv.Tstyp == myafl.Tyafl && uv.Jacc == 1))
        {
            string propname = ucol.Scdrub + ",";
            propertyNamesToCopy.Add(ucol.Scdrub);
        }
        var type = typeof(Tiwafl);
        foreach (var propName in propertyNamesToCopy)
        {
            var prop = type.GetProperty(propName);
            if (prop != null && prop.CanRead && prop.CanWrite)
            {
                var value = prop.GetValue(myafl);
                prop.SetValue(draftAfl, value);
            }
        }
        //init edition
        myafl.Xedt1 = -1;
        EditingAflRowGuid = myafl.Rowguid;
    }
    void CancEdingAfl(Tiwafl myafl)
    {
        myafl.Xedt1 = 0;
        //isEdingMan = false;
        editingAfl = null;
        draftAfl = null;
        EditingAflRowGuid = Guid.Empty;
    }
    void ConfEdingAfl(Tiwafl myafl)
    {
        if (editingAfl != null)
        {
            // List of property names to copy, e.g. from your available names
            var propertyNamesToCopy = new List<string>();
            foreach (var ucol in LsCols.Where(uv => uv.Totyp == Ugpe && uv.Tstyp == myafl.Tyafl && uv.Jacc == 1))
            {
                string propname = ucol.Scdrub + ",";
                propertyNamesToCopy.Add(ucol.Scdrub);
            }
            var type = typeof(Tiwafl);

            // Assuming you want to copy the same set of property names as before,
            // or you can dynamically load those names as needed instead of hardcoding:

            foreach (var propName in propertyNamesToCopy)
            {
                var prop = type.GetProperty(propName);
                if (prop != null && prop.CanRead && prop.CanWrite)
                {
                    var value = prop.GetValue(myafl);
                    prop.SetValue(editingAfl, value);
                }
            }

            // Now attach or update in context as you do:
            if (!curODContext.GetAllTrackedEntities().Any(e => e.Entity == editingAfl))
                curODContext.AttachTo("Tiwafls", editingAfl);

            curODContext.UpdateObject(editingAfl);
        }

        myafl.Xedt1 = 0;
        editingAfl = null;
        EditingAflRowGuid = Guid.Empty;
    }
    //DELETING AFL
    private void PromptAflDelete(Tiwafl item)
    {
        ConfirmingAflDeleteRowGuid = item.Rowguid;
    }
    private void CancelAflDelete()
    {
        ConfirmingAflDeleteRowGuid = Guid.Empty;
    }
    private void ConfirmAflDelete(Tiwafl row)
    {
        var parent = curTiw;
        Console.WriteLine($"Parent may be found : {parent.Id}");
        if (parent == null)
            return;
        Console.WriteLine($"del parent {parent.Nom} and row id : {parent.Id}");
        Tiwafl svRow = row;
        // For existing rows: mark for OData deletion and remove locally
        if (curODContext.IsEntityTracked(row))
        {
            curODContext.DeleteObject(row); // Mark for deletion in OData context
        }
        else
        {
            curODContext.Detach(row); // Mark for deletion in OData context
        }
        curTiw.Tiwafls.ToList().RemoveAll(rf => rf.Itie == svRow.Itie);
        curTiw.Tiwafls.Remove(svRow);
        EditingAflRowGuid = Guid.Empty;
        ConfirmingAflDeleteRowGuid = Guid.Empty;
        StateHasChanged(); // Notify UI about changes
    }
    private async Task OuvrirFiche(int orig)
    {
        isRecptVisible = false;
        if (orig == 1)
        { //recepisse
            isRecptVisible = true;
        }
        //stopenFich = "OuvrirRecepisse";
        //isFicheVisible = true;
        // isFicheVisible = !isFicheVisible;
        // if (isFicheVisible)
        // {
        //     stopenFich = "FermerRecepisse";
        // }
        // else
        // {
        //     stopenFich = "OuvrirRecepisse";
        // }
    }
    private async Task ValidTiwAsync()
    {
        //await _twentityManager.SaveChanges();
    }
    private void HandleValidSubmit()
    {
        Console.WriteLine("Form submitted successfully!");
    }
    private void OnTiwChanged(EventArgs args)
    {
        var chgeEventArgs = (ChangeEventArgs)args;
        var selno = Convert.ToInt16(chgeEventArgs.Value.ToString());
        if (selno > 0)
        {
            curTiw = LsTAtts.Where(tiw => tiw.Id == selno).FirstOrDefault();
        }
    }
    private void OnTAccAll(ChangeEventArgs e, int origchk)
    {
        bool isChecked = (bool)e.Value;
        if (origchk == 1)
        {
            IsGlobalT1Checked = isChecked; // Update the bound value manually
        } else if (origchk == 2) 
        {
            IsGlobalT2Checked = isChecked; // Update the bound value manually
        } else if (origchk == 3)
        {
            IsGlobalT3Checked = isChecked; // Update the bound value manually
        }
        foreach (var tw in ensTiws)
        {
            if (origchk == 1)
            {
                //tw.Ivalid = isChecked ? 9 : 0;
                tw.Jacc = isChecked ? 1 : 0;
            } else
            if (origchk == 2)
            {
                //tw.Ivalid = isChecked ? 9 : 0;
                tw.Jrej = isChecked ? 1 : 0;
            }
            else
            if (origchk == 3)
            {
                //tw.Ivalid = isChecked ? 9 : 0;
                tw.Jnot = isChecked ? 1 : 0;
            }
            Console.WriteLine($"Global Valid  / {tw.Jacc} / {tw.Jrej} / {tw.Jnot}");
        }
        StateHasChanged();
    }
    
    private void ShowModal()
    {
        // Optionally, set the current entity to edit
        //currentEntity = new YourEntityType { Name = "Sample Name", Description = "Sample Description" }; // Example initialization
        //_mdcTiwel = curTiwel;
        Console.WriteLine($"ShowModal appele");
        isModalVisible = true;
    }

    private Task OnModalVisibilityChanged(bool isVisible)
    {
        isModalVisible = isVisible;
        return Task.CompletedTask;
    }
    private Task HandleSave(Tiewel entity)
    {
        // Handle modal entity save
        // For example, save to the database or update the UI
        Console.WriteLine($"Entity saved: {entity.Nom}, {entity.Pnom}");
        return Task.CompletedTask;
    }

    private async Task<bool> IsTiwValid(Tiewel mytiw)
    {
        //verification saisie
        errors = false;
        errorList = new List<string>();
        if (String.IsNullOrEmpty(mytiw.Nom))
        {
            errors = true;
            errorList.Add("Echec, Nom obligatoire.");
            return false;
        }
        if (String.IsNullOrEmpty(mytiw.Pnom))
        {
            errors = true;
            errorList.Add("Echec, Prenom(s) obligatoire.");
            return false;
        }
        // if (mytiw.Sexe == "0")
        // {
        //     errors = true;
        //     errorList.Add("Echec, Sexe obligatoire.");
        //     return false;
        // }
        // if (mytiw.Sitmat == 0)
        // {
        //     errors = true;
        //     errorList.Add("Echec, Sit.matrimon. obligatoire.");
        //     return false;
        // }
        // if (mytiw.Respon == 0)
        // {
        //     errors = true;
        //     errorList.Add("Echec, Responsabilite obligatoire.");
        //     return false;
        // }
        if (String.IsNullOrEmpty(mytiw.Email))
        {
            strmeta = mytiw.Email;
            errors = true;
            errorList.Add("Echec, Email obligatoire.");
            return false;
        }
        // if (Siphone == 1)
        // { //telephone obligatoire
        //     if (String.IsNullOrEmpty(mytiw.Usrphone))
        //     {
        //         errors = true;
        //         errorList.Add("Echec, Telephone obligatoire.");
        //         return false;
        //     }
        // }
        return true;
    }
    //manage SAVING
    public async Task EdtAll()
    {
        allEnable = true;
        //myacfl.EdtAll();        
        isTiwInEditing = false;
    }
    public async Task CncCHILD()
    { //reload
        isTiwInEditing = false;
        //ChildADDING = false;
        //ChildUPDING = false;
    }
    private async Task<bool> IsAflValid(Tiwafl mytiw)
    {
        //verification saisie
        errors = false;
        errorList = new List<string>();
        if (String.IsNullOrEmpty(mytiw.Nom))
        {
            errors = true;
            errorList.Add("Echec, Nom obligatoire.");
            return false;
        }
        if (String.IsNullOrEmpty(mytiw.Pnom))
        {
            errors = true;
            errorList.Add("Echec, Prenom(s) obligatoire.");
            return false;
        }
        // if (mytiw.Sexe == "0")
        // {
        //     errors = true;
        //     errorList.Add("Echec, Sexe obligatoire.");
        //     return false;
        // }
        // if (mytiw.Sitmat == 0)
        // {
        //     errors = true;
        //     errorList.Add("Echec, Sit.matrimon. obligatoire.");
        //     return false;
        // }
        // if (mytiw.Respon == 0)
        // {
        //     errors = true;
        //     errorList.Add("Echec, Responsabilite obligatoire.");
        //     return false;
        // }
        if (String.IsNullOrEmpty(mytiw.Usremail))
        {
            strmeta = mytiw.Usremail;
            errors = true;
            errorList.Add("Echec, Email obligatoire.");
            return false;
        }
        // if (Siphone == 1)
        // { //telephone obligatoire
        //     if (String.IsNullOrEmpty(mytiw.Usrphone))
        //     {
        //         errors = true;
        //         errorList.Add("Echec, Telephone obligatoire.");
        //         return false;
        //     }
        // }
        return true;
    }
    // public async Task SavAll()
    // {
    //     if (isTiwInEditing)
    //     {
    //         curODContext.UpdateObject<Tiewel>(curTiw);
    //         await curODContext.SaveDataAsync();
    //         isTiwInEditing = false;
    //     }
    //     allEnable = false;
    // }
    private void HandleFieldChanged(object sender, FieldChangedEventArgs e)
    {
        //ChildUPDING = true;
        if (!isTiwInEditing) isTiwInEditing = true;
        Console.WriteLine($"Field edited: {e.FieldIdentifier.FieldName}");
        // Place your logic here when a field is edited
    }
    private void OnLocationChanged(object sender, LocationChangedEventArgs e)
    {
        allEnable = false;
        SaveCurEntities();
    }
    public async Task<bool> SaveCurEntities()
    {
        try
        {
            //if (isTiwInEditing || myacfl.isTwAflEditing)
            if (isTiwInEditing)
            {
                //curODContext.UpdateObject<Tiewel>(curTiw);
                await curODContext.SaveDataAsync();
                isTiwInEditing = false;
                Console.WriteLine("Saved SUCCESS");
            }
            //var wrkplns = curOrga.Plngens.Where(pl => pl.Ptyp == 3 && pl.Totyp == IMyAtr).ToList();
            //MyDaPlans = wrkplns;
            StateHasChanged();
            return true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Saved ISSUE {ex.Message}");
            //Alert($"ECHEC Entities not SAVED");
            return false;
        }
    }
 
    private void ResetEditContext(Tiewel model)
    {
        // Dispose old handlers before replacing
        if (edTiwContext != null)
        {
            edTiwContext.OnFieldChanged -= HandleFieldChanged;
        }

        edTiwContext = new EditContext(model);
        edTiwContext.OnFieldChanged += HandleFieldChanged;
    }
    public void Dispose()
    {
        if (edTiwContext != null)
        {
            edTiwContext.OnFieldChanged -= HandleFieldChanged;
        }

        _navmanager.LocationChanged -= OnLocationChanged;
    }
}