@page "/enroltiw"
@* @implements IDisposable *@
@layout EnrolMenu

@using System
@using System.ComponentModel.DataAnnotations
@using System.Dynamic
@using System.Net.Http.Headers
@using System.Reflection
@using System.Text
@using System.Text.Json
@using System.Web
@using BlazorBootstrap
@using GxShared.Sess
@using GxShared.Others
@using GxTie.ClieModels
@using GxTie.Services
@using GxTie.Components.Paccu.RtPer
@* @using GxTie.Services.Mform *@
@using GxWapi.DaModels
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Rendering
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.OData.Client
@using Newtonsoft.Json

@inject NavigationManager _navmanager
@inject HttpClientService _cliemanager
<!-- InscTiewComponent.razor -->
<PageTitle>RECEPTION</PageTitle>
@* <h3>Formulaire INSCRIPTION</h3> *@ 
@* <div>
    @strmeta
</div>  *@
<div>
    @Imessage
</div>
@if (isLoading)
{
    <Progress class="progress mb-3">
        <ProgressBar Width="100" Label="Persos/Accueil Loading..." Type="ProgressType.StripedAndAnimated" Color="ProgressColor.Primary" />
    </Progress>
}
<!--downmodal-->
@if (curTiw != null && isModalVisible == true)
{
    <GlobModal IsVisible="@isModalVisible"
               IsVisibleChanged="@OnModalVisibilityChanged"
               Title="Chargement des documents"
               EntyTiw="@curTiw"
               EntyTie="null"
               LsmVars="@LsVars"
               LsmFixes="@LsFixes"
               OnTiwSave="@HandleSave"
               Oparent="2">
    </GlobModal>
}
<div class="d-flex flex-column">
    <div class="container row">
        <div class="d-flex flex-column">
            @if (success)
            {
                <div class="alert alert-success">@successmsg</div>
            }
            @if (errors)
            {
                foreach (var error in errorList)
                {
                    <div class="alert alert-danger">@error</div>
                }
            }
            @if (yainfo)
            {
                <div class="alert alert-info">
                    @infomess
                </div>
            }
        </div>
    </div>
    <div class="my-container">
        @if (toChild != null)
        {
            @ChildContent
        }
    </div> 
    <AuthorizeView>
        <Authorized Context="authContext">
            @if (isLoading)
            {
                <p>Loading...</p>
            }
            else
            {
                <Tabs @bind-ActiveTabIndex="activeTabIndex" EnableFadeEffect="true">
                    <Tab Title="Candidature">
                        <Content>
                            <div class="card">
                                <div class="card-header">
                                    <div class="form-group">
                                        @if (allEnable)
                                        {
                                            @if (!isTiwAdding && !isTiwEdding && !isTiwDeling)
                                            { //
                                              <button class="btn btn-primary btn-sm" @onclick="() => PrepareAddTiw()">
                                                  ➕ Add
                                              </button>
                                              <span>&nbsp;&nbsp;</span>
                                            }
                                            @if (isTiwAdding)
                                            { //sinwTiw && curTiw.Xadd1 == -1
                                              <span>&nbsp;&nbsp;</span>
                                              <button class="btn btn-sm btn-success" @onclick="() => IncludeTiw(curTiw)">
                                                  <span class="me-1">💾</span> Inclure
                                              </button>
                                              <span>&nbsp;&nbsp;</span>
                                              <button class="btn btn-sm btn-secondary" @onclick="() => CancelTiwAdding()">
                                                  ❎ Annuler
                                              </button>
                                            }
                                           
                                            @if (curTiw != null && !isTiwAdding && !isTiwEdding && !isTiwDeling)
                                            {//curTiw.Xadd1 != -2
                                             <button class="btn btn-sm btn-warning me-1"
                                                     @onclick="() => BeginTiwEdit()">
                                                 ✏️ Edit
                                             </button>
                                             <button class="btn btn-sm btn-danger"
                                                     @onclick="() => PromptTiwDeling()">
                                                 🗑️ Delete
                                             </button>
                                            }
                                            @if (isTiwEdding)
                                            {
                                                <button class="btn btn-sm btn-success" @onclick="() => ConfirmTiwEdding()">
                                                    ✅ Confirm
                                                </button>
                                                <button class="btn btn-sm btn-secondary" @onclick="CancelTiwEdding">
                                                    ❌ Cancel
                                                </button>
                                            }
                                            @if (isTiwDeling)
                                            {
                                                <button class="btn btn-sm btn-success" @onclick="() => ConfirmTiwDeling()">
                                                    ✅ Confirm
                                                </button>
                                                <button class="btn btn-sm btn-secondary" @onclick="CancelTiwDeling">
                                                    ❌ Cancel
                                                </button>
                                            }
                                            @if (isTiwAdding || isTiwEdding)
                                            {
                                                <span>&nbsp;&nbsp;</span>
                                                <button type="button" class="btn btn-lnk btn-sm btn-info bg-opacity-50" @onclick="ShowModal">piece(s)</button>
                                            }
                                        }
                                    </div>
                                </div>
                                <div class="card-body @(isTiwDisabled ? "disabled-div" : "")">
                                    @foreach (var kvp in visibleJaccFields)
                                    {
                                        var prop = typeof(Tiewel).GetProperty(kvp.Key);
                                        if (prop == null) continue;
                                        <div class="row mb-2" @key="kvp.Key">
                                            <label class="col-sm-2 col-form-label">
                                                @FieldLabels.GetValueOrDefault(kvp.Key, kvp.Key)
                                            </label>
                                            <div class="col-sm-5">
                                                @if (_tiewelLookups.TryGetValue(kvp.Key, out var lookupItems))
                                                {
                                                    <select class="form-select"
                                                            value="@StringProps.GetValueOrDefault(kvp.Key, "")"
                                                            @onchange="@((e) => StringProps[kvp.Key] = e.Value?.ToString() ?? "")">
                                                        <option value="">-- Select --</option>
                                                        @foreach (var item in lookupItems)
                                                        {
                                                            <option value="@item.Value">@item.Text</option>
                                                        }
                                                    </select>
                                                }
                                                else if (IntProps.TryGetValue(kvp.Key, out var intValue))
                                                {
                                                    <input type="number" class="form-control"
                                                           value="@(intValue?.ToString() ?? "")"
                                                           @onchange="@((e) => IntProps[kvp.Key] = _lookupService.ParseInt(e.Value?.ToString()))" />
                                                }
                                                else
                                                {
                                                    <input class="form-control"
                                                           value="@StringProps.GetValueOrDefault(kvp.Key, "")"
                                                           @onchange="@((e) => StringProps[kvp.Key] = e.Value?.ToString() ?? "")" />
                                                }
                                            </div>
                                        </div>
                                    }
                                    @* <div class="row mt-4">
                                        <div class="col-12">
                                            <button @onclick="HandleSubmit" class="btn btn-primary">Save Tiewel</button>
                                            <button @onclick="Cancel" class="btn btn-secondary ms-2">Cancel</button>
                                        </div>
                                    </div> *@
                                </div>
                            </div>
                        </Content>
                    </Tab>
                    <Tab Title="Details">
                        <Content>
                            @if (Ugpe != 0 && curTiw != null)
                            {
                                <!--Ityp(exist?)-->
                                var eligibleUfls = TUafls.Where(ufl => ufl.Ityp == 1 && ufl.Etyp != 1 && ufl.Etyp != 0).ToList();
                                <div class="card">
                                    <div class="card-header">
                                        @* @if (curOrga != null && curTiw != null && curAfl != null && toChild != null && Ugpe != 0 && _tiwaflLookups.Any())
                                        {
                                            <span>Utyp : {@curTiw.Utyp} Jwlc {@curTiw.Jwlc}</span>
                                            if (curTiw.Utyp != 0)
                                            {
                                                <!--pour chqe existant dans table //Etp <-> tab// -->
                                                <div class="form-group">
                                                    @if (!isAflAdding && (curTiw.Jwlc == 1 || curTiw.Jwlc == 2))
                                                    { //allEnable && AddStep[ufl.Etyp] != -1
                                                      <button class="btn btn-primary btn-sm" @onclick="() => PrepareAddAfl(curTiw)">
                                                          ➕ Add
                                                      </button>
                                                      <span>&nbsp;&nbsp;</span>
                                                    }
                                                    @if (isAflAdding)
                                                    { //allEnable && sinwAfl && AddStep[ufl.Etyp] == -1
                                                      <button class="btn btn-sm btn-success" @onclick="() => IncludeAfl(curAfl)">
                                                          <span class="me-1">💾</span> Inclure
                                                      </button>
                                                      <span>&nbsp;&nbsp;</span>
                                                      <button class="btn btn-sm btn-secondary" @onclick="() => CancelAflAdding()">
                                                          ❎ Annuler
                                                      </button>
                                                    }
                                                </div>
                                            }
                                        } *@
                                    </div>
                                    <div class="card-body">
                                        <Tabs @bind-ActiveTabIndex="activeTabIndex" EnableFadeEffect="true">
                                            @foreach (var ufl in eligibleUfls)
                                            {
                                                var jsliba = ufl.Sliba + (ufl.Elea == 1 ? "(es)" : "(s)");
                                                curAfl = curTiw.Tiwafls.FirstOrDefault(); @* af => af. == ufl.Id); *@
                                                @if (curOrga != null && curTiw != null && ufl != null && toChild != null && Ugpe != 0 && _tiwaflLookups.Any())
                                                {
                                                    <span>Utyp : {@curTiw.Utyp} Jwlc {@curTiw.Jwlc}</span>
                                                    if (curTiw.Utyp != 0)
                                                    {
                                                        <!--pour chqe existant dans table //Etp <-> tab// -->
                                                        <div class="form-group">
                                                            @if (!isAflAdding && (curTiw.Jwlc == 1 || curTiw.Jwlc == 2))
                                                            { //allEnable && AddStep[ufl.Etyp] != -1
                                                                <button class="btn btn-primary btn-sm" @onclick="() => PrepareAddAfl(curTiw, ufl.Ityp)">
                                                                    ➕ Add
                                                                </button>
                                                                <span>&nbsp;&nbsp;</span>
                                                            }
                                                            @if (isAflAdding)
                                                            { //allEnable && sinwAfl && AddStep[ufl.Etyp] == -1
                                                                <button class="btn btn-sm btn-success" @onclick="() => IncludeAfl(curAfl)">
                                                                    <span class="me-1">💾</span> Inclure
                                                                </button>
                                                                <span>&nbsp;&nbsp;</span>
                                                                <button class="btn btn-sm btn-secondary" @onclick="() => CancelAflAdding()">
                                                                    ❎ Annuler
                                                                </button>
                                                            }
                                                        </div>
                                                    }
                                                }
                                                <Tab Title="@jsliba">
                                                    <Content>
                                                        @foreach (var kvp in visibleJaccFields)
                                                        {
                                                            var prop = typeof(Tiwafl).GetProperty(kvp.Key);
                                                            if (prop == null) continue;
                                                            <div class="row mb-2" @key="kvp.Key">
                                                            <label class="col-sm-2 col-form-label">
                                                                @FieldLabels.GetValueOrDefault(kvp.Key, kvp.Key)
                                                            </label>
                                                            <div class="col-sm-5">
                                                                @if (_tiwaflLookups.TryGetValue(kvp.Key, out var lookupItems))
                                                                {
                                                                    <select class="form-select"
                                                                            value="@StringProps.GetValueOrDefault(kvp.Key, "")"
                                                                            @onchange="@((e) => StringProps[kvp.Key] = e.Value?.ToString() ?? "")">
                                                                        <option value="">-- Select --</option>
                                                                        @foreach (var item in lookupItems)
                                                                        {
                                                                            <option value="@item.Value">@item.Text</option>
                                                                        }
                                                                    </select>
                                                                }
                                                                else if (IntProps.TryGetValue(kvp.Key, out var intValue))
                                                                {
                                                                    <input type="number" class="form-control"
                                                                           value="@(intValue?.ToString() ?? "")"
                                                                           @onchange="@((e) => IntProps[kvp.Key] = _lookupService.ParseInt(e.Value?.ToString()))" />
                                                                }
                                                                else
                                                                {
                                                                    <input class="form-control"
                                                                           value="@StringProps.GetValueOrDefault(kvp.Key, "")"
                                                                           @onchange="@((e) => StringProps[kvp.Key] = e.Value?.ToString() ?? "")" />
                                                                }
                                                            </div>
                                                        </div>
                                                        }
                                                    </Content>
                                                </Tab>
                                            }
                                        </Tabs>
                                    </div>
                                </div>
                            }
                        </Content>
                    </Tab>
                    <Tab Title="Verification">
                        <Content>
                            <div class="row tab-pane fade" id="nav-verfs" role="tabpanel" aria-labelledby="vrf">
                                <div style="max-height: 300px; overflow-y: auto;">
                                    <Grid TItem="Tiewel"
                                          Data="@ensTiws.Where(t=>t.Jwlc < 4)"
                                          AllowRowClick="true"
                                          OnRowClick="OnTiwRowClick"
                                          AllowPaging="true"
                                          Responsive="true">
                                        <GridColumns>
                                            <GridColumn TItem="Tiewel" HeaderText="Accord?">
                                                <HeaderContent>
                                                    <label>Verf?</label>
                                                    <InputCheckbox Value="@IsGlobalT1Checked"
                                                                   ValueChanged="(bool val) => OnTAccAll(new ChangeEventArgs { Value = val }, 1)"
                                                                   ValueExpression="@(() => IsGlobalT1Checked)"
                                                                   class="form-check-input"
                                                                   disabled="@(!allEnable)">
                                                    </InputCheckbox>
                                                </HeaderContent>
                                                <ChildContent Context="item">
                                                    <div @key="item.Rowguid"></div>
                                                    <InputCheckbox @bind-Value="item.IsJaccChecked"
                                                                   @onchange="e => { item.Jacc = (bool)e.Value ? 1 : 0; }"
                                                                   class="form-check-input"
                                                                   disabled="@(!allEnable)">
                                                    </InputCheckbox>
                                                </ChildContent>
                                            </GridColumn>
                                            <GridColumn TItem="Tiewel" HeaderText="Rejet?">
                                                <HeaderContent>
                                                    <label>Rjt?</label>
                                                    <InputCheckbox Value="@IsGlobalT2Checked"
                                                                   ValueChanged="(bool val) => OnTAccAll(new ChangeEventArgs { Value = val }, 2)"
                                                                   ValueExpression="@(() => IsGlobalT2Checked)"
                                                                   class="form-check-input"
                                                                   disabled="@(!allEnable)">
                                                    </InputCheckbox>
                                                </HeaderContent>
                                                <ChildContent Context="item">
                                                    <InputCheckbox @bind-Value="item.IsJrejChecked"
                                                                   @onchange="e => { item.Jrej = (bool)e.Value ? 1 : 0; }"
                                                                   class="form-check-input"
                                                                   disabled="@(!allEnable)">
                                                    </InputCheckbox>
                                                </ChildContent>
                                            </GridColumn>
                                            <GridColumn TItem="Tiewel" HeaderText="Notif?">
                                                <HeaderContent>
                                                    <label>Ntf?</label>
                                                    <InputCheckbox Value="@IsGlobalT3Checked"
                                                                   ValueChanged="(bool val) => OnTAccAll(new ChangeEventArgs { Value = val }, 3)"
                                                                   ValueExpression="@(() => IsGlobalT3Checked)"
                                                                   class="form-check-input"
                                                                   disabled="@(!allEnable)">
                                                    </InputCheckbox>
                                                </HeaderContent>
                                                <ChildContent Context="item">
                                                    <InputCheckbox @bind-Value="item.IsJnotChecked"
                                                                   @onchange="e => { item.Jrej = (bool)e.Value ? 1 : 0; }"
                                                                   class="form-check-input"
                                                                   disabled="@(!allEnable)">
                                                    </InputCheckbox>
                                                </ChildContent>
                                            </GridColumn>
                                            <GridColumn TItem="Tiewel" HeaderText="Dossier">
                                                <ChildContent Context="item">
                                                    @item.Xmatri
                                                </ChildContent>
                                            </GridColumn>
                                            <GridColumn TItem="Tiewel" HeaderText="Nom">
                                                <ChildContent Context="item">
                                                    @item.Nom
                                                </ChildContent>
                                            </GridColumn>
                                            <GridColumn TItem="Tiewel" HeaderText="Pnom">
                                                <ChildContent Context="item">
                                                    @item.Pnom
                                                </ChildContent>
                                            </GridColumn>
                                            <GridColumn TItem="Tiewel" HeaderText="Actions">
                                                <HeaderContent>
                                                    <!-- Accepter-->
                                                    <!-- Rejeter-->
                                                    <!-- Notifier-->
                                                </HeaderContent>
                                                <ChildContent Context="item">
                                                    @if (!(curODContext.GetEntityState(item) == EntityStates.Added))
                                                    {
                                                        @if (curODContext.GetEntityState(item) == EntityStates.Modified)
                                                        {
                                                            <span>&nbsp;&nbsp;</span>
                                                        }
                                                    }
                                                </ChildContent>
                                            </GridColumn>
                                            <GridColumn TItem="Tiewel" HeaderText="Actions">
                                                <ChildContent Context="item">
                                                    <div class="col-2">
                                                        <button class="btn btn-warning btn-sm" @onclick="() => OuvrirFiche(1)">Recepisse</button>
                                                    </div>
                                                </ChildContent>
                                            </GridColumn>
                                        </GridColumns>
                                        <GridEmptyDataTemplate TItem="Tiewel">
                                            @* <div class="text-center p-3">
                                                        <p>No records available.</p>
                                                        <button class="btn btn-primary" @onclick="() => InitializeData()">
                                                                Initialize Data
                                                        </button>
                                                    </div> *@
                                        </GridEmptyDataTemplate>
                                    </Grid>
                                </div>
                            </div>
                        </Content>
                    </Tab>
                </Tabs>
                @if (isRecptVisible)
                {
                    <div class="row">
                        <RtW11Fic @ref="myftiw"
                                  curOrga="@curOrga"
                                  toChild="@toChild"
                                  curODContext="@curODContext"
                                  curTiw="@rselTiw">
                            <ChildContent>
                                @* <h2 class="child-box">Fiche d'Inscription</h2> *@
                            </ChildContent>
                        </RtW11Fic>
                    </div>
                }
            }
        </Authorized>
        <NotAuthorized>
            <p>Access denied. Please log in.</p>
        </NotAuthorized>
    </AuthorizeView>
</div>

<style>
    .inputfl {
        opacity: 0;
        width: 0.1;
        height: 0.1;
        position: absolute;
    }

    .disabled {
        pointer-events: none; /* Prevents clicking */
        opacity: 0.5; /*visual cue for disabled state */
    }
    .disabled-div {
        pointer-events: none;
        opacity: 0.65;
        cursor: not-allowed;
    }

    .gpe-select {
        font-size: 24px;
        font-weight: bold;
    }

        .gpe-select option {
            font-size: 18px;
            font-weight: bold;
        }

    .my-container {
        background-color: yellow;
    }

    .maxh-400 {
        max-height: 400px;
        overflow-y: auto;
    }

    .disabled-action {
        pointer-events: none;
        opacity: 0.5;
    }

    .grid-container {
        display: grid;
        grid-template-columns: max-content minmax(max-content, auto);
        gap: 8px 16px;
    }

    .grid-row {
        display: contents; /* makes children participate directly in the grid */
    }

    .grid-container label {
        grid-column: 1;
        font-weight: bold;
        white-space: nowrap;  /* prevent label wrap */
    }

    .grid-container > div {
        grid-column: 2;
    }

    .standard-width {
        width: 200px; /* or any fixed width like 150px, 100%, etc */
        max-width: 100%;
    }

    .fs-xs {
        font-size: 0.65rem;
    }
</style>

@code {
    private bool isLoading = true;

    private bool isRecptVisible = false;
    // private AccuAfil myafl;
    private string Imessage = "", Jmessage = "";

    [Parameter]
    public RenderFragment ChildContent { get; set; }
    [Parameter]
    public MyODataContext curODContext { get; set; }
    [Parameter]
    public Gxorga curOrga { get; set; }
    [Parameter]
    public MyShareVars toChild { get; set; }
    [Parameter]
    public int? Tgpe { get; set; }
    [Parameter]
    public int? Ugpe { get; set; }
    [Parameter] 
    public int Id { get; set; }
    [Parameter]
    public bool allEnable { get; set; }
    [Parameter]
    public int toMenu { get; set; }
    //guard
    [Parameter]
    public PendingChangesGuard _guard { get; set; }
    [Parameter]
    public EventCallback<PendingState> OnPendingStateChanged { get; set; }
    [Parameter]
    public int NbChanges { get; set; }
    [Parameter]
    public EventCallback<int> NbChangesChanged { get; set; }  // 🔥 CRITICAL
    //[Parameter] 
    //public EventCallback<int> OnEdit { get; set; }
    [Parameter]
    public EventCallback<Tiewel> OnSaved { get; set; }

    //tiers non integrer, non rejeter et non accepter
    public List<Tiewel> ensTiws = new();

    private List<Gpdivh> _lsDivs = new List<Gpdivh>();
    private List<Divpst> _lsPsts => _lsDivs.Where(dv => dv.Ihie == curTiw.Idhie).SelectMany(dp => dp.Divpsts).ToList();

    private RtW11Fic myftiw { get; set; }

    public string Title { get; set; }
    public List<Gpvar> TUafls = new();
    public List<Tiwafl> Dasafls = new();
    string gpeLiba = "";
    private int chxTab = 0;
    private Tiewel? curTiw = new();

    [Parameter] 
    public Tiewel Model { get; set; } = default!;
    private Tiwafl? curAfl = new();
    private Tiewel? rselTiw = new();
    private bool sinwTiw = false, sinwAfl = false;
    private int _lgcdu = 0;
    private bool IsGlobalT1Checked { get; set;} = false;
    private bool IsGlobalT2Checked { get; set; } = false;
    private bool IsGlobalT3Checked { get; set; } = false;

    public List<Gpfixe> LsFixes { get; set; }
    public List<Gpfixe> LsTgpes { get; set; }
    public List<Gpvar> LsVars { get; set; }
    public List<Gsglne> LsCols = new();
    public List<Gsglne> TbElems = new();
    //liste attente de save
    private List<Tiewel> LsTAtts = new List<Tiewel>();
    private UsrMail _usrMail = new UsrMail();

    private bool success, errors, yaEnreg = false, yainfo = false;
    private string successmsg = "", infomess = "", searchstr = "", strPoint = "";
    private List<string> errorList = new List<string>();
    private ProgressBar progressBar;
    private string strmeta = "";
    private bool chkAll { get; set; }
    // Operation VUE
    [Parameter]
    public bool ParentOK { get; set; }
    [Parameter]
    public bool ParentEDT { get; set; }

    private Guid? AddingTiwRowGuid = Guid.Empty;
    private Guid? EditingTiwRowGuid = Guid.Empty;
    private Guid? ConfirmingTiwDeleteRowGuid = Guid.Empty;
    private Guid? AddingAflRowGuid = Guid.Empty; //pmodal
    private Guid? EditingAflRowGuid = Guid.Empty;
    private Guid? ConfirmingAflDeleteRowGuid = Guid.Empty;

    //private bool AddVue => ParentOK && ParentEDT;
    private bool isTiwDisabled => !(isTiwAdding || isTiwEdding);
    private bool isTiwAdding = false, isTiwEdding = false, isTiwDeling;

    private bool isAflAdding = false, isAflEdding = false, isAflDeling = false;
    //private bool IncludeVue => AddVue && AddingTiwRowGuid != Guid.Empty;
    private bool ValiderVue => (EditingTiwRowGuid != Guid.Empty || ConfirmingTiwDeleteRowGuid != Guid.Empty);
    //private bool EdtDelVue => !IncludeVue || !ValiderVue;
    //private bool EdtDelDisable => curTiw == null || !ParentEDT;
    //rubriques Afl
    //private bool AddRubVue => curTiw != null && Addvue;
    //private bool IncludeRubVue => AddRubVue && AddingAflRowGuid != Guid.Empty;
    //private bool ValiderRubVue => (EditingAflRowGuid != Guid.Empty || ConfirmingAflDeleteRowGuid != Guid.Empty);
    //private bool EdtDelRubVue => !IncludeRubVue || !ValiderRubVue;
    private bool EdtDelRubDisable => curAfl == null || !ParentEDT;
    //private bool isDisabled = true;
    //private string DisabledClass => !EdtDelVue ? "disabled" : "";

    //modals
    private bool isModalVisible = false;

    //pere-editing/adding/deleting
    private bool noData = false;
    private bool isTiwInEditing = false;

    private bool IsTiwAdding(Tiewel item) => AddingTiwRowGuid == item.Rowguid;
    private bool IsTiwEditing(Tiewel item) => EditingTiwRowGuid == item.Rowguid;


    private int activeTabIndex { get; set; } = 0;


    //private bool IsAflAdding(Tiwafl item) => AddingAflRowGuid == item.Rowguid;
    //private bool IsAflEditing(Tiwafl item) => EditingAflRowGuid == item.Rowguid;

    Tiwafl draftAfl = new();
    Tiwafl? editingAfl = null;
    private LookupService _lookupService;
    private Dictionary<string, List<LookupItem>> _tiewelLookups = new();
    private Dictionary<string, List<LookupItem>> _tiwaflLookups = new();

    private Dictionary<string, bool> visibleJaccFields = new();
    private Dictionary<string, string> FieldLabels = new();  // ✅ New!
    private Dictionary<string, string> TieLabels { get; set; } = new();
    private Dictionary<string, string> StringProps { get; set; } = new();
    private Dictionary<string, int?> IntProps { get; set; } = new();
    private Dictionary<string, decimal?> DecimalProps { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        if (Ugpe == 0)
        {
            Imessage = "Groupe Obligatoire";
            return;
        }
        //transmis par 2
        LsVars = toChild.LsVars;
        //Ityp=1exist/Itb=6ou7/Totyp=1cible2operat3client....
        TUafls = LsVars.Where(tu => tu.Gvars == 3 && tu.Itb == 6 && tu.Totyp == Ugpe && tu.Ityp == 1).ToList();
        //Console.WriteLine($"TUafls {TUafls.Count} // {Ugpe}");
        LsFixes = toChild.LsFixes;
        //LsPlans = toChild.LsPlans.Where(pl => pl.Ptyp == 4).ToList();
        LsCols = toChild.LsCols;
        TbElems = toChild.TbElems;
        _lgcdu = 3;
        var noslims = LsVars.Where(uv => uv.Idhie == 0 && uv.Gvars == 21 && uv.Itb == 1 && uv.Elea == 1);
        if (noslims.Any()) _lgcdu = noslims.FirstOrDefault().Ivala;

        _lsDivs = toChild.LsDivs.Where(uh => uh.Sidiv == 1).ToList();

        // Load ALL gsglne for this organization (single query!)
        var allCols = curOrga.Gsglnes.Where(g => g.Otyp == 5).ToList();
        var tblitems = curOrga.Gsglnes.Where(g => g.Otyp == 4).ToList();
        Console.WriteLine($"nb cols {allCols}"); 
        _lookupService = new LookupService(allCols, tblitems);  // ✅ Direct constructor
        _tiewelLookups = await _lookupService.GetTiewelLookupsAsync(curOrga.Idorg);
        _tiwaflLookups = await _lookupService.GetTiwaflLookupsAsync(curOrga.Idorg);

        LsTgpes = LsFixes.Where(iv => iv.Gvars == 53 && iv.Itb == 2 && iv.Elea != 0).ToList(); //cible/operat...
        // = "Gpe//" + Ugpe.ToString();
        ensTiws = curOrga.Tiewels.Where(t => t.Jwlc < 4).ToList();
        curTiw = ensTiws.FirstOrDefault();
        curTiw ??= new Tiewel();
        if (curTiw != null)
        {
            Dasafls = curTiw.Tiwafls.ToList();
        }
        _tiewelLookups = await _lookupService.GetTiewelLookupsAsync(curOrga.Idorg);
        visibleJaccFields = _lookupService.GetVisibleFields(curOrga.Idorg);
        //var visibleJacc1 = _lookupService.GetFieldsByJacc(curOrga.Idorg, 1);
        Console.WriteLine($"Charge : {visibleJaccFields.Count}");
        // 🔥 ONE LINE MAGIC
        var (str, ints, decs, labels) = _lookupService.InitializeAllPropsWithLabels(
            curOrga.Idorg, typeof(Tiewel), curTiw, visibleJaccFields.Keys);
        StringProps = str;
        IntProps = ints;
        DecimalProps = decs;
        FieldLabels = labels;  // ✅ Labels ready!
        isLoading = false;
        _navmanager.LocationChanged += OnLocationChanged;
        //Console.WriteLine($"Authentication ENTREE curtiw {curTiw.Nom} nbele :{TbElems.Count} et nbcols : {LsCols.Count}");
    }
    private async Task InitializeData()
    {
        // Seed some sample rows
        // if (OnChildEmptyData.HasDelegate)
        // {
        //     await OnChildEmptyData.InvokeAsync();
        //Console.WriteLine($"Retour parent : {allEnable}");
        curTiw = new();
        curTiw.Idorg = curOrga.Idorg;
        curTiw.Utyp = Ugpe;
        curTiw.Nom = "Martin ESSEC";
        curTiw.Pnom = "Simpore";
        curTiw.Datc = DateTime.Now;
        curTiw.Xadd1 = -1;
        noData = true;
        //Console.WriteLine($"1.{ParentEDT} 2.{ParentOK}");
        //AddingTiwRowGuid = curTiw.Rowguid;
        //sinwTiw = true;
        Console.WriteLine("Correct");
        StateHasChanged();
    }

    void OnTiwRowClick(GridRowEventArgs<Tiewel> args)
    {
        Console.WriteLine($"OnTiwRowClick Triggered : {args.Item.Id}");
        rselTiw = args.Item; //get gRubsMap
        Console.WriteLine($"X1seq {rselTiw.Id}");
        if (rselTiw == null || rselTiw.Id == 0)
        {
            return;
        }
        StateHasChanged();
    }

    //new method to reset EditContext
    private async Task<Dictionary<string, bool>> LoadVisibleFieldsAsync(int idorg)
    {
        var visible = new Dictionary<string, bool>();

        var visibleGsglne = _lookupService.ColDefs
            .Where(g => g.Scdrub != null
                     && g.Jacc == 1) // ← VISIBLE fields only
            .Select(g => g.Scdrub)
            .Distinct()
            .ToList();

        foreach (var fieldName in visibleGsglne)
        {
            visible[fieldName] = true;
        }

        return visible;
    }

    // ✅ CORRECT property access with EditContext support
    private string GetPropValue(Tiewel entity, PropertyInfo prop)
    {
        var value = prop.GetValue(entity);
        return value?.ToString() ?? "";
    }

    private async Task SetPropValue(Tiewel entity, PropertyInfo prop, object newValue)
    {
        if (newValue == null) return;

        try
        {
            string stringValue = newValue.ToString();

            // ✅ Simple type-safe conversion
            object convertedValue = prop.PropertyType.Name switch
            {
                "String" => stringValue,
                "Int32" or "int" => int.TryParse(stringValue, out int i) ? i : 0,
                "Decimal" => decimal.TryParse(stringValue, out decimal d) ? d : 0m,
                "DateTime" => DateTime.TryParse(stringValue, out DateTime dt) ? dt : DateTime.MinValue,
                "DateOnly" => DateOnly.TryParse(stringValue, out DateOnly dateOnly) ? dateOnly : DateOnly.MinValue,
                "Boolean" => bool.TryParse(stringValue, out bool b) ? b : false,
                _ => stringValue  // default to string
            };

            prop.SetValue(entity, convertedValue);
            //editContext.NotifyFieldChanged(editContext.Field(prop.Name));
            StateHasChanged();
        }
        catch (Exception)
        {
            // Silent fail
        }
    }

    // ✅ For regular inputs - bind directly to property
    private async Task OnInputChanged(ChangeEventArgs e, PropertyInfo prop)
    {
        await SetPropValue(curTiw, prop, e.Value);
    }

    // ✅ Correct input type detection
    private string GetInputType(PropertyInfo prop)
    {
        var typeName = prop.PropertyType.Name.ToLowerInvariant();
        return typeName switch
        {
            "datetime" or "dateonly" => "date",
            "int32" or "int" => "number",
            "decimal" or "double" => "number",
            "bool" => "checkbox",
            _ => "text"
        };
    }
    // CheckBoxes
    private bool isChecked
    {
        get => curTiw.Jacc == 1;
        set => curTiw.Jacc = value ? 1 : 0;
    }
    //CRUD Tiewel
    private EntityStates? GetState(object entity)
    {
        return curODContext?.GetEntityState(entity);
    }
    void PrepareAddTiw()
    {
        //curTiw = new();
        Tiewel mytier = AddNewTiwRow();
        if (mytier != null)
        {
            curTiw = mytier;  //mytier;
            AddingTiwRowGuid = curTiw.Rowguid;
            sinwTiw = true;
            isTiwAdding = true;
            StateHasChanged();
        } else
        {
            curTiw = new();
            isTiwAdding = false;
        }
    }
    void PrepareAddAfl(Tiewel mytier, int typfl)
    {
        //calc next Seq
        //Console.WriteLine($" le type : {mySTyp}");
        int nextSeq = 1;
        Tiwafl myafl = AddNewAflRow(mytier, typfl, nextSeq);
        if (myafl != null)
        {
            //curAfl = myafl;
            //AddStep[mySTyp] = -1;
            curTiw.Tiwafls.Add(myafl);
            AddingAflRowGuid = myafl.Rowguid;
            sinwAfl = true;
            isAflAdding = true;
            curAfl = myafl;
            StateHasChanged();
        }
    }
    Tiewel AddNewTiwRow()
    {
        if (curOrga == null || allEnable == false)
        {
            Imessage = "REFUS, Creation Orga indisponible";
            //Yames = true;
            return new Tiewel();
        }
        try
        {
            Console.WriteLine("In Adding");
            return new Tiewel
            {
                //Rowguid = Guid.NewGuid(),
                Idorg = curOrga.Idorg,

                Utyp = Ugpe,
                Nom = "Martin ESSEC",
                Pnom = "Simpore",
                Datc = DateTime.Now,
                Xadd1 = -1,
            };
        }catch(Exception ex)
        {
            Console.WriteLine($"ici : error exception : {ex.Message}");
        }
        return new Tiewel();
    }
    Tiwafl AddNewAflRow(Tiewel mytier, int typfl, int nextSeq)
    {
        if (mytier == null || allEnable == false)
        {
            Imessage = "REFUS, Creation Tiers indisponible";
            //Yames = true;
            return new Tiwafl();
        }
        try
        {
            Console.WriteLine("In Adding");
            return new Tiwafl
            {
                //Rowguid = Guid.NewGuid(),
                Itie = curTiw?.Id,
                Ttyp = Ugpe,
                Tyafl = typfl,
                Irang = nextSeq,
                Nom = "Fils Martin",
                Pnom = "Ilboudo",
                Datc = DateTime.Now,
                Xadd1 = -1,
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ici : error exception : {ex.Message}");
        }
        return new Tiwafl();
    }
    async Task IncludeTiw(Tiewel aglne)
    {
        // Use parent Idrub as key to gRubsMap dictionary
        var parentId = curOrga.Idorg;
        bool YaTiw = false;
        YaTiw = await IsTiwValid(aglne);
        if (!YaTiw) return;
        Imessage = "";
        if (!curODContext.IsEntityTracked(aglne))
        {
            curTiw.Xadd1 = -2;  //fin adding to be tracked in loaded rubfmts wait for new add
            aglne.Xadd1 = 0;
            aglne.Utyp = Ugpe;
            int wivalid = 0; int wjwlc = 1;
            if (aglne.Utyp == 3) //auto tiersp/admin
            { //auto ou Admin
                wivalid = 9; //declench validation tiersp
                wjwlc = 3; //integrate to tiersp in Jwcl = 1/added
            }
            if (curOrga.Opauto == 1 && aglne.Utyp == 5)
            { //operateur
                wivalid = 9; //declench validation tiersp
                wjwlc = 1; //added
            }
            if (curOrga.Cbauto == 1 && aglne.Utyp == 11)
            { //cible
                wivalid = 9; //declench validation tiersp
                wjwlc = 1; //added
            }
            aglne.Tiedcl = wivalid;
            aglne.Jwlc = wjwlc;
            curODContext.AddObject<Tiewel>("Tiewels", aglne);
            sinwTiw = false;
            AddingTiwRowGuid = Guid.Empty;
            curOrga.Tiewels.Add(aglne);
            ensTiws.Add(aglne);
            StateHasChanged();
            Imessage = "Success... programme ajoute";
        }
        else
        {
            aglne.Xadd1 = 0;
            Imessage = "Deja ajoute";
        }
        sinwTiw = false;
    }
    void IncludeAfl(Tiwafl myafl)
    {
        var parentId = curTiw.Rowguid;
        //bool YaChild = IsChildValid(aglne); // Make sure this returns true if aglne is valid to add
        if (!curODContext.IsEntityTracked(myafl)) // && YaChild)
        {
            try
            {
                myafl.Xadd1 = -2;  // Mark as being added
                if (!curODContext.IsEntityTracked(curTiw))
                {
                    curODContext.AttachTo("Tiewels", curTiw);
                }
                int instp = Convert.ToInt16(myafl.Tyafl);
                //AddStep[instp] = -2;
                //myafl.Xadd1 = -2;  //fin adding to be tracked in loaded rubfmts wait for new add
                curODContext.AddRelatedObject(curTiw, "Tiwafls", myafl);
                //curAfl.Xadd1 = -2;
                sinwAfl = false;
                AddingAflRowGuid = Guid.Empty;
                curTiw.Tiwafls.Add(myafl);
                //siAflAdding = true;
                Imessage = "Success... Rubrique ajoutee";
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Erreur addrelatedobject : {ex.Message}");
            }
            StateHasChanged();
        }
        else
        {
            myafl.Xadd1 = 0;
            Imessage = "Deja ajoute";
        }

        //isAdetCodeValid = false;
        sinwAfl = false; // Consider moving this flag reset based on your UI state management needs
    }
    private async Task CancelTiwAdding()
    {
        if (curODContext.IsEntityTracked(curTiw))
        {
            foreach(var ifl in curTiw.Tiwafls)
            {
                if (curODContext.IsEntityTracked(ifl))
                {
                    curODContext.Detach(ifl);
                }
            }
            curODContext.Detach(curTiw);
            //LsTAtts.Remove(curTiw);
            Imessage = "Annulee... Creation Personne";
        }
        else
        {
            curTiw = new Tiewel();
            Imessage = "Deja annule";
        }
        //added or included
        var ya1Tiw = LsTAtts.Where(t => t.Xadd1 == -1 || t.Xadd1 == -2).FirstOrDefault();
        if (ya1Tiw != null)
        { //Xadd1 est parti
            LsTAtts.Remove(ya1Tiw);
            ensTiws.Remove(ya1Tiw);
        } 
        AddingTiwRowGuid = Guid.Empty;
        sinwTiw = false;
        isTiwAdding = false;
        isTiwEdding = false;
        isTiwDeling = false;
        StateHasChanged();
    }
    private async Task CancelAflAdding()
    {
        if (curODContext.IsEntityTracked(curAfl))
        {
            curODContext.Detach(curAfl);
            //curTiw.Tiwafls.Remove(curAfl);
            Imessage = "Annulee... Creation Affilie";
        }
        else
        {
            curAfl = new Tiwafl();
            Imessage = "Deja annule";
        }
        //added or included
        var ya1Afl = curTiw.Tiwafls.Where(a => a.Xadd1 == -1 || a.Xadd1 == -2).FirstOrDefault();
        if (ya1Afl != null)
        { //curAfl.Xadd1 est parti
            curTiw.Tiwafls.Remove(ya1Afl);
        }
        int custp = Convert.ToInt16(curAfl.Tyafl);
        //AddStep[custp] = 0;
        AddingAflRowGuid = Guid.Empty;
        sinwAfl = false;
        isAflAdding = false;
        isAflEdding = false;
        isAflDeling = false;
        StateHasChanged();
    }
    //EDITION/DELETE - Tiewel
    void BeginTiwEdit()
    {
        EditingTiwRowGuid = curTiw.Rowguid;
        isTiwEdding = true;
    }
    void PromptTiwEding(Tiewel mytiw)
    {
        // myafl.Xedt1 = 0;
        // editingAfl = myafl;

        // draftAfl = new Tiwafl();

        // // List of property names to copy, e.g. from your available names
        // var propertyNamesToCopy = new List<string>();
        // foreach (var ucol in LsCols.Where(uv => uv.Totyp == Ugpe && uv.Tstyp == myafl.Tyafl && uv.Jacc == 1))
        // {
        //     string propname = ucol.Scdrub + ",";
        //     propertyNamesToCopy.Add(ucol.Scdrub);
        // }
        // var type = typeof(Tiwafl);
        // foreach (var propName in propertyNamesToCopy)
        // {
        //     var prop = type.GetProperty(propName);
        //     if (prop != null && prop.CanRead && prop.CanWrite)
        //     {
        //         var value = prop.GetValue(myafl);
        //         prop.SetValue(draftAfl, value);
        //     }
        // }
        // //init edition
        // myafl.Xedt1 = -1;
        // EditingAflRowGuid = myafl.Rowguid;
    }
    private void CancelTiwEdding()
    {
        // if (_originalTiwSnapshots.TryGetValue(curTiw.Rowguid, out var original))
        // {
        //     RestoreTiwValues(curTiw, original);
        //     _originalTiwSnapshots.Remove(curTiw.Rowguid);
        // }
        EditingTiwRowGuid = Guid.Empty;
        isTiwEdding = false;
        isTiwAdding = false;
        isTiwDeling = false;
        StateHasChanged();
    }
    void ConfirmTiwEdding()
    {
        // if (editingTiw != null)
        // {
        //     // List of property names to copy, e.g. from your available names
        //     var propertyNamesToCopy = new List<string>();
        //     foreach (var ucol in LsCols.Where(uv => uv.Totyp == Ugpe && uv.Tstyp == myafl.Tyafl && uv.Jacc == 1))
        //     {
        //         string propname = ucol.Scdrub + ",";
        //         propertyNamesToCopy.Add(ucol.Scdrub);
        //     }
        //     var type = typeof(Tiwafl);

        //     // Assuming you want to copy the same set of property names as before,
        //     // or you can dynamically load those names as needed instead of hardcoding:

        //     foreach (var propName in propertyNamesToCopy)
        //     {
        //         var prop = type.GetProperty(propName);
        //         if (prop != null && prop.CanRead && prop.CanWrite)
        //         {
        //             var value = prop.GetValue(myafl);
        //             prop.SetValue(editingAfl, value);
        //         }
        //     }

        //     // Now attach or update in context as you do:
        //     if (!curODContext.GetAllTrackedEntities().Any(e => e.Entity == editingAfl))
        //         curODContext.AttachTo("Tiwelss", editingTiw);

        //     curODContext.UpdateObject(editingTiw);
        // }

        // mytiw.Xedt1 = 0;
        // editingTiw = null;
        // EditingTiwRowGuid = Guid.Empty;
        isTiwEdding = false;
        isTiwAdding = false;
        isTiwDeling = false;
    }
    private void PromptTiwDeling()
    {
        ConfirmingTiwDeleteRowGuid = curTiw.Rowguid;
        isTiwDeling = true;
    }
    private void CancelTiwDeling()
    {
        ConfirmingTiwDeleteRowGuid = Guid.Empty;
        isTiwDeling = false;
        isTiwEdding = false;
        isTiwAdding = false;
    }
    private void ConfirmTiwDeling()
    {
        var parent = curOrga;
        if (parent == null)
            return;
        Console.WriteLine($"del parent {parent.Raison} and row id : {parent.Idorg}");
        Tiewel svRow = curTiw;
        // For existing rows: mark for OData deletion and remove locally
        if (curODContext.IsEntityTracked(curTiw))
        {
            curODContext.DeleteObject(curTiw); // Mark for deletion in OData context
        }
        else
        {
            curODContext.Detach(curTiw); // Mark for deletion in OData context
        }
        //curOrga.Rubvars.ToList().RemoveAll(rf => rf.Idpln == svRow.Idpln);
        //curOrga.Plngens.Remove(svRow); // Remove from tracked collection
        EditingTiwRowGuid = Guid.Empty;
        ConfirmingTiwDeleteRowGuid = Guid.Empty;
        isTiwDeling = false;
        isTiwEdding = false;
        isTiwAdding = false;
        StateHasChanged(); // Notify UI about changes
    }
    private async Task DelTiwAsync(Tiewel mytiw)
    {
        Console.WriteLine("In Deleting");
        curTiw = mytiw;
    }
    //EDITION Tiwafl
    void BeginAflEdit(Tiwafl myafl)
    {
        EditingAflRowGuid = myafl.Rowguid;
        isAflEdding = false;
    }
    void PromptAflEdit(Tiwafl myafl)
    {
        myafl.Xedt1 = 0;
        editingAfl = myafl;

        draftAfl = new Tiwafl();

        // List of property names to copy, e.g. from your available names
        var propertyNamesToCopy = new List<string>();
        foreach (var ucol in LsCols.Where(uv => uv.Totyp == Ugpe && uv.Tstyp == myafl.Tyafl && uv.Jacc == 1))
        {
            string propname = ucol.Scdrub + ",";
            propertyNamesToCopy.Add(ucol.Scdrub);
        }
        var type = typeof(Tiwafl);
        foreach (var propName in propertyNamesToCopy)
        {
            var prop = type.GetProperty(propName);
            if (prop != null && prop.CanRead && prop.CanWrite)
            {
                var value = prop.GetValue(myafl);
                prop.SetValue(draftAfl, value);
            }
        }
        //init edition
        myafl.Xedt1 = -1;
        EditingAflRowGuid = myafl.Rowguid;
    }
    void CancelAflEding(Tiwafl myafl)
    {
        myafl.Xedt1 = 0;
        //isEdingMan = false;
        editingAfl = null;
        draftAfl = null;
        EditingAflRowGuid = Guid.Empty;
        isAflEdding = false;
        isAflAdding = false;
        isAflDeling = false;
    }
    void ConfirmAflEding(Tiwafl myafl)
    {
        if (editingAfl != null)
        {
            // List of property names to copy, e.g. from your available names
            var propertyNamesToCopy = new List<string>();
            foreach (var ucol in LsCols.Where(uv => uv.Totyp == Ugpe && uv.Tstyp == myafl.Tyafl && uv.Jacc == 1))
            {
                string propname = ucol.Scdrub + ",";
                propertyNamesToCopy.Add(ucol.Scdrub);
            }
            var type = typeof(Tiwafl);

            // Assuming you want to copy the same set of property names as before,
            // or you can dynamically load those names as needed instead of hardcoding:

            foreach (var propName in propertyNamesToCopy)
            {
                var prop = type.GetProperty(propName);
                if (prop != null && prop.CanRead && prop.CanWrite)
                {
                    var value = prop.GetValue(myafl);
                    prop.SetValue(editingAfl, value);
                }
            }

            // Now attach or update in context as you do:
            if (!curODContext.GetAllTrackedEntities().Any(e => e.Entity == editingAfl))
                curODContext.AttachTo("Tiwafls", editingAfl);

            curODContext.UpdateObject(editingAfl);
        }

        myafl.Xedt1 = 0;
        editingAfl = null;
        EditingAflRowGuid = Guid.Empty;
        isAflEdding = false;
        isAflAdding = false;
        isAflDeling = false;
    }
    //DELETING AFL
    private void PromptAflDelete(Tiwafl item)
    {
        ConfirmingAflDeleteRowGuid = item.Rowguid;
        isAflDeling = true;
    }
    private void CancelAflDeling()
    {
        ConfirmingAflDeleteRowGuid = Guid.Empty;
        isAflEdding = false;
        isAflAdding = false;
        isAflDeling = false;
    }
    private void ConfirmAflDeling(Tiwafl row)
    {
        var parent = curTiw;
        Console.WriteLine($"Parent may be found : {parent.Id}");
        if (parent == null)
            return;
        Console.WriteLine($"del parent {parent.Nom} and row id : {parent.Id}");
        Tiwafl svRow = row;
        // For existing rows: mark for OData deletion and remove locally
        if (curODContext.IsEntityTracked(row))
        {
            curODContext.DeleteObject(row); // Mark for deletion in OData context
        }
        else
        {
            curODContext.Detach(row); // Mark for deletion in OData context
        }
        curTiw.Tiwafls.ToList().RemoveAll(rf => rf.Itie == svRow.Itie);
        curTiw.Tiwafls.Remove(svRow);
        EditingAflRowGuid = Guid.Empty;
        ConfirmingAflDeleteRowGuid = Guid.Empty;
        isAflEdding = false;
        isAflAdding = false;
        isAflDeling = false;
        StateHasChanged(); // Notify UI about changes
    }
    private async Task OuvrirFiche(int orig)
    {
        isRecptVisible = false;
        if (orig == 1)
        { //recepisse
            isRecptVisible = true;
        }
        //stopenFich = "OuvrirRecepisse";
        //isFicheVisible = true;
        // isFicheVisible = !isFicheVisible;
        // if (isFicheVisible)
        // {
        //     stopenFich = "FermerRecepisse";
        // }
        // else
        // {
        //     stopenFich = "OuvrirRecepisse";
        // }
    }
    private async Task ValidTiwAsync()
    {
        //await _twentityManager.SaveChanges();
    }
    private void HandleValidSubmit()
    {
        Console.WriteLine("Form submitted successfully!");
    }
    private void OnTiwChanged(EventArgs args)
    {
        var chgeEventArgs = (ChangeEventArgs)args;
        var selno = Convert.ToInt16(chgeEventArgs.Value.ToString());
        if (selno > 0)
        {
            curTiw = LsTAtts.Where(tiw => tiw.Id == selno).FirstOrDefault();
        }
    }
    private void OnTAccAll(ChangeEventArgs e, int origchk)
    {
        bool isChecked = (bool)e.Value;
        if (origchk == 1)
        {
            IsGlobalT1Checked = isChecked; // Update the bound value manually
        } else if (origchk == 2) 
        {
            IsGlobalT2Checked = isChecked; // Update the bound value manually
        } else if (origchk == 3)
        {
            IsGlobalT3Checked = isChecked; // Update the bound value manually
        }
        foreach (var tw in ensTiws)
        {
            if (origchk == 1)
            {
                //tw.Ivalid = isChecked ? 9 : 0;
                tw.Jacc = isChecked ? 1 : 0;
            } else
            if (origchk == 2)
            {
                //tw.Ivalid = isChecked ? 9 : 0;
                tw.Jrej = isChecked ? 1 : 0;
            }
            else
            if (origchk == 3)
            {
                //tw.Ivalid = isChecked ? 9 : 0;
                tw.Jnot = isChecked ? 1 : 0;
            }
            Console.WriteLine($"Global Valid  / {tw.Jacc} / {tw.Jrej} / {tw.Jnot}");
        }
        StateHasChanged();
    }
    
    private void ShowModal()
    {
        // Optionally, set the current entity to edit
        //currentEntity = new YourEntityType { Name = "Sample Name", Description = "Sample Description" }; // Example initialization
        //_mdcTiwel = curTiwel;
        Console.WriteLine($"ShowModal appele");
        isModalVisible = true;
    }

    private Task OnModalVisibilityChanged(bool isVisible)
    {
        isModalVisible = isVisible;
        return Task.CompletedTask;
    }
    private Task HandleSave(Tiewel entity)
    {
        // Handle modal entity save
        // For example, save to the database or update the UI
        Console.WriteLine($"Entity saved: {entity.Nom}, {entity.Pnom}");
        return Task.CompletedTask;
    }

    private async Task<bool> IsTiwValid(Tiewel mytiw)
    {
        //verification saisie
        errors = false;
        errorList = new List<string>();
        if (String.IsNullOrEmpty(mytiw.Nom))
        {
            errors = true;
            errorList.Add("Echec, Nom obligatoire.");
            return false;
        }
        if (String.IsNullOrEmpty(mytiw.Pnom))
        {
            errors = true;
            errorList.Add("Echec, Prenom(s) obligatoire.");
            return false;
        }
        // if (mytiw.Sexe == "0")
        // {
        //     errors = true;
        //     errorList.Add("Echec, Sexe obligatoire.");
        //     return false;
        // }
        // if (mytiw.Sitmat == 0)
        // {
        //     errors = true;
        //     errorList.Add("Echec, Sit.matrimon. obligatoire.");
        //     return false;
        // }
        // if (mytiw.Respon == 0)
        // {
        //     errors = true;
        //     errorList.Add("Echec, Responsabilite obligatoire.");
        //     return false;
        // }
        if (String.IsNullOrEmpty(mytiw.Email))
        {
            strmeta = mytiw.Email;
            errors = true;
            errorList.Add("Echec, Email obligatoire.");
            return false;
        }
        // if (Siphone == 1)
        // { //telephone obligatoire
        //     if (String.IsNullOrEmpty(mytiw.Usrphone))
        //     {
        //         errors = true;
        //         errorList.Add("Echec, Telephone obligatoire.");
        //         return false;
        //     }
        // }
        return true;
    }
    //manage SAVING
    public async Task EdtAll()
    {
        allEnable = true;
        //myacfl.EdtAll();        
        isTiwInEditing = false;
    }
    public async Task CncCHILD()
    { //reload
        isTiwInEditing = false;
        //ChildADDING = false;
        //ChildUPDING = false;
    }
    private async Task<bool> IsAflValid(Tiwafl mytiw)
    {
        //verification saisie
        errors = false;
        errorList = new List<string>();
        if (String.IsNullOrEmpty(mytiw.Nom))
        {
            errors = true;
            errorList.Add("Echec, Nom obligatoire.");
            return false;
        }
        if (String.IsNullOrEmpty(mytiw.Pnom))
        {
            errors = true;
            errorList.Add("Echec, Prenom(s) obligatoire.");
            return false;
        }
        // if (mytiw.Sexe == "0")
        // {
        //     errors = true;
        //     errorList.Add("Echec, Sexe obligatoire.");
        //     return false;
        // }
        // if (mytiw.Sitmat == 0)
        // {
        //     errors = true;
        //     errorList.Add("Echec, Sit.matrimon. obligatoire.");
        //     return false;
        // }
        // if (mytiw.Respon == 0)
        // {
        //     errors = true;
        //     errorList.Add("Echec, Responsabilite obligatoire.");
        //     return false;
        // }
        if (String.IsNullOrEmpty(mytiw.Usremail))
        {
            strmeta = mytiw.Usremail;
            errors = true;
            errorList.Add("Echec, Email obligatoire.");
            return false;
        }
        // if (Siphone == 1)
        // { //telephone obligatoire
        //     if (String.IsNullOrEmpty(mytiw.Usrphone))
        //     {
        //         errors = true;
        //         errorList.Add("Echec, Telephone obligatoire.");
        //         return false;
        //     }
        // }
        return true;
    }
    // public async Task SavAll()
    // {
    //     if (isTiwInEditing)
    //     {
    //         curODContext.UpdateObject<Tiewel>(curTiw);
    //         await curODContext.SaveDataAsync();
    //         isTiwInEditing = false;
    //     }
    //     allEnable = false;
    // }
    private void HandleFieldChanged(object sender, FieldChangedEventArgs e)
    {
        //ChildUPDING = true;
        if (!isTiwInEditing) isTiwInEditing = true;
        Console.WriteLine($"Field edited: {e.FieldIdentifier.FieldName}");
        // Place your logic here when a field is edited
    }
    private async void OnLocationChanged(object sender, LocationChangedEventArgs e)
    {
        allEnable = false;
        await SaveCurEntities();
    }
    public async Task<bool> SaveCurEntities()
    {
        try
        {
            //if (isTiwInEditing || myacfl.isTwAflEditing)
            //if (isTiwInEditing)
            //{
                //curODContext.UpdateObject<Tiewel>(curTiw);
                ////await curODContext.SaveDataAsync();
                //isTiwInEditing = false;
                Console.WriteLine("Saved SUCCESS");
            //}
            //var wrkplns = curOrga.Plngens.Where(pl => pl.Ptyp == 3 && pl.Totyp == IMyAtr).ToList();
            //MyDaPlans = wrkplns;
            StateHasChanged();
            return true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Saved ISSUE {ex.Message}");
            //Alert($"ECHEC Entities not SAVED");
            return false;
        }
    }

}