@page "/saieactlnes"
@layout SaieMenu

@using System.Net.Http.Headers
@using System.Security.Claims
@using System.Text.Json
@using BlazorBootstrap
@using BlazorDownloadFile
@using Blazored.LocalStorage
@using GxShared.Formulas.ForaContext
@using GxShared.Formulas.ForaModels
@using GxShared.Sess
@using GxShared.Others
@using GxTie.ClieModels
@using GxTie.Components.Opera
@using GxTie.Services
@using GxTie.Components.Opera.RtOpe
@using GxWapi.DaModels

@inject MyAuthStateProvider _authprovider
@inject ILocalStorageService _localStorage
@inject IBlazorDownloadFileService DownloadService
@inject HttpClientService _cliemanager
@inject RendAgres _rendAgres
@inject IJSRuntime _jsRun

<PageTitle>Saisie Offline</PageTitle>
<div>
    @Imessage
</div>
<div class="my-container">
    @if (toChild != null)
    {
        @ChildContent
    }
</div>
<!--tiers/search et/ou creation? -->
@if (isLoading)
{
    <Progress class="progress mb-3">
        <ProgressBar Width="30" Label="Saisies/Saisie Loading..." Type="ProgressType.StripedAndAnimated" Color="ProgressColor.Primary" />
    </Progress>
}
else
{
    @if (SessOpen)
    {
        <div class="input-group">
            <label>Programme :</label>
            <div class="text-center">
                <InputSelect id="pgrId" @bind-Value="ImyProg">
                <option value="0">progr?</option>
                @foreach (var pgr in LsProgs)
                {
                    <option value="@pgr.Id" @onclick="() => GetSelectedProg(pgr)">@pgr.Liba</option>
                }
            </InputSelect>
            </div>
            <label for="TypDiv">Service :</label>
            <div>
                <InputSelect id="TypDiv" @bind-Value="ImyDiv">
                    <option value="0">Aucun</option>
                    @foreach (var divo in _lsDivs)
                    {
                        <option value="@divo.Ihie" onclick="@trierTiers">@divo.Abg-@divo.Liba</option>
                    }
                </InputSelect>
            </div>
        </div>
    }
    <div class="input-group">
        @if(ProgOpen)
        {
            <div class="text-center">
                <InputSelect id="optId" @bind-Value="ImyOpti">
                    <option value="0">aucun</option>
                    @foreach (var uf in LsFixes.Where(xf => xf.Gvars == 33 && xf.Itb == 7 && xf.Gp1 == 4))
                    {
                        <option value="@uf.Elea" @onclick="() => GetSelectedOption(uf)">par @uf.Liba</option>
                    }
                </InputSelect>
            </div>
        }
        @if (ProgOpen)
        {
            @if (ImyOpti == 1)
            {
                <label>matricule :</label>
                <div class="text-center">
                    <InputSelect id="Idtie" @bind-Value="ImyTier">
                        <option value="0">tiers?</option>
                        @foreach (var tie in PreTiers)
                        {
                            <option value="@tie.Id" @onclick="() => GetSelectedTier(tie)">@tie.Smatri</option>
                        }
                    </InputSelect>
                </div>
                <label class="text-center">nom : </label>
                <div class="text-center">
                    <InputSelect id="Idtie2" @bind-Value="ImyTier">
                        <option value="0">tiers?</option>
                        @foreach (var tie in PreTiers)
                        {
                            <option value="@tie.Id" @onclick="() => GetSelectedTier(tie)">@($"{tie.Nom} {tie.Pnom}")</option>
                        }
                    </InputSelect>
                </div>
            }
            @if (ImyOpti == 2)
            {
                <label>Code : </label>
                <div class="text-center">
                    <InputSelect id="rubrid" @bind-Value="ImyRubr">
                        <option value="0">rubrique?</option>
                        @foreach (var rub in EnsRubrs)
                        {
                            <option value="@rub.Id" @onclick="() => GetSelectedRubr(rub)">@rub.Scdrub</option>
                        }
                    </InputSelect>
                </div>
                <label>Libelle : </label>
                <div class="text-center">
                    <InputSelect id="rubrid" @bind-Value="ImyRubr">
                        <option value="0">rubrique?</option>
                        @foreach (var rub in EnsRubrs)
                        {
                            <option value="@rub.Id" @onclick="() => GetSelectedRubr(rub)">@rub.Liba</option>
                        }
                    </InputSelect>
                </div>
            }
        }
        @if (CanSaie)
        {
            <Button class="btn btn-sm btn-secondary btnsz"
                    style="@(!allEnable ? "" : "display:none;")"
                    @onclick="() => PrepOpeSaie(ImyOpti)">
                OuvrirSaisie 
            </Button>
                @if (FinPreparer == true)
                {
                    <!--en saisie et peut soumettre a save
                        et peut revenir continuer a saisir 
                        et a saved -->
                    <Button class="btn btn-sm btn-secondary btnsz"
                            style="@(!allEnable ? "" : "display:none;")"
                            @onclick="() => SaveCalcLinesAsync(CalcLines)">
                        Enregistrer
                    </Button>
                }
            <div>
                &nbsp;&nbsp;
                <button class="btn btn-warning btn-sm" @onclick="() => OuvrirFiche(ImyOpti)">@stopenFich</button>
            </div>
        }
    </div>
}
<!--Actsaie Portrait-->
@if (!isLoading)
{
<!--VISIBLE SAISIE-->
@if (isFicheVisible)
{
    <RtS11Fic @ref="myfsaie"
        curOrga="@curOrga"
        toChild="@toChild"
        curODContext="@curODContext"
        _curTier="@_curTier">
        <ChildContent>
           <h2 class="child-box">Fiche de @curProg.Liba</h2>
        </ChildContent>
    </RtS11Fic>
}
<div class="d-flex flex-row">
    <EditForm Context="invform" Model="curOrga">
        <DataAnnotationsValidator />
        <ValidationSummary />
            <div class="p-1" style="max-height: 400px; overflow-y: auto;">
                <Grid TItem="FormulaLine"
                      Data="@MissionLines"
                      AllowFiltering="@isFilteringEnabled"
                      AllowPaging="true"
                      Responsive="true">
                    <GridColumns>
                        <GridColumn TItem="FormulaLine" HeaderText="No">
                            <ChildContent Context="item">@item.Id</ChildContent>
                        </GridColumn>
                        <GridColumn TItem="FormulaLine" HeaderText="Code" IsVisible="@(ImyOpti == 1)">
                            <ChildContent Context="item">@item.LineNumber</ChildContent>
                        </GridColumn>
                        <GridColumn TItem="FormulaLine" HeaderText="Designation" IsVisible="@(ImyOpti == 1)">
                            <ChildContent Context="item">@item.Liba</ChildContent>
                        </GridColumn>
                        <GridColumn TItem="FormulaLine" HeaderText="Matricule" IsVisible="@(ImyOpti == 2)">
                            <ChildContent Context="item">@item.Smatri</ChildContent>
                        </GridColumn>
                        <GridColumn TItem="FormulaLine" HeaderText="Nom" IsVisible="@(ImyOpti == 2)">
                            <ChildContent Context="item">@item.Nom</ChildContent>
                        </GridColumn>
                        <GridColumn TItem="FormulaLine" HeaderText="PNom" IsVisible="@(ImyOpti == 2)">
                            <ChildContent Context="item">@item.Pnom</ChildContent>
                        </GridColumn>
                        <GridColumn TItem="FormulaLine" HeaderText="MtCalcule">
                            <ChildContent Context="item">
                                @item.Result
                            </ChildContent>
                        </GridColumn>
                        <GridColumn TItem="FormulaLine" HeaderText="MtSaisie">
                            <ChildContent Context="item">
                                <ValidatedInput Atyp="2"
                                                @bind-Value="item.Valsaie"
                                                ErrorMessage="Please enter a valid integer"
                                                OnValidInput="val => HandleValidInput(item, val)" />
                            </ChildContent>
                        </GridColumn>
                    </GridColumns>
                </Grid>
            </div>
    </EditForm>
</div>
}
<style>
    .inputfl {
        opacity: 0;

    }
</style>
@code {
    private bool isLoading = true;
    private bool allEnable = false;
    //private bool notEnable => !allEnable;
    private bool enrEnable = false;
    private bool isEditing = false;
    private bool isFicheVisible = false;
    private bool FinPreparer = false;

    private bool Yames = false;
    private string Imessage = "", stopenFich = "OuvrirFiche";

    [Parameter]
    public RenderFragment ChildContent { get; set; }
    [Parameter]
    public MyODataContext curODContext { get; set; }
    [Parameter]
    public Gxorga curOrga { get; set; }
    [Parameter]
    public MyShareVars toChild { get; set; }
    //[Parameter]
    //public MyMenuVars froMenu { get; set; }

    // [CascadingParameter(Name = "SaieLayout")]
    // public SaieLayout Mainsaie { get; set; }
    //[Parameter]
    //public MyODataContext _gODContext { get; set; }    //Authentication

    //private EditContext _saiEdtContext;

    private bool isAuthenticated { get; set; }
    private ClaimsPrincipal authUser;
    private IEnumerable<Claim> claims = Enumerable.Empty<Claim>();

    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }

    private RtS11Fic myfsaie;

    //private FormulaEvalService _calcService;


    //private HttpClient _apiClient;
    public int _lgcdu = 0;

    //private Userbag _usrBag = new Userbag();
    private List<Actsaie> _tieActs = new();
    private List<Actsaie> _lsmActs = new();

    private Tiersp _curTier = new();
    private List<Tiersp> EnsTiers = new();
    private List<Plngen> EnsProgs = new();
    private List<Rubvar> EnsRubrs = new();
    private List<Gpdivh> _lsDivs = new();

    //  private Actsaie curAct = new();
    private Plngen curProg = new();

    private bool isFilteringEnabled = false;
    private Rubvar _curRub = new();
    private Gsesio _curSes = new();
    private Plngen selPgr = new();
    private Rubvar selRub = new();
    private Rubfmt selFmt = new();
    private DateTime _sesDat;

    private List<Gpfixe> LsFixes = new List<Gpfixe>();
    private List<Gpvar> LsVars = new();
    private List<Gplan> LsProgs = new();

    private bool success, errors, isSubmitting = false;
    private string[] errorList = [];
    private string rolInv = "", userName = "", isatmsg = "";

    private List<Tiersp> PreTiers = new();
    private List<Tiersp> SaieTiers = new();

    private ReqgnModel qryModel = new ReqgnModel();

    //private bool isExoSaieOpen => toChild.MainOptsOk; //exo et site
    private bool isSesSaieOpen => toChild.MainOptsOk && ImyProg != 0 && ImyOpti != 0;
    //Options Calculation workflow
    private bool SaveMarked = false;
    private bool CalcMarked = false;
    private bool autoSave = false;
    private bool SessOpen => toChild.curExo != null && toChild.curExo.Id != 0
                    && toChild.curSesio != null && toChild.curSesio.Id != 0;
    private bool ProgOpen => SessOpen && ImyProg != 0 && ImyDiv != 0;
    private bool CanSaie => ProgOpen && ImyOpti != 0 && (ImyRubr != 0 || ImyTier != 0);
    //->can Edit-can OpenSaie
    //->can Saie and Save
    //jusqu-a fermer
    private PersonEvaluationSession _currentSession;
    //CRUD ROW ADDING
    private Guid? EditingActRowGuid; //pmodal
    private bool IsActAdding(Plngen item) => EditingActRowGuid == item.Rowguid;
    private Guid? ConfirmingActDeleteRowGuid;
    private Guid? EditingDetRowGuid; //pmodal
    private bool IsDetAdding(Plngen item) => EditingDetRowGuid == item.Rowguid;
    private Guid? ConfirmingDetDeleteRowGuid;

    //private string opseudo = "", opnomp = "";
    //private int opfonc = 0, opgrad = 0, opafec = 0;
    private int ImyTier = 0, ImyProg = 0, ImyRubr = 0;
    private int ImyExo = 0, ImyDiv = 0; //ImySes = 0,
    private string kmessage = "";
    private string _errorMessage = "";
    private int itRub = 0;
    private int itProg = 0;
    private int itTie = 0;
    private int itPgr = 0;
    private int itGpe = 0;
    private int ImyOpti = 0; // par tiers

    //variables PLANS
    Modal edAModal;
    Actsaie actItem = new();
    int? edAIndex = null;
    Actsaie edAct = new();
    bool adingAct = false;

    Actdet edADet = new();
    //variables Man
    Actsaie? draftAct = null;
    Actsaie? editingAct = null;
    //bool yaEuActModif = false;
    //variables Lne
    Actdet? draftDet = null;
    Actdet? editingDet = null;
    bool yaEuDetModif = false;

    //private IRubvarResolver _rubvarResolver;

    List<FormulaLine> MissionLines = new();
    List<OutDataLineStream> CalcLines = new();
    private void HandleValidInput(FormulaLine item, object val)
    {
        if (val is int parsed)
        {
            //val.StrValue = parsed.ToString(); // or store as int if your model supports it
            //Console.WriteLine($"✅ Valid input for line {item.Scdrub}: {parsed}");
        }
        else
        {
            Console.WriteLine($"❌ Unexpected type: {val?.GetType().Name}");
        }
    }
    private void ManipulateResult()
    {
        //     switch (result.Type)
        //     {
        //         case LineType.Decimal:
        //             Console.WriteLine($"{Convert.ToDecimal(result.Value):N2}");
        //             break;
        //         case LineType.Date:
        //             Console.WriteLine($"{Convert.ToDateTime(result.Value):yyyy-MM-dd}");
        //             break;
        //         case LineType.Bool:
        //             Console.WriteLine((bool)result.Value ? "Yes" : "No");
        //             break;
        //         default:
        //             Console.WriteLine(result.Value?.ToString());
        //             break;
        //     }
        //     var amount = GetValueAs<decimal>(result);
        //     var date = GetValueAs<DateTime>(result);
        //     if (!result.IsEmpty && result.Value is decimal amount)
        //     {
        //         // safe to use amount
        //     }
        //     public readonly struct FormulaValue<T>
        // {
        //     public T Value { get; }
        //     public TrustLevel Trust { get; }

        //     public FormulaValue(T value, TrustLevel trust)
        //     {
        //         Value = value;
        //         Trust = trust;
        //     }
        //     var fv = new FormulaValue<decimal>((decimal)result.Value!, result.Trust);
        // }

    }
    protected override async Task OnInitializedAsync()
    {
        CalcLines = new();
        isLoading = true;
        isAuthenticated = toChild.isAuthenticated;
        authUser = toChild.authUser;
        if (!isAuthenticated)
        {
            Imessage = "Erreur, Utilisateur non authentifie";
            return;
        }
        //curOrga = toChild.curOrga;
        LsVars = toChild.LsVars;
        LsFixes = toChild.LsFixes;
        LsProgs = toChild.LsPlans.Where(pl => pl.Ptyp == 5).ToList();
        Console.WriteLine($"Programmes en cours : {LsProgs.Count}");
        //LsProgs = toChild.LsProgs;
        //LsSites = toChild.LsSites
        //indata
        EnsTiers = curOrga.Tiersps.ToList();
        Console.WriteLine($"ACTSAIE Active {EnsTiers.Count() }");
        //EnsSess = curOrga.Gsesios.Where(us => us.Styp == 3 && us.Sicur == 1 && us.Sieta == 1).ToList(); //saisies ouversts
        _curTier = EnsTiers.FirstOrDefault();
        EnsProgs = curOrga.Plngens.Where(pl => pl.Ptyp == 5).ToList(); //saisies
        _lgcdu = 3;
        var noslims = LsVars.Where(uv => uv.Idhie == 0 && uv.Gvars == 21 && uv.Itb == 1 && uv.Elea == 1);
        if (noslims.Any()) _lgcdu = noslims.FirstOrDefault().Ivala;

        _lsDivs = await _rendAgres.LoadOrgaPostes(); 
        //toChild.LsDivs.Where(uh => uh.Sidiv == 1).ToList();


        // // _calcService = new FormulaEvalService(esaTier, esaAct, esaDet, resaDon, resaDet);
        // _calcService = new FormulaEvalService(
        //     new List<Tiersp> { _curTier }, // single person context
        //         curDaAct,
        //         curActDet,
        //         curDaDon,
        //         curResDet
        // );
        // _saiEdtContext(curOrg)
        Console.WriteLine("Authentication ENTREE");
        isLoading = false;
    }
    private async Task OuvrirFiche(int orig)
    {
        isFicheVisible = !isFicheVisible;
        if (isFicheVisible)
        {
            stopenFich = "FermerFiche";
        }
        else
        {
            stopenFich = "OuvrirFiche";
        }
    }
    //Others Selections//si isSesSaieOpen
    private void GetSelectedOption(Gpfixe myuf)
    {

        StateHasChanged();
    }
    private async Task GetSelectedProg(Gplan bropln)
    {
        //Console.WriteLine($"ICI PROGRAMMES : {EnsProgs.Count()}");
        curProg = new();
        EnsRubrs = new();
        if (EnsProgs.Any())
        {
            curProg = EnsProgs.Where(pl => pl.Id == bropln.Id).FirstOrDefault();
            if (curProg != null)
            {
                //Console.WriteLine($"ICI prog Id : {curProg.Idorg}");
                toChild.curProg = curProg;
                EnsRubrs = curProg.Rubvars.ToList();
                //_rubvarResolver = new RubvarResolver(curProg.Rubvars.ToList());
                var curDivpln = curOrga.Plngens.Where(pl => pl.Id == curProg.Plsdiv).FirstOrDefault();
                if (curDivpln != null)
                {
                    List<Gpdivh> inDivs = await _rendAgres.LoadOrgaPostes();
                    _lsDivs = inDivs?.Where(ud => ud.Ihie == curDivpln.Id && ud.Sidiv == 1).ToList();
                } else
                {
                    _lsDivs = new();
                }
            }
        }
        //Console.WriteLine($"ICI RUBRIQUES : {curProg.Rubvars.Count()}");
    }
    private void trierTiers()
    {
        Console.WriteLine("TRIE Commence");
        if (ImyDiv != 0)
        {
            Console.WriteLine($"TRIE Prepare : {EnsTiers.Count}");
            Imessage = "Preparation de la liste en cours";
            PreTiers = EnsTiers.Where(t => t.Ihie == ImyDiv)
                .OrderByDescending(um => um.Smatri)
                .ToList();
            Imessage = "Liste des tiers prete";
            Console.WriteLine($"TRIE termine : {PreTiers.Count}");
            StateHasChanged();
        }
        Console.WriteLine("TRIE Fini");
    }
    private void GetSelectedTier(Tiersp mytier)
    {
        if (mytier != null)
        {
            _curTier = mytier;
            if (_curTier.Id == 0)
            {
                Imessage = "Le tier doit avoir un service";
                return;
            }
            _currentSession = new PersonEvaluationSession(_curTier.Rowguid, DateTime.Today);
            _currentSession.HydrateInputs(_curTier.Actsaies, _curTier.Resdons);
            _currentSession.LoadFormulaLines(MissionLines);
            //can Input      
        }
    }
    private void GetSelectedRubr(Rubvar myrub)
    {
        //Console.WriteLine($"ENTREE DANS PLN : {curProg.Liba}");
        if (myrub != null)
        {
            _curRub = myrub;
            foreach (var tie in PreTiers)
            {
                var session = new PersonEvaluationSession(tie.Rowguid, DateTime.Today);
                session.HydrateInputs(tie.Actsaies, tie.Resdons);
                session.LoadFormulaLines(MissionLines);
                //can Input;
            }
        }
    }
    private async Task EvaluateSaisie()
    {
        CalcLines.AddRange(_currentSession.Outputs);
        _currentSession.Clear();
        if (autoSave) await OpeSaveAsync();
    }
    private async Task OpeSaveAsync()
    {
        var request = new ResCalcModel
        {
            Opetyp = 1, // saisie
            Sireel = curProg.Tovue,
            Idorg = curOrga.Idorg,
            Idpln = curProg.Id,
            Vperi = toChild.curSesio.Speri,
            Eperi = toChild.curExo.Speri,
            Datope = DateTime.Now,
            Gseq = 1,
            OutLines = CalcLines
        };
        await _cliemanager.SendRequestAsync(
            "AUTHClient",
            HttpMethod.Post,
            "lgauth/savcalcresu",
        request);
        SaveMarked = true;
        ShowSuccess("Résultats enregistrés avec succès.");
        StateHasChanged();
    }



    private void GetSelectedTActs(int orig, Tiersp mytier, Rubvar myrub)
    {
        //LsDaActs = new();
        DateTime sessionDate = Convert.ToDateTime(_curSes.Datses); // session current date
        if (orig == 1 && mytier != null) //personne
        {
            if (mytier.Actsaies.Any())
            {
                var lsRubs = curProg.Rubvars.ToList();

                var icurActs = _curTier.Actsaies
                    .Where(ac => ac.Prowguid == mytier.Rowguid && lsRubs.Any(r => r.Rowguid == ac.Rowguid))
                    //ADJUST LATER
                    // .Where(ac =>
                    //     (ac.Tperi == 0) ||
                    //     (ac.Tperi == 1 && ac.Dfval <= sessionDate) ||
                    //     (ac.Tperi == 2 && ac.Dfval == sessionDate)
                    // )
                    .ToList();
                foreach(var ac in icurActs)
                {
                    var icurRub = curProg.Rubvars.Where(ur => ur.Rowguid == ac.Rowguid).FirstOrDefault();
                    ac.Liba = icurRub.Liba;
                    ac.Abg = icurRub.Abg;
                }
                //LsDaActs = icurActs;
            }
        }
        else if (orig == 2 && myrub != null) //par rubrique
        {
            if (myrub.Id != 0)
            {
                var lsTiers = curOrga.Tiersps.ToList(); //Where(te => te.Idhie == froMenu.Usite).ToList();
                Console.WriteLine($"AVANT RECUP ACTS : {lsTiers.Count}");
                var icurActs = lsTiers
                    .SelectMany(tier => tier.Actsaies)
                    .Where(ac => ac.Rowguid == myrub.Prowguid)  // Filter by selected Rubvar
                    //ADJUST LATER
                    // .Where(ac =>
                    //     (ac.Tperi == 0) ||
                    //     (ac.Tperi == 1 && ac.Dfval <= sessionDate) ||
                    //     (ac.Tperi == 2 && ac.Dfval == sessionDate)
                    // )
                    .ToList();
                foreach (var ac in icurActs)
                {
                    var icurRub = curProg.Rubvars.Where(ur => ur.Rowguid == ac.Rowguid).FirstOrDefault();
                    ac.Liba = icurRub.Liba;
                    ac.Abg = icurRub.Abg;
                }
                //LsDaActs = icurActs;
                //Console.WriteLine($"APRES RECUP ACTS : {LsDaActs.Count}");
            }
        }
        var updated = _curTier.Actsaies.Where(a => !string.IsNullOrEmpty(a.Liba) || !string.IsNullOrEmpty(a.Abg)).ToList();
        Console.WriteLine($"Verified Liba Set : {_curTier.Actsaies.FirstOrDefault().Liba}");
    }

    //manage SAVING
    public async Task EdtAll()
    {
        allEnable = true;
        //EditingRowGuid = Guid.Empty;
    }
    public async Task CncAll()
    { //reload to annul AddObject/UpdateObject/DeleteObjet
        Imessage = "Annulation Operations, patience...";
        allEnable = false;
        //EditingRowGuid = Guid.Empty;
        Imessage = "";
    }
    public async Task SavAll()
    {
        Imessage = "Enregistrement Operations, patience...";
        allEnable = false;
        //EditingRowGuid = Guid.Empty;
        await curODContext.SaveDataAsync();
    }
    //Manage CALCULATION
    private void Opecalc()
    {

    }


    private void PrepOpeSaie(int opt)
    {


        //Resultats => SaieLines
    }
    // private void PrepOpeSaie(int opt)
    // {
    //     //preparation
    //     CalcLines.Clear();
    //     FinPreparer = false;
    //     SaieTiers = PreTiers;
    //     Tiersp mytier = _curTier; //peut etre null si par 2rub 
    //     Rubvar myrub = _curRub; // peut etre nul si par 1tier
    //     if (opt == 1)
    //     { //par personne/_curTier <-- ONE LINE PARSING
    //         foreach (var uru in curProg.Rubvars)
    //         {
    //             var saielines = FormulaParser.ParseFormulaBlock(uru.Frsource, _rubvarResolver);
    //             //_calcService.SetLineTable(saielines);

    //             var parsedLine = saielines.FirstOrDefault(l => l.LineNumber == Convert.ToInt32(uru.Scdrub));
    //             var rubvar = _rubvarResolver.ResolveByScdrub(Convert.ToInt32(uru.Scdrub));

    //             CalcLines.Add(new FormulaLine
    //             {
    //                 Idrub = rubvar?.Idrub ?? 0,
    //                 Scdrub = rubvar?.Scdrub ?? uru.Scdrub,
    //                 Idtie = _curTier.Idtie,
    //                 Liba = rubvar?.Liba ?? "",
    //                 Abg = rubvar?.Abg ?? "",
    //                 Nom = _curTier.Nom,
    //                 Pnom = _curTier.Pnom,
    //                 Formula = parsedLine?.Formula ?? "", // ✅ critical
    //                 Result = "",
    //                 Resaie = ""
    //             });
    //         }
    //     }
    //     if (opt == 2)
    //     { //par rubrique/_curRub --> MULTILINES PARSING
    //         var saielines = FormulaParser.ParseFormulaBlock(_curRub.Frsource, _rubvarResolver);
    //         //_calcService.SetLineTable(saielines);

    //         foreach (var tie in SaieTiers.Where(t => t.Idhie == ImyDiv))
    //         {
    //             foreach (var line in saielines)
    //             {
    //                 var rubvar = _rubvarResolver.ResolveByScdrub(line.LineNumber);

    //                 CalcLines.Add(new FormulaLine
    //                 {
    //                     Idrub = rubvar?.Idrub ?? 0,
    //                     Scdrub = rubvar?.Scdrub ?? line.LineNumber.ToString(),
    //                     Idtie = tie.Idtie,
    //                     Liba = rubvar?.Liba ?? "",
    //                     Abg = rubvar?.Abg ?? "",
    //                     Nom = tie.Nom,
    //                     Pnom = tie.Pnom,
    //                     Formula = line.Formula, // ✅ already parsed
    //                     Result = "",
    //                     Resaie = ""
    //                 });
    //             }
    //         }
    //     }
    //     ///LsDaActs = LsDaActs.ToList();//dans CalcLines
    //     FinPreparer = true;
    //     allEnable = true;
    //     StateHasChanged();
    // }
    //Saisie des lignes dans Saisies
    private async Task SaveCalcLinesAsync(List<OutDataLineStream> calcLines)
    {
        // ✅ Step 1: Evaluate each line using the new service
        // foreach (var line in calcLines)
        // {
        //     _formulaEvalService.EvaluateFormula(line);
        // }

        // ✅ Step 2: Build the request model
        var request = new ResCalcModel
        {
            Opetyp = 1, // saisie
            Sireel = curProg.Tovue,
            Idorg = curOrga.Idorg,
            Idpln = curProg.Id,
            Vperi = toChild.curSesio.Speri,
            Eperi = toChild.curExo.Speri,
            Datope = DateTime.Now,
            Gseq = 1,
            OutLines = calcLines
        };

        // ✅ Step 3: Submit to API
        await _cliemanager.SendRequestAsync(
            "AUTHClient",
            HttpMethod.Post,
            "lgauth/savcalcresu",
            request
        );

        // ✅ Step 4: Notify success
        SaveMarked = true;
        ShowSuccess("Résultats enregistrés avec succès.");
    }

    private async Task CalcAndSaveAsync()
    {
        //CalcLines.Clear();
        //FinPreparer = false;
        //     foreach (var tie in PreTiers.Where(t =>
        // string.Compare(t.Smatri, IdebTier, StringComparison.OrdinalIgnoreCase) >= 0 &&
        // string.Compare(t.Smatri, IfinTier, StringComparison.OrdinalIgnoreCase) <= 0))
        //     {
        CalcLines.Clear();
            var session = new PersonEvaluationSession(_curTier.Rowguid, DateTime.Today);
            session.HydrateInputs(_curTier.Actsaies, _curTier.Resdons);
            session.LoadFormulaLines(MissionLines);
            session.Evaluate();
            CalcLines.AddRange(session.Outputs); // Collect results
            session.Clear();
        //}
        if (autoSave)
        {
            var request = new ResCalcModel
            {
                Opetyp = 1, // saisie
                Sireel = curProg.Tovue,
                Idorg = curOrga.Idorg,
                Idpln = curProg.Id,
                Vperi = toChild.curSesio.Speri,
                Eperi = toChild.curExo.Speri,
                Datope = DateTime.Now,
                Gseq = 1,
                OutLines = CalcLines
            };
            await _cliemanager.SendRequestAsync(
                "AUTHClient",
                HttpMethod.Post,
                "lgauth/savcalcresu",
            request);
            SaveMarked = true;
            ShowSuccess("Résultats enregistrés avec succès.");
            StateHasChanged();
        }
        else
        {
            CalcMarked = true;
        }
    }
    private async Task SaveResultAsync()
    {
        if (CalcMarked)
        {
            var request = new ResCalcModel
            {
                Opetyp = 1, // saisie
                Sireel = curProg.Tovue,
                Idorg = curOrga.Idorg,
                Idpln = curProg.Id,
                Vperi = toChild.curSesio.Speri,
                Eperi = toChild.curExo.Speri,
                Datope = DateTime.Now,
                Gseq = 1,
                OutLines = CalcLines
            };
            await _cliemanager.SendRequestAsync(
                "AUTHClient",
                HttpMethod.Post,
                "lgauth/savcalcresu",
            request);
            SaveMarked = true;
            CalcMarked = false;
        }
    }
    private void ShowSuccess(string message)
    {
        Imessage = message;
        // You can also implement a more sophisticated notification system if needed
    }
    // private async Task SubmitCalcLinesAsync(List<FormulaLine> calcLines)
    // {
    //     // ✅ Step 1: Evaluate all formulas
    //     foreach (var line in calcLines)
    //     {
    //         _formulaEvalService.EvaluateFormula(line);
    //     }

    //     // ✅ Step 2: Build request model
    //     var request = new ResCalcModel
    //     {
    //         Opetyp = 1, // saisie
    //         Sireel = curProg.Tovue,
    //         Idorg = curOrga.Idorg,
    //         Idpln = curProg.Id,
    //         Vperi = toChild.curSesio.Speri,
    //         Eperi = toChild.curExo.Speri,
    //         Datope = DateTime.Now,
    //         Gseq = 1,
    //         Lines = calcLines
    //     };

    //     // ✅ Step 3: Submit to API
    //     await _cliemanager.SendRequestAsync(
    //         "AUTHClient",
    //         HttpMethod.Post,
    //         "lgauth/savcalcresu",
    //         request
    //     );

    //     // ✅ Step 4: Notify success
    //     ShowSuccess("Résultats enregistrés avec succès.");
    // }
    // private async Task TiersEnregistrement()
    // {
    //     // ✅ Evaluate all prepared lines
    //     _calcService.SetLineTable(CalcLines); // for iXXXX resolution
    //     _calcService.EvaluateAll(CalcLines, _rubvarResolver);
    //     // ✅ Prepare request model
    //     var reqModel = new ResCalcModel
    //     {
    //         Opetyp = 1, // saisie
    //         Sireel = curProg.Tovue,
    //         Idorg = curOrga.Idorg,
    //         Idpln = curProg.Id,
    //         Vperi = toChild.curSesio.Speri,
    //         Eperi = toChild.curExo.Speri,
    //         Datope = DateTime.Now,
    //         Gseq = 1,
    //         InLines = CalcLines,
    //         OutLines = new()
    //     };

    //     // ✅ Send to API
    //     await _cliemanager.SendRequestAsync("AUTHClient", HttpMethod.Post, "lgauth/savcalcresu", reqModel);
    // }
    private async Task ValidSaieAsync()
    {
        try
        {
            //await _entityManager.SaveChanges(); // Specify type argument here
        }
        catch (Exception ex)
        {
            // Handle error (e.g., show error message)
        }
    }
    private void ToggleFiltering()
    {
        isFilteringEnabled = !isFilteringEnabled;
    }
    private async Task PrintFiche()
    {
        Actdet myedt = new();
        //var asi = myedt.Idrub;

        await _jsRun.InvokeVoidAsync("printForm", ".print-area");
    }  
}