<h3>Postbrou</h3>

@code {
    // void BuildRubhieMap()
    // {MyGPlans
    //     rubhieMap.Clear();
    //     foreach (var pln in MyGPlans)
    //     {
    //         foreach (var rub in pln.Rubhies)
    //         {
    //             rubhieMap[rub.Rowguid] = rub;
    //         }
    //     }
    // }
    //     private Dictionary<Guid, ObservableCollection<Rubpst>> postesMap = new();

    //     private IEnumerable<Rubpst> GetPostes(Rubhie parent)
    //     {
    //         if (parent == null || parent.Rowguid == Guid.Empty)
    //             return Enumerable.Empty<Rubpst>();

    //         return postesMap.TryGetValue(parent.Rowguid, out var list) ? list : Enumerable.Empty<Rubpst>();
    //     }

    //     void AddPoste(Rubhie parent)
    //     {
    //         var idgrow = parent.Rowguid;
    //         if (idgrow == Guid.Empty || curOrga == null || IMyPlan == 0 || !allEnable)
    //         {
    //             Imessage = "REFUS, Plan non choisi";
    //             return;
    //         }

    //         Console.WriteLine($"BEFORE nb parent.Rubpsts : {parent.Rubpsts.Count}");

    //         if (!postesMap.ContainsKey(idgrow))
    //             postesMap[idgrow] = new ObservableCollection<Rubpst>();
    //         if (!postesMap.ContainsKey(idgrow))
    //             postesMap[idgrow] = new ObservableCollection<Rubpst>();
    //         var nextZon = parent.Rubpsts.Any() ? parent.Rubpsts.Max(p => p.Idzon) + 1 : 10;
    //         var newPoste = new Rubpst
    //         {
    //             Rowguid = Guid.NewGuid(), //unique
    //             Idhie = parent.Idhie,
    //             Padres = "555556",
    //             Scdrub = parent.Scdrub,
    //             Idzon = nextZon,
    //             Zcdrub = nextZon.ToString(),
    //             Zucdrub = $"{parent.Scdrub}Z{nextZon}",
    //             Eta = -1
    //         };
    //         Console.WriteLine($"before updatedList");
    //         var updatedList = postesMap[idgrow];
    //         //parent.Rubpsts = new DataServiceCollection<Rubpst>(updatedList);
    //         //parent.Rubpsts = curODContext.CreateTrackedCollection(postesMap[idgrow], "Rubpsts");
    //         Console.WriteLine($"after updatedList");
    //         Console.WriteLine($"✅ Adding newPoste to postesMap[{idgrow}]");
    //         postesMap[idgrow].Add(newPoste); // ✅ Add before reassigning

    //         Console.WriteLine($"📦 postesMap count: {postesMap[idgrow].Count}");


    //         parent.Rubpsts = new DataServiceCollection<Rubpst>(
    //     curODContext.Context,
    //     postesMap[idgrow],
    //     TrackingMode.AutoChangeTracking,
    //     "Rubpsts",
    //     null,
    //     null
    // );
    //         Console.WriteLine($"AFTER nb parent.Rubpsts : {parent.Rubpsts.Count}");
    //         StateHasChanged(); // Ensure UI refresh
    //     }
    //     private void BeginEdit(Rubpst item)
    //     {
    //         try
    //         {
    //             Console.WriteLine($"beginEdit before : {item.Idpst} et {item.Rowguid}");
    //             if (EditingRowGuid != null)
    //                 return; // prevent concurrent edits
    //             Console.WriteLine($"beginEdit after : {item.Idpst} et {item.Rowguid}");
    //             if (!_originalSnapshots.ContainsKey(item.Rowguid))
    //             {
    //                 _originalSnapshots[item.Rowguid] = Clone(item);
    //             }
    //             EditingRowGuid = item.Rowguid;
    //             Console.WriteLine($"beginEdit editing row Guid : {EditingRowGuid}");
    //         }
    //         catch (Exception ex)
    //         {
    //             Console.WriteLine($"issue in beginEdit : {ex.Message}");
    //         }
    //     }
    //     private async Task SaveEdit(Rubpst item)
    //     {
    //         if (item.Eta == -1)
    //         {
    //             curODContext.EnsureDetached(item);
    //             curODContext.AddObject("Rubpsts", item);
    //         }
    //         else
    //         {
    //             curODContext.UpdateObject(item);
    //         }
    //         ////await curODContext.SaveChangesAsync();
    //         item.Eta = 0; // mark as saved
    //         EditingRowGuid = null;
    //     }
    //     private void CancelEdit(Rubhie parent, Rubpst item)
    //     {
    //         var idgrow = parent.Rowguid;
    //         if (!postesMap.TryGetValue(idgrow, out var posteList))
    //             return;

    //         bool isNewDraft = item.Eta == -1;

    //         if (!isNewDraft && !_originalSnapshots.ContainsKey(item.Rowguid))
    //         {
    //             Console.WriteLine($"⚠️ No snapshot found for Rowguid: {item.Rowguid}. Skipping restore.");
    //         }
    //         if (isNewDraft)
    //         {
    //             posteList.Remove(item);
    //             // ✅ Sync parent.Rubpsts if used elsewhere
    //             var updatedList = new ObservableCollection<Rubpst>(posteList);
    //             postesMap[idgrow] = updatedList;
    //             parent.Rubpsts = new DataServiceCollection<Rubpst>(updatedList);

    //             Console.WriteLine("🔁 postesMap reassigned and parent.Rubpsts synced");
    //         }
    //         else if (_originalSnapshots.TryGetValue(item.Rowguid, out var original))
    //         {
    //             Console.WriteLine($"🔄 Restoring snapshot for Rowguid: {item.Rowguid}");

    //             item.Rowguid = original.Rowguid;
    //             item.Idhie = original.Idhie;
    //             item.Padres = original.Padres;
    //             item.Scdrub = original.Scdrub;
    //             item.Idzon = original.Idzon;
    //             item.Zcdrub = original.Zcdrub;
    //             item.Zucdrub = original.Zucdrub;
    //             item.Eta = original.Eta;
    //             // Restore other fields as needed
    //         }

    //         EditingRowGuid = null;

    //         Console.WriteLine($"🧼 Snapshot cleanup. Count before: {_originalSnapshots.Count}");
    //         _originalSnapshots.Remove(item.Rowguid);
    //         Console.WriteLine($"✅ Snapshot removed. Count after: {_originalSnapshots.Count}");

    //         StateHasChanged(); // 🔔 Notify Blazor to re-render
    //     }
    //     private void PromptDelete(Rubpst item)
    //     {
    //         ConfirmingDeleteRowGuid = item.Rowguid;
    //     }

    //     private void CancelDelete()
    //     {
    //         ConfirmingDeleteRowGuid = null;
    //     }
    //     void ConfirmDelete(Rubpst row)
    //     {
    //         if (row == null)
    //             return;

    //         var isDraft = row.Eta == -1;
    //         var parent = FindParent(row);
    //         var idgrow = parent?.Rowguid ?? Guid.Empty;

    //         if (parent == null || idgrow == Guid.Empty)
    //         {
    //             Imessage = "❌ Cannot resolve parent for deletion.";
    //             return;
    //         }

    //         if (!postesMap.TryGetValue(idgrow, out var posteList))
    //         {
    //             Imessage = "❌ postesMap missing for parent.";
    //             return;
    //         }

    //         Console.WriteLine($"🧹 ConfirmDelete: Rowguid={row.Rowguid}, Eta={row.Eta}, Idgrow={idgrow}");

    //         if (isDraft)
    //         {
    //             // Remove from local collection only
    //             posteList.Remove(row);
    //             postesMap[idgrow] = new ObservableCollection<Rubpst>(posteList); // 🔁 force rebind

    //             parent.Rubpsts = new DataServiceCollection<Rubpst>(
    //                 curODContext.Context,
    //                 postesMap[idgrow],
    //                 TrackingMode.AutoChangeTracking,
    //                 "Rubpsts",
    //                 null,
    //                 null
    //             );
    //             var descriptor = curODContext.Context.GetEntityDescriptor(row);
    //             if (descriptor != null)
    //             {
    //                 curODContext.Context.Detach(row); // 💥 ensures it's fully untracked
    //             }
    //             Imessage = "✅ Draft row removed";
    //             StateHasChanged();
    //             return;
    //         }

    //         // Persisted row: proceed with OData delete
    //         try
    //         {
    //             if (curODContext.Context.GetEntityDescriptor(row) != null)
    //             {
    //                 curODContext.Context.DeleteObject(row);
    //             }

    //             posteList.Remove(row);
    //             postesMap[idgrow] = new ObservableCollection<Rubpst>(posteList); // 🔁 force rebind

    //             parent.Rubpsts = new DataServiceCollection<Rubpst>(
    //                 curODContext.Context,
    //                 postesMap[idgrow],
    //                 TrackingMode.AutoChangeTracking,
    //                 "Rubpsts",
    //                 null,
    //                 null
    //             );
    //             var descriptor = curODContext.Context.GetEntityDescriptor(row);
    //             if (descriptor != null)
    //             {
    //                 curODContext.Context.Detach(row); // 💥 ensures it's fully untracked
    //             }
    //             Imessage = "✅ Row deleted";
    //             StateHasChanged();
    //         }
    //         catch (Exception ex)
    //         {
    //             Imessage = $"❌ Delete failed: {ex.Message}";
    //         }
    //     }
    //     List<Rubhie> allRubhies;
    //     Rubhie FindParent(Rubpst row)
    //     {
    //         if (row == null || row.Idhie == 0)
    //             return null;

    //         return rubhieMapByIdhie.TryGetValue(Convert.ToInt32(row.Idhie), out var parent) ? parent : null;
    //     }
    // void CleanupAfterDelete(Rubpst row)
    // {
    //     var descriptor = curODContext.Context.GetEntityDescriptor(row);
    //     if (descriptor != null)
    //         curODContext.Context.Detach(row);

    //     SelectedRubpst = null;
    //     EditingRubpst = null;

    //     StateHasChanged();
    // }
    //Dictionary<int, Gsgfix> draftRows = new Dictionary<int, Gsgfix>();
    //Dictionary<int, Gsgfix> modifiedRows = new Dictionary<int, Gsgfix>();
}
