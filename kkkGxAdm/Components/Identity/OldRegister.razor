@page "/oldregister"
@using System
@using System.Text
@using System.ComponentModel.DataAnnotations
@using System.Reflection
@using GxAdm.Services
@using GxWapi.DaModels
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.AspNetCore.Components.Forms
@using GxShared.GlobModels
@using System.Text.Json

@inject IHttpClientFactory httpfacClient
@inject NavigationManager _navmanager

<PageTitle>Register</PageTitle>

<h1>Register</h1>

@if (errors == true)
{
    foreach (var error in errorList)
    {
        <div class="alert alert-danger">@error</div>
    }
}
@if (success == true)
{
    <div class="alert alert-success">@successmsg</div>
}
<AuthorizeView>
    <Authorized>
        <div class="alert alert-success">You're already logged in as @context.User.Identity?.Name.</div>
    </Authorized>
    <NotAuthorized>
        <EditForm Context="regform" Model="regModel">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div>
                <label for="raison">Raison:</label>
                @if (_siProprio)
                {
                    <InputText id="raison" required @bind-Value="regModel.Raison" />
                } else
                {
                    <label class="bg-danger bg-opacity-10">@regModel.Raison</label>
                }
            </div>
            <div>
                <label for="sigle">Sigle:</label>
                @if (_siProprio)
                {
                    <InputText id="sigle" required @bind-Value="regModel.Stsigle" />
                } else
                {
                    <label class="bg-danger bg-opacity-10">@regModel.Stsigle</label>
                }
            </div

            <div>
                <label>-----</label>
            </div>
            @if (success == false) {
                <div>
                    <label>Pseudo(caract.minus. : 6min15maxi):</label>
                </div>
                <div>
                    <InputText id="ouname" required @bind-Value="regModel.Username" />
                    <ValidationMessage For="@(() => regModel.Username)" />
                </div>
                <div>
                    <label for="phone">Phonenumber:</label>
                    <InputText id="phone" required @bind-Value="regModel.Phonenumber" placeholder="phonenumber" />
                    <ValidationMessage For="@(() => regModel.Phonenumber)" />
                </div>
                <div>
                    <label for="email">Email:</label>
                    @if (_siAllManager)
                    {
                        <label class="bg-danger bg-opacity-10">@regModel.Email</label>
                    }
                    else
                    {
                        <InputText id="email" @bind-Value="regModel.Email" placeholder="email" />
                        <ValidationMessage For="@(() => regModel.Email)" />
                    }
                </div>
                <div>
                    <label>-----</label>
                </div>
                <div>
                    <label for="onom">Nom:</label>
                    <InputText id="onom" required @bind-Value="regModel.Nom" />
                </div>
                <div>
                    <label for="opnoms">Prenom(s):</label>
                    <InputText id="opnoms" required @bind-Value="regModel.Pnom" />
                </div>
                <div>
                    <label for="Srole">Role:</label>
                    <label class="bg-danger  bg-opacity-10" id="Toqsrole">@regModel.Tqsrole</label>
                </div>
                <div>
                    <label for="ppays">Pays:</label>
                    @if (_myCatal != null)
                    {
                        if (_myCatal.countries != null && _myCatal.countries.Count > 0)
                        {
                            <select id="ppays" @bind="regModel.CdePays" disabled>
                                @foreach (var utp in _myCatal.countries)
                                {
                                    <option value="@utp.Elea">@utp.Liba</option>
                                }
                            </select>
                        }
                        else
                        {
                            <p>pas de pays</p>
                        }
                    }
                    else
                    {
                        <p>Loading...</p>
                    }
                </div>
                <div>
                    <label for="plang">Langue:</label>
                    @if (_myCatal != null)
                    {
                        if (_myCatal.langues != null && _myCatal.langues.Count > 0)
                        {
                            <select id="plang" @bind="regModel.Glang">
                                @foreach (var utp in _myCatal.langues)
                                {
                                    <option value="@utp.Abg">@utp.Liba</option>
                                }
                            </select>
                        } else
                        {
                            <p>pas de langue</p>
                        }
                    }
                    else
                    {
                        <p>Loading...</p>
                    }
                </div>
                <div>
                    <label for="password">Password:</label>
                    <InputText id="password" required @bind-Value="_password" />
                </div>
                <div>
                    <label for="confirmpassword">Confirm Password:</label>
                    <InputText id="confirmpassword" required  @bind-Value="_confirmPassword" />
                </div>
                <div>
                    @if (isLoading)
                    {
                        <p>Registring (PATIENCE!...)</p>
                    } else
                    {
                    <div>Enregistrez-vous pour @regModel.Idorg</div>
                        <button class="btn btn-primary" type="submit" @onclick="DoRegisterAsync">
                            Register
                        </button>    
                    }
                </div>
            }else
            {
                <div class="alert alert-success">@successmsg</div>
            }
        </EditForm>
    </NotAuthorized>
</AuthorizeView>

@code {
    private bool isLoading = false, errors = false, success = false;
    private string successmsg = "";
    private List<string> errorList = new List<string>();

    private string _password = "", _confirmPassword="";
    private string UserLogged = "";
    private Mytable _myCatal = new Mytable()
        {
            langues = new List<Eltable>(),
            domas = new List<Eltable>(),
            sites = new List<Eltable>(),
            countries = new List<Eltable>(),
            regions = new List<Eltable>(),
            paiements = new List<Eltable>(),
            etapes = new List<Eltable>(),
            statuts = new List<Eltable>()
        };
    private RegisterModel regModel = new RegisterModel();
   
    private HttpClient _logClient;
    private HttpClient _dftClient;
    private bool _siAllManager = false;
    private bool _siProprio = false;
    protected override async Task OnInitializedAsync()
    {
        var testbaseAddress = _navmanager.BaseUri.TrimEnd('/');
        Console.WriteLine($"BASEURI is {testbaseAddress}");
        errors = false; success = false; successmsg = ""; isLoading = false;
        regModel.IsPret = false;
        _myCatal = new Mytable();
        _logClient = httpfacClient.CreateClient("OFFLClient");
        _dftClient = httpfacClient.CreateClient("DefaultClient");
        //var uri = navmanager.ToAbsoluteUri(navmanager.Uri);
        //Console.WriteLine("Entree de registration:");
        _myCatal = await _dftClient.GetFromJsonAsync<Mytable>("gdata/tables.json");
        //Console.WriteLine(jsdata);
        Console.Write("Zone table");
        //Console.WriteLine(_myCatal.First().domas.F().Liba);
        await RendsQueryString();
        //return mdData;
        //yCatal = //await myauthenprov.RendClieTbls();
    }
    public async Task DoRegisterAsync()
    {
        errors = false; success = false; isLoading = true;
        //email required//owner-siset/free others
        if (_siAllManager)
        {
            if (string.IsNullOrWhiteSpace(regModel.Email))
            {
                errors = true;
                errorList.Add("Email is required.");
                isLoading = false;
                return;
            } else
            {
                var normalizedEmail = regModel.Email.ToUpperInvariant();
                if (normalizedEmail == null)
                {
                    errors = true;
                    errorList.Add("Email contains inacceptable characters.");
                    isLoading = false;
                    return;
                }
            }
        }
        //regModel.Username = regModel.Email ?? regModel.Phonenumber;
        //si par email ou phonenumber
        if (string.IsNullOrWhiteSpace(_password))
        {
            errors = true;
            errorList.Add("Password is required.");
            isLoading = false;
            return;
        }
        if (string.IsNullOrWhiteSpace(regModel.Username))
        {
            errors = true;
            errorList.Add("Username is required.");
            isLoading = false;
            return;
        }
        if (string.IsNullOrWhiteSpace(_confirmPassword))
        {
            errors = true;
            errorList.Add("Please confirm your password.");
            isLoading = false;
            return;
        }

        if (_password != _confirmPassword)
        {
            errors = true;
            errorList.Add("Passwords don't match.");
            isLoading = false;
            return;
        }
        if (string.IsNullOrWhiteSpace(regModel.Raison))
        {
            errors = true;
            errorList.Add("Raison est obligatoire.");
            isLoading = false;
            return;
        }
        regModel.Password = _password;
        regModel.ConfirmPassword = _confirmPassword;
        if (string.IsNullOrEmpty(regModel.DeqEmail))
        {
            errors = true;
            errorList.Add("Probleme a la commande Email vendeur.");
            isLoading = false;
            return;   
        }
        bool sibien = await VerifConcordances(regModel); //IsPret
        if (regModel.IsPret)
        {// tout Ok declenche enregistrement par Acct
            try
            {
                Console.WriteLine("PARTI POUR ENREGISTREMENT");
                //recuperer baseAddress of the blazor
                var baseAddress = _navmanager.BaseUri.TrimEnd('/');
                regModel.BlzAddress = baseAddress;
                var response = await _logClient.PostAsJsonAsync("lgauth/register", regModel, CancellationToken.None);
                if (response.IsSuccessStatusCode)
                {
                    var usrdata = await response.Content.ReadFromJsonAsync<LoginResult>();
                    if (usrdata != null)
                    {
                        Console.WriteLine($"retour Email Enreg : {usrdata.Succeeded}");
                        Console.WriteLine($"all returned userdata : {usrdata}");
                        UserLogged = regModel.Email;
                        // SndmModel sdmInfo = new SndmModel();
                        // sdmInfo.TypMail = 2;
                        // sdmInfo.MailTo = regModel.DeqEmail; //email inviteur
                        // sdmInfo.MailSubject = "Achat ou Inscription";
                        // sdmInfo.MailBody = "nouveau acheteur, un acheteur/" + regModel.Email;

                        //errorList = [];
                        successmsg = "SUCCES...Consultez votre boite email pour confirmation de votre enregistrement sur le siteweb du logiciel."; 
                        success = true; isLoading = false; errors = false;
                        return;
                        //_navmanager.NavigateTo("/");
                    }
                    else
                    {
                        successmsg = "";
                        errorList.Add("31ECHEC ENREGISTREMENT!... (le mot de passe : au moins 6 caracteres, au moins un caractere en minuscule, un caractere special comme @, un caractere majuscule, un chiffre...) Re-essayez/support.");
                        errors = true; success = false;
                        Console.WriteLine("VERS VERS 17");
                        isLoading = false;
                        return;
                    }
                }
                else
                {
                    successmsg = "";
                    errorList.Add("32ECHEC ENREGISTREMENT!... (le mot de passe : au moins 6 caracteres, au moins un caractere en minuscule, un caractere special comme @, un caractere majuscule, un chiffre...) Re-essayez/support.");
                    var usrdata = await response.Content.ReadFromJsonAsync<LoginResult>();
                    if (usrdata != null)
                    {
                        foreach (var era in usrdata.ErrList)
                        {
                            errorList.Add(era);
                        }
                    }
                    errors = true; success = false;
                    Console.WriteLine($"VERS VERS 18 {errorList}");
                    isLoading = false;
                    return; 
                }
            }catch(Exception ex)
            {
                successmsg = "";
                errorList.Add($"Remplissage formulaire peu concordant. {ex.Message}");
                errors = true; success = false;
                Console.WriteLine("VERS VERS 19");
                isLoading = false;
                return;
            }
        } else
        {
            successmsg = "";
            errorList.Add($"3z!... Error.");
            errors = true; success = false;
            isLoading = false;
            return;
        }
        //StateHasChanged();
    }

    public async Task RendsQueryString()
    {
        var niv = 0;
        try {
            var uri = _navmanager.ToAbsoluteUri(_navmanager.Uri);
            regModel.CodInvit = uri.ToString();
            var inqry = uri.Query;
            //decode A
            var outquery = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
            Console.WriteLine($" query out : {outquery}");
            Dictionary<string, string> queryParams = new Dictionary<string, string>();
            if (outquery.TryGetValue("cdlnk", out var encodlnk))
            {
                var bytes = WebEncoders.Base64UrlDecode(encodlnk);
                var query = Encoding.UTF8.GetString(bytes);
                queryParams = query
                    .Split('&')
                    .Select(pair => pair.Split('='))
                    .Where(keyValue => keyValue.Length == 2)
                    .ToDictionary(keyValue => Uri.UnescapeDataString(keyValue[0]), keyValue => Uri.UnescapeDataString(keyValue[1]));

                Console.WriteLine($" query in : {query} queryParams : {queryParams}");
                regModel.ICoda = queryParams["icoda"];
                Console.WriteLine($"RECU CODE : {regModel.ICoda}");
                DateTime.TryParse(queryParams["datcde"], out DateTime cddate);
                regModel.Datope = cddate;
                int.TryParse(queryParams["orig"], out int IntQry);
                regModel.Orig = IntQry;
                regModel.Tqsrole = queryParams["tqsrole"];
                regModel.Nom = queryParams["toqnom"];
                regModel.Pnom = queryParams["toqpnoms"];
                regModel.Raison = queryParams["straison"];
                regModel.Stsite = queryParams["stsite"];
                regModel.Stdoma = queryParams["stdoma"];
                regModel.Stsigle = queryParams["stsigle"];
                
                regModel.Deqid = queryParams["deqid"];
                regModel.DeqEmail = queryParams["deqmail"];
                regModel.DeqPhone = queryParams["deqphone"];
                regModel.DeqUname = queryParams["dequname"];
                regModel.DeqNom = queryParams["deqnom"];
                regModel.DeqPnom = queryParams["deqpnom"];
                
                regModel.Email = queryParams["toqmail"];
                regModel.Phonenumber = queryParams["phone"];
                regModel.Glang = queryParams["toqlang"];
                regModel.Dqsrole = queryParams["dqsrole"];

                int.TryParse(queryParams["ivorga"], out IntQry);
                regModel.Idorg = IntQry;
                int.TryParse(queryParams["dequi"], out IntQry);
                regModel.Dequi = IntQry;
                _siAllManager = false;
                if (regModel.Dequi <= 3)
                {
                    _siAllManager = true;
                }
                int.TryParse(queryParams["toqui"], out IntQry);
                regModel.Toqui = IntQry;
                regModel.Utyp = IntQry;
                //int.TryParse(queryParams["typadm"], out IntQry);
                ///regModel.Atyp = IntQry;
                niv = 2;
                //regModel.Toqid = query["toqid"];
                int.TryParse(queryParams["opays"], out IntQry);
                regModel.CdePays = IntQry;
                int.TryParse(queryParams["typtie"], out IntQry);
                regModel.Utyp = IntQry;
                int.TryParse(queryParams["tqirole"], out IntQry);
                regModel.Tqirole = IntQry;
                regModel.Siowner = false;
                _siProprio = false;
                int.TryParse(queryParams["isowner"], out IntQry);
                if (IntQry == 1)
                {
                    regModel.Siowner = true;
                    _siProprio = true;
                }
                int.TryParse(queryParams["tysite"], out IntQry);
                regModel.Site = IntQry;

                int.TryParse(queryParams["tydoma"], out IntQry);
                regModel.Doma = IntQry;
                niv = 3;
                int.TryParse(queryParams["methp"], out IntQry);
                regModel.Methp = IntQry;
                int.TryParse(queryParams["isowner"], out IntQry);
                regModel.Siowner = false;
                regModel.Atyp = 0;
                if (IntQry == 1)
                {
                    regModel.Siowner = true;
                    regModel.Atyp = 1;
                }
                int.TryParse(queryParams["hiera"], out IntQry);
                regModel.Idhie = IntQry;
                int.TryParse(queryParams["nbalea"], out IntQry);
                regModel.Nbalea = IntQry; //nbalea = 11013946 & verif = kUlrubRm
                niv = 4;
            }
        } catch(Exception ex)
        {
            Console.Write("mon ex erreur");
            Console.WriteLine(ex.Message);
            isLoading = false;
        }
        finally
        {
            Console.Write("fin");
            Console.WriteLine(niv);
            isLoading = false;
        }
    }
    private async Task<bool> VerifConcordances(RegisterModel regModel)
    {
        regModel.IsPret = true;
        
        return true;
    }
    //dqirole
    //dqsrole
    //tqirole
    //tosrole;
    //toqlang
    //typtie
    //straison
    //ivorga
    //tydoma
    //stdoma
    //verif
}