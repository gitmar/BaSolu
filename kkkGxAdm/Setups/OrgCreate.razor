@page "/orgcreate"

@using System
@using System.Text
@using System.ComponentModel.DataAnnotations
@using System.Reflection
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.AspNetCore.Components.Forms
@using GxAdm.Services
@using GxShared.GlobModels
@using Newtonsoft.Json
@using GxShared.Services
@* @using SQLitePCL *@

@inject IConfiguration _Iconfig
@inject HttpClientService _cliemanager
@inject NavigationManager _navmanager
@inject LinkSerialiser _linkSerialiser
@inject IJSRuntime _jsRun

<PageTitle>OrgCreate</PageTitle>

<h2>Creation Institution</h2>
@if (yaerrors)
{
    foreach (var error in errorList)
    {
        <div class="alert alert-danger">@error</div>
    }
}

@* <AuthorizeView>
    <Authorized>
        <div class="alert alert-success">You're already logged in as @_invModel.Username</div>
    </Authorized>
    <NotAuthorized>
 *@
<EditForm Context="regform" Model="_invModel">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div class="container">
        <div class="row mb-2">
            message :
            @if (!string.IsNullOrEmpty(Imessage))
            {
                <label style="font-weight: bold; color: red; background-color: yellow;">@Imessage</label>
            }
        </div>
        <div class="row mb-2">
            <div class="col-3">
                <label>Code Institution:</label>
            </div>
            <div class="col-2">
                <label class="text-left"><b>@_invModel.Idorg/(@_invModel.Iqmax)</b></label>
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-2">
                <label for="raison">Raison</label>
            </div>    
            <div class="col-6">
                <InputText @bind-Value="@_invModel.Raison">
                </InputText>
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-2">
            <label for="raison">Sigle</label>
            </div>
            <div class="col-3">
                <InputText @bind-Value="@_invModel.Sigle">
                </InputText>
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-2">
                <label for="toweb">website:</label>
            </div>
            <div class="col-5">
                <label class="fw-bold">@_invModel.Weburl</label>
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-2">
                <label for="toweb">domaine:</label>
            </div>
            <div class="col-3">
                <label class="fw-bold">@stDoma</label>
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-2">
                <label for="idorg">Candidats:</label>
            </div>
            <div class="col-5">
                <InputSelect id="idorg" @bind-Value="_invModel.Userid" class="form-control">
                    @foreach (var uad in LsAdmins)
                    {
                        <option value="@uad.Usrid" @onclick="() => SelectAdmin(uad)">@uad.Fullnom</option>
                    }
                </InputSelect>
            </div>
        </div>
            <div class="row mb-2">
                <div class="col-3">
                    <label for="opseudo">Pseudo/Email :</label>
                </div>
                <div class="col-3">
                    <label class="fw-bold">@_invModel.Username</label>
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-3">
                    <label for="phone">No Phone:</label>
                </div>
                <div class="col-3">
                    <label class="fw-bold">@_invModel.Phonenumber</label>
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-2">
                    <label for="onom">User Id:</label>
                </div>
                <div class="col-7">
                    <label class="fw-bold">@_invModel.Userid</label>
                </div>
            </div>
            @* @if (isInstallable)
            { *@
        <div class="row mb-2">
            <div class="col-8">
                <button class="btn btn-primary btn-sm" style="font-weight: bold; color: yellow;" @onclick="() => CreateCustOrga()">
                    ➕ Installer Institution Complementaire
                </button>
            </div>
        </div>
    </div>
 </EditForm>

@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public string cdlink { get; set; }

    private bool isLoading = false, yaerrors = false;
    private string successmsg = "";
    private List<string> errorList = new();
    private string stDoma = "";
    //recu de Qry
    private int iorig = 0, noerror = 0;
    private string errmess = "";
    private string Imessage = "", erames = "", erames2 = "", erames3 = "";

    //private HttpClient _apiClient;
    //private HttpClient _locClient;
    //private TableSet _myCatal = new();
    //private BackModel _retModel = new();
    private UsrOgSetModel _invModel = new();
    private List<UAdm> LsAdmins = new();
    private Userbag _usrBag = new();
    private string _generatedLink = "";

    private bool isInstallable => _invModel.Email != null && _invModel.Idoma != 0;

    //private List<Customer> LsCustomers = new();
    //private Customer _curCustomer= new();
    //private List<Order> LsOrders = new();
    //private Order _curOrder = new();

    protected override async Task OnInitializedAsync()
    {
        Imessage = ""; 
        successmsg = "";
        isLoading = true;
        yaerrors = false; errorList.Clear();
        //apistate
        var response = await _cliemanager.SendRequestAsync("AUTHClient", HttpMethod.Get, "usercontext/apistate");
        var result = JsonConvert.DeserializeObject<ResgnModel>(response);
        if (result == null || !result.Succeeded)
        {
            Imessage = Imessage + " Failed to load user context.";
            //errorList = result.ErrList.ToList();
            return;
        }
        _invModel.Idorg = result.FIdorg;
        _invModel.Iqmax = result.Iqmax;
        LsAdmins = result.LsAdms.Where(ua => ua.SiOrga == 0).ToList();
        //_usrBag = await _sessionContext.GetUserbagAsync();
        _invModel.Weburl = _Iconfig["BackendUrl"];
        //pre-filled
        //ModelHelper.CopyMatchingProperties(_invModel, _invModel);
        //ModelHelper.CopyMatchingProperties(_invModel, _invModel);
        yaerrors = false; isLoading = false;
    }
    private void SetupCustOrga()
    {
        if (string.IsNullOrEmpty(_invModel.UsernameOrEmail))
        {
            Imessage = "Pseudo ou Email obligatoire";
            return;
        }
        if (string.IsNullOrEmpty(_invModel.Password) || _invModel.Password.Length < 6)
        {
            Imessage = "Mot de passe obligatoire et plus de 6 caracteres";
            return;
        }
        Imessage = "Installation en cours...";
        var _LinkSerialiser = new LinkSerialiser(_jsRun);
        string baseUrl = _invModel.Weburl;
        baseUrl = baseUrl.TrimEnd('/');
        baseUrl = baseUrl + "/api/usercontext/";
        //regenerer pour Creation Orga
        //_invModel.Idorg = _curOrder.Idorg;
        //_invModel.FbackUrl = _curCustomer.Weburl;
        //Idorg et Userid set
        _invModel.Username = _invModel.UsernameOrEmail;
        //password et usernameoremail is in _invModel
        Console.WriteLine($"combined Model : {_invModel.Password}");
        // TEST
        // // Get the Type of the object
        // Type objectType = _invModel.GetType();
        // PropertyInfo[] properties = objectType.GetProperties();
        // // Iterate through each property
        // foreach (PropertyInfo property in properties)
        // {
        //     // Get the property name
        //     string propertyName = property.Name;
        //     // Get the property value
        //     object propertyValue = property.GetValue(_invModel, null);
        //     // Display the property name and value
        //     Console.WriteLine($"  {propertyName}: {propertyValue}");
        // }

        //✅ main now has all combined values
        _generatedLink = _LinkSerialiser.GenerateLink(_invModel, baseUrl, "startorga");
        _navmanager.NavigateTo(_generatedLink);
    }
    private async Task CreateCustOrga()
    {
        isLoading = true;
        try
        {
            Imessage = "installing...";
            //var aisi = await _localStorage.GetItemAsStringAsync("blazToken");
            //Console.WriteLine($"blazToken : {aisi}");
            //var reqModel = new RegiscorModel();
            //reqModel.Idorg = _usrBag.;
            //reqModel.Usrid = _UserId;
            //reqModel.Orig = 1; //interne
            
            var response = await _cliemanager.SendRequestAsync("AUTHClient", HttpMethod.Post, "usercontext/set2orga", _invModel);
            if (response != null)
            {
                var rspModel = JsonConvert.DeserializeObject<ResgnModel>(response);
                if (rspModel != null)
                {
                    if (rspModel.siDrap == -1)
                    {
                        successmsg = "Installation organisation echoue";
                        //submitmess = "annuler et recommencer";
                        //errors = true;
                        //success = false;
                    }
                    else
                    {
                        //isSet = 1;
                        successmsg = "Organization installed";
                        //submitmess = "termine";
                        //errors = false;
                        //success = true;
                        //peutSortir = true;
                    }
                }
            }
            //isSubmitting = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Echec installation : {ex.Message}");
        }
    }
    private async Task TraitApiErra(int orig, int eror)
    {
        @if (orig == 1) //adm registring
        {
            @switch (eror)
            {
                case 9: //bon
                    erames = "Merci de la confiance que vous avez faite a GX-SOLUTIONS"
                             + " Votre enregistrement est fait.";
                    erames2 = "Vous devez confirmer votre adresse mail a partir du lien"
                             + " recu dans votre boite email."
                             + " pour acceder a votre DOMAINE et continuer.";
                    erames3 = "Ensuite, vous pouvez et devez INSTALLER votre logiciel"
                             + " pour acceder a votre LOGICIEL."
                             + " Consultez votre boite Email, le lien y est egalement.";
                   break;
                case 1: //link
                    erames = "Un probleme est survenu lord de votre enregistrement :"
                              + " Le lien est corrompu.";
                    erames2 = "Re-essayez!";
                    erames3 = "Si ca ne marche pas, veuillez contacte le support.";
                    break;
                case 2: //data
                    erames = "Un probleme est survenu lors de votre enregistrement :"
                              + " Des donnees sont absentes.";
                    erames2 = "Re-essayez!";
                    erames3 = "Si ca ne marche pas, veuillez contacte le support.";
                    break;
                case 3: //deja enreg
                    erames = "Un probleme est survenu lors de votre enregistrement :"
                              + " Des donnees sont absentes.";
                    erames2 = "Re-essayez!";
                    erames3 = "Si ca ne marche pas, veuillez contacte le support.";
                    break;
                case 4: //echec enreg
                    erames = "Un probleme est survenu lord de votre enregistrement:"
                            + " L-enregistrement a echoue.";
                    erames2 = " Veuillez contacter le support";
                    break;
                case 5: //sans jeton

                    break;
                default:
                    erames = "Un probleme inconnu est survenu lors de votre enregistrement :"
                                + " L-enregistrement a echoue.";
                    erames2 = " Veuillez re-essayer ou contacter le support";
                    break;
            }

        }
        @if (orig == 2) //supt registring
        {
            @switch (eror)
            {
                case 9: //bon

                    break;


                default:

                    break;
            }
        }
    }
    private void SelectAdmin(UAdm myAdm)
    {
        _invModel.Userid = myAdm.Usrid;
        _invModel.Nom = myAdm.Fullnom;
        _invModel.Username = myAdm.Username;
        _invModel.Phonenumber = myAdm.Phone;
        //_invModel.Sior = myAdm.SiOrga;
        //cur
    }
}
