@using System.Reflection
@using Microsoft.AspNetCore.Components.Forms
@using GxShared.GlobModels

<!-- TabhieComponent.razor -->
<InputSelect class=" @GetCssClass()" @bind-Value="SelectedValue">
    <option value="">Select @Title</option>
    @foreach (var item in FilteredOptions)
    {
        <option value="@item.Elea">@item.Liba</option>
    }
</InputSelect>
@code {
    [Parameter] public object Obj { get; set; }
    [Parameter] public string PropertyName { get; set; }
    [Parameter] public EventCallback<object> ObjChanged { get; set; }
    [Parameter] public int Zfro { get; set; }
    [Parameter] public List<Gpvar> tbElems { get; set; }
    [Parameter] public string Title { get; set; }
    [Parameter] public int ParentTableValue { get; set; }
    [Parameter] public string Class { get; set; }
    [Parameter] public string Style { get; set; }
    [Parameter] public TextAlignment TextAlign { get; set; } = TextAlignment.Left;
    [Parameter] public Size TextSize { get; set; } = Size.Medium;
    [Parameter] public ControlWidth Width { get; set; } = ControlWidth.Medium;

    private string _selectedValue;
    private IEnumerable<Gpvar> FilteredOptions { get; set; }

    protected override void OnParametersSet()
    {
        _selectedValue = GetCurrentValue();
        FilteredOptions = tbElems?
            .Where(ita => ita.Itb == Zfro && ita.Ydpd == ParentTableValue)
            ?? Enumerable.Empty<Gpvar>();
    }

    private string SelectedValue
    {
        get => _selectedValue;
        set
        {
            if (_selectedValue != value)
            {
                _selectedValue = value;
                SetPropertyValue(value);
            }
        }
    }

    private string GetCurrentValue()
    {
        if (Obj != null && !string.IsNullOrEmpty(PropertyName))
        {
            var prop = Obj.GetType().GetProperty(PropertyName,
                       BindingFlags.Public | BindingFlags.Instance);
            return prop?.GetValue(Obj)?.ToString() ?? "";
        }
        return "";
    }

    private async void SetPropertyValue(string value)
    {
        if (Obj != null && !string.IsNullOrEmpty(PropertyName))
        {
            var prop = Obj.GetType().GetProperty(PropertyName,
                       BindingFlags.Public | BindingFlags.Instance);
            if (prop != null && prop.CanWrite)
            {
                try
                {
                    object convertedValue;
                    var targetType = prop.PropertyType;

                    // Handle nullable types
                    var underlyingType = Nullable.GetUnderlyingType(targetType);
                    if (underlyingType != null)
                    {
                        // If value is null or empty, set to null
                        convertedValue = string.IsNullOrEmpty(value)
                            ? null
                            : Convert.ChangeType(value, underlyingType);
                    }
                    else
                    {
                        convertedValue = Convert.ChangeType(value, targetType);
                    }

                    prop.SetValue(Obj, convertedValue);

                    // Notify parent about change
                    await ObjChanged.InvokeAsync(Obj);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error setting {PropertyName}: {ex.Message}");
                }
            }
        }
        StateHasChanged();
    }
    //CSS class and style
    private string GetCssClass()
    {
        var widthCssClass = Width switch
        {
            ControlWidth.Small => "width-small",
            ControlWidth.Medium => "width-medium",
            ControlWidth.Large => "width-large",
            ControlWidth.Full => "width-full",
            _ => "width-medium"
        };
        var alignmentClass = TextAlign switch
        {
            TextAlignment.Left => "text-start",
            TextAlignment.Center => "text-center",
            TextAlignment.Right => "text-end",
            TextAlignment.Justify => "text-justify",
            _ => "text-start"
        };
        var sizeClass = TextSize switch
        {
            Size.Small => "small-text",
            Size.Medium => "medium-text",
            Size.Large => "large-text",
            _ => "medium-text"
        };

        // Combine widthCssClass with other classes
        return $"{widthCssClass} {alignmentClass} {sizeClass}";
    }
}


@*<select @bind="@SelectedValue" class="form-select">
    <option value="">Select an option</option>
    @foreach (var item in FilteredOptions)
    {
        <option value="@item.Elea">@item.Liba</option>
    }
</select>

@code {
    [Parameter] public object Obj { get; set; }
    [Parameter] public string PropertyName { get; set; }
    [Parameter] public int Zfro { get; set; }
    [Parameter] public List<Gpvar> tbElems { get; set; }
    [Parameter] public int ParentTableValue { get; set; }

    private string _selectedValue;
    private IEnumerable<Gpvar> FilteredOptions { get; set; }

    protected override void OnParametersSet()
    {
        _selectedValue = GetCurrentValue();
        FilteredOptions = tbElems?
            .Where(ita => ita.Itb == Zfro && ita.Ydpd == ParentTableValue)
            ?? Enumerable.Empty<Gpvar>();
    }

    private string SelectedValue
    {
        get => _selectedValue;
        set
        {
            _selectedValue = value;
            SetPropertyValue(value);
        }
    }

    private string GetCurrentValue()
    {
        if (Obj != null && !string.IsNullOrEmpty(PropertyName))
        {
            var prop = Obj.GetType().GetProperty(PropertyName,
                       BindingFlags.Public | BindingFlags.Instance);
            return prop?.GetValue(Obj)?.ToString() ?? "";
        }
        return "";
    }

    private void SetPropertyValue(string value)
    {
        if (Obj != null && !string.IsNullOrEmpty(PropertyName))
        {
            var prop = Obj.GetType().GetProperty(PropertyName,
                       BindingFlags.Public | BindingFlags.Instance);

            if (prop != null)
            {
                try
                {
                    var convertedValue = Convert.ChangeType(value, prop.PropertyType);
                    prop.SetValue(Obj, convertedValue);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error setting {PropertyName}: {ex.Message}");
                }
            }
        }
        StateHasChanged();
    }
}
 *@


