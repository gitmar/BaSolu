@using System.Reflection
@using Microsoft.AspNetCore.Components.Forms

<!-- BoolComponent.razor -->

<InputCheckbox @bind-Value="CurrentBool"
               class="form-check-input"
               @oninput="HandleInput" />

@code {
    [Parameter] public object Obj { get; set; }
    [Parameter] public string PropertyName { get; set; }
    [Parameter] public EventCallback<object> ObjChanged { get; set; }

    private bool _currentBool;

    protected override void OnInitialized()
    {
        CurrentBool = GetCurrentValue();
    }

    protected override void OnParametersSet()
    {
        CurrentBool = GetCurrentValue();
    }

    private async void HandleInput(ChangeEventArgs e)
    {
        CurrentBool = Convert.ToBoolean(e.Value);
        await SetPropertyValue(Obj, PropertyName, CurrentBool);
    }

    public bool CurrentBool
    {
        get => _currentBool;
        set
        {
            if (_currentBool != value)
            {
                _currentBool = value;
                StateHasChanged();
            }
        }
    }

    private bool GetCurrentValue()
    {
        if (Obj == null || string.IsNullOrEmpty(PropertyName))
            return false;
        var prop = Obj.GetType().GetProperty(PropertyName, BindingFlags.Public | BindingFlags.Instance);
        if (prop != null && prop.PropertyType == typeof(bool))
        {
            return (bool)prop.GetValue(Obj);
        }
        return false;
    }

    private async Task SetPropertyValue(object obj, string propName, object val)
    {
        if (obj == null || string.IsNullOrEmpty(propName))
            return;
        var prop = obj.GetType().GetProperty(propName, BindingFlags.Public | BindingFlags.Instance);
        if (prop != null && prop.CanWrite)
        {
            prop.SetValue(obj, val);
            Console.WriteLine($"Bool prop set {propName} to {val}");
            await ObjChanged.InvokeAsync(obj);
        }
        StateHasChanged();
    }
}
