@page "z3iagrmenu"
@inherits LayoutComponentBase
@layout FreeLayout

@using System.Security.Claims
@using BlazorBootstrap
@using Blazored.LocalStorage
@using GxAdm.ClieModels
@using GxAdm.Components.Admina.PRubs
@using GxAdm.Components.Admina.Ictvars
@using GxAdm.Services
@using GxAdm.StaticHelpers
@using GxShared.Sess
@using GxWapi.DaModels
@using Microsoft.OData.Client
@using Newtonsoft.Json

@implements IDisposable

@inject NavigationManager _navManager
@inject ILocalStorageService _localStorage
@inject HttpClientService _clieManager
@inject IODataContextFactory _contextFactory
@inject SessionContextService _sessionContext
@inject RendAgres _rendAgres
@inject PendingChangesGuard _guard
@inject IJSRuntime _JsRUN

@if (isLoading)
{
    <div class="text-center">
        <Spinner Color="SpinnerColor.Primary" Size="SpinnerSize.Large" />
        <p>ASTREINTES/Saisies Loading...</p>
    </div>
}
else
{
    <div class="gx-screen-layout">
        <div class="container gx-parent-container" style="height: 100vh;">
            <div class="d-flex flex-column" style="height: 100%;">
                <!-- Top Menu -->
                <GxNavMenu BrandText="A24soft Gx-Solutions"
                           MenuItems="@MenuItems"
                           YaGroup="false"
                           Groups="@Groupes"
                           MenuSelected="@_chxMenu"
                           MenuSelectedChanged="@SelMenu"
                           GroupSelected="@_chxGpe"
                           GroupSelectedChanged="@SelGpe"
                           OnBack="@NavigateBack" />

                <!-- Main Content -->
                @if (this != null)
                {
                    @if (_chxMenu != 0 && toChild != null && curOrga != null && curODContext != null)
                    {
                        @if (_chxMenu == 1)
                        { //grille
                            <IctGrils @ref="myigrd"
                            toMenu="@_chxMenu"
                            @bind-NbChanges="_nbChanges"
                            _guard="_guard"
                            curOrga="@curOrga"
                            toChild="@toChild"
                            curODContext="@curODContext">
                                <ChildContent>
                                    @*  <h2 class="child-box">Hello STANDARD</h2> *@
                                </ChildContent>
                            </IctGrils>
                        }
                        else if (_chxMenu == 2)
                        { //échéancier
                            <IctEches @ref="myiech"
                            toMenu="@_chxMenu"
                            @bind-NbChanges="_nbChanges"
                            _guard="_guard"
                            curOrga="@curOrga"
                            toChild="@toChild"
                            curODContext="@curODContext">
                                <ChildContent>
                                </ChildContent>
                            </IctEches>
                        }
                        else if (_chxMenu == 3)
                        {  //postes
                            <IctPosts @ref="myipst"
                            toMenu="@_chxMenu"
                            @bind-NbChanges="_nbChanges"
                            _guard="_guard"
                            curOrga="@curOrga"
                            toChild="@toChild"
                            curODContext="@curODContext">
                                <ChildContent>
                                </ChildContent>
                            </IctPosts>
                        }
                        else if (_chxMenu == 4)
                        { //CALCULS
                            //ref="mygclc"
                        }
                    }
                }
            </div>
        </div>
    </div>
    <div class="alert alert-warning d-flex justify-content-between align-items-center py-1 px-2 position-fixed bottom-0 end-0"
         style="background-color: transparent; z-index: 1050; max-width: 400px;">
        <div class="d-flex gap-2 align-items-center">
            <Button class="w-auto flex-grow-0 flex-shrink-0" Color="ButtonColor.Info" @onclick="SaveAllChanges"
                    Enabled="@_guard.HasPendingChanges()">
                Save All (@_guard.GetPendingChangesCount() changes)
            </Button>
            <Button class="w-auto flex-grow-0 flex-shrink-0" Color="ButtonColor.Secondary" @onclick="CancelAllChanges"
                    Enabled="@_guard.HasPendingChanges()">
                Cancel All
            </Button>
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    public MyODataContext curODContext;
    public Gxorga curOrga = new Gxorga();
    public MyShareVars toChild = new();

    private PrubSaie mygsai = new();
    private PrubCalc mygclc = new();
    private PrubVent mygvnt = new();

    private IctGrils myigrd = new();
    private IctEches myiech = new();
    private IctPosts myipst = new();
    private ArubMenu myrmenu = new();

    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }
    public ClaimsPrincipal authUser;

    //menus
    private string strComp = "Grille.SAISIE";
    public List<GxMenuItem> MenuItems = new()
    {
        new GxMenuItem { Id = 1, Text = "Saisie.GRILLE", Icon = "bi bi-box-arrow-in-down" },
        new GxMenuItem { Id = 2, Text = "Saisie.ECHEANCIER", Icon = "bi bi-house-door" },
        new GxMenuItem { Id = 3, Text = "Saisie.POSTES", Icon = "bi bi-house-door" },
        new GxMenuItem { Id = 4, Text = "APlans", Icon = "bi bi-house-door" },
    };
    public List<GxGroupe> Groupes = new();

    public string Imessage = "";
    public Userbag _usrBag = new Userbag();
    public List<Gpfixe> LsFixes = new();
    public List<Gpdivh> LsDivs = new();
    public List<Gpvar> LsVars = new();
    public List<Gplan> LsPlans = new();
    public List<Gpvar> LtTabls = new();
    public List<Gpvar> LsTabls = new();
    private int _gIdTie = 0, _chxGpe = 0, _chxMenu = 1;

    //modal management
    private string SidebarStyle = "width: 200px;";

    //Guard
    private int _nbChanges = 0;
    private IDisposable? _locationHandler;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        try
        {
            var authState = await AuthState;
            if (!authState.User.Identity.IsAuthenticated) return;
            // Load lightweight user data FIRST
            _usrBag = await _sessionContext.GetUserbagAsync();
            _gIdTie = _usrBag.Usorga.Gdtie;
            LsVars = _usrBag.Usorga.Uvars.ToList();
            LsFixes = _usrBag.Ufixes.ToList();
            LsPlans = _usrBag.Usorga.Uplns.Where(pl => pl.Ptyp == 2 || pl.Ptyp == 3 || pl.Ptyp == 4).ToList();
            LtTabls = _usrBag.Usorga.Uvars.Where(tb => tb.Gvars == 4).ToList();
            LsTabls = _usrBag.Usorga.Uvars.Where(tb => tb.Gvars == 5).ToList();
            // Create context
            curODContext = await _contextFactory.CreateAsync();
            _guard.AttachContext(curODContext);
            //var expand1 = "Plngens($expand=Rubvars,Rubhies),Gsgfixes,Gsglnes";
            int key = _usrBag.Idorg;
            string expandPlngens = ODataQueryHelper.Expand<Gxorga, IEnumerable<Plngen>>(o => o.Plngens);
            string expandTiersps = ODataQueryHelper.Expand<Gxorga, IEnumerable<Tiersp>>(o => o.Tiersps);
            // Build nested expansions
            string expandPlngensNested = expandPlngens + "($expand=Rubvars($expand=Rubfmts))";
            string expandTierspsNested = expandTiersps + "($expand=Actsaies($expand=Actdets))";
            // Combine them
            string expand = string.Join(",", expandPlngensNested, expandTierspsNested);
            curOrga = await curODContext.GetByKeyAsync<Gxorga>(
                key,
                "Gxorgas",
                expand
            );
            if (curOrga == null)
            {
                Console.WriteLine("No organization found for the current user.");
                return;
            }
            Console.WriteLine($"✅ COMPLETE: Plngens={curOrga.Plngens?.Count ?? 0}, " +
                          //$"Gsgfixes={curOrga.Gsgfixes?.Count ?? 0}, " +
                          $"Tiersps={curOrga.Tiersps?.Count ?? 0}");
            // Populate child data immediately
            Console.WriteLine($"Usrbag plans : {_usrBag.Usorga.Uplns.Count()}");
            // foreach (var ipl in LsPlans)
            // {
            //     Console.WriteLine($"before : pliba {ipl.Liba} et ptyp {ipl.Ptyp}");
            // }
            toChild = new MyShareVars
            {
                authUser = authState.User,
                isAuthenticated = true,
                LsDivs = await _rendAgres.LoadOrgaPostes(),
                LsVars = LsVars.ToList(),
                LsFixes = LsFixes.ToList(),
                LsPlans = LsPlans.ToList(),
                LsTabls = LsTabls.ToList()
            };
            // foreach(var ipl in LsPlans)
            // {
            //     Console.WriteLine($"after : pliba {ipl.Liba} et ptyp {ipl.Ptyp}");
            // }
            //_guard.RegisterUnconfirmedPredicate<Plngen>(p => p.Xadd1 == -1);
            //_guard.RegisterUnconfirmedPredicate<Rubvar>(r => r.Xadd1 == -1);
            _guard.RegisterUnconfirmedPredicate<Rubhie>(p => p.Xadd1 == -1);
            _guard.RegisterUnconfirmedPredicate<Rubpst>(f => f.Xadd1 == -1);
            _guard.RegisterUnconfirmedPredicate<Actsaie>(a => a.Xadd1 == -1);
            _guard.RegisterUnconfirmedPredicate<Actdet>(d => d.Xadd1 == -1);
            _nbChanges = _guard.GetPendingChangesCount();  // Initial value
        }
        finally
        {
            isLoading = false;
        }
    }
  
    private async Task LoadChildrenAsync(int key)
    {
        // 🔥 ONE CALL - ALL NAV PROPERTIES!
        await curODContext.GetByKeyAsync<Gxorga>(key, "Gxorgas",
            "Plngens($expand=Rubvars),Gsgfixes,Gsglnes,Tiersps($expand=Actsaies)");

        // Refresh curOrga with ALL children
        curOrga = await curODContext.GetByKeyAsync<Gxorga>(key, "Gxorgas");

        Console.WriteLine($"✅ COMPLETE: Plngens={curOrga.Plngens?.Count ?? 0}, " +
                          $"Gsgfixes={curOrga.Gsgfixes?.Count ?? 0}, " +
                          $"Tiersps={curOrga.Tiersps?.Count ?? 0}");

        isLoading = false;
        await InvokeAsync(StateHasChanged);

        // await curODContext.GetByKeyAsync<Gxorga>(key, "Gxorgas", "Gsgfixes,Gsglnes");
        // await curODContext.GetByKeyAsync<Gxorga>(key, "Gxorgas", "Plngens($expand=Rubvars)");
        // //await curODContext.GetByKeyAsync<Gxorga>(key, "Gxorgas", "Gsgfixes,Gsglnes");
        // await curODContext.GetByKeyAsync<Gxorga>(key, "Gxorgas", "Tiersps($expand=Actsaies)");

        // // Refresh curOrga with children
        // curOrga = await curODContext.GetByKeyAsync<Gxorga>(key, "Gxorgas");
    }


    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            _locationHandler = _navManager.RegisterLocationChangingHandler(OnLocationChangingAsync);
            //Console.WriteLine("📌 LocationChangingHandler registered");
        }
    }
    private async ValueTask OnLocationChangingAsync(LocationChangingContext context)
    {
        Console.WriteLine($"🌐 Intercepted: {context.TargetLocation}");

        if (!_guard.HasPendingChanges())
        {
            Console.WriteLine("✅ Clean - allowing navigation");
            return;
        }

        context.PreventNavigation();  // BLOCK navigation
        Console.WriteLine($"🚫 Showing confirm dialog {context.TargetLocation}");

        try
        {
            var save = await _JsRUN.InvokeAsync<bool>("confirm", "Save changes before leaving?");

            if (save)
            {
                // 🔥 YES: SaveAllChanges() → Navigate away
                await SaveAllChanges();
                Console.WriteLine("💾 Saved - navigating away");
                _navManager.NavigateTo(context.TargetLocation, forceLoad: false);
            }
            else
            {
                // 🔥 NO: STAY on page - NO CancelAllChanges()
                Console.WriteLine("❌ User chose NO - staying on page");
                // User stays - sees SaveAllChanges() / CancelAllChanges() buttons ENABLED
                // They can now manually: SaveAllChanges() OR CancelAllChanges()
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error: {ex.Message}");
            // Safety: stay on page
        }
    }

    private async Task SelMenu(int noM)
    {
        _chxMenu = noM;
        if (_chxMenu == 1) strComp = $"Saisie.GRILLE";
        if (_chxMenu == 2) strComp = $"Saisie.ECHEANCIER";
        if (_chxMenu == 3) strComp = $"Saisie.POSTES";
        if (_chxMenu == 4)
        {
            _navManager.NavigateTo("/arubmenu", replace: true);
            strComp = $"Aplans";
        }
        StateHasChanged();
        await Task.Delay(1);
    }
    private async Task SelGpe(int noG)
    {
        _chxGpe = noG;
        StateHasChanged();
        Console.WriteLine("PAS 2");
        await Task.Delay(1);
    }
    private async Task CancelAllChanges()
    {
        Console.WriteLine("🗑️ CancelAllChanges START");
        await _guard.CancelChangesAsync();  // 🔥 AWAIT - blocks until done
        Imessage = "CancelAllChanges successfully";
        StateHasChanged();
        Console.WriteLine($"✅ CancelAllChanges END - Pending: {_guard.GetPendingChangesCount()}");
    }
    private async Task SaveAllChanges()
    {
        //_guard.DiscardUnconfirmedAdds<Plngen>();
        //_guard.DiscardUnconfirmedAdds<Rubvar>();
        _guard.DiscardUnconfirmedAdds<Rubhie>();
        _guard.DiscardUnconfirmedAdds<Rubpst>();
        _guard.DiscardUnconfirmedAdds<Actsaie>();
        _guard.DiscardUnconfirmedAdds<Actdet>();
        if (_guard.HasPendingChanges())
        {
            await curODContext.Context.SaveChangesAsync();
        }
        _guard.NotifyChanges();
        Imessage = "✅ Save successful";
        StateHasChanged();
    }

    public void Dispose()
    {
        _locationHandler?.Dispose();
        // Parent-level cleanup
        _guard.DiscardUnconfirmedAdds<Rubhie>();
        _guard.DiscardUnconfirmedAdds<Rubpst>();
        _guard.DiscardUnconfirmedAdds<Actsaie>();
        _guard.DiscardUnconfirmedAdds<Actdet>();
    }

    void NavigateBack()
    {
        _navManager.NavigateTo("/");
    }
    // // var expand1 = "Plngens($expand=Rubvars,Rubhies($expand=Rubpsts)),Gsgfixes,Gsglnes";
    // // var expand2 = "Tiersps($expand=Actsaies($expand=Actdets))";
    // // await curODContext.GetByKeyAsync<Gxorga>(key, "Gxorgas", expand1);
    // // await curODContext.GetByKeyAsync<Gxorga>(key, "Gxorgas", expand2);
    // // curOrga = curODContext.Context.Entities
    // //     .Select(e => e.Entity)
    // //     .OfType<Gxorga>()
    // //     .SingleOrDefault(o => o.Idorg == key);
    // var expand = "Plngens($expand=Rubvars($expand=Rubfmts),Rubhies($expand=Rubpsts)),Gsgfixes,Gsglnes,Tiersps($expand=Actsaies($expand=Actdets))";
    // await curODContext.GetByKeyAsync<Gxorga>(key, "Gxorgas", expand);  // ONE call!

    // curOrga = curODContext.Context.Entities
    //     .OfType<Gxorga>()
    //     .SingleOrDefault(o => o.Idorg == key);
    // var orgaTask1 = curODContext.Context.Gxorgas
    //     .ByKey(key)
    //     .Expand("Plngens($expand=Rubvars($expand=Rubfmts))")
    //     .Expand("Gsgfixes,Gsglnes")
    //     .FindEntryAsync();

    // var orgaTask2 = curODContext.Context.Gxorgas
    //     .ByKey(key)
    //     .Expand("Tiersps($expand=Actsaies($expand=Actdets))")
    //     .FindEntryAsync();

    // await Task.WhenAll(orgaTask1, orgaTask2);
}
