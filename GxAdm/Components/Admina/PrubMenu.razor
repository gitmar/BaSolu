@page "/prubmenu"
@inherits LayoutComponentBase
@layout FreeLayout

@using System.Security.Claims
@using BlazorBootstrap
@using Blazored.LocalStorage
@using GxAdm.ClieModels
@using GxAdm.Components.Admina.PRubs
@using GxAdm.Services
@using GxAdm.StaticHelpers
@using GxShared.Sess
@using GxWapi.DaModels
@using Microsoft.OData.Client
@using Newtonsoft.Json

@implements IDisposable

@inject NavigationManager _navManager
@inject ILocalStorageService _localStorage
@inject HttpClientService _cliemanager
@inject IODataContextFactory _contextFactory
@inject SessionContextService _sessionContext
@inject RendAgres _rendAgres
@inject PendingChangesGuard _guard
@inject IJSRuntime _JsRUN

@if (isLoading)
{
    <div class="text-center">
        <Spinner Color="SpinnerColor.Primary" Size="SpinnerSize.Large" />
        <p>PROGRAMS/PLANS Loading...</p>
    </div>
}
else
{
    <div class="gx-screen-layout">
        <div class="container gx-parent-container" style="height: 100vh;">
            <div class="d-flex flex-column" style="height: 100%;">
                <!-- Top Menu -->
                <GxNavMenu BrandText="A24soft Gx-Solutions"
                           MenuItems="@MenuItems"
                           YaGroup="false"
                           Groups="@Groupes"
                           MenuSelected="@_chxMenu"
                           MenuSelectedChanged="@SelMenu"
                           GroupSelected="@_chxGpe"
                           GroupSelectedChanged="@SelGpe"
                           OnBack="@NavigateBack" />
            
                <!-- Main Content -->
                @if (this != null)
                {
                    @if (_chxMenu != 0 && toChild != null && curOrga != null && curODContext != null)
                    {
                        @if (_chxMenu == 1)
                        { //SAISIES
                            <PrubSaie @ref="mygsai"
                            toMenu="@_chxMenu"
                            @bind-NbChanges="_nbChanges"
                            _guard="_guard"
                            curOrga="@curOrga"
                            toChild="@toChild"
                            curODContext="@curODContext">
                                <ChildContent>
                                </ChildContent>
                            </PrubSaie>
                        }
                        else if (_chxMenu == 2)
                        { //CALCULS
                          <PrubCalc @ref="mygclc"
                                    toMenu="@_chxMenu"
                                    @bind-NbChanges="_nbChanges"
                                    _guard="_guard"
                                    curOrga="@curOrga"
                                    toChild="@toChild"
                                    curODContext="@curODContext">
                              <ChildContent>
                              </ChildContent>
                          </PrubCalc>
                        }
                        else if (_chxMenu == 3)
                        { //VENTILATIONS
                          <PrubVent @ref="mygvnt"
                                    toMenu="@_chxMenu"
                                    @bind-NbChanges="_nbChanges"
                                    _guard="_guard"
                                    curOrga="@curOrga"
                                    toChild="@toChild"
                                    curODContext="@curODContext">
                              <ChildContent>
                              </ChildContent>
                        </PrubVent>
                        }
                        else if (_chxMenu == 4)
                        { //CALCULS
                            //ref="mygclc"
                        }
                    }
                }
            </div>
        </div>
    </div>
    <div class="alert alert-warning d-flex justify-content-between align-items-center py-1 px-2 position-fixed bottom-0 end-0"
         style="background-color: transparent; z-index: 1050; max-width: 400px;">
        <div class="d-flex gap-2 align-items-center">
            <Button class="w-auto flex-grow-0 flex-shrink-0" Color="ButtonColor.Info" @onclick="SaveAllChanges"
                    Enabled="@_guard.HasPendingChanges()">
                Save All (@_guard.GetPendingChangesCount() changes)
            </Button>
            <Button class="w-auto flex-grow-0 flex-shrink-0" Color="ButtonColor.Secondary" @onclick="CancelAllChanges"
                    Enabled="@_guard.HasPendingChanges()">
                Cancel All
            </Button>
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    public MyODataContext curODContext;
    public Gxorga curOrga = new Gxorga();
    public MyShareVars toChild = new();

    private PrubSaie mygsai = new();
    private PrubCalc mygclc = new();
    private PrubVent mygvnt = new();

    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }
    public ClaimsPrincipal authUser;

    //menus
    private string strComp = "Prog.SAISIE";
    public List<GxMenuItem> MenuItems = new()
    {
        new GxMenuItem { Id = 1, Text = "Prog.SAISIE", Icon = "bi bi-box-arrow-in-down" },
        new GxMenuItem { Id = 2, Text = "Prog.CALCUL", Icon = "bi bi-house-door" },
        new GxMenuItem { Id = 3, Text = "VENTILATION", Icon = "bi bi-house-door" },
        //new MenuItem { Id = 4, Text = "Mutation", Icon = "bi bi-arrow-repeat" },
    };
    public List<GxGroupe> Groupes = new();

    public string Imessage = "";
    public Userbag _usrBag = new Userbag();
    public List<Gpfixe> LsFixes = new();
    public List<Gpdivh> LsDivs = new();
    public List<Gpvar> LsVars = new();
    public List<Gplan> LsPlans = new();
    public List<Gpvar> LtTabls = new();
    public List<Gpvar> LsTabls = new();
    private int _gIdTie = 0, _chxGpe = 0, _chxMenu = 1;

    //modal management
    private string SidebarStyle = "width: 200px;";

    //Guard
    private int _nbChanges = 0;
    private IDisposable? _locationHandler;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        try
        {
            var authState = await AuthState;
            if (!authState.User.Identity.IsAuthenticated) return;
            // Load lightweight user data FIRST
            _usrBag = await _sessionContext.GetUserbagAsync();
            _gIdTie = _usrBag.Usorga.Gdtie;
            LsVars = _usrBag.Usorga.Uvars.ToList();
            LsFixes = _usrBag.Ufixes.ToList();
            LsPlans = _usrBag.Usorga.Uplns.Where(pl => pl.Ptyp == 3).ToList();
            LtTabls = _usrBag.Usorga.Uvars.Where(tb => tb.Gvars == 4).ToList();
            LsTabls = _usrBag.Usorga.Uvars.Where(tb => tb.Gvars == 5).ToList();
            // Create context
            curODContext = await _contextFactory.CreateAsync();
            _guard.AttachContext(curODContext);
            // Load ONLY parent entity
            int key = _usrBag.Idorg;
            // Typed expansion for Plngens -> Rubvars -> Rubfmts
            string expand = ODataQueryHelper.Expand<Gxorga, IEnumerable<Plngen>>(
                o => o.Plngens) + "($expand=Rubvars($expand=Rubfmts))";
            curOrga = await curODContext.GetByKeyAsync<Gxorga>(
                key,
                "Gxorgas",
                expand);
            if (curOrga == null) return;
            // ✅ Plngens exists as empty DataServiceCollection - USE I
            Console.WriteLine($"READY: Orga loaded, Plngens={curOrga.Plngens?.Count ?? 0}");
            if (curOrga == null) return;
            // Populate child data immediately
            toChild = new MyShareVars
            {
                authUser = authState.User,
                isAuthenticated = true,
                LsDivs = await _rendAgres.LoadOrgaPostes(),
                LsVars = LsVars.ToList(),
                LsFixes = LsFixes.ToList(),
                LsPlans = LsPlans.ToList(),
                LsTabls = LsTabls.ToList()  
            };
            _guard.RegisterUnconfirmedPredicate<Plngen>(p => p.Xadd1 == -1);
            _guard.RegisterUnconfirmedPredicate<Rubvar>(r => r.Xadd1 == -1);
            _guard.RegisterUnconfirmedPredicate<Rubfmt>(f => f.Xadd1 == -1);
            _nbChanges = _guard.GetPendingChangesCount();  // Initial value
        }
        finally {
            isLoading = false;
            Console.WriteLine($"isLoading state :{isLoading}");
        }
    }
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            _locationHandler = _navManager.RegisterLocationChangingHandler(OnLocationChangingAsync);
            Console.WriteLine("📌 LocationChangingHandler registered");
        }
    } 
    private async ValueTask OnLocationChangingAsync(LocationChangingContext context)
    {
        Console.WriteLine($"🌐 Intercepted: {context.TargetLocation}");

        if (!_guard.HasPendingChanges())
        {
            Console.WriteLine("✅ Clean - allowing navigation");
            return;
        }

        context.PreventNavigation();  // BLOCK navigation
        Console.WriteLine($"🚫 Showing confirm dialog {context.TargetLocation}");

        try
        {
            var save = await _JsRUN.InvokeAsync<bool>("confirm", "Save changes before leaving?");

            if (save)
            {
                // 🔥 YES: SaveAllChanges() → Navigate away
                await SaveAllChanges();
                Console.WriteLine("💾 Saved - navigating away");
                _navManager.NavigateTo(context.TargetLocation, forceLoad: false);
            }
            else
            {
                // 🔥 NO: STAY on page - NO CancelAllChanges()
                Console.WriteLine("❌ User chose NO - staying on page");
                // User stays - sees SaveAllChanges() / CancelAllChanges() buttons ENABLED
                // They can now manually: SaveAllChanges() OR CancelAllChanges()
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error: {ex.Message}");
            // Safety: stay on page
        }
    }

    private async Task SelMenu(int noM)
    {
        _chxMenu = noM;
        if (_chxMenu == 1) strComp = $"Prog.SAISIE";
        if (_chxMenu == 2) strComp = $"Prog.CALCUL";
        if (_chxMenu == 3) strComp = $"VENTILATION";
        //if (_chxMenu == 5) strComp = "Colonnes";
        StateHasChanged();
        await Task.Delay(1);
    }
    private async Task SelGpe(int noG)
    {
        _chxGpe = noG;
        StateHasChanged();
        Console.WriteLine("PAS 2");
        await Task.Delay(1);
    }
    private async Task CancelAllChanges()
    {
        Console.WriteLine("🗑️ CancelAllChanges START");
        await _guard.CancelChangesAsync();  // 🔥 AWAIT - blocks until done
        Imessage = "CancelAllChanges successfully";
        StateHasChanged();
        Console.WriteLine($"✅ CancelAllChanges END - Pending: {_guard.GetPendingChangesCount()}");
    }
    private async Task SaveAllChanges()
    {
        _guard.DiscardUnconfirmedAdds<Plngen>();
        _guard.DiscardUnconfirmedAdds<Rubvar>();
        _guard.DiscardUnconfirmedAdds<Rubfmt>();
        if (_guard.HasPendingChanges())
        {
            await curODContext.Context.SaveChangesAsync();
        }
        _guard.NotifyChanges();
        Imessage = "✅ Save successful";
        StateHasChanged();
    }

    public void Dispose()
    {
        _locationHandler?.Dispose();
        // Parent-level cleanup
        _guard.DiscardUnconfirmedAdds<Plngen>();
        _guard.DiscardUnconfirmedAdds<Rubvar>();
        _guard.DiscardUnconfirmedAdds<Rubfmt>();
    }
   
    void NavigateBack()
    {
        _navManager.NavigateTo("/");
    }
}