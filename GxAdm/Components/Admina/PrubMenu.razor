@page "/prubmenu"
@inherits LayoutComponentBase
@layout FreeLayout

@using System.Security.Claims
@using BlazorBootstrap
@using Blazored.LocalStorage
@using GxAdm.ClieModels
@using GxAdm.Components.Admina.PRubs
@using GxAdm.Services
@using GxAdm.StaticHelpers
@using GxShared.Sess
@using GxWapi.DaModels
@using Microsoft.OData.Client
@using Newtonsoft.Json

@implements IDisposable

@inject NavigationManager _navManager
@inject ILocalStorageService _localStorage
@inject HttpClientService _cliemanager
@inject IODataContextFactory _contextFactory
@inject SessionContextService _sessionContext
@inject RendAgres _rendAgres
@inject PendingChangesGuard _guard
@inject IJSRuntime _JsRUN

@if (isLoading)
{
    <div class="text-center">
        <Spinner Color="SpinnerColor.Primary" Size="SpinnerSize.Large" />
        <p>PROGRAMS/PLANS Loading...</p>
    </div>
}
else
{
    <div class="gx-screen-layout">
        <div class="container gx-parent-container" style="height: 100vh;">
            <div class="d-flex flex-column" style="height: 100%;">
                <!-- Top Menu -->
                <GxNavMenu BrandText="A24soft Gx-Solutions"
                           MenuItems="@MenuItems"
                           YaGroup="false"
                           Groups="@Groupes"
                           MenuSelected="@_chxMenu"
                           MenuSelectedChanged="@SelMenu"
                           GroupSelected="@_chxGpe"
                           GroupSelectedChanged="@SelGpe"
                           OnBack="@NavigateBack" />
            
                <!-- Main Content -->
                @if (this != null)
                {
                    @if (_chxMenu != 0 && toChild != null && curOrga != null && curODContext != null)
                    {
                        @if (_chxMenu == 1)
                        { //SAISIES
                            <PrubSaie @ref="mygsai"
                            toMenu="@_chxMenu"
                            @bind-NbChanges="_nbChanges"
                            _guard="_guard"
                            curOrga="@curOrga"
                            toChild="@toChild"
                            curODContext="@curODContext">
                                <ChildContent>
                                    <h2 class="child-box">Hello RECEPTION</h2>
                                </ChildContent>
                            </PrubSaie>
                        }
                        else if (_chxMenu == 2)
                        { //CALCULS
                            <PrubCalc @ref="mygclc" 
                            toMenu="@_chxMenu"
                            curOrga="@curOrga"
                            toChild="@toChild"
                            curODContext="@curODContext">
                                <ChildContent>
                                </ChildContent>
                            </PrubCalc>
                        }
                        else if (_chxMenu == 3)
                        { //VENTILATIONS
                            <PrubVent @ref="mygvnt"
                            toMenu="@_chxMenu"
                            curOrga="@curOrga"
                            toChild="@toChild"
                            curODContext="@curODContext">
                                <ChildContent>
                                    @* <h2 class="child-box">Hello RECEPTION</h2> *@
                                </ChildContent>
                            </PrubVent>
                        }
                        else if (_chxMenu == 4)
                        { //CALCULS
                            //ref="mygclc"
                        }
                    }
                }
            </div>
        </div>
    </div>
    <div class="alert alert-warning d-flex justify-content-between align-items-center py-1 px-2 position-fixed bottom-0 end-0"
         style="background-color: transparent; z-index: 1050; max-width: 400px;">
        <div class="d-flex gap-2 align-items-center">
            <Button class="w-auto flex-grow-0 flex-shrink-0" Color="ButtonColor.Info" @onclick="SaveAllChanges"
                    Enabled="@_guard.HasPendingChanges()">
                Save All (@_guard.GetPendingChangesCount() changes)
            </Button>
            <Button class="w-auto flex-grow-0 flex-shrink-0" Color="ButtonColor.Secondary" @onclick="CancelAllChanges"
                    Enabled="@_guard.HasPendingChanges()">
                Cancel All
            </Button>
        </div>
    </div>
    @* <div>
        ⚠️ @_guard.GetPendingChangesCount() unsaved changes
    </div> *@
}

@code {
    private bool isLoading = true;
    public MyODataContext curODContext;
    public Gxorga curOrga = new Gxorga();
    public MyShareVars toChild = new();
    //private bool allEnable = false;

    private PrubSaie mygsai = new();
    private PrubCalc mygclc = new();
    private PrubVent mygvnt = new();

    [Parameter]
    public RenderFragment Pstands { get; set; }
    [Parameter]
    public RenderFragment Pmaties { get; set; }
    [Parameter]
    public RenderFragment Pgrilles { get; set; }
    [Parameter]
    public RenderFragment Pschemas { get; set; }
    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }
    public ClaimsPrincipal authUser;
    //public bool isAuthenticated = false;
    //in DATA
    public List<Gsgfix> LsTables = new List<Gsgfix>();

    public string _strOrga = "", _curSigle = "", MImessage = "", strmeta = "", strmeta2 = "";

    //menus
    public List<GxMenuItem> MenuItems = new()
    {
        new GxMenuItem { Id = 1, Text = "Prog.SAISIE", Icon = "bi bi-box-arrow-in-down" },
        new GxMenuItem { Id = 2, Text = "Prog.CALCUL", Icon = "bi bi-house-door" },
        new GxMenuItem { Id = 3, Text = "VENTILATION", Icon = "bi bi-house-door" },
        //new MenuItem { Id = 4, Text = "Mutation", Icon = "bi bi-arrow-repeat" },
    };
    public List<GxGroupe> Groupes = new();

    //entities load
    private IEnumerable<Gxorga> _lsOrgas = new List<Gxorga>();
    //Gestion CRUD Entete
    public bool EnrEnable = false;
    public string Imessage = "";

    //GlobModels
    public Userbag _usrBag = new Userbag();
    public List<Gpfixe> LsFixes = new();
    public List<Gpdivh> LsDivs = new();
    public List<Gpvar> LsVars = new();
    public List<Gplan> LsPlans = new();
    public List<Gpvar> LtTabls = new();
    public List<Gpvar> LsTabls = new();
    private int _gIdTie = 0, _chxGpe = 0, _chxMenu = 1;
    private string strComp = "Prog.SAISIE";
    //modal management
    private string SidebarStyle = "width: 200px;";
    private bool IsOpen = true;
    private bool FirstLoadCompleted = false;
    private bool ContentLoaded = false;

    //Guard
    private int _nbChanges = 0;
    private IDisposable? _locationHandler;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        try
        {
            var authState = await AuthState;
            if (!authState.User.Identity.IsAuthenticated) return;
            // Load lightweight user data FIRST
            // 2. Load user data
            _usrBag = await _sessionContext.GetUserbagAsync();
            _gIdTie = _usrBag.Usorga.Gdtie;
            LsVars = _usrBag.Usorga.Uvars.ToList();
            LsFixes = _usrBag.Ufixes.ToList();
            LsPlans = _usrBag.Usorga.Uplns.Where(pl => pl.Ptyp == 3).ToList();
            LtTabls = _usrBag.Usorga.Uvars.Where(tb => tb.Gvars == 4).ToList();
            LsTabls = _usrBag.Usorga.Uvars.Where(tb => tb.Gvars == 5).ToList();
            // Create context
            curODContext = await _contextFactory.CreateAsync();
            _guard.AttachContext(curODContext);
            // Load ONLY parent entity
            int key = _usrBag.Idorg;
            // curOrga = await curODContext.GetByKeyAsync<Gxorga>(
            //     key,
            //     "Gxorgas",
            //     "Plngens($expand=Rubvars($expand=Rubfmts))"
            // );
            // Typed expansion for Plngens -> Rubvars -> Rubfmts
            string expand = ODataQueryHelper.Expand<Gxorga, IEnumerable<Plngen>>(
                o => o.Plngens) + "($expand=Rubvars($expand=Rubfmts))";
            curOrga = await curODContext.GetByKeyAsync<Gxorga>(
                key,
                "Gxorgas",
                expand);
            if (curOrga == null) return;
            // ✅ Plngens exists as empty DataServiceCollection - USE I
            Console.WriteLine($"READY: Orga loaded, Plngens={curOrga.Plngens?.Count ?? 0}");
            if (curOrga == null) return;

            // Populate child data immediately
            toChild = new MyShareVars
            {
              authUser = authState.User,
                isAuthenticated = true,
                LsDivs = await _rendAgres.LoadOrgaPostes(),
                LsVars = LsVars.ToList(),
                LsFixes = LsFixes.ToList(),
                LsPlans = LsPlans.ToList(),
                LsTabls = LsTabls.ToList()  
            };
            _guard.RegisterUnconfirmedPredicate<Plngen>(p => p.Xadd1 == -1);
            _guard.RegisterUnconfirmedPredicate<Rubvar>(r => r.Xadd1 == -1);
            _guard.RegisterUnconfirmedPredicate<Rubfmt>(f => f.Xadd1 == -1);
            _nbChanges = _guard.GetPendingChangesCount();  // Initial value
        }
        finally {
            isLoading = false;
            Console.WriteLine($"isLoading state :{isLoading}");
        }
    }
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            _locationHandler = _navManager.RegisterLocationChangingHandler(OnLocationChangingAsync);
            Console.WriteLine("📌 LocationChangingHandler registered");
        }
    } 
    // private async ValueTask On55LocationChangingAsync(LocationChangingContext context)
    // {
    //     _guard.DiscardAllUnconfirmedAdds();

    //     if (!_guard.HasConfirmedPendingChanges()) return;
    //     if (context.TargetLocation == "/") return;

    //     context.PreventNavigation();

    //     try
    //     {
    //         // 🔥 Custom JS - NO cast errors!
    //         var save = await _JsRUN.InvokeAsync<bool>("confirm", "Save changes?");

    //         if (save)
    //         {
    //             await _guard.FlushAsync();
    //             _navManager.NavigateTo("/", forceLoad: false);
    //         }
    //         else
    //         {
    //             _guard.CancelChanges();
    //         }
    //     }
    //     catch (Exception ex)
    //     {
    //         Console.WriteLine($"❌ Error: {ex.Message}");
    //         _guard.CancelChanges();
    //     }
    // }

    private async ValueTask OnLocationChangingAsync(LocationChangingContext context)
    {
        Console.WriteLine($"🌐 Intercepted: {context.TargetLocation}");

        // Discard unconfirmed first
        _guard.DiscardAllUnconfirmedAdds();

        // Allow if no pending changes
        if (!_guard.HasPendingChanges())
        {
            Console.WriteLine("✅ Clean - allowing navigation");
            return; // Blazor continues automatically
        }

        // Normalize path
        var absoluteUri = _navManager.ToAbsoluteUri(context.TargetLocation);
        var relative = _navManager.ToBaseRelativePath(absoluteUri.ToString());

        // Intercept navigation because there are confirmed changes
        context.PreventNavigation();
        Console.WriteLine("🚫 Showing confirm dialog");

        try
        {
            var save = await _JsRUN.InvokeAsync<bool>("confirm", "Save changes?");
            if (save)
            {
                await _guard.FlushAsync();
                Console.WriteLine("💾 Saved - resuming navigation");
                _navManager.NavigateTo(context.TargetLocation, forceLoad: false);
            }
            else
            {
                _guard.CancelChangesAsync();
                Console.WriteLine("❌ Cancelled - staying put");
                // Do NOT call NavigateTo here → user stays on current page
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error: {ex.Message}");
            _guard.CancelChangesAsync();
        }
    }
    private async Task SelMenu(int noM)
    {
        _chxMenu = noM;
        if (_chxMenu == 1) strComp = $"Prog.SAISIE";
        if (_chxMenu == 2) strComp = $"Prog.CALCUL";
        if (_chxMenu == 3) strComp = $"VENTILATION";
        //if (_chxMenu == 5) strComp = "Colonnes";
        StateHasChanged();
        await Task.Delay(1);
    }
    private async Task SelGpe(int noG)
    {
        _chxGpe = noG;
        StateHasChanged();
        Console.WriteLine("PAS 2");
        await Task.Delay(1);
    }
    // private async Task CancelAllChanges()
    // {
    //     Console.WriteLine("🗑️ CancelAllChanges");

    //     // 🔥 SINGLE LINE - service handles everything
    //     _guard.CancelChangesAsync();
    //     Imessage = "CancelAllChanges successfully";
    //     StateHasChanged();
    // }

    // private async Task SaveAllChanges()
    // {
    //     Console.WriteLine($"🔄 SaveAllChanges: {_guard.GetPendingChangesCount()} pending");

    //     // 🔥 DISCARD ALL unconfirmed rows FIRST (Plngen + Rubvar + ANY type)
    //     _guard.DiscardAllUnconfirmedAdds();

    //     if (!_guard.HasPendingChanges())
    //     {
    //         Console.WriteLine("✅ No confirmed changes - nothing to save");
    //         StateHasChanged();
    //         return;
    //     }
    //     try
    //     {
    //         await curODContext.Context.SaveChangesAsync();
    //         Console.WriteLine("✅ Save successful");
    //         Imessage = "✅ Save successful";
    //     }
    //     catch (Exception ex)
    //     {
    //         Console.WriteLine($"❌ Save failed: {ex.Message}");
    //         // Optionally revert changes
    //         _guard.CancelChangesAsync();
    //         Imessage = $"❌ Save failed: {ex.Message}";
    //     }
    //     _guard.NotifyChanges();
    //     StateHasChanged();
    // }
    private async Task CancelAllChanges()
    {
        Console.WriteLine("🗑️ CancelAllChanges START");

        await _guard.CancelChangesAsync();  // 🔥 AWAIT - blocks until done

        Imessage = "CancelAllChanges successfully";
        StateHasChanged();
        Console.WriteLine($"✅ CancelAllChanges END - Pending: {_guard.GetPendingChangesCount()}");
    }

    private async Task SaveAllChanges()
    {
        Console.WriteLine($"🔄 SaveAllChanges START: {_guard.GetPendingChangesCount()}");

        _guard.DiscardAllUnconfirmedAdds();

        if (!_guard.HasPendingChanges())
        {
            Imessage = "No changes to save";
            StateHasChanged();
            return;
        }

        try
        {
            await curODContext.Context.SaveChangesAsync();
            Imessage = "✅ Save successful";
        }
        catch (Exception ex)
        {
            Imessage = $"❌ Save failed: {ex.Message}";
            await _guard.CancelChangesAsync();  // Also await here!
        }

        StateHasChanged();
    }

    public void Dispose()
    {
        _locationHandler?.Dispose();
        // Parent-level cleanup
        _guard.DiscardUnconfirmedAdds<Plngen>();
        _guard.DiscardUnconfirmedAdds<Rubvar>();
        _guard.DiscardUnconfirmedAdds<Rubfmt>();
    }
    private void DiscardAllUnconfirmed()
    {
        _guard.DiscardUnconfirmedAdds<Plngen>();
        _guard.DiscardUnconfirmedAdds<Rubvar>();
        _guard.DiscardUnconfirmedAdds<Rubfmt>();
    }
    private async ValueTask OnLocationChanging(LocationChangingContext args)
    {
        // Already handled by child Dispose() - but defensive check
        if (HasOnlyUnconfirmed())
        {
            DiscardAllKnownUnconfirmed();
            return;
        }
        await SaveAllChanges();
    }

    private bool HasOnlyUnconfirmed()
    {
        return _guard.GetPendingChangesCount() == 0
            && curODContext.Context.Entities.Any(e =>
                e.Entity is Plngen p && p.Xadd1 == -1 ||
                e.Entity is Rubvar r && r.Xadd1 == -1 ||
                e.Entity is Rubfmt f && f.Xadd1 == -1);
    }

    private void DiscardAllKnownUnconfirmed()
    {
        _guard.DiscardUnconfirmedAdds<Plngen>();
        _guard.DiscardUnconfirmedAdds<Rubvar>();
        _guard.DiscardUnconfirmedAdds<Rubfmt>();
    }

    void NavigateBack()
    {
        _navManager.NavigateTo("/");
    }
}