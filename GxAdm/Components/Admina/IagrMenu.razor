@page "/iagrmenu"
@inherits LayoutComponentBase
@layout FreeLayout

@using System.Security.Claims
@using BlazorBootstrap
@using Blazored.LocalStorage
@using GxAdm.ClieModels
@using GxAdm.Components.Admina.ARubs
@using GxAdm.Components.Admina.Ictvars
@using GxAdm.Services
@using GxShared.Sess
@using GxWapi.DaModels
@using Microsoft.OData.Client
@using Newtonsoft.Json

@inject NavigationManager _navmanager
@inject ILocalStorageService _localStorage
@inject HttpClientService _cliemanager
@inject IODataContextFactory _contextFactory
@inject SessionContextService _sessionContext
@inject RendAgres _rendAgres

@if (isLoading)
{
    <div class="text-center">
        <Spinner Color="SpinnerColor.Primary" Size="SpinnerSize.Large" />
        <p>PARAMS/ASTREINTES Loading...</p>
    </div>
}
@if(!isLoading)
{
    <div class="gx-screen-layout">
        <div class="container gx-parent-container" style="height: 100vh;">
            <div class="d-flex flex-column" style="height: 100%;">
                <!-- Top Menu -->
                <GxNavMenu BrandText="A24soft Gx-Solutions"
                           MenuItems="@MenuItems"
                           YaGroup="false"
                           Groups="@Groupes"
                           MenuSelected="@_chxMenu"
                           GroupSelected="@_chxGpe" />
                @* <!-- Top Menu -->
                <div class="innermenu-container d-flex align-items-center justify-content-start">
                    <!-- Brand -->
                    <button class="navbar-brand text-white d-flex align-items-center me-4"
                            style="height:44px;" @onclick="() => NavigateBack()">
                        <i class="bi bi-grid-3x3-gap-fill me-2"></i>
                        A24soft Gx-Solutions
                    </button>

                    <!-- Nav Items -->
                    <ul class="menu nav nav-pills d-flex align-items-center">
                        <li class="nav-item">
                            <div @onclick="() => SelMenu(1)"
                                 class="nav-link d-flex align-items-center @(_chxMenu == 1 ? "active" : "")">
                                <i class="bi bi-table me-2"></i> Grille
                            </div>
                        </li>

                        <li class="nav-item">
                            <div @onclick="() => SelMenu(2)"
                                 class="nav-link d-flex align-items-center @(_chxMenu == 2 ? "active" : "")">
                                <i class="bi bi-tags me-2"></i> Echeancier
                            </div>
                        </li>

                        <li class="nav-item">
                            <div @onclick="() => SelMenu(3)"
                                 class="nav-link d-flex align-items-center @(_chxMenu == 3 ? "active" : "")">
                                <i class="bi bi-file-earmark-text me-2"></i> Postes
                            </div>
                        </li>

                        <li class="nav-item">
                            <div @onclick="() => SelMenu(4)"
                                 class="nav-link d-flex align-items-center @(_chxMenu == 4 ? "active" : "")">
                                <i class="bi bi-file-earmark-text me-2"></i> Plans
                            </div>
                        </li>
                    </ul>
                </div> *@
                <div class="row">
                    <div class="col-md-12 input-group align-middle">
                        <span class="text-uppercase text- text-success"><b>@strComp</b></span>
                        &nbsp;&nbsp;
                        <span class="separator">|| </span>
                        <Button class="btn btn-sm btn-secondary btnsz"
                                style="@(!allEnable ? "" : "display:none;")"
                                @onclick="ManEditAll">
                            Modifier
                        </Button>
                        <Button class="btn btn-sm btn-secondary btnsz"
                                style="@(allEnable ? "" : "display:none;")"
                                @onclick="ManCnclAll">
                            Annuler
                        </Button>
                        <span class="separator">|  </span>
                        <Button class="btn btn-sm btn-secondary btnsz"
                                style="@(allEnable ? "" : "display:none;")"
                                @onclick="ManSaveAll">
                            Enregistrer
                        </Button>
                        @if (!String.IsNullOrEmpty(MImessage))
                        {
                            <span class="bg-info bg-opacity-10" style="font-style:italic;color:red">&nbsp;--> @MImessage</span>
                        }
                    </div>
                </div>
                <!-- Main Content -->
                @if (_chxMenu != 0 && toChild != null && curOrga != null && curODContext != null)
                {
                    @if (_chxMenu == 1)
                    { //grille
                        <Ictgrils @ref="myigrd"
                                   _chxMenu="@_chxMenu"
                                   curOrga="@curOrga"
                                   toChild="@toChild"
                                   curODContext="@curODContext">
                            <ChildContent>
                               @*  <h2 class="child-box">Hello STANDARD</h2> *@
                            </ChildContent>
                        </Ictgrils>
                    }
                    else if (_chxMenu == 2)
                    { //echeancier
                        <Icteches @ref="myiech"
                                 _chxMenu="@_chxMenu"
                                 curOrga="@curOrga"
                                 toChild="@toChild"
                                 curODContext="@curODContext">
                            <ChildContent>
                                @* <h2 class="child-box">Hello STANDARD</h2> *@
                            </ChildContent>
                        </Icteches>
                    }
                    else if (_chxMenu == 3)
                    { //schema-postes
                        <Ictposts @ref="myipst"
                                   _chxMenu="@_chxMenu"
                                   curOrga="@curOrga"
                                   toChild="@toChild"
                                   curODContext="@curODContext">
                            <ChildContent>
                                <h2 class="child-box">Hello POSTES</h2>
                            </ChildContent>
                        </Ictposts>
                    }
                    else if (_chxMenu == 4)
                    { //plan rubriques sur un autre menu
                        <ArubMenu @ref="myrmenu">
                          @* <ChildContent>

                          </ChildContent>
 *@                      </ArubMenu>
                    }
                }
            </div>
        </div>
    </div>
}
@code {
    private bool isLoading = true;
    public MyODataContext curODContext;
    public Gxorga curOrga = new Gxorga();
    public MyShareVars toChild = new();
    private bool allEnable = false;
    private Ictgrils myigrd;
    private Icteches myiech;  
    private Ictposts myipst;
    private ArubMenu myrmenu;

    [Parameter]
    public RenderFragment Pstands { get; set; }
    [Parameter]
    public RenderFragment Pmaties { get; set; }
    [Parameter]
    public RenderFragment Pgrilles { get; set; }
    [Parameter]
    public RenderFragment Pschemas { get; set; }

    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }
    public ClaimsPrincipal authUser;
    public bool isAuthenticated = false;
    //in DATA
    public List<Gsgfix> LsTables = new List<Gsgfix>();

    public string _strOrga = "", _curSigle = "", MImessage ="", strmeta = "", strmeta2 = "";

    //menus
    public List<GxMenuItem> MenuItems = new()
    {
        new GxMenuItem { Id = 1, Text = "Saisie GRILLE", Icon = "bi bi-box-arrow-in-down" },
        new GxMenuItem { Id = 2, Text = "Saisie ECHEANCIER", Icon = "bi bi-house-door" },
        new GxMenuItem { Id = 3, Text = "Saisie POSTES", Icon = "bi bi-house-door" },
        new GxMenuItem { Id = 4, Text = "Plans", Icon = "bi bi-house-door" },
        //new MenuItem { Id = 4, Text = "Mutation", Icon = "bi bi-arrow-repeat" },
    };
    public List<GxGroupe> Groupes = new();

    //entities load
    private IEnumerable<Gxorga> _lsOrgas = new List<Gxorga>();
    //Gestion CRUD Entete
    public bool EnrEnable = false;
    public string Imessage = "";

    //GlobModels
    public Userbag _usrBag = new Userbag();
    //public Usaibag ColBag = new Usaibag();
    public List<Gpfixe> LsFixes = new();
    //public List<Upara> TUafls = new List<Upara>();
    public List<Gpdivh> LsDivs = new();
    public List<Gpvar> LsVars = new();
    public List<Gplan> LsPlans = new();
    public List<Gpvar> LtTabls = new();
    public List<Gpvar> LsTabls = new();
    public List<Gpvar> TbElems = new();
    //Navigation
    private int _gIdTie = 0, _chxGpe = 0, _chxMenu = 1;
    private string strComp = "Saisie GRILLE";
    //modal management
    private string SidebarStyle = "width: 200px;";
    private bool IsOpen = true;
    private bool FirstLoadCompleted = false;
    private bool ContentLoaded = false;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        var authState = await AuthState;
        authUser = authState.User;
        isAuthenticated = authUser.Identity.IsAuthenticated;
        if (!isAuthenticated)
        {
            Console.WriteLine("Authentication in Astreintes Utilisateur ECHEC");
            return;
        }
        else
        {
            Console.WriteLine("Authentication in Astreintes SUCCESS");
        }
        _usrBag = await _sessionContext.GetUserbagAsync();
        _gIdTie = _usrBag.Usorga.Gdtie;
        //var idplnadm = _usrBag.Usorga.Schba;
        //LsDivs = _usrBag.Usorga.Uhies.Where(uh => uh.Idpln == idplnadm && uh.Sidiv == 1).ToList();
        LsVars = _usrBag.Usorga.Uvars.ToList();
        LsFixes = _usrBag.Ufixes.ToList();
        LsPlans = _usrBag.Usorga.Uplns.Where(pl => (pl.Ptyp == 2 || pl.Ptyp == 3 || pl.Ptyp == 4)).ToList();
        LtTabls = _usrBag.Usorga.Uvars.Where(tb => tb.Gvars == 4).ToList();
        LsTabls = _usrBag.Usorga.Uvars.Where(tb => tb.Gvars == 5).ToList();
        //LsCols = ColBag.Ucols.Where(uv => uv.Jtyp == 1).OrderBy(uv => uv.Ydpd).ToList();
        //TbElems = _usrBag.Usorga.Uvars.Where(uv => uv.Gvars == 5 && uv.Ade == 1 && uv.Elea != 0).ToList();
        //ensemble des roles
        //var _allRoles = _usrBag.Allroles;
        //var _usrRoles = _usrBag.Allroles.Where(ur => ur.Sicur == true).ToList();
        //int minrol = _usrBag.Usprof.Rlmin;
        Console.WriteLine("Authentication ENTREE");
        ////EnrolVue.ShowSubmenu();
        //pita = 21;
        //await LoadROrgaAsync();
        await LoadSTROrgaAsync();
        //await LoadRubricsAsync();
        //pita = 5;
        Console.WriteLine("TIERS A ETE TESTE");
        toChild.authUser = authUser;
        toChild.isAuthenticated = isAuthenticated;
        //toChild.Usrid = _UserId;
        //toChild.Idorg = _UorgId;
        toChild.LsDivs = await _rendAgres.LoadOrgaPostes();
        toChild.LsVars = LsVars.ToList();
        toChild.LsFixes = LsFixes.ToList();
        toChild.LsPlans = LsPlans.ToList();
        toChild.LsTabls = LsTabls.ToList();
        //curODContext = _curODContext;
        isLoading = false;
    }
    //CRUD
    private async Task LoadSTROrgaAsync()
    {
        curODContext = await _contextFactory.CreateAsync(); // Use factory
        var expand = "Tiersps," +
            "Tiersps($expand=Actsaies,Actsaies($expand=Actdets))";
        var dxorgas = await curODContext.LoadFilteredAsync<Gxorga>(expand: expand);
        curOrga = dxorgas.FirstOrDefault();
        if (curOrga == null)
        {
            Console.WriteLine("No organization found for the current user.");
            return;
        }
        Console.WriteLine($"orga recu {curOrga.Raison}");
        var expand2 = "Plngens," +
            "Plngens($expand=Rubvars,Rubvars($expand=Rubfmts))," +
            "Plngens($expand=Rubhies,Rubhies($expand=Rubpsts))";
        var dxplns = await curODContext.LoadFilteredAsync<Gxorga>(expand: expand2);
        Console.WriteLine($"nb de tiers :  {curOrga.Tiersps.Count()}");
    }
    // private async Task LoadSTROrgaAsync22()
    // {
    //     int pisa = 2;
    //     try
    //     {
    //         curODContext = await _contextFactory.CreateAsync(); // Use factory

    //         //curODContext = await _contextFactory.CreateAsync();
    //         //curOrga et Gsgfixes, Gsglnes
    //         //var expand = "Gsgfixes," + "Gsglnes";
    //         //Expression<Func<Gxorga, bool>> ogfilter = g => g.Idorg == _usrBag.Idorg;
    //         var dxorgas = await curODContext.LoadFilteredAsync<Gxorga>();
    //         pisa = 3;
    //         curOrga = dxorgas.FirstOrDefault();
    //         if (curOrga == null)
    //         {
    //             Console.WriteLine("No organization found for the current user.");
    //             return;
    //         }
    //         Console.WriteLine($"orga recu {curOrga.Raison}");
    //         //Console.WriteLine($"nb gsgfixes : {curOrga.Gsgfixes.Count()}");
    //         //curOrga Plngens and rubvars
    //         var expand2 =
    //         "Rubvars," +
    //         "Rubvars($expand=Rubfmts)," +
    //         "Rubhies," +
    //         "Rubhies($expand=Rubpsts)";
    //         var dxplns = await curODContext.LoadFilteredAsync<Plngen>(expand: expand2);
    //         pisa = 4;
    //         //Console.WriteLine($"nb de plans :  {dxplns.Count()}");
    //         var expand3 = 
    //         "Actsaies," +
    //         "Actsaies($expand=Actdets)";
    //         var dxtiers = await curODContext.LoadFilteredAsync<Tiersp>(expand: expand3);
    //         pisa = 5;
    //         Console.WriteLine($"nb de tiers :  {curOrga.Tiersps.Count()}");
    //     }
    //     catch (Exception ex)
    //     {
    //         Console.WriteLine($"stack trace : {ex.StackTrace} place : {pisa} ex-mess : {ex.Message} and also in-mess: {ex.InnerException}");
    //     }
    // }
    // public async Task<IEnumerable<Plngen>> LoadRubricsAsync()
    // {
    //     // int pisa = 2;
    //     var expand = "Rubhies,Rubhies($expand=Rubpsts),Rubvars,Rubvars($expand=Rubfmts)";
    //     return await curODContext.LoadFilteredAsync<Plngen>(expand: expand);
    //     //expand = "Rubvars,Rubvars($expand=Rubfmts)";
    //     //return await curODContext.LoadFilteredAsync<Plngen>(expand: expand);
    // }
    // manage Access all

    private async Task ManEditAll()
    {
        MImessage = "Edition en preparation...";
        if (_chxMenu == 1)
        { //grille
            await myigrd.EdtAll();
        }
        if (_chxMenu == 2)
        { //echeancier
            await myiech.EdtAll();
        }
        if (_chxMenu == 3)
        { //schemas
            await myipst.EdtAll();
        }
        MImessage = "";
        allEnable = true;
    }
    private async Task ManCnclAll()
    {
        MImessage = "annulation en cours...";
        if (_chxMenu == 1)
        { //grille
            await myigrd.CncAll();
        }
        if (_chxMenu == 2)
        { //echeancier
            await myiech.CncAll();
        }
        if (_chxMenu == 3)
        { //schemas
            await myipst.CncAll();
        }
        //reload
        //LoadSTROrgaAsync();
        MImessage = "";
        allEnable = false;
    }
    private async Task ManSaveAll()
    {
        MImessage = "enregistrement en cours...";
        if (_chxMenu == 1)
        { //grille
            await myigrd.SavAll();
        }
        if (_chxMenu == 2)
        { //echeancier
            await myiech.SavAll();
        }
        if (_chxMenu == 3)
        { //schemas
            await myipst.SavAll();
        }
        MImessage = "";
        allEnable = false;
    }

    private async Task SelMenu(int noM)
    {
        _chxMenu = noM;
        if (_chxMenu == 1) strComp = $"Saisie GRILLE";
        if (_chxMenu == 2) strComp = $"Saisie ECHEANCIER";
        if (_chxMenu == 3) strComp = $"Saisie POSTES";
        if (_chxMenu == 3) strComp = $"Plans";
        //if (_chxMenu == 5) strComp = "Colonnes";
        allEnable = false;
        StateHasChanged();
        await Task.Delay(1);
    }
    private async Task SelGpe(int noG)
    {
        _chxGpe = noG;
        //gpeLiba = "";
        //if (noG == 0) return;
        //var mygpe = LsGties.Where(gt => gt.Itb == 6 && gt.Elea == noG).FirstOrDefault();
        //LsCols = curOrga.Gsglnes.Where(ug => ug.Otyp == 5 && ug.Dtyp == 6 && ug.Totyp == Ugpe && ug.Jacc == 1).ToList();
        //Ugpe = noG;
        //Tgpe = mygpe.Gp2;
        //gpeLiba = LsGties.Where(ut => ut.Elea == mygpe.Elea).FirstOrDefault().Liba.ToUpperInvariant();
        StateHasChanged();
        Console.WriteLine("PAS 2");
        await Task.Delay(1);
    }
    void NavigateBack()
    {
        _navmanager.NavigateTo("/");
    }
}