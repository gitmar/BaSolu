@page "/astrmenu"
@inherits LayoutComponentBase
@layout FreeLayout

@using System.Security.Claims
@using System.Linq.Expressions
@using BlazorBootstrap
@using Blazored.LocalStorage
@using GxAdm.ClieModels
@using GxAdm.Components.Admina.Astreins
@using GxAdm.Services
@using GxAdm.StaticHelpers
@using GxShared.Sess
@using GxShared.Others
@using GxWapi.DaModels
@using Microsoft.OData.Client
@using Newtonsoft.Json
@using Gx.Components
@using Gx.Components.Navigation

@inject NavigationManager _navmanager
@inject ILocalStorageService _localStorage
@inject HttpClientService _clieManager
@inject IODataContextFactory _contextFactory
@inject SessionContextService _sessionContext
@inject RendAgres _rendAgres
@inject PendingChangesGuard _guard
@inject IMessageService _messageService

@if (isLoading)
{
    <div class="text-center">
        <Spinner Color="SpinnerColor.Primary" Size="SpinnerSize.Large" />
        <p>PARAMS/TABLES Loading...</p>
    </div>
}
@if(!isLoading)
{
    <div class="gx-screen-layout">
     <div class="container gx-parent-container" style="height: 100vh;">
        <div class="d-flex flex-column" style="height: 100%;">
                <!-- Top Menu -->
                <GxNavMenu BrandText="A24soft Gx-Solutions"
                           MenuItems="@MenuItems"
                           YaGroup="false"
                           Groups="@Groupes"
                           MenuSelected="@_chxMenu"
                           MenuSelectedChanged="@SelMenu"
                           GroupSelected="@_chxGpe"
                           GroupSelectedChanged="@SelGpe"
                           OnBack="@NavigateBack" />

                <div class="row">
                    <div class="col-md-12 input-group align-middle">
                        <span class="text-uppercase text- text-success"><b>@strComp</b></span>
                        @* @if (curOrga != null && toChild != null && curODContext != null)
                        {
                            <MessageHost>
                                @if (_chxMenu == 1)
                                {
                                    <Gtables />
                                }
                                else if (_chxMenu == 2)
                                {
                                    <Gatribs />
                                }
                                else if (_chxMenu == 3)
                                {
                                    <Gconstes />
                                }
                            </MessageHost>
                        } *@
                        <span class="separator">|| </span>
                        <Button class="btn btn-sm btn-secondary btnsz"
                                style="@(!allEnable ? "" : "display:none;")"
                                @onclick="ManEditAll">
                            Modifier
                        </Button>
                        <Button class="btn btn-sm btn-secondary btnsz"
                                style="@(allEnable ? "" : "display:none;")"
                                @onclick="ManCnclAll">
                            Annuler
                        </Button>
                        <span class="separator">|  </span>
                        <Button class="btn btn-sm btn-secondary btnsz"
                                style="@(allEnable ? "" : "display:none;")"
                                @onclick="ManSaveAll">
                            Enregistrer
                        </Button>     
                    </div>
                </div>

                <!-- Main Content -->
                @if (curOrga != null && toChild != null && curODContext != null)
                {
                    @if (_chxMenu == 1)
                    {
                        <Gtables @ref="mygtbl"
                        curOrga="@curOrga"
                        _guard="@_guard"
                        toChild="@toChild"
                        allEnable="@allEnable"
                        curODContext="@curODContext">
                            <ChildContent>
                                @* <h2 class="child-box">Hello TABLES</h2> *@
                            </ChildContent>
                        </Gtables>
                    }
                    else if (_chxMenu == 2)
                    {
                        <Gatribs @ref="mygatr"
                        curOrga="@curOrga"
                        toChild="@toChild"
                        allEnable="@allEnable"
                        curODContext="@curODContext">
                            <ChildContent>
                                @* <h2 class="child-box">Hello ATTRIBUTS</h2> *@
                            </ChildContent>
                        </Gatribs>
                    }
                    else if (_chxMenu == 3)
                    {
                        <Gconstes @ref="mygcst"
                        curOrga="@curOrga"
                        toChild="@toChild"
                        allEnable="@allEnable"
                        curODContext="@curODContext">
                            <ChildContent>
                                @* <h2 class="child-box">Hello ATTRIBUTS</h2> *@
                            </ChildContent>
                        </Gconstes>
                    }
                    @* else if (_chxMenu == 4)
                    {
                        <ArubMenu @ref="myamenu">
                                  curOrga="@curOrga"
                                  toChild="@toChild"
                                  curODContext="@curODContext">
                            <ChildContent>
                            </ChildContent>
                        </ArubMenu>
                    } *@

                }
        </div>
    </div>
        <div class="row mt-3">
            <div class="col-12">
                @if (_guard.HasPendingChanges())
                {
                    <div class="alert alert-warning">
                        <strong>@pendingCount changes pending across all tabs</strong>
                    </div>
                }
                <div class="d-flex gap-2 justify-content-end">
                    <Button Color="ButtonColor.Primary"
                            @onclick="SaveAllAsync"
                            Enabled="@_guard.HasPendingChanges()">
                        Save All (@pendingCount changes)
                    </Button>
                    <Button Color="ButtonColor.Secondary"
                            @onclick="CancelAllChanges">
                        Cancel All Changes
                    </Button>
                </div>
            </div>
        </div>
    </div>
}
<ErrorBoundary>
    <ErrorContent>
        An unexpected error occured. Please try again later.
    </ErrorContent>
</ErrorBoundary>
@code {

    private int selectedMenu = 1;

    private bool isLoading = true;
    //public MyODataContext curODContext;
    public MyODataContext? curODContext = null;
    public Gxorga curOrga = new Gxorga();
    public MyShareVars toChild = new MyShareVars();
    public RenderFragment ChildContent { get; set; }
    private bool allEnable = false;
    private string Imessage = "", Jmessage = "";

    private Gtables mygtbl = new();
    private Gatribs mygatr = new();
    private Gconstes mygcst = new();
    private ArubMenu myamenu = new();

    //message managment

    //private Gcolons mygcol;

    //private OrigGgrilles mygcatr;

    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }
    public ClaimsPrincipal authUser;
    public bool isAuthenticated = false;
    //in DATA
    public List<Gsgfix> LsTables = new List<Gsgfix>();

    private string _strOrga = "", _curSigle = "", strmeta = "", strmeta2 = "";
    //private int _lgcdu = 0;
    //entities load
    private IEnumerable<Gxorga> _lsOrgas = new List<Gxorga>();

    //GlobModels
    public Userbag _usrBag = new Userbag();
    public List<Gpfixe> LsFixes = new();
    //public List<Upara> Uafls = new();
    public List<Gpdivh> LsDivs = new();
    public List<Gpvar> LsVars = new();
    public List<Gplan> LsPlans = new();
    public List<Gpvar> LtTabls = new();
    public List<Gpvar> LsTabls = new();
    //public List<Gpvar> TbElems = new();
    //public List<Clvar> LsCols = new();
    //Navigation
    private int _gIdTie = 0, _chxGpe = 0, _chxMenu = 1;
    private string strComp = "Tables";

    //menus
    public List<GxMenuItem> MenuItems = new()
    {
        new GxMenuItem { Id = 1, Text = "Tables", Icon = "bi bi-box-arrow-in-down" },
        new GxMenuItem { Id = 2, Text = "Attributs", Icon = "bi bi-house-door" },
        new GxMenuItem { Id = 3, Text = "Documents", Icon = "bi bi-house-door" },
        //new MenuItem { Id = 4, Text = "Mutation", Icon = "bi bi-arrow-repeat" },
    };
    public List<GxGroupe> Groupes = new();

    //modal management
    private string SidebarStyle = "width: 200px;";
    private bool IsOpen = true;
    private bool FirstLoadCompleted = false;
    private bool ContentLoaded { get; set; } = false;

    //Guard
    private int pendingCount => _guard.HasPendingChanges() ?
        curODContext.Context.Entities.Count(e => e.State != EntityStates.Unchanged) : 0;
    private async Task SaveAllAsync()
    {
        try
        {
            await _guard.FlushAsync();
            Imessage = "✅ Save successful";
        } 
        catch(Exception ex)
        {
            Imessage = $"❌ Save failed: {ex.Message}";
            await _guard.CancelChangesAsync();
        }
        StateHasChanged();
    }
    private async void CancelAllChanges()
    {
        await _guard.CancelChangesAsync();
        StateHasChanged();
    }
    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;

            // 1. CRITICAL: AUTH FIRST
            var authState = await AuthState!;
            if (!authState.User.Identity.IsAuthenticated)
            {
                _messageService.Show("❌ Utilisateur non authentifié", ToastType.Danger);
                return;  // STOP EXECUTION
            }

            // 2. Load user context
            _usrBag = await _sessionContext.GetUserbagAsync();
            if (_usrBag == null)
            {
                _messageService.Show("❌ Session utilisateur invalide", ToastType.Danger);
                return;
            }

            _gIdTie = _usrBag.Usorga.Gdtie;
            LsFixes = _usrBag.Ufixes.ToList();
            LsVars = _usrBag.Usorga.Uvars.ToList();
            LsPlans = _usrBag.Usorga.Uplns.ToList();
            LtTabls = _usrBag.Usorga.Uvars.Where(tb => tb.Gvars == 4).ToList();
            LsTabls = _usrBag.Usorga.Uvars.Where(tb => tb.Gvars == 5).ToList();

            // 3. Parallel loads for performance
            var allDivsTask = _rendAgres.LoadOrgaPostes();
            var allDivs = await allDivsTask;
            LsDivs = allDivs.Where(ud => ud.Pdom == 6 && ud.Patr == 1).ToList();

            await LoadSTROrgaAsync();
            // 4. NOW pass to child (all data ready)
            toChild.authUser = authUser;
            toChild.isAuthenticated = true;
            toChild.LsDivs = LsDivs;
            toChild.LsVars = LsVars;
            toChild.LsFixes = LsFixes;
            toChild.LsPlans = LsPlans;
            toChild.LsTabls = LsTabls;
            toChild.curOrga = curOrga;  // ADD THIS!
        }
        catch (Exception ex)
        {
            _messageService.Show($"❌ Erreur chargement: {ex.Message}", ToastType.Danger);
            Console.WriteLine($"Load error: {ex}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    public async Task LoadSTROrgaAsync()
    {
        int pisa = 2;
        try
        {
            curODContext = await _contextFactory.CreateAsync();  // ✅ DISPOSES AUTOMATICALLY
            _guard.AttachContext(curODContext);

            int key = _usrBag.Idorg;
            string expandPlngens = ODataQueryHelper.Expand<Gxorga, IEnumerable<Plngen>>(o => o.Plngens);
            string expandPlngensNested = expandPlngens + "($expand=Rubvars)";
            string expandGsgfixes = ODataQueryHelper.Expand<Gxorga, IEnumerable<Gsgfix>>(g => g.Gsgfixes);
            string expandGsglnes = ODataQueryHelper.Expand<Gxorga, IEnumerable<Gsglne>>(g => g.Gsglnes);
            string expand = string.Join(",", expandPlngensNested, expandGsgfixes, expandGsglnes);

            curOrga = await curODContext.GetByKeyAsync<Gxorga>(key, "Gxorgas", expand);

            if (curOrga == null)
            {
                _messageService.Show("❌ Organisation non trouvée", ToastType.Danger);
                return;
            }
        }
        catch (Exception ex)
        {
            _messageService.Show($"❌ Erreur organisation: {ex.Message}", ToastType.Danger);
            Console.WriteLine($"pisa {pisa}: {ex}");
        }
    }

    // protected override async Task OnInitializedAsync()
    // {
    //     isLoading = true;
    //     _usrBag = await _sessionContext.GetUserbagAsync();
    //     _gIdTie = _usrBag.Usorga.Gdtie;
    //     LsFixes = _usrBag.Ufixes.ToList();
    //     var allDivs = await _rendAgres.LoadOrgaPostes();
    //     LsDivs = allDivs.Where(ud => ud.Pdom == 6 && ud.Patr == 1).ToList();
    //     LsVars = _usrBag.Usorga.Uvars.ToList();
    //     LsFixes = _usrBag.Ufixes.ToList();
    //     LsPlans = _usrBag.Usorga.Uplns.ToList();
    //     LtTabls = _usrBag.Usorga.Uvars.Where(tb => tb.Gvars == 4).ToList();
    //     LsTabls = _usrBag.Usorga.Uvars.Where(tb => tb.Gvars == 5).ToList();
    //     await LoadSTROrgaAsync();
  
    //     Console.WriteLine("TIERS A ETE TESTE");
    //     toChild.authUser = authUser;
    //     toChild.isAuthenticated = isAuthenticated;
    //     toChild.LsDivs = LsDivs.ToList();
    //     toChild.LsVars = LsVars.ToList();
    //     toChild.LsFixes = LsFixes.ToList();
    //     toChild.LsPlans = LsPlans.ToList();
    //     toChild.LsTabls = LsTabls.ToList();
    //     isLoading = false;
    // }
    // //CRUD
    // public async Task LoadSTROrgaAsync()
    // {
    //     int pisa = 2;
    //     try
    //     {
    //         curODContext = await _contextFactory.CreateAsync();
    //         _guard.AttachContext(curODContext);
    //         int key = _usrBag.Idorg;
    //         string expandPlngens = ODataQueryHelper.Expand<Gxorga, IEnumerable<Plngen>>(o => o.Plngens);
    //         string expandPlngensNested = expandPlngens + "($expand=Rubvars)";
    //         string expandGsgfixes = ODataQueryHelper.Expand<Gxorga, IEnumerable<Gsgfix>>(g => g.Gsgfixes);
    //         string expandGsglnes = ODataQueryHelper.Expand<Gxorga, IEnumerable<Gsglne>>(g => g.Gsglnes);

    //         string expand = string.Join(",", expandPlngensNested, expandGsgfixes, expandGsglnes);
    //         curOrga = await curODContext.GetByKeyAsync<Gxorga>(
    //             key,
    //             "Gxorgas",
    //             expand
    //         );
    //         if (curOrga == null)
    //         {
    //             Console.WriteLine("No organization found for the current user.");
    //             return;
    //         }
    //         Console.WriteLine($"orga recu {curOrga.Raison}");
    //         Console.WriteLine($"nb plans curOrga {curOrga.Plngens.Count()}");
    //     }catch(Exception ex)
    //     {
    //         Console.WriteLine($"ICI TODAY stack trace : {ex.StackTrace} place : {pisa} ex-mess : {ex.Message} and also in-mess: {ex.InnerException}");
    //     }
    // }
    // protected override async Task OnAfterRenderAsync(bool firstRender)
    // {
    //     if (firstRender)  // Old way
    //     {                          // vs
    //         var authState = await AuthState;
    //         if (!authState.User.Identity.IsAuthenticated)  // New way - works everywhere
    //         {
    //             _messageService.Show("❌ Utilisateur non authentifié", ToastType.Danger);
    //             return;
    //         }
    //     }
    // }

    private async Task ManEditAll()
    {
        Imessage = "Edition en preparation...";
        if (_chxMenu == 1)
        { //tables
            //await mygtbl.EdtAll();
        }
        if (_chxMenu == 2)
        { //attributs
            //await mygatr.EdtAll();
        }
        if (_chxMenu == 3)
        { //constantes
            //await mygcst.EdtAll();
        }
        // if (_chxMenu == 4)
        // { //plans
        //     await mygpln.EdtAll();
        // }
        // if (_chxMenu == 4)
        // { //colonnes
        //     await mygcol.EdtAll();
        // }
        Imessage = "";
        allEnable = true;
    }
    private async Task ManCnclAll()
    {
        Imessage = "annulation en cours...";
        if (_chxMenu == 1)
        { //tables
            await mygtbl.CncAll();
        }
        if (_chxMenu == 2)
        { //atributs
            await mygatr.CncAll();
        }
        if (_chxMenu == 3)
        { //constantes
            await mygcst.CncAll();
        }
        // if (_chxMenu == 4)
        // { //plans
        //     await mygpln.CncAll();
        // }
        // if (_chxMenu == 4)
        // { //colonnes
        //     await mygcol.CncAll();
        // }
        //reload
        await LoadSTROrgaAsync();
        Imessage = "";
        allEnable = false;
    }
    private async Task ManSaveAll()
    {
        bool oksav = false;
        Imessage = "enregistrement en cours...";
        if(_chxMenu == 1)
        { //tables
            //oksav = await mygtbl.SaveCurEntities();
        }
        if (_chxMenu == 2)
        { //atributs
            //oksav = await mygatr.SaveCurEntities();
        }
        if (_chxMenu == 3)
        { //constantes
            //oksav = await mygcst.SaveCurEntities();
        }
        // if (_chxMenu == 4)
        // { //plan
        //     oksav = await mygpln.SaveCurEntities();
        // }
        // if (_chxMenu == 4)
        // { //colonnes
        //     oksav = await mygcol.SaveCurEntities();
        // }
        if (oksav) Imessage = "";
        allEnable = false;
    }
    // private async Task SelMenu(int noM)
    // {
    //     _chxMenu = noM;
    //     if (_chxMenu == 1) strComp = "Tables";
    //     if (_chxMenu == 2) strComp = "Attributs";
    //     if (_chxMenu == 3) strComp = "Documents";
    //     //if (_chxMenu == 4) strComp = "Colonnes";
    //     //if (_chxMenu == 5) strComp = "Colonnes";
    //     allEnable = false;
    //     StateHasChanged();
    //     await Task.Delay(800);
    // }
    // private async Task LoadOrgaPostes()
    // {
    //     //FmtPsts
    //     //LsDivs = await _rendAgres.LoadOrgaPostes();
    //     // var indata = await _clieManager.SendRequestAsync("AUTHClient", HttpMethod.Get, "lgauth/rubhiepsts");
    //     // //Console.WriteLine($"21RECU DE LOGIN {strcall}");
    //     // var inResu = JsonConvert.DeserializeObject<List<Gpdivh>>(indata);
    //     // if (inResu.Any())
    //     // {
    //     //     Console.WriteLine($"Nb Divs : {inResu.Count}");
    //     //     LsDivs = inResu.ToList();
    //     // }
    //     // else
    //     // {
    //     //     Console.WriteLine("Nb Psts : null");
    //     //     LsDivs = new();
    //     // }
    //     //Pdom 6tiers Patr1baseadm
        
    // }
    private async Task SelMenu(int noM)
    {
        _chxMenu = noM;
        if (_chxMenu == 1) strComp = $"Tables";
        if (_chxMenu == 2) strComp = $"Attributs";
        if (_chxMenu == 3) strComp = $"Documents";
        // if (_chxMenu == 4)
        // {
        //     strComp = $"Aplans";
        // }
        //if (_chxMenu == 5) strComp = "Colonnes";
        allEnable = false;
        StateHasChanged();
        await Task.Delay(1);
    }
    private async Task SelGpe(int noG)
    {
        _chxGpe = noG;
        //gpeLiba = "";
        //if (noG == 0) return;
        //var mygpe = LsGties.Where(gt => gt.Itb == 6 && gt.Elea == noG).FirstOrDefault();
        //LsCols = curOrga.Gsglnes.Where(ug => ug.Otyp == 5 && ug.Dtyp == 6 && ug.Totyp == Ugpe && ug.Jacc == 1).ToList();
        //Ugpe = noG;
        //Tgpe = mygpe.Gp2;
        //gpeLiba = LsGties.Where(ut => ut.Elea == mygpe.Elea).FirstOrDefault().Liba.ToUpperInvariant();
        StateHasChanged();
        Console.WriteLine("PAS 2");
        await Task.Delay(1);
    }
    private async Task Save()
    {
        await _guard.FlushAsync();  // ✅ Parallel batch saves
    }
    void NavigateBack()
    {
        _navmanager.NavigateTo("/");
    }
}