@page "/astrmenu"
@layout FreeLayout

@using System.Security.Claims
@using System.Linq.Expressions
@using BlazorBootstrap
@using Blazored.LocalStorage
@using GxAdm.ClieModels
@using GxAdm.Components.Admina.Astreins
@using GxAdm.Services
@using GxShared.GlobModels
@using GxWapi.DaModels
@using Microsoft.OData.Client
@using Newtonsoft.Json

@inject NavigationManager _navmanager
@inject ILocalStorageService _localStorage
@inject HttpClientService _cliemanager
@inject IODataContextFactory _contextFactory
@inject SessionContextService _sessionContext
@inject RendAgres _rendAgres

@if (isLoading)
{
    <div class="text-center">
        <Spinner Color="SpinnerColor.Primary" Size="SpinnerSize.Large" />
        <p>PARAMS/TABLES Loading...</p>
    </div>
}
@if(!isLoading)
{
<div class="mag-screen-layout">
    <div class="container" style="height: 100vh;">
        <div class="d-flex flex-column" style="height: 100%;">
            <!-- Top Menu -->
                <div class="content-and-sidebar-container bg-success bg-opacity-10">
                    <button class="navbar-brand text-left text-white bg-dark bg-opacity-75 me-2 py-0 px-1" style="height:44px;" @onclick="NavigateBack">
                        A24soft Gx-Solutions
                    </button>
                    <div><span class="separator">||</span></div>
                    <ul class="menu">
                        <li><NavLink @onclick="() => SelMenu(1)" class="nav-item" ActiveClass="active">Tables</NavLink></li>
                        <li><span class="separator">|</span></li>
                        <li><NavLink @onclick="() => SelMenu(2)" class="nav-item">Attributs</NavLink></li>
                        <li><span class="separator">|</span></li>
                        <li><NavLink @onclick="() => SelMenu(3)" class="nav-item">Documents</NavLink></li>
                        @* <li><span class="separator">|</span></li> *@
                        @* <li><NavLink @onclick="() => SelMenu(4)" class="nav-item">Plans</NavLink></li>
                        <li><span class="separator">|</span></li> *@
                        @* <li><NavLink @onclick="() => SelMenu(4)" class="nav-item">Colonnes</NavLink></li> *@
                    </ul>
                </div>
                <div class="row">
                    <div class="col-md-12 input-group align-middle">
                        <span class="text-uppercase text- text-success"><b>@strComp</b></span>
                        &nbsp;&nbsp;
                        <span class="separator">|| </span>
                        <Button class="btn btn-sm btn-secondary btnsz"
                                style="@(!allEnable ? "" : "display:none;")"
                                @onclick="ManEditAll">
                            Modifier
                        </Button>
                        <Button class="btn btn-sm btn-secondary btnsz"
                                style="@(allEnable ? "" : "display:none;")"
                                @onclick="ManCnclAll">
                            Annuler
                        </Button>
                        <span class="separator">|  </span>
                        <Button class="btn btn-sm btn-secondary btnsz"
                                style="@(allEnable ? "" : "display:none;")"
                                @onclick="ManSaveAll">
                            Enregistrer
                        </Button>
                        @if (!String.IsNullOrEmpty(MImessage))
                        {
                            <span class="bg-info bg-opacity-10" style="font-style:italic;color:red">&nbsp;--> @MImessage</span>
                        }
                    </div>
                </div>
                <!-- Main Content -->
                @if (curOrga != null && toChild != null && curODContext != null)
                {
                    @if (chxMenu == 1)
                    {
                        <Gtables @ref="mygtbl"
                        curOrga="@curOrga"
                        toChild="@toChild"
                        curODContext="@curODContext">
                            <ChildContent>
                                @* <h2 class="child-box">Hello TABLES</h2> *@
                            </ChildContent>
                        </Gtables>
                    }
                    else if (chxMenu == 2)
                    {
                        <Gatribs @ref="mygatr"
                        curOrga="@curOrga"
                        toChild="@toChild"
                        curODContext="@curODContext">
                            <ChildContent>
                                @* <h2 class="child-box">Hello ATTRIBUTS</h2> *@
                            </ChildContent>
                        </Gatribs>
                    }
                    else if (chxMenu == 3)
                    {
                        <Gcstes @ref="mygcst"
                        curOrga="@curOrga"
                        toChild="@toChild"
                        curODContext="@curODContext">
                            <ChildContent>
                                @* <h2 class="child-box">Hello ATTRIBUTS</h2> *@
                            </ChildContent>
                        </Gcstes>
                    }
                }
        </div>
    </div>
</div>
}
<ErrorBoundary>
    <ErrorContent>
        An unexpected error occured. Please try again later.
    </ErrorContent>
</ErrorBoundary>
@code {
    private bool isLoading = true;
    public MyODataContext curODContext;
    public Gxorga curOrga = new Gxorga();
    public MyShareVars toChild = new MyShareVars();
    private bool allEnable = false;
    private string MImessage = "";

    private Gtables mygtbl;
    private Gatribs mygatr;
    private Gcstes mygcst;
    //private Gplans mygpln;
    //private Gcolons mygcol;

    //private OrigGgrilles mygcatr;

    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }
    public bool isOwner = false;
    public ClaimsPrincipal authUser;
    public bool isAuthenticated = false;
    //in DATA
    public List<Gsgfix> LsTables = new List<Gsgfix>();

    private int _GIdTie = 0;
    private string _strOrga = "", _curSigle = "", strmeta = "", strmeta2 = "";
    //private int _lgcdu = 0;
    //entities load
    private IEnumerable<Gxorga> _lsOrgas = new List<Gxorga>();

    //GlobModels
    public Userbag _usrBag = new Userbag();
    public List<Gpfixe> LsFixes = new();
    //public List<Upara> Uafls = new();
    public List<Gpdivh> LsDivs = new();
    public List<Gpvar> LsVars = new();
    public List<Gplan> LsPlans = new();
    public List<Gpvar> LtTabls = new();
    public List<Gpvar> LsTabls = new();
    //public List<Gpvar> TbElems = new();
    //public List<Clvar> LsCols = new();
    //Navigation
    private int chxMenu = 1;
    private string strComp = "Tables";
    //modal management
    private string SidebarStyle = "width: 200px;";
    private bool IsOpen = true;
    private bool FirstLoadCompleted = false;
    private bool ContentLoaded { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        var authState = await AuthState;
        authUser = authState.User;
        isAuthenticated = authUser.Identity.IsAuthenticated;
        if (!isAuthenticated)
        {
            Console.WriteLine("Authentication in Astreintes Utilisateur ECHEC");
            return;
        }
        else
        {
            Console.WriteLine("Authentication in Astreintes SUCCESS");
        }
        _usrBag = await _sessionContext.GetUserbagAsync();
        _GIdTie = _usrBag.Usorga.Gdtie;
        //var idplnadm = _usrBag.Usorga.Schba;
        // LsDivs = _usrBag.Usorga.Uhies
        //     .Where(uh => uh.Idpln == idplnadm && uwaih.Sidiv == 1).ToList();
        LsFixes = _usrBag.Ufixes.ToList();
        //LsGties = _usrBag.Ufixes
        //    .Where(ut => ut.Gvars == 36 && ut.Elea != 0 && ut.Elea != 9)
        //    .ToList();
        //LsDoms = _usrBag.Ufixes
        //    .Where(ut => ut.Gvars == 36 && ut.Itb == 4 && ut.Gp1 == 3 && ut.Elea != 0)
        //    .ToList();
        var allDivs = await _rendAgres.LoadOrgaPostes();
        LsDivs = allDivs.Where(ud => ud.Pdom == 6 && ud.Patr == 1).ToList();
        isOwner = _usrBag.SiOwner;
        LsVars = _usrBag.Usorga.Uvars.ToList();
        LsFixes = _usrBag.Ufixes.ToList();
        LsPlans = _usrBag.Usorga.Uplns.ToList();
        LtTabls = _usrBag.Usorga.Uvars.Where(tb => tb.Gvars == 4).ToList();
        LsTabls = _usrBag.Usorga.Uvars.Where(tb => tb.Gvars == 5).ToList();
        //LsCols = ColBag.Ucols.Where(uv => uv.Jtyp == 1).OrderBy(uv => uv.Ydpd).ToList();
        //TbElems = _usrBag.Usorga.Uvars.Where(uv => uv.Gvars == 5 && uv.Ade == 1 && uv.Elea != 0).ToList();
        //ensemble des roles
        //var _allRoles = _usrBag.Allroles;
        //var _usrRoles = _usrBag.Allroles.Where(ur => ur.Sicur == true).ToList();
        //int minrol = _usrBag.Usprof.Rlmin;
        await LoadSTROrgaAsync();
        //pita = 5;

        Console.WriteLine("TIERS A ETE TESTE");
        toChild.authUser = authUser;
        toChild.isAuthenticated = isAuthenticated;
        toChild.LsDivs = LsDivs.ToList();
        toChild.LsVars = LsVars.ToList();
        toChild.LsFixes = LsFixes.ToList();
        toChild.LsPlans = LsPlans.ToList();
        toChild.LsTabls = LsTabls.ToList();
        isLoading = false;
    }
    //CRUD
    public async Task LoadSTROrgaAsync()
    {
        int pisa = 2;
        try
        {
            curODContext = await _contextFactory.CreateAsync();
            //curOrga et Gsgfixes, Gsglnes
            var expand = "Gsgfixes," + "Gsglnes";
            //Expression<Func<Gxorga, bool>> ogfilter = g => g.Idorg == _usrBag.Idorg;
            var dxorgas = await curODContext.LoadFilteredAsync<Gxorga>(expand: expand);
            pisa = 3;
            curOrga = dxorgas.FirstOrDefault();
            if (curOrga == null)
            {
                Console.WriteLine("No organization found for the current user.");
                return;
            }
            Console.WriteLine($"orga recu {curOrga.Raison}");
            //Console.WriteLine($"nb gsgfixes : {curOrga.Gsgfixes.Count()}");
            //curOrga Plngens and rubvars
            var expand2 = "Rubvars";
            var dxplns = await curODContext.LoadFilteredAsync<Plngen>(expand: expand2);
            pisa = 4;
            //Console.WriteLine($"nb de plans :  {dxplns.Count()}");
        }catch(Exception ex)
        {
            Console.WriteLine($"ICI TODAY stack trace : {ex.StackTrace} place : {pisa} ex-mess : {ex.Message} and also in-mess: {ex.InnerException}");
        }
    }

    private async Task ManEditAll()
    {
        MImessage = "Edition en preparation...";
        if (chxMenu == 1)
        { //tables
            await mygtbl.EdtAll();
        }
        if (chxMenu == 2)
        { //attributs
            await mygatr.EdtAll();
        }
        if (chxMenu == 3)
        { //constantes
            await mygcst.EdtAll();
        }
        // if (chxMenu == 4)
        // { //plans
        //     await mygpln.EdtAll();
        // }
        // if (chxMenu == 4)
        // { //colonnes
        //     await mygcol.EdtAll();
        // }
        MImessage = "";
        allEnable = true;
    }
    private async Task ManCnclAll()
    {
        MImessage = "annulation en cours...";
        if (chxMenu == 1)
        { //tables
            await mygtbl.CncAll();
        }
        if (chxMenu == 2)
        { //atributs
            await mygatr.CncAll();
        }
        if (chxMenu == 3)
        { //constantes
            await mygcst.CncAll();
        }
        // if (chxMenu == 4)
        // { //plans
        //     await mygpln.CncAll();
        // }
        // if (chxMenu == 4)
        // { //colonnes
        //     await mygcol.CncAll();
        // }
        //reload
        await LoadSTROrgaAsync();
        MImessage = "";
        allEnable = false;
    }
    private async Task ManSaveAll()
    {
        bool oksav = false;
        MImessage = "enregistrement en cours...";
        if(chxMenu == 1)
        { //tables
            oksav = await mygtbl.SaveCurEntities();
        }
        if (chxMenu == 2)
        { //atributs
            oksav = await mygatr.SaveCurEntities();
        }
        if (chxMenu == 3)
        { //constantes
            oksav = await mygcst.SaveCurEntities();
        }
        // if (chxMenu == 4)
        // { //plan
        //     oksav = await mygpln.SaveCurEntities();
        // }
        // if (chxMenu == 4)
        // { //colonnes
        //     oksav = await mygcol.SaveCurEntities();
        // }
        if (oksav) MImessage = "";
        allEnable = false;
    }
    private async Task SelMenu(int noM)
    {
        chxMenu = noM;
        if (chxMenu == 1) strComp = "Tables";
        if (chxMenu == 2) strComp = "Attributs";
        if (chxMenu == 3) strComp = "Documents";
        //if (chxMenu == 4) strComp = "Colonnes";
        //if (chxMenu == 5) strComp = "Colonnes";
        allEnable = false;
        StateHasChanged();
        await Task.Delay(800);
    }
    // private async Task LoadOrgaPostes()
    // {
    //     //FmtPsts
    //     //LsDivs = await _rendAgres.LoadOrgaPostes();
    //     // var indata = await _cliemanager.SendRequestAsync("AUTHClient", HttpMethod.Get, "lgauth/rubhiepsts");
    //     // //Console.WriteLine($"21RECU DE LOGIN {strcall}");
    //     // var inResu = JsonConvert.DeserializeObject<List<Gpdivh>>(indata);
    //     // if (inResu.Any())
    //     // {
    //     //     Console.WriteLine($"Nb Divs : {inResu.Count}");
    //     //     LsDivs = inResu.ToList();
    //     // }
    //     // else
    //     // {
    //     //     Console.WriteLine("Nb Psts : null");
    //     //     LsDivs = new();
    //     // }
    //     //Pdom 6tiers Patr1baseadm
        
    // }
    void NavigateBack()
    {
        _navmanager.NavigateTo("/");
    }
}