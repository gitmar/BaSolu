@page "/zzprubsaie"
@layout PrubMenu

@using System
@using System.Collections.ObjectModel
@using System.ComponentModel.DataAnnotations
@using System.Dynamic
@using System.Linq.Expressions
@using System.Net.Http.Headers
@using System.Reflection
@using System.Security.Claims
@using System.Text.RegularExpressions
@using System.Web
@using BlazorBootstrap
@using Blazored.LocalStorage
@using GxAdm.ClieModels
@using GxAdm.Services
@using GxShared.Sess
@using GxWapi.DaModels
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.OData.Client
@using Newtonsoft.Json

@inject ILocalStorageService _localStorage
@inject NavigationManager _navmanager
@inject HttpClientService _cliemanager
@inject IJSRuntime _jsRun

<!-- InscTiewComponent.razor -->
<PageTitle>Tables</PageTitle>

@if (isLoading)
{
    <Progress class="progress mb-3">
        <ProgressBar Width="30" Label="Programs/Plan Loading..." Type="ProgressType.StripedAndAnimated" Color="ProgressColor.Primary" />
    </Progress>
}
else
{
    <div class="d-flex flex-column">
        <div class="my-container">
            @if (toChild != null)
            {
                @ChildContent
            }
        </div>
    </div>
    <AuthorizeView>
        <Authorized Context="AuthContext">
            <div class="row">
                <div class="col-md-12 input-group align-middle">
                    <span><b>Message :</b></span>
                    &nbsp;&nbsp;
                    @if (!String.IsNullOrEmpty(Imessage))
                    {
                        <span class="bg-info bg-opacity-10" style="font-style:italic;color:red">&nbsp;--> @Imessage</span>
                    }
                </div>
            </div>
            <div class="form-group">
                <div class="btn btn-group">
                    @* <label class="me-2">Domaine :</label>
                    <InputSelect @bind-Value="IMyDom" class="me-3" style="width:auto">
                        <option class="jchx" value="0domaine</option>
                        @foreach (var tob in LsPDoms.Where(ug => ug.Gp2 == IMyGpln)) //LsFixes.Where(ut => ut.Gvars == 61 && ut.Itb == 1 & ut.Elea != 0))
                        {
                            <option value="@tob.Gp1" @onclick="() => SelPlanDom(tob.Gp1)">@tob.Liba</option>
                        }
                    </InputSelect>*@          
                    <label class="fw-bold">Base :</label>
                    <InputSelect @bind-Value="IMyVue" class="me-3" style="width:auto">
                        <option class="jchx" value="0">?util</option>
                        @foreach (var tob in LsVues) //.Where(ut => ut.Gvars == 62 && ut.Itb == 1 && ut.Elea != 0 && ut.Gp2 == IMyDom))
                        {
                            <option value="@tob.Elea" @onclick="() => SelPlanVue(tob.Elea)">@tob.Liba</option>
                        }
                    </InputSelect>
                </div>
            </div>
            <div class="container-fluid-fixed-top">
                @if (curOrga == null)
                {
                    <p style="color:red;">Warning: curOrga is unexpectedly null.</p>
                }
                else
                {
                  <EditForm Context="invform" Model="@curOrga">
                        <DataAnnotationsValidator />
                        <ValidationSummary />
                        <div class="row">
                            @if (!String.IsNullOrEmpty(Kmessage))
                            {
                                <span class="bg-info bg-opacity-10" style="font-style:italic;color:red">&nbsp;--> @Jmessage</span>
                            }
                        </div>
                        <div class="row">
                            @if (IMyDom != 0 && IMyVue != 0)
                            {
                                <Grid TItem="Plngen"
                                      Data="@MyDaPlans"
                                      @key="PlanRenderKey"
                                      AllowDetailView="true"
                                      AllowRowClick="true"
                                      OnRowClick="@OnPlnRowClick"
                                      AllowPaging="true"
                                      Responsive="true">
                                    <GridColumns>
                                        <GridColumn TItem="Plngen" HeaderText="No">
                                            <ChildContent Context="item">
                                                @if (item.Xadd1 == -1)
                                                {
                                                    <span>?@item?.Iui</span>
                                                }
                                                else
                                                {
                                                    <span class="plnpoint">@item?.Iele</span>
                                                }
                                            </ChildContent>
                                        </GridColumn>
                                        <GridColumn TItem="Plngen" HeaderText="Designation">
                                            <ChildContent Context="item">
                                                @if (EdPlnRowguid == item.Rowguid)
                                                {

                                                    <InputText @bind-Value="draftPln.Liba" />
                                                }
                                                else
                                                {
                                                    @item.Liba
                                                }
                                            </ChildContent>
                                        </GridColumn>
                                        <GridColumn TItem="Plngen" HeaderText="abrege">
                                            <ChildContent Context="item">
                                                @if (EdPlnRowguid == item.Rowguid)
                                                {

                                                    <InputText @bind-Value="draftPln.Abg" />
                                                }
                                                else
                                                {
                                                    @item.Abg
                                                }
                                            </ChildContent>
                                        </GridColumn>
                                        <GridColumn TItem="Plngen" HeaderText="Formule">
                                            <ChildContent Context="item">
                                                @if (EdPlnRowguid == item.Rowguid)
                                                { // show draftPln inputs
                                                  <Button Color="ButtonColor.Secondary" Class="btn btn-default btn-sm" @onclick="() => showFrplnModal(draftPln)">
                                                      <i class="bi bi-pencil-square"></i>
                                                      <span class="text-truncate d-inline-block" style="max-width: 100px;">@draftPln?.Fpsource</span>
                                                  </Button>
                                                }
                                                else
                                                { // show item as read-only
                                                  <Button Color="ButtonColor.Secondary" Class="btn btn-default btn-sm" @onclick="() => showFrplnModal(item)">
                                                      <i class="bi bi-pencil-square"></i>
                                                      <span class="text-truncate d-inline-block" style="max-width: 100px;">@item.Fpsource</span>
                                                  </Button>
                                                }
                                            </ChildContent>
                                        </GridColumn>
                                        <GridColumn TItem="Plngen" HeaderText="Eta">
                                            <HeaderContent>
                                                @if (IMyDom != 0 && IMyVue != 0)
                                                {
                                                    <button class="btn btn-primary btn-sm
                                                                            @(AllowMultipleEdits || !isAddPln ? "" : "disabled-action")"
                                                            @onclick="() => StartAddNewPlnAsync()">
                                                        ➕ Add
                                                    </button>
                                                }
                                            </HeaderContent>
                                            <ChildContent Context="item">
                                                @if (EdPlnRowguid == item.Rowguid)
                                                {
                                                    <InputSelect @bind-Value="draftPln.Eta">
                                                        <option class="jchx" value="0">?choisir</option>
                                                        @foreach (var tob in LsFixes.Where(ut => ut.Gvars == 32 && ut.Itb == 1 && ut.Elea != 0))
                                                        {
                                                            <option value="@tob.Elea">@tob.Liba</option>
                                                        }
                                                    </InputSelect>
                                                }
                                                else
                                                {
                                                    <InputSelect @bind-Value="item.Eta" disabled="true">
                                                        <option class="jchx" value="0">?choisir</option>
                                                        @foreach (var tob in LsFixes.Where(ut => ut.Gvars == 32 && ut.Itb == 1 && ut.Elea != 0))
                                                        {
                                                            <option value="@tob.Elea">@tob.Liba</option>
                                                        }
                                                    </InputSelect>
                                                }
                                            </ChildContent>
                                        </GridColumn>
                                        <GridColumn TItem="Plngen" HeaderText="actions" Filterable="false">
                                            <ChildContent Context="item">
                                                @if (IsPlnRowLocked(item.Rowguid))
                                                {
                                                    <span class="text-muted">—</span>
                                                }
                                                else
                                                {
                                                    <div @onclick:stopPropagation="true">
                                                        @if (DlPlnRowguid == item.Rowguid)
                                                        { //delete mode
                                                            <Button Color="ButtonColor.Danger"
                                                            Size="ButtonSize.Small"
                                                            @onclick="() => ConfirmPlnDelete(item)">
                                                                ⚠️ Confirm
                                                            </Button>
                                                            <Button Color="ButtonColor.Secondary"
                                                            Size="ButtonSize.Small"
                                                            @onclick="CancelPlnDelete">
                                                                ❎ Cancel
                                                            </Button>
                                                        }
                                                        else if (EdPlnRowguid == item.Rowguid)
                                                        { //edit mode
                                                            <Button Color="ButtonColor.Success"
                                                            Size="ButtonSize.Small"
                                                            @onclick="() => ConfirmPlnEdit(draftPln)">
                                                                💾 Save
                                                            </Button>
                                                            <Button Color="ButtonColor.Secondary"
                                                            Size="ButtonSize.Small"
                                                            @onclick="() => CancelPlnEdit(draftPln)">
                                                                ❎ Cancel
                                                            </Button>
                                                        }
                                                        else
                                                        { //normal mode
                                                            <Button Color="ButtonColor.Warning"
                                                            Size="ButtonSize.Small"
                                                            Disabled="DisablePlnActions"
                                                            @onclick="() => StartPlnEdit(item, item.Rowguid)">
                                                                ✏️ Edit
                                                            </Button>
                                                            <Button Color="ButtonColor.Danger"
                                                            Size="ButtonSize.Small"
                                                            Disabled="DisablePlnActions"
                                                            @onclick="() => StartPlnDelete(item)">
                                                                🗑 Delete
                                                            </Button>
                                                        }
                                                    </div>
                                                }
                                            </ChildContent>
                                        </GridColumn>
                                    </GridColumns>
                                    <GridDetailView TItem="Plngen" Context="parent">
                                        <div class="container-fluid">
                                            <div class="row">
                                                <div class="col-2">
                                                    <Button Color="ButtonColor.Secondary" Class="btn btn-default btn-sm" @onclick="() => showPgLink()">
                                                        Dpdce
                                                    </Button>
                                                </div>
                                                @if (yaPgLink)
                                                {
                                                    <div class="col-3">
                                                        <label>Division</label>
                                                    </div>
                                                    <div class="col-3">
                                                        <label>Grille</label>
                                                    </div>
                                                    <div class="col-3">
                                                        <label>Echeancier</label>
                                                    </div>
                                                }
                                            </div>
                                            <div class="row">
                                                <div class="col-2"></div>
                                                @if (yaPgLink)
                                                {
                                                    @if (EdPlnRowguid == parent.Rowguid)
                                                    {
                                                        <div class="col-3">
                                                            <InputSelect @bind-Value="draftPln.Plsdiv" 
                                                                class="w-100">
                                                                <option value="0">?choisir</option>
                                                                @foreach (var tob in LsPlsDivs)
                                                                {
                                                                    <option value="@tob.Id">@tob.Abg-@tob.Liba</option>
                                                                }
                                                            </InputSelect>
                                                        </div>
                                                        <div class="col-3">
                                                            <InputSelect @bind-Value="draftPln.Plsgri" class="w-100">
                                                                <option value="0">?choisir</option>
                                                                @foreach (var tob in LsPlsGris)
                                                                {
                                                                    <option value="@tob.Id">@tob.Abg-@tob.Liba</option>
                                                                }
                                                            </InputSelect>
                                                        </div>
                                                        <div class="col-3">
                                                            <InputSelect @bind-Value="draftPln.Plsech" class="w-100">
                                                                <option value="0">?choisir</option>
                                                                @foreach (var tob in LsPlsEchs)
                                                                {
                                                                    <option value="@tob.Id">@tob.Abg-@tob.Liba</option>
                                                                }
                                                            </InputSelect>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <div class="col-3">
                                                            <InputSelect @bind-Value="parent.Plsdiv" disabled="true" class="w-100">
                                                                <option value="0">?choisir</option>
                                                                @foreach (var tob in LsPlsDivs)
                                                                {
                                                                    <option value="@tob.Id">@tob.Abg-@tob.Liba</option>
                                                                }
                                                            </InputSelect>
                                                        </div>
                                                        <div class="col-3">
                                                            <InputSelect @bind-Value="parent.Plsgri" disabled="true" class="w-100">
                                                                @foreach (var tob in LsPlsGris)
                                                                {
                                                                    <option value="@tob.Id">@tob.Abg-@tob.Liba</option>
                                                                }
                                                            </InputSelect>
                                                        </div>
                                                        <div class="col-3">
                                                            <InputSelect @bind-Value="parent.Plsech" disabled="true" class="w-100">
                                                                @foreach (var tob in LsPlsEchs)
                                                                {
                                                                    <option value="@tob.Id">@tob.Abg-@tob.Liba</option>
                                                                }
                                                            </InputSelect>
                                                        </div>
                                                    }
                                                }
                                            </div>
                                            <div class="row">
                                                <div class="col-12">
                                                    <Grid TItem="Rubvar"
                                                          Data="@MyDaRubs"
                                                          @key="RubRenderKey"
                                                          AllowDetailView="true"
                                                          AllowPaging="true"
                                                          AllowRowClick="true"
                                                          OnRowClick="@OnRubRowClick"
                                                          Responsive="true">
                                                        <GridColumns>
                                                            <GridColumn TItem="Rubvar" HeaderText="No">
                                                                <ChildContent Context="item">
                                                                    @if (item.Xadd1 == -1)
                                                                    {
                                                                        <span>?@item?.Iui</span>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span class="plnpoint">@item?.Iele</span>
                                                                    }
                                                                </ChildContent>
                                                            </GridColumn>
                                                            <GridColumn TItem="Rubvar" HeaderText="">
                                                                <HeaderContent>
                                                                    Code
                                                                    @if (!String.IsNullOrEmpty(Jmessage))
                                                                    {
                                                                        <span class="bg-info bg-opacity-10" style="font-style:italic;color:red">&nbsp;--> @Jmessage</span>
                                                                    }
                                                                </HeaderContent>
                                                                <ChildContent Context="item">
                                                                    <div style="width:90px" class="rubpoint">
                                                                        @if (EdRubRowguid == item.Rowguid)
                                                                        {
                                                                            <InputText @bind-Value="draftRub.Scdrub"
                                                                                       placeholder="code"
                                                                                       id="rucode"
                                                                                       maxlength="@_lgcdu"
                                                                                       @onblur="@(() => OnChlBlurHandler(parent, draftRub))"
                                                                                       @onfocus="@(() => OnChlFocusHandler(parent, draftRub))"
                                                                                       pattern="@($"[0-9]{{{_lgcdu}}}")"
                                                                                       title="@($"{_lgcdu} chiffres obligatoires et unique")"
                                                                                       required />
                                                                        }
                                                                        else
                                                                        {
                                                                            @item.Scdrub
                                                                        }
                                                                    </div>
                                                                </ChildContent>
                                                            </GridColumn>
                                                            <GridColumn TItem="Rubvar" HeaderText="Designation">
                                                                <ChildContent Context="item">
                                                                    @if (EdRubRowguid == item.Rowguid)
                                                                    {
                                                                        <InputText @bind-Value="draftRub.Liba" />
                                                                    }
                                                                    else
                                                                    {
                                                                        @item.Liba
                                                                    }
                                                                </ChildContent>
                                                            </GridColumn>
                                                            <GridColumn TItem="Rubvar" HeaderText="Abrege">
                                                                <ChildContent Context="item">
                                                                    @if (EdRubRowguid == item.Rowguid)
                                                                    {
                                                                        <InputText @bind-Value="draftRub.Abg" />
                                                                    }
                                                                    else
                                                                    {
                                                                        @item.Abg
                                                                    }
                                                                </ChildContent>
                                                            </GridColumn>
                                                            <GridColumn TItem="Rubvar" HeaderText="Refer">
                                                                <ChildContent Context="item">
                                                                    @if (EdRubRowguid == item.Rowguid)
                                                                    { // show draftPln inputs
                                                                      <InputText @bind-Value="draftRub.Xcod" />
                                                                    }
                                                                    else
                                                                    { // show item as read-only
                                                                      @item.Xcod
                                                                    }
                                                                </ChildContent>
                                                            </GridColumn>
                                                            <GridColumn TItem="Rubvar" HeaderText="Atyp">
                                                                <ChildContent Context="item">
                                                                    @if (EdRubRowguid == item.Rowguid)
                                                                    {
                                                                        <InputSelect @bind-Value="draftRub.Atyp" class="col-md-1" style="width:auto">
                                                                            @foreach (var tob in LsFixes.Where(ut => ut.Gvars == 32 && ut.Itb == 2 && ut.Elea != 0))
                                                                            {
                                                                                <option value="@tob.Elea">@tob.Liba</option>
                                                                            }
                                                                        </InputSelect>
                                                                    }
                                                                    else
                                                                    { // show item as read-only
                                                                      <InputSelect @bind-Value="item.Atyp" class="col-md-1" style="width:auto" disabled>
                                                                            @foreach (var tob in LsFixes.Where(ut => ut.Gvars == 32 && ut.Itb == 2 && ut.Elea != 0))
                                                                            {
                                                                                <option value="@tob.Elea">@tob.Liba</option>
                                                                            }
                                                                        </InputSelect>
                                                                    }
                                                                </ChildContent>
                                                            </GridColumn>
                                                            <GridColumn TItem="Rubvar" HeaderText="Formule">
                                                                <ChildContent Context="item">
                                                                    @if (EdRubRowguid == item.Rowguid)
                                                                    { // show draftRub inputs
                                                                      <Button Color="ButtonColor.Secondary" Class="btn btn-default btn-sm" @onclick="() => showFrrubModal(draftRub)">
                                                                          <i class="bi bi-pencil-square"></i>
                                                                          <span class="text-truncate d-inline-block" style="max-width: 100px;">@draftRub?.Frsource</span>
                                                                      </Button>
                                                                    }
                                                                    else
                                                                    { // show item as read-only
                                                                      <Button Color="ButtonColor.Secondary" Class="btn btn-default btn-sm" @onclick="() => showFrrubModal(item)">
                                                                          <i class="bi bi-pencil-square"></i>
                                                                          <span class="text-truncate d-inline-block" style="max-width: 100px;">@item.Frsource</span>
                                                                      </Button>
                                                                    }
                                                                </ChildContent>
                                                            </GridColumn>
                                                            <GridColumn TItem="Rubvar" HeaderText="Eta">
                                                                <HeaderContent>
                                                                    @if (!isFiltre)
                                                                    {
                                                                        <button class="btn btn-info btn-sm" @onclick="ToggleRubFiltering">
                                                                            @(isRubFilteringEnabled ? "🚫 Out Filter" : "🔍 In Filter")
                                                                        </button>
                                                                    }
                                                                    @if (parent != null)
                                                                    {
                                                                        <button class="btn btn-primary btn-sm
                                                                                @(AllowMultipleEdits || !isAddRub ? "" : "disabled-action")"
                                                                                @onclick="() => StartAddNewRubAsync(parent)">
                                                                            ➕ Add
                                                                        </button>
                                                                    }
                                                                </HeaderContent>
                                                                <ChildContent Context="item">
                                                                    @if (EdRubRowguid == item?.Rowguid)
                                                                    { // show draftPln inputs
                                                                      <InputSelect @bind-Value="draftRub.Eta" class="col-md-1" style="width:auto">
                                                                          <option class="jchx" value="0">?etat</option>
                                                                            @foreach (var tob in LsFixes.Where(ut => ut.Gvars == 32 && ut.Itb == 1 && ut.Elea != 0))
                                                                            {
                                                                                <option value="@tob.Elea">@tob.Liba</option>
                                                                            }
                                                                        </InputSelect>
                                                                    }
                                                                    else
                                                                    { // show item as read-only
                                                                      <InputSelect @bind-Value="item.Eta" class="col-md-1" style="width:auto" disabled>
                                                                          <option class="jchx" value="0">?etat</option>
                                                                            @foreach (var tob in LsFixes.Where(ut => ut.Gvars == 32 && ut.Itb == 1 && ut.Elea != 0))
                                                                            {
                                                                                <option value="@tob.Elea">@tob.Liba</option>
                                                                            }
                                                                        </InputSelect>
                                                                    }
                                                                </ChildContent>
                                                            </GridColumn>
                                                            <GridColumn TItem="Rubvar" HeaderText="Actions" Filterable="false">
                                                                <ChildContent Context="item">
                                                                    @if (IsRubRowLocked(item.Rowguid))
                                                                    {
                                                                    <span class="text-muted">—</span>
                                                                    }
                                                                    else
                                                                    {
                                                                    <div @onclick:stopPropagation="true">
                                                                        @if (DlRubRowguid == item.Rowguid)
                                                                        { //delete mode
                                                                          <Button Color="ButtonColor.Danger"
                                                                                  Size="ButtonSize.Small"
                                                                                  @onclick="() => ConfirmRubDelete(item)">
                                                                              ⚠️ Confirm
                                                                          </Button>
                                                                          <Button Color="ButtonColor.Secondary"
                                                                                  Size="ButtonSize.Small"
                                                                                  @onclick="CancelRubDelete">
                                                                              ❎ Cancel
                                                                          </Button>
                                                                        }
                                                                        else if (EdRubRowguid == item.Rowguid)
                                                                        { //edit mode
                                                                          <Button Color="ButtonColor.Success"
                                                                                  Size="ButtonSize.Small"
                                                                                  @onclick="() => ConfirmRubEdit(parent, draftRub)">
                                                                              💾 Save
                                                                          </Button>
                                                                          <Button Color="ButtonColor.Secondary"
                                                                                  Size="ButtonSize.Small"
                                                                                  @onclick="() => CancelRubEdit(draftRub)">
                                                                              ❎ Cancel
                                                                          </Button>
                                                                        }
                                                                        else
                                                                        { //normal mode
                                                                          <Button Color="ButtonColor.Warning"
                                                                                  Size="ButtonSize.Small"
                                                                                  Disabled="DisableRubActions"
                                                                                  @onclick="() => StartRubEdit(item, item.Rowguid)">
                                                                              ✏️ Edit
                                                                          </Button>
                                                                          <Button Color="ButtonColor.Danger"
                                                                                  Size="ButtonSize.Small"
                                                                                  Disabled="DisableRubActions"
                                                                                  @onclick="() => StartRubDelete(item)">
                                                                              🗑 Delete
                                                                          </Button>
                                                                        }
                                                                    </div>
                                                                    }
                                                                    @* @if (AllowMultipleEdits || EdRubRowguid != item.Rowguid)
                                                                    {
                                                                        <button class="btn btn-warning btn-sm" @onclick="() => StartRubEdit(item, item.Rowguid)">
                                                                            ✏️ Edit
                                                                        </button>
                                                                    }
                                                                    else  // Single active row
                                                                    {
                                                                        <button class="btn btn-success btn-sm" @onclick="() => ConfirmRubEdit(parent, draftRub)">💾 Save</button>
                                                                        <button class="btn btn-secondary btn-sm" @onclick="() => CancelRubEdit(draftRub)">❎ Cancel</button>
                                                                    } *@
                                                                </ChildContent>
                                                            </GridColumn>
                                                        </GridColumns>
                                                        <GridDetailView TItem="Rubvar" Context="pchild">
                                                            <Grid TItem="Rubfmt"
                                                                  Data="@MyDaFmts"
                                                                  @key="FmtRenderKey"
                                                                  AllowPaging="true"
                                                                  Responsive="true">
                                                                <GridColumns>
                                                                    <GridColumn TItem="Rubfmt" HeaderText="Code">
                                                                        <ChildContent Context="rf">
                                                                            @if (rf.Xadd1 == -1)
                                                                            {
                                                                                <span>?@rf?.Iui</span>
                                                                            }
                                                                            else
                                                                            {
                                                                                <span fmtpoint">@rf?.Zcdrub</span>
                                                                            }
                                                                        </ChildContent>
                                                                    </GridColumn>
                                                                    <GridColumn TItem="Rubfmt" HeaderText="Libelle">
                                                                        <ChildContent Context="rf">
                                                                            @if (EdFmtRowguid == rf.Rowguid)
                                                                            { // show draftPln inputs
                                                                              <InputText @bind-Value="draftFmt.Liba" />
                                                                            }
                                                                            else
                                                                            { // show item as read-only
                                                                              @rf.Liba
                                                                            }
                                                                        </ChildContent>
                                                                    </GridColumn>
                                                                    <GridColumn TItem="Rubfmt" HeaderText="Abrege">
                                                                        <ChildContent Context="rf">
                                                                            @if (EdFmtRowguid == rf.Rowguid)
                                                                            { // show draftPln inputs
                                                                              <InputText @bind-Value="draftFmt.Abg" />
                                                                            }
                                                                            else
                                                                            { // show item as read-only
                                                                              @rf.Abg
                                                                            }
                                                                        </ChildContent>
                                                                    </GridColumn>
                                                                    <GridColumn TItem="Rubfmt" HeaderText="Ztyp">
                                                                        <ChildContent Context="rf">
                                                                            @if (EdFmtRowguid == rf.Rowguid)
                                                                            { // show draftPln inputs
                                                                              <InputSelect @bind-Value="draftFmt.Ztyp" class="col-md-1" style="width:auto">
                                                                                    @foreach (var tob in LsFixes.Where(ut => ut.Gvars == 32 && ut.Itb == 2 && ut.Elea != 0))
                                                                                    {
                                                                                        <option value="@tob.Elea">@tob.Liba</option>
                                                                                    }
                                                                                </InputSelect>
                                                                            }
                                                                            else
                                                                            {
                                                                                <InputSelect @bind-Value="draftFmt.Ztyp" class="col-md-1" style="width:auto" disabled>
                                                                                    @foreach (var tob in LsFixes.Where(ut => ut.Gvars == 32 && ut.Itb == 2 && ut.Elea != 0))
                                                                                    {
                                                                                        <option value="@tob.Elea">@tob.Liba</option>
                                                                                    }
                                                                                </InputSelect>
                                                                            }
                                                                        </ChildContent>
                                                                    </GridColumn>
                                                                    <GridColumn TItem="Rubfmt" HeaderText="Formule">
                                                                        <ChildContent Context="rf">
                                                                            @if (EdFmtRowguid == rf.Rowguid)
                                                                            { // show draftFmt inputs
                                                                              <Button Color="ButtonColor.Secondary" Class="btn btn-default btn-sm" @onclick="() => showFrfmtModal(draftFmt)">
                                                                                  <i class="bi bi-pencil-square"></i>
                                                                                  <span class="text-truncate d-inline-block" style="max-width: 100px;">@rf.Ftsource</span>
                                                                              </Button>
                                                                            }
                                                                            else
                                                                            { // show item as read-only
                                                                              <Button Color="ButtonColor.Secondary" Class="btn btn-default btn-sm" @onclick="() => showFrfmtModal(rf)">
                                                                                  <i class="bi bi-pencil-square"></i>
                                                                                  <span class="text-truncate d-inline-block" style="max-width: 100px;">@rf.Ftsource</span>
                                                                              </Button>
                                                                            }
                                                                        </ChildContent>
                                                                    </GridColumn>
                                                                    <GridColumn TItem="Rubfmt" HeaderText="Col">
                                                                        <ChildContent Context="rf">
                                                                            @if (EdFmtRowguid == rf.Rowguid)
                                                                            { // show draftPln inputs
                                                                              <InputNumber @bind-Value="draftFmt.Col" style="width:60px" />
                                                                            }
                                                                            else
                                                                            { // show item as read-only
                                                                              @rf.Col
                                                                            }
                                                                        </ChildContent>
                                                                    </GridColumn>
                                                                    <GridColumn TItem="Rubfmt" HeaderText="Lne">
                                                                        <ChildContent Context="rf">
                                                                            @if (EdFmtRowguid == rf.Rowguid)
                                                                            { // show draftPln inputs
                                                                              <InputNumber @bind-Value="draftFmt.Lne" style="width:60px" />
                                                                            }
                                                                            else
                                                                            { // show item as read-only
                                                                              @rf.Lne
                                                                            }
                                                                        </ChildContent>
                                                                    </GridColumn>
                                                                    <GridColumn TItem="Rubfmt" HeaderText="Fmt">
                                                                        <ChildContent Context="rf">
                                                                            @if (EdFmtRowguid == rf.Rowguid)
                                                                            { // show draftPln inputs
                                                                              <InputText @bind-Value="draftFmt.Lgtf" style="width:100px" />
                                                                            }
                                                                            else
                                                                            { // show item as read-only
                                                                              @rf.Lgtf
                                                                            }
                                                                        </ChildContent>
                                                                    </GridColumn>
                                                                    <GridColumn TItem="Rubfmt" HeaderText="Eta">
                                                                        <ChildContent Context="rf">
                                                                            @if (EdFmtRowguid == rf.Rowguid)
                                                                            { // show draftPln inputs
                                                                              <InputSelect @bind-Value="draftFmt.Eta" class="col-md-1" style="width:auto">
                                                                                  <option class="jchx" value="0">?etat</option>
                                                                                    @foreach (var tob in LsFixes.Where(ut => ut.Gvars == 32 && ut.Itb == 1 && ut.Elea != 0))
                                                                                    {
                                                                                        <option value="@tob.Elea">@tob.Liba</option>
                                                                                    }
                                                                                </InputSelect>
                                                                            }
                                                                            else
                                                                            { // show item as read-only
                                                                              <select @bind="rf.Eta" class="col-md-1" style="width:auto" disabled>
                                                                                  <option class="jchx" value="0">?etat</option>
                                                                                    @foreach (var tob in LsFixes.Where(ut => ut.Gvars == 32 && ut.Itb == 1 && ut.Elea != 0))
                                                                                    {
                                                                                        <option value="@tob.Elea">@tob.Liba</option>
                                                                                    }
                                                                                </select>
                                                                            }
                                                                        </ChildContent>
                                                                    </GridColumn>
                                                                    <GridColumn TItem="Rubfmt" HeaderText="Actions">
                                                                        <HeaderContent>
                                                                            @if (pchild != null)
                                                                            {
                                                                                <button class="btn btn-primary btn-sm
                                                                                                @(AllowMultipleEdits || !isAddFmt ? "" : "disabled-action")"
                                                                                        @onclick="() => StartAddNewFmtAsync(pchild)">
                                                                                    ➕ Add
                                                                                </button>
                                                                            }
                                                                        </HeaderContent>
                                                                        <ChildContent Context="rf">
                                                                            @if (IsFmtRowLocked(rf.Rowguid))
                                                                            {
                                                                            <span class="text-muted">—</span>
                                                                            }
                                                                            else
                                                                            {
                                                                            <div @onclick:stopPropagation="true">
                                                                                @if (DlFmtRowguid == rf.Rowguid)
                                                                                { //delete mode
                                                                                  <Button Color="ButtonColor.Danger"
                                                                                          Size="ButtonSize.Small"
                                                                                          @onclick="() => ConfirmFmtDelete(rf)">
                                                                                      ⚠️ Confirm
                                                                                  </Button>
                                                                                  <Button Color="ButtonColor.Secondary"
                                                                                          Size="ButtonSize.Small"
                                                                                          @onclick="CancelFmtDelete">
                                                                                      ❎ Cancel
                                                                                  </Button>
                                                                                }
                                                                                else if (EdFmtRowguid == rf.Rowguid)
                                                                                { //edit mode
                                                                                  <Button Color="ButtonColor.Success"
                                                                                          Size="ButtonSize.Small"
                                                                                          @onclick="() => ConfirmFmtEdit(pchild, draftFmt)">
                                                                                      💾 Save
                                                                                  </Button>
                                                                                  <Button Color="ButtonColor.Secondary"
                                                                                          Size="ButtonSize.Small"
                                                                                          @onclick="() => CancelFmtEdit(draftFmt)">
                                                                                      ❎ Cancel
                                                                                  </Button>
                                                                                }
                                                                                else
                                                                                { //normal mode
                                                                                  <Button Color="ButtonColor.Warning"
                                                                                          Size="ButtonSize.Small"
                                                                                          Disabled="DisableFmtActions"
                                                                                          @onclick="() => StartFmtEdit(rf, rf.Rowguid)">
                                                                                      ✏️ Edit
                                                                                  </Button>
                                                                                  <Button Color="ButtonColor.Danger"
                                                                                          Size="ButtonSize.Small"
                                                                                          Disabled="DisableFmtActions"
                                                                                          @onclick="() => StartFmtDelete(rf)">
                                                                                      🗑 Delete
                                                                                  </Button>
                                                                                }
                                                                            </div>
                                                                            }
                                                                            @* @if (AllowMultipleEdits || EdFmtRowguid != rf.Rowguid)
                                                                            {
                                                                                <button class="btn btn-warning btn-sm" @onclick="() => StartFmtEdit(rf, rf.Rowguid)">
                                                                                    ✏️ Edit
                                                                                </button>
                                                                            }
                                                                            else  // Single active row
                                                                            {
                                                                                <button class="btn btn-success btn-sm" @onclick="() => ConfirmFmtEdit(pchild, draftFmt)">💾 Save</button>
                                                                                <button class="btn btn-secondary btn-sm" @onclick="() => CancelFmtEdit(draftFmt)">❎ Cancel</button>
                                                                            } *@
                                                                        </ChildContent>
                                                                    </GridColumn>
                                                                </GridColumns>
                                                            </Grid>
                                                        </GridDetailView>
                                                    </Grid>
                                                </div>
                                            </div>
                                        </div>
                                    </GridDetailView>
                                </Grid>
                            }
                        </div>
                    </EditForm>  
                }
            </div>
            <!-- Modal for FORMULE PLAN -->
            <Modal @ref="pForuModal" Size="ModalSize.Large" Title="Edit Formula" ShowCloseButton="false">
                <BodyTemplate>
                    <div class="mb-3">
                        <label class="form-label">Formula</label>
                        <InputTextArea class="form-control"
                                       @bind-Value="curPlan.Fpsource"
                                       rows="8"
                                       style="resize: vertical;" />
                    </div>
                </BodyTemplate>
                <FooterTemplate>
                    <Button Color="ButtonColor.Secondary" @onclick="() => pForuModal.HideAsync()">Cancel</Button>
                </FooterTemplate>
            </Modal>
            <!-- Modal for FORMULE RUB -->
            <Modal @ref="rForuModal" Size="ModalSize.Large" Title="Edit Plan Formula" ShowCloseButton=false>
                <BodyTemplate>
                    <div class="mb-3">
                        <label class="form-label">Formula</label>
                        <InputTextArea class="form-control"
                                       @bind-Value="curRubr.Frsource"
                                       rows="6"
                                       style="resize: vertical;" />
                    </div>
                </BodyTemplate>
                <FooterTemplate>
                    <Button Color="ButtonColor.Secondary" @onclick="() => rForuModal.HideAsync()">Cancel</Button>
                </FooterTemplate>
            </Modal>
            <!-- Modal for FORMULE FMT -->
            <Modal @ref="gForuModal" Size="ModalSize.Large" Title="Edit Formula">
                <BodyTemplate>
                    <div class="mb-3">
                        <label class="form-label">Formula</label>
                        <InputTextArea class="form-control"
                                       @bind-Value="curFmat.Ftsource"
                                       rows="3"
                                       style="resize: vertical;" />
                    </div>
                </BodyTemplate>
                <FooterTemplate>
                    <Button Color="ButtonColor.Secondary" @onclick="() => gForuModal.HideAsync()">Cancel</Button>
                </FooterTemplate>
            </Modal>
        </Authorized>
    </AuthorizeView>
}
<style>
    .modal-wide .modal-dialog {
        max-width: 50vw;
        width: auto;
        margin: auto;
    }

    .rubModal-wide .modal-dialog {
        max-width: 65vw;
        width: auto;
        margin: auto;
    }

    .disabled-action {
        pointer-events: none;
        opacity: 0.5;
    }

    .formul.button {
        pointer-events: none;
        opacity: 0.5;
        heignt: btn btn-success btn-sm
    }
    .plnpoint {
        font-weight: bold;
        background-color: blue;
        color:white;  
    }
   .rubpoint {
        font-weight: bold;
        background-color: yellow;
        color:black;
    }
    .fmtpoint {
        font-weight: bold;
        background-color: darkolivegreen;
        color: black;
    }
    /* Centre le conteneur global du bas */
    ::deep .bb-grid-pagination {
        justify-content: center !important;
    }

    /* Cible le bloc spécifique contenant le texte "Page de..." */
    ::deep .pagination-container {
        display: flex;
        flex-direction: column; /* Aligne le texte au dessus/dessous des icônes */
        align-items: center; /* Centre horizontalement */
        width: 100%;
    }

</style>
@code {
    private bool isLoading = true;
    private string Imessage = "", Jmessage = "", Kmessage = "";
    private bool yaPgLink = false;

    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }
    [Parameter]
    public RenderFragment ChildContent { get; set; }
    [Parameter]
    public MyODataContext curODContext { get; set; }
    [Parameter]
    public Gxorga curOrga { get; set; } = new();
    [Parameter]
    public MyShareVars toChild { get; set; }
    [Parameter]
    public int toMenu { get; set; }
    //guard
    [Parameter]
    public PendingChangesGuard _guard { get; set; }
    [Parameter]
    public EventCallback<PendingState> OnPendingStateChanged { get; set; }
    [Parameter]
    public int NbChanges { get; set; }
    [Parameter]
    public EventCallback<int> NbChangesChanged { get; set; }  // 🔥 CRITICAL
    //author
    private ClaimsPrincipal authUser;
    private bool isAuthenticated = false;
    //usrbag
    private Userbag _usrBag = new Userbag();
    private string _UserId = "";
    private int _UorgId = 0;

    private Dictionary<int, bool> EdState = new Dictionary<int, bool>();

    private List<Gplan> LsPlans = new();
    private List<Gpfixe> LsFixes = new();
    private List<Gpvar> LsVars = new();
    private List<Gpfixe> LsDoms = new();
    private List<Gpfixe> LsAtrs = new();
    private List<Gpfixe> LsVues = new();

    private int _lgcdu = 0;
    private bool isPlnFilteringEnabled = false;
    private bool isRubFilteringEnabled = false;

    //Global
    private int IMyGpln = 5, IMyDom = 1, IMyVue = 1;
    private string atrTitle = "";

    private string atrDest = "Programmes de Saisie :";
    private Plngen curPlan = new();
    private Rubvar curRubr = new();
    private Rubfmt curFmat = new();

    private bool isRubCodeValid = false;
    //data
    private List<Plngen> MyDaPlans = new();
    private List<Rubvar> MyDaRubs = new();
    private List<Rubfmt> MyDaFmts = new();
    private List<Plngen> LsPlsEchs => curOrga.Plngens.Where(pl => pl.Ptyp == 2).ToList();
    private List<Plngen> LsPlsGris => curOrga.Plngens.Where(pl => pl.Ptyp == 3).ToList();
    private List<Plngen> LsPlsDivs => curOrga.Plngens.Where(pl => pl.Ptyp == 4).ToList();

    private bool AllowMultipleEdits { get; set; } = false;
    private bool isFiltre { get; set; } = false;
    //PLAN
    private Guid? PlanRenderKey = null;
    private Dictionary<Guid, Plngen> _editOriginals = new();
    private Plngen? draftPln = null;
    private bool isAddPln = false;
    private bool isEdtPln = false;
    private bool isDelPln = false;
    private Guid? AdPlnRowguid = null;
    private Guid? EdPlnRowguid = null;// Currently editing row ID
    private Guid? DlPlnRowguid = null;
    //RUBRIQUE
    private Guid? RubRenderKey = null;
    private Dictionary<Guid, Rubvar> _editRubOriginals = new();
    private Rubvar? draftRub = null;
    private bool isAddRub = false;
    private bool isEdtRub = false;
    private bool isDelRub = false;
    private Guid? AdRubRowguid = null;
    private Guid? EdRubRowguid = null;// Currently editing row ID
    private Guid? DlRubRowguid = null;
    //FORMAT
    private Guid? FmtRenderKey = null;
    private Dictionary<Guid, Rubfmt> _editFmtOriginals = new();
    private Rubfmt? draftFmt = null;
    private bool isAddFmt = false;
    private bool isEdtFmt = false;
    private bool isDelFmt = false;
    private Guid? AdFmtRowguid = null;
    private Guid? EdFmtRowguid = null;// Currently editing row ID
    private Guid? DlFmtRowguid = null;
    //Disable Actions
    bool DisablePlnActions
    => IsEdPlnAnyRow || IsDelPlnAnyRow;
    bool DisableRubActions
    => IsEdRubAnyRow || IsDelRubAnyRow;
    bool DisableFmtActions
    => IsEdFmtAnyRow || IsDelFmtAnyRow;
    bool IsEdPlnAnyRow =>
        !AllowMultipleEdits && EdPlnRowguid.HasValue;
    bool IsEdRubAnyRow =>
        !AllowMultipleEdits && EdRubRowguid.HasValue;
    bool IsEdFmtAnyRow =>
        !AllowMultipleEdits && EdFmtRowguid.HasValue;
    bool IsDelPlnAnyRow =>
        !AllowMultipleEdits && DlPlnRowguid.HasValue;
    bool IsDelRubAnyRow =>
        !AllowMultipleEdits && DlRubRowguid.HasValue;
    bool IsDelFmtAnyRow =>
        !AllowMultipleEdits && DlFmtRowguid.HasValue;
    bool IsPlnRowLocked(Guid rowGuid) =>
        !AllowMultipleEdits &&
        (EdPlnRowguid.HasValue || DlPlnRowguid.HasValue) &&
        EdPlnRowguid != rowGuid &&
        DlPlnRowguid != rowGuid;
    bool IsRubRowLocked(Guid rowGuid) =>
        !AllowMultipleEdits &&
        (EdRubRowguid.HasValue || DlRubRowguid.HasValue) &&
        EdRubRowguid != rowGuid &&
        DlRubRowguid != rowGuid;
    bool IsFmtRowLocked(Guid rowGuid) =>
        !AllowMultipleEdits &&
        (EdFmtRowguid.HasValue || DlFmtRowguid.HasValue) &&
        EdFmtRowguid != rowGuid &&
        DlFmtRowguid != rowGuid;

    //Modals formule
    Modal pForuModal = new(); //plans
    Modal rForuModal = new(); //rubriques
    Modal gForuModal = new(); //formats
    private string patTitle = "", chlTitle = "", gsnTitle = "";
    private string patInitTitle = "", chlInitTitle = "", gsnInitTitle = "";
    private string pstrFormu = "", rstrFormu = "", fstrFormu = "";

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        try
        {
            if (toChild == null || curOrga == null)
            {
                Console.WriteLine("Missing parent data");
                return;
            }
            isAuthenticated = toChild.isAuthenticated;
            authUser = toChild.authUser;
            if (!isAuthenticated)
            {
                Imessage = "CONNEXION, Utilisateur non authentifie";
                return;
            }
            LsVars = toChild.LsVars;
            LsFixes = toChild.LsFixes;
            LsVues = LsFixes.Where(ut => ut.Gvars == 36 && ut.Itb == 4 && ut.Gp1 == 5 && ut.Elea != 0).ToList();
            //LsTabls = toChild.LsTabls.ToList();
            LsPlans = toChild.LsPlans;
            //LsSites = toChild.LsSites;
            _lgcdu = 3;
            var noslims = LsVars.Where(uv => uv.Idhie == 0 && uv.Gvars == 21 && uv.Itb == 1 && uv.Elea == 1);
            if (noslims.Any()) _lgcdu = noslims.FirstOrDefault().Ivala;
            Console.WriteLine($"lsplans {LsPlans.Count} IS NULL");
            //ChargeParentData;
            Console.WriteLine($"Child init: Plngens={curOrga.Plngens?.Count ?? 0}");
            // 🔥 SAFE LOOP - skip LoadPropertyAsync entirely
            if (curOrga.Plngens != null)
            {
                foreach (var pln in curOrga.Plngens)
                {
                    // Just log - NO OData calls in child!
                    Console.WriteLine($"Pln {pln.Id}: Rubvars={pln.Rubvars != null}");
                    // Rubvars/Rubhies will lazy-load when UI actually needs them
                }
                //MyDaPlans = curOrga.Plngens.Where(pl => pl.Ptyp == 5 && pl.Todom == IMyDom && pl.Tovue == IMyVue).ToList();
                MyDaPlans = curOrga.Plngens.Where(pl => pl.Ptyp == 5 && pl.Todom == IMyDom).ToList();
            }
            // Register "add-edit-delete mode" predicate for existing entities
            _guard.RegisterUnconfirmedPredicate<Plngen>(p => p.Xadd1 == -1 || p.Xedt1 == -1 || p.Xdel1 == -1);
            _guard.RegisterUnconfirmedPredicate<Rubvar>(r => r.Xadd1 == -1 || r.Xedt1 == -1 || r.Xdel1 == -1);
            _guard.RegisterUnconfirmedPredicate<Rubfmt>(f => f.Xadd1 == -1 || f.Xedt1 == -1 || f.Xdel1 == -1);
            atrTitle = "Saisie";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Child crash: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();  // 🔥 CRITICAL
        }
    }

    //PLAN
    //✅ Mark1-0.Plan RowClick
    private void OnPlnRowClick(GridRowEventArgs<Plngen> args)
    {
        var selectedPln = args.Item;
        if (!AllowMultipleEdits && EdPlnRowguid == selectedPln.Rowguid)
            return;
        // ✅ FIXED TRACKING: Correct AttachTo signature
        if (curODContext.IsEntityTracked(selectedPln))
        {
            curODContext.UpdateObject(selectedPln);
        }
        else if (isAddPln)
        {
            curODContext.AddObject("Plngens", selectedPln);
        }
        else
        {
            // ✅ FIX: AttachTo(entitySetName, entity) - NO EntityStates parameter
            curODContext.SafeAttachOrUpdate<Plngen>(selectedPln, "Plngens", isAddPln);
            //curODContext.Context.AttachTo("Plngens", selectedPln);
            curODContext.UpdateObject(selectedPln);
        }
        StateHasChanged();
    }

    //✅ Mark1-2.Plan Start New Row
    private async Task StartAddNewPlnAsync()
    {
        Console.WriteLine("🚨 StartAddNewPlnAsync CALLED - Who triggered?");
        var newPln = new Plngen 
        {
            Rowguid = Guid.NewGuid(),
            Xadd1 = -1, //newly added/edited
            Xedt1 = 0,
            Xdel1 = 0,
            Iui = nextSeq(1),
            Idorg = curOrga.Idorg,
            Ptyp = IMyGpln,
            Todom = IMyDom,
            Liba = "",
            Abg = "",
            Styp = 0,
            Totyp = 0,
            Tovue = IMyVue,
            Toatr = 0,
            Eta = 1,
        };
        curODContext.AddObject("Plngens", newPln);
        MyDaPlans.Insert(0, newPln);
        await Task.Delay(1);
        EdPlnRowguid = AllowMultipleEdits ? null : newPln.Rowguid;
        draftPln = newPln;
        isAddPln = true;
        await _jsRun.InvokeVoidAsync("focusFirstInput");
        // 🔥 NOTIFY PARENT (positional record syntax)
        await OnPendingStateChanged.InvokeAsync(new PendingState(true, 1));
        PlanRenderKey = null;  // Force refresh
        Console.WriteLine($"passed start addnew {newPln.Xadd1}");
        StateHasChanged();
    }
    //✅ Mark2-2.Rubr New Row
    private async Task StartAddNewRubAsync(Plngen mypln)
    {
        Console.WriteLine("🚨 StartAddNewRubAsync CALLED");
        var newRub = new Rubvar
        {
            Rowguid = Guid.NewGuid(),
            Xadd1 = -1, //newly added/edited
            Xedt1 = 0,
            Xdel1 = 0,
            Iui = nextSeq(2),
            Idorg = mypln.Idorg,
            Id = mypln.Id,
            Torub = 0,
            Utyp = IMyDom, //services
            Sigrid = 0, //est grille
            Gdact = 0, //declenche (ajt rubriq Actsaie)
            Ustyp = 0, //de base
            Dtperi = 0, //toujours
            Liba = "",
            Abg = "",
            Xcod = "",
            Ddval = 0,
            Dfval = 0,
            Eaut = 0, //supprimable
            Atyp = 4,
            Eint = 0,
            Eta = 1
        };
        // 🔥 1. Mark + Add to context (unchanged)
        _guard.MarkUnconfirmedAdd<Rubvar>(newRub);
        curODContext.AddObject("Rubvars", newRub);
        // 🔥 2. Add to LOCAL collection FIRST (immediate UI)
        MyDaRubs.Insert(0, newRub);
        // 🔥 3. Set edit state
        EdRubRowguid = AllowMultipleEdits ? null : newRub.Rowguid;
        draftRub = newRub;
        isAddRub = true;
        // 🔥 4. Focus + MINIMAL refresh (no parent collapse)
        await _jsRun.InvokeVoidAsync("focusFirstInput");
        await OnPendingStateChanged.InvokeAsync(new PendingState(true, 1));
        // 🔥 REMOVE THESE TWO LINES - THEY CAUSE COLLAPSE:
        RubRenderKey = null;
        // StateHasChanged();              ❌ FORCES PARENT RE-RENDER
        Console.WriteLine($"✅ Rubvar #{newRub.Iui} added - edit mode");
    }
    //✅ Mark3-2.Fmt New Row
    private async Task StartAddNewFmtAsync(Rubvar myrub)
    {
        Console.WriteLine("🚨 StartAddNewFmtAsync CALLED - Who triggered?");
        var newFmt = new Rubfmt
        {
            Rowguid = Guid.NewGuid(),
            Xadd1 = -1,  //newly added/edited
            Xedt1 = 0,
            Xdel1 = 0,
            Iui = nextSeq(3),
            Irub = myrub.Id,
            Idzon = nextSeq(3),
            Zcdrub = nextSeq(3).ToString(),
            Liba = "",
            Abg = "",
            Tperi = 1,
            Col = 1,
            Lne = 1,
            Ztyp = 4, //decimal
            Eint = 0,
            Eta = 1
        };
        // 🔥 MARK AS UNCONFIRMED ADD
        _guard.MarkUnconfirmedAdd<Rubfmt>(newFmt);  // Track for auto-discard
        curODContext.AddObject("Rubfmts", newFmt);
        MyDaFmts.Insert(0, newFmt);
        await Task.Delay(1);
        EdFmtRowguid = AllowMultipleEdits ? null : newFmt.Rowguid;
        draftFmt = newFmt;
        isAddFmt = true;
        await _jsRun.InvokeVoidAsync("focusFirstInput");
        // 🔥 NOTIFY PARENT (positional record syntax)
        await OnPendingStateChanged.InvokeAsync(new PendingState(true, 1));
        FmtRenderKey = null;  // Force refresh
        StateHasChanged();
    }
    //✅ Mark1-3.Plan Start Edit
    private void StartPlnEdit(Plngen item, Guid rowguid)
    {
        item.Xedt1 = -1;
        item.Xadd1 = 0;
        item.Xdel1 = 0;
        if (!AllowMultipleEdits && EdPlnRowguid.HasValue) return;
        _editOriginals[rowguid] = (Plngen)DeepClone(item);
        EdPlnRowguid = AllowMultipleEdits ? null : rowguid;
        if (!curODContext.IsEntityTracked(item))
        {
            curODContext.UpdateObject(item);
            Console.WriteLine($"Update Object {item.Id}");
        }
        draftPln = item;
        isEdtPln = true;
        Console.WriteLine($"passed start editing {item.Xedt1}");
        StateHasChanged();
    }
    //✅ Mark2-3.Rub Start Edit
    private void StartRubEdit(Rubvar item, Guid rowguid)
    {
        item.Xedt1 = -1;
        item.Xadd1 = 0;
        item.Xdel1 = 0;
        if (!AllowMultipleEdits && EdRubRowguid.HasValue) return;
        _editRubOriginals[rowguid] = (Rubvar)DeepClone(item);
        EdRubRowguid = AllowMultipleEdits ? null : rowguid;
        if (!curODContext.IsEntityTracked(item))
        {
            curODContext.UpdateObject(item);
        }
        draftRub = item;
        isEdtRub = true;
        //StateHasChanged();
    }
    //✅ Mark3-3.Fmt Start Edit
    private void StartFmtEdit(Rubfmt item, Guid rowguid)
    {
        item.Xedt1 = -1;
        item.Xadd1 = 0;
        item.Xdel1 = 0;
        if (!AllowMultipleEdits && EdFmtRowguid.HasValue) return;
        _editFmtOriginals[rowguid] = (Rubfmt)DeepClone(item);
        EdFmtRowguid = AllowMultipleEdits ? null : rowguid;
        if (!curODContext.IsEntityTracked(item))
        {
            curODContext.UpdateObject(item);
        }
        draftFmt = item;
        isEdtFmt = true;
        //StateHasChanged();
    }
    //✅ Mark1-4.Plan Start Delete
    private void StartPlnDelete(Plngen item)
    {
        if (!AllowMultipleEdits && EdPlnRowguid.HasValue)
            return; // editing blocks delete
        item.Xdel1 = -1;
        item.Xedt1 = 0;
        item.Xadd1 = 0;
        // 🔥 HARD EXIT EDIT MODE
        EdPlnRowguid = null;
        isEdtPln = false;
        draftPln = null;
        DlPlnRowguid = item.Rowguid;
        isDelPln = true;
        Console.WriteLine($"🗑 Start delete {item.Rowguid}");
        StateHasChanged();
    }
    //✅ Mark2-4.Rub Start Delete
    private void StartRubDelete(Rubvar item)
    {
        if (!AllowMultipleEdits && EdRubRowguid.HasValue)
            return; // editing blocks delete
        item.Xdel1 = -1;
        item.Xedt1 = 0;
        item.Xadd1 = 0;
        // 🔥 HARD EXIT EDIT MODE
        EdRubRowguid = null;
        isEdtRub = false;
        draftRub = null;
        DlRubRowguid = item.Rowguid;
        isDelRub = true;
        Console.WriteLine($"🗑 Start delete {item.Rowguid}");
        //StateHasChanged();
    }
    //✅ Mark3-4.Fmt Start Delete
    private void StartFmtDelete(Rubfmt item)
    {
        if (!AllowMultipleEdits && EdFmtRowguid.HasValue)
            return; // editing blocks delete
        item.Xdel1 = -1;
        item.Xedt1 = 0;
        item.Xadd1 = 0;
        // 🔥 HARD EXIT EDIT MODE
        EdFmtRowguid = null;
        isEdtFmt = false;
        draftFmt = null;
        DlFmtRowguid = item.Rowguid;
        isDelFmt = true;
        Console.WriteLine($"🗑 Start delete {item.Rowguid}");
        //StateHasChanged();
    }
    //CONFIRMATIONS
    // ✅ LEVEL 1: Plngen (Parent)
    private async Task ConfirmPlnEdit(Plngen item)
    {
        if (!ValidatePln(item)) { Imessage = "infos plan non valide"; return; }

        _editOriginals.Remove(item.Rowguid);

        bool wasAddMode = isAddPln && !AllowMultipleEdits;
        if (wasAddMode) { await StartAddNewPlnAsync(); }
        else if (item.Id > 0)
        {
            MarkAsModified(item);  // Unified helper
        }

        await ResetPlnEditState();  // Unified reset

        await NotifyPendingChanges();  // Unified notifications
    }

    // ✅ LEVEL 2: Rubvar (Child of Plngen)
    private async Task ConfirmRubEdit(Plngen mypln, Rubvar item)
    {
        if (!ValidateRub(item)) { Imessage = "infos rubrique invalide"; return; }

        _editRubOriginals.Remove(item.Rowguid);

        bool wasAddMode = isAddRub && !AllowMultipleEdits;
        if (wasAddMode) { await StartAddNewRubAsync(mypln); }
        else
        {
            MarkAsModified(item);  // 🔥 SAME AS PARENT
        }

        await ResetRubEditState();  // Unified reset
        await NotifyPendingChanges();  // Unified notifications
    }

    // ✅ LEVEL 3: Rubfmt (Child of Rubvar)
    private async Task ConfirmFmtEdit(Rubvar myrub, Rubfmt item)
    {
        if (!ValidateFmt(item)) { Imessage = "infos fmt non valide"; return; }

        _editFmtOriginals.Remove(item.Rowguid);

        bool wasAddMode = isAddFmt && !AllowMultipleEdits;
        if (wasAddMode) { await StartAddNewFmtAsync(myrub); }
        else
        {
            MarkAsModified(item);  // 🔥 SAME AS PARENT
        }

        await ResetFmtEditState();  // Unified reset
        await NotifyPendingChanges();  // Unified notifications
    }
    private void MarkAsModified(object entity)
    {
        // Reset flags universally
        if (entity is Plngen pln) { pln.Xedt1 = pln.Xadd1 = pln.Xdel1 = 0; }
        else if (entity is Rubvar rub) { rub.Xedt1 = rub.Xadd1 = rub.Xdel1 = 0; }
        else if (entity is Rubfmt fmt) { fmt.Xedt1 = fmt.Xadd1 = fmt.Xdel1 = 0; }

        try { curODContext.Context.AttachTo(GetEntitySet(entity), entity); }
        catch (InvalidOperationException) { }  // Already tracked

        curODContext.Context.UpdateObject(entity);  // 🔥 KEY: Context.UpdateObject()
        Console.WriteLine($"✅ {entity.GetType().Name} marked Modified");
    }

    private string GetEntitySet(object entity)
    {
        return entity switch
        {
            Plngen _ => "Plngens",
            Rubvar _ => "Rubvars",
            Rubfmt _ => "Rubfmts",
            _ => throw new ArgumentException("Unknown entity type")
        };
    }

    private async Task ResetPlnEditState()
    {
        if (!AllowMultipleEdits)
        {
            EdPlnRowguid = null; draftPln = null; isEdtPln = false;
        }
        PlanRenderKey = null;
    }

    private async Task ResetRubEditState()
    {
        if (!AllowMultipleEdits)
        {
            EdRubRowguid = null; draftRub = null; isEdtRub = false;
        }
        RubRenderKey = null;
    }

    private async Task ResetFmtEditState()
    {
        if (!AllowMultipleEdits)
        {
            EdFmtRowguid = null; draftFmt = null; isEdtFmt = false;
        }
        FmtRenderKey = null;
    }

    private async Task NotifyPendingChanges()
    {
        await OnPendingStateChanged.InvokeAsync(new PendingState(
            _guard.HasPendingChanges(),
            _guard.GetPendingChangesCount()
        ));

        NbChanges = _guard.GetPendingChangesCount();
        await NbChangesChanged.InvokeAsync(NbChanges);
        StateHasChanged();
    }


    // //✅ Mark1-5.Plan Confirm Edit
    // private async Task ConfirmPlnEdit(Plngen item)
    // {
    //     if (!ValidatePln(item))
    //     {
    //         Imessage = "infos plan non valide";
    //         return;
    //     }

    //     Console.WriteLine($"🔍 EDITING: Id={item.Id}");
    //     _editOriginals.Remove(item.Rowguid);

    //     bool wasAddMode = isAddPln && !AllowMultipleEdits;

    //     if (wasAddMode)
    //     {
    //         await StartAddNewPlnAsync();
    //     }
    //     else if (item.Id > 0)  // Existing entity edit
    //     {
    //         // 🔥 YOUR PERFECT ConfGdom() PATTERN
    //         item.Xedt1 = 0;
    //         item.Xadd1 = 0;
    //         item.Xdel1 = 0;
    //         try
    //         {
    //             curODContext.Context.AttachTo("Plngens", item);
    //         }
    //         catch (InvalidOperationException)
    //         {
    //             // Already tracked - safe to ignore ✅
    //         }

    //         curODContext.Context.UpdateObject(item);
    //         Console.WriteLine($"✅ Plngen marked as Modified Id={item.Id}");
    //     }

    //     if (!AllowMultipleEdits)
    //     {
    //         EdPlnRowguid = null;
    //         draftPln = null;
    //         EdPlnRowguid = null;
    //         isEdtPln = false;
    //     }
    //     PlanRenderKey = null;

    //     await OnPendingStateChanged.InvokeAsync(new PendingState(
    //         _guard.HasPendingChanges(),
    //         _guard.GetPendingChangesCount()
    //     ));

    //     NbChanges = _guard.GetPendingChangesCount();
    //     await NbChangesChanged.InvokeAsync(NbChanges);
    //     isEdtPln = false;
    //     draftPln = null;
    //     StateHasChanged();
    // }
    // //✅ Mark2-5.Rub Confirm Edit
    // private async Task ConfirmRubEdit(Plngen mypln, Rubvar item)
    // {
    //     item.Xadd1 = 0;
    //     item.Xedt1 = 0;
    //     item.Xdel1 = 0;
    //     if (!ValidateRub(item)) 
    //     {
    //         Imessage = "infos rubrique invalide";
    //         return;
    //     }
    //     _editRubOriginals.Remove(item.Rowguid);
    //     bool wasAddMode = isAddRub && !AllowMultipleEdits;
    //     if (wasAddMode)
    //     {
    //         await StartAddNewRubAsync(mypln);  // Chain continues - NO SAVE YET
    //     }
    //     else
    //     {
    //         // 🔥 ONLY save for Edit mode or multi-edit
    //         if (curODContext.IsEntityTracked(item))
    //         {
    //             await _guard.FlushAsync();
    //         }

    //         if (!AllowMultipleEdits)
    //         {
    //             EdRubRowguid = null;
    //             draftRub = null;
    //             EdRubRowguid = null;
    //             isEdtRub = false;
    //         }
    //     }
    //     RubRenderKey = null;
    //     await OnPendingStateChanged.InvokeAsync(new PendingState(
    //         _guard.HasPendingChanges(),
    //         _guard.GetPendingChangesCount()
    //     ));
    //     // In ANY child edit method:
    //     NbChanges = _guard.GetPendingChangesCount();
    //     await NbChangesChanged.InvokeAsync(NbChanges);  // Updates parent's _nbChanges
    //     isEdtRub = false;
    //     draftRub = null;
    //     StateHasChanged();
    // }
    // //✅ Mark3-5.Fmt Confirm Edit
    // private async Task ConfirmFmtEdit(Rubvar myrub, Rubfmt item)
    // {
    //     item.Xedt1 = 0;
    //     item.Xadd1 = 0;
    //     item.Xdel1 = 0;
    //     if (!ValidateFmt(item))
    //     {
    //         Imessage = "infos fmt non valide";
    //         return;
    //     }
    //     _editFmtOriginals.Remove(item.Rowguid);
    //     bool wasAddMode = isAddFmt && !AllowMultipleEdits;
    //     if (wasAddMode)
    //     {
    //         await StartAddNewFmtAsync(myrub);  // Chain continues - NO SAVE YET
    //     }
    //     else
    //     {
    //         // 🔥 ONLY save for Edit mode or multi-edit
    //         if (curODContext.IsEntityTracked(item))
    //         {
    //             await _guard.FlushAsync();
    //         }
    //         if (!AllowMultipleEdits)
    //         {
    //             EdFmtRowguid = null;
    //             draftFmt = null;
    //             EdFmtRowguid = null;
    //             isEdtFmt = false;
    //         }
    //     }
    //     FmtRenderKey = null;
    //     await OnPendingStateChanged.InvokeAsync(new PendingState(
    //         _guard.HasPendingChanges(),
    //         _guard.GetPendingChangesCount()
    //     ));
    //     // In ANY child edit method:
    //     NbChanges = _guard.GetPendingChangesCount();
    //     await NbChangesChanged.InvokeAsync(NbChanges);  // Updates parent's _nbChanges
    //     isEdtFmt = false;
    //     draftFmt = null;
    //     StateHasChanged();
    // }

    //✅ Mark1-6.Plan Cancel Edit
    private async Task CancelPlnEdit(Plngen item)
    {
        Guid rowGuid = item.Rowguid;
        // 🔥 CRITICAL: DETACH ODATA FIRST (fixes Guard)
        var trackedEntity = curODContext.IsEntityTracked(item)
            ? item
            : MyDaPlans.FirstOrDefault(x => x.Rowguid == rowGuid);
        if (trackedEntity != null && curODContext.IsEntityTracked(trackedEntity))
        {
            if (curODContext.GetEntityState(trackedEntity) == EntityStates.Added)
            {
                curODContext.Detach(trackedEntity);  // ← REMOVES FROM GUARD TRACKING
                Console.WriteLine($"✅ DETACHED from OData: {rowGuid}");
            }
        }
        // Clear edit states
        draftPln = null;
        EdPlnRowguid = null;
        AdPlnRowguid = null;
        DlPlnRowguid = null;
        isEdtPln = false;
        isAddPln = false;
        isDelPln = false;
        // Your working UI fix
        MyDaPlans.RemoveAll(x => x.Rowguid == rowGuid);
        MyDaPlans = MyDaPlans.ToList();
        // ✅ CORRECT: Positional arguments
        // 🔥 NOTIFY PARENT
        await OnPendingStateChanged.InvokeAsync(new PendingState(
            curODContext.GetPendingChanges().Any(), 
            curODContext.GetPendingChanges().Count()
        ));
        item.Xadd1 = 0;
        item.Xedt1 = 0;
        item.Xdel1 = 0;
        PlanRenderKey = null;
        NbChanges = _guard.GetPendingChangesCount();
        await NbChangesChanged.InvokeAsync(NbChanges);  // Updates parent's _nbChanges
        Console.WriteLine($"passed cancel edit {item.Xedt1}");
        StateHasChanged();
    }
    //✅ Mark2-6.Rub Cancel Edit
    private async Task CancelRubEdit(Rubvar item)
    {
        Guid rowGuid = item.Rowguid;
        // 🔥 CRITICAL: DETACH ODATA FIRST (fixes Guard)
        var trackedEntity = curODContext.IsEntityTracked(item)
            ? item
            : MyDaRubs.FirstOrDefault(x => x.Rowguid == rowGuid);
        if (trackedEntity != null && curODContext.IsEntityTracked(trackedEntity))
        {
            if (curODContext.GetEntityState(trackedEntity) == EntityStates.Added)
            {
                curODContext.Detach(trackedEntity);  // ← REMOVES FROM GUARD TRACKING
                Console.WriteLine($"✅ DETACHED from OData: {rowGuid}");
            }
        }
        // Clear edit states
        draftRub = null;
        EdRubRowguid = null;
        AdRubRowguid = null;
        //DlRubRowguid = null;
        isEdtRub = false;
        isAddRub = false;
        isDelRub = false;
        // Your working UI fix
        MyDaRubs.RemoveAll(x => x.Rowguid == rowGuid);
        MyDaRubs = MyDaRubs.ToList();
        // ✅ CORRECT: Positional arguments
        // 🔥 NOTIFY PARENT
        await OnPendingStateChanged.InvokeAsync(new PendingState(
            curODContext.GetPendingChanges().Any(),
            curODContext.GetPendingChanges().Count()
        ));
        item.Xadd1 = 0;
        item.Xedt1 = 0;
        item.Xdel1 = 0;
        RubRenderKey = null;
        NbChanges = _guard.GetPendingChangesCount();
        await NbChangesChanged.InvokeAsync(NbChanges);  // Updates parent's _nbChanges
        StateHasChanged();
    }
    //✅ Mark3-6.Fmt Cancel Edit
    private async Task CancelFmtEdit(Rubfmt item)
    {
        Guid rowGuid = item.Rowguid;
        // 🔥 CRITICAL: DETACH ODATA FIRST (fixes Guard)
        var trackedEntity = curODContext.IsEntityTracked(item)
            ? item
            : MyDaFmts.FirstOrDefault(x => x.Rowguid == rowGuid);
        if (trackedEntity != null && curODContext.IsEntityTracked(trackedEntity))
        {
            if (curODContext.GetEntityState(trackedEntity) == EntityStates.Added)
            {
                curODContext.Detach(trackedEntity);  // ← REMOVES FROM GUARD TRACKING
                Console.WriteLine($"✅ DETACHED from OData: {rowGuid}");
            }
        }
        // Clear edit states
        draftFmt = null;
        EdFmtRowguid = null;
        AdFmtRowguid = null;
        //DlFmtRowguid = null;
        isEdtFmt = false;
        isAddFmt = false;
        isDelFmt = false;
        // Your working UI fix
        MyDaFmts.RemoveAll(x => x.Rowguid == rowGuid);
        MyDaFmts = MyDaFmts.ToList();
        // ✅ CORRECT: Positional arguments
        // 🔥 NOTIFY PARENT
        await OnPendingStateChanged.InvokeAsync(new PendingState(
            curODContext.GetPendingChanges().Any(),
            curODContext.GetPendingChanges().Count()
        ));
        item.Xedt1 = 0;
        item.Xadd1 = 0;
        item.Xdel1 = 0;
        FmtRenderKey = null;
        NbChanges = _guard.GetPendingChangesCount();
        await NbChangesChanged.InvokeAsync(NbChanges);  // Updates parent's _nbChanges
        StateHasChanged();
    }

    //✅ Mark1-7.Plan Confirm Delete
    private async Task ConfirmPlnDelete(Plngen item)
    {
        Guid rowGuid = item.Rowguid;

        Console.WriteLine($"🔥 CONFIRM DELETE {rowGuid}");

        // 🔥 DETACH IF NEEDED (important for Guard stability)
        if (curODContext.IsEntityTracked(item))
        {
            curODContext.DeleteObject(item);
        }
        else
        {
            curODContext.AttachTo("Plngens", item);
            curODContext.DeleteObject(item);
        }

        // 🔥 FLUSH DELETE
        await _guard.FlushAsync();

        // 🔥 REMOVE FROM UI
        MyDaPlans.RemoveAll(x => x.Rowguid == rowGuid);
        MyDaPlans = MyDaPlans.ToList();

        // 🔥 RESET STATES
        DlPlnRowguid = null;
        isDelPln = false;

        // 🔥 NOTIFY PARENT
        await OnPendingStateChanged.InvokeAsync(new PendingState(
            _guard.HasPendingChanges(),
            _guard.GetPendingChangesCount()
        ));

        NbChanges = _guard.GetPendingChangesCount();
        await NbChangesChanged.InvokeAsync(NbChanges);

        PlanRenderKey = null;
        Console.WriteLine($"✅ Deleted {rowGuid}");

        StateHasChanged();
    }
    //✅ Mark2-7.Rub Confirm Delete
    private async Task ConfirmRubDelete(Rubvar item)
    {
        DlRubRowguid = null;
        isDelRub = false;

        // 🔥 ENSURE WE RETURN TO NORMAL MODE
        EdRubRowguid = null;
        isEdtRub = false;
        draftRub = null;

        Console.WriteLine("❎ Delete canceled");
        //StateHasChanged();
    }
    //✅ Mark3-7.Fmt Confirm Delete
    private async Task ConfirmFmtDelete(Rubfmt item)
    {
        DlFmtRowguid = null;
        isDelFmt = false;

        // 🔥 ENSURE WE RETURN TO NORMAL MODE
        EdFmtRowguid = null;
        isEdtFmt = false;
        draftFmt = null;

        Console.WriteLine("❎ Delete canceled");
        //StateHasChanged();
    }
    //✅ Mark1-8.Plan Cancel Delete
    private void CancelPlnDelete()
    {
        DlPlnRowguid = null;
        isDelPln = false;

        // 🔥 ENSURE WE RETURN TO NORMAL MODE
        EdPlnRowguid = null;
        isEdtPln = false;
        draftPln = null;

        Console.WriteLine("❎ Delete canceled");
        StateHasChanged();
    }
    //✅ Mark2-8.Rub Cancel Delete
    private void CancelRubDelete()
    {
        DlRubRowguid = null;
        isDelRub = false;

        // 🔥 ENSURE WE RETURN TO NORMAL MODE
        EdRubRowguid = null;
        isEdtRub = false;
        draftRub = null;

        Console.WriteLine("❎ Delete canceled");
        //StateHasChanged();
    }
    //✅ Mark3-8.Fmt Cancel Delete
    private void CancelFmtDelete()
    {
        DlFmtRowguid = null;
        isDelFmt = false;

        // 🔥 ENSURE WE RETURN TO NORMAL MODE
        EdFmtRowguid = null;
        isEdtFmt = false;
        draftFmt = null;

        Console.WriteLine("❎ Delete canceled");
        StateHasChanged();
    }



    //RUBRIQUE
    //✅ Mark2-0.Rub RowClick
    void OnRubRowClick(GridRowEventArgs<Rubvar> args)
    {
        var selectedRub = args.Item;
        if (!AllowMultipleEdits && EdRubRowguid == selectedRub.Rowguid)
            return;
        if (!EdRubRowguid.HasValue || AllowMultipleEdits)
        {
            _editRubOriginals[selectedRub.Rowguid] = (Rubvar)DeepClone(selectedRub);
        }
        EdRubRowguid = AllowMultipleEdits ? null : selectedRub.Rowguid;
        draftRub = selectedRub;
        //EdRubRowguid = selectedRub.Rowguid;
        // ✅ FIXED TRACKING: Correct AttachTo signature
        if (curODContext.IsEntityTracked(selectedRub))
        {
            curODContext.UpdateObject(selectedRub);
        }
        else if (isAddRub)
        {
            curODContext.AddObject("Rubvars", selectedRub);
        }
        else
        {
            // ✅ FIX: AttachTo(entitySetName, entity) - NO EntityStates parameter
            curODContext.SafeAttachOrUpdate<Rubvar>(selectedRub, "Rubvars", isAddRub);
            curODContext.UpdateObject(selectedRub);
        }
        isEdtRub = true;
        StateHasChanged();
    }

    //FORMAT
    //✅ Mark3-0.Fmt RowClick
    void OnFmtRowClick(GridRowEventArgs<Rubfmt> args)
    {
        var selectedFmt = args.Item;
        if (!AllowMultipleEdits && EdFmtRowguid == selectedFmt.Rowguid)
            return;
        if (!EdFmtRowguid.HasValue || AllowMultipleEdits)
        {
            _editFmtOriginals[selectedFmt.Rowguid] = (Rubfmt)DeepClone(selectedFmt);
        }
        EdFmtRowguid = AllowMultipleEdits ? null : selectedFmt.Rowguid;
        draftFmt = selectedFmt;
        //EdFmtRowguid = selectedFmt.Rowguid;
        // ✅ FIXED TRACKING: Correct AttachTo signature
        if (curODContext.IsEntityTracked(selectedFmt))
        {
            curODContext.UpdateObject(selectedFmt);
        }
        else if (isAddFmt)
        {
            curODContext.AddObject("Rubfmts", selectedFmt);
        }
        else
        {
            // ✅ FIX: AttachTo(entitySetName, entity) - NO EntityStates parameter
            curODContext.SafeAttachOrUpdate<Rubfmt>(selectedFmt, "Rubfmts", isAddFmt);
            curODContext.UpdateObject(selectedFmt);
        }
        isEdtFmt = true;
        StateHasChanged();
    }

    private int nextSeq(int orig)
    {
        int maxSeq = 0;
        if (orig == 1) maxSeq = MyDaPlans.Any() ? MyDaPlans.Max(p => p.Iui) : 0;
        if (orig == 2) maxSeq = MyDaRubs.Any() ? MyDaRubs.Max(r => r.Iui) : 0;
        if (orig == 3) maxSeq = MyDaFmts.Any() ? MyDaFmts.Max(f => f.Idzon) ?? 0 : 0;
        return maxSeq + 1;
    }
    //DeepClone global
    private object DeepClone(object entity)
    {
        var settings = new JsonSerializerSettings
        {
            ReferenceLoopHandling = ReferenceLoopHandling.Ignore
        };

        var json = JsonConvert.SerializeObject(entity, settings);
        return JsonConvert.DeserializeObject(json, entity.GetType(), settings)!;
    }

    // MARK 5: VALIDATE INPUT
    private bool ValidatePln(Plngen mypln)
    {
        //liba
        if (string.IsNullOrEmpty(mypln.Liba)
            || mypln.Liba.Length < 5)
        {
            Imessage = "designation obligatoire/longueur";
            return false;
        }
        //abrege
        if (string.IsNullOrEmpty(mypln.Abg)
            || mypln.Abg.Length < 4)
        {
            Imessage = "abrege obligatoire/longueur";
            return false;
        }
        //etat
        if (mypln.Eta < 0)
        {
            Imessage = "etat obligatoire";
            return false;
        }
        return true;
    }
    // MARK 5: VALIDATE INPUT
    private bool ValidateRub(Rubvar myrub)
    {
        //liba
        if (string.IsNullOrEmpty(myrub.Liba)
            || myrub.Liba.Length < 5)
        {
            Imessage = "designation obligatoire/longueur";
            return false;
        }
        //abrege
        if (string.IsNullOrEmpty(myrub.Abg)
            || myrub.Abg.Length < 4)
        {
            Imessage = "abrege obligatoire/longueur";
            return false;
        }
        //etat
        if (myrub.Eta < 0)
        {
            Imessage = "etat obligatoire";
            return false;
        }
        return true;
    }
    private bool ValidateFmt(Rubfmt myfmt)
    {
        //liba
        if (string.IsNullOrEmpty(myfmt.Liba)
            || myfmt.Liba.Length < 5)
        {
            Imessage = "designation obligatoire/longueur";
            return false;
        }
        //abrege
        if (string.IsNullOrEmpty(myfmt.Abg)
            || myfmt.Abg.Length < 4)
        {
            Imessage = "abrege obligatoire/longueur";
            return false;
        }
        //etat
        if (myfmt.Eta < 0)
        {
            Imessage = "etat obligatoire";
            return false;
        }
        return true;
    }
    bool AreRowsEqual(Rubvar row1, Rubvar row2) =>
        row1.Liba == row2.Liba && row1.Abg == row2.Abg;
    //FILTRES
    private Grid<Plngen> grid = default!;
    private async void TogglePlnFiltering()
    {
        isPlnFilteringEnabled = !isPlnFilteringEnabled;
        await grid.RefreshDataAsync(); // Refresh the grid to apply the change
    }
    private void ToggleRubFiltering()
    {
        isRubFilteringEnabled = !isRubFilteringEnabled;
    }
    //PLAN Formule modals
    void showFrplnModal(Plngen mypln)
    {
        pstrFormu = "";
        if (!String.IsNullOrEmpty(mypln.Fpsource))
        {
            pstrFormu = mypln.Liba.Substring(0, 8);
        }
        curPlan = mypln;
        pForuModal?.ShowAsync();
    }
    //RUBR Formule modals
    void showFrrubModal(Rubvar myrub)
    {
        rstrFormu = "";
        if (!String.IsNullOrEmpty(myrub.Frsource))
        {
            rstrFormu = myrub.Liba.Substring(0, 8);
        }
        curRubr = myrub;
        rForuModal?.ShowAsync();
    }
    //FMT Formule modals
    void showFrfmtModal(Rubfmt myfmt)
    {
        fstrFormu = "";
        if (!String.IsNullOrEmpty(myfmt.Ftsource))
        {
            fstrFormu = myfmt.Liba.Substring(0, 8);
        }
        curFmat = myfmt;
        gForuModal?.ShowAsync();
    }
    private void showPgLink()
    {
        yaPgLink = !yaPgLink;
    }
    // private void SelPlanDom(int xdom)
    // {
    //     if (xdom != 0)
    //     {
            
    //     }
    // }
    private void SelPlanVue(int xdom)
    {
        if (xdom != 0)
        {

        }
    }
    private string GetCodeStyle()
    {
        return "width:50%;";
    }
    private string GetStyle(int? itemId)
    {
        int oId = Convert.ToInt32(itemId);
        Console.WriteLine($" style state : {oId}");
        return EdState.TryGetValue(oId, out bool onEditing) && onEditing
        ? "background-color:yellow;"
        : "";
    }
    private string GetButton(int itemId)
    {
        int oId = Convert.ToInt32(itemId);
        return EdState.TryGetValue(oId, out bool onEditing) && onEditing ? "Confirm" : "Edit";
    }

    private bool IsChildValid(Rubvar myrb)
    {
        int ercpt = 0;
        chlTitle = chlInitTitle;
        if (string.IsNullOrEmpty(myrb.Liba)) 
        {
            chlTitle = chlTitle + "Obligatoire designation";
            ercpt = ercpt + 1;
        }
        if (isRubCodeValid = false) //verifie scdrub
        {
            chlTitle = chlTitle + "Obligatoire code";
            ercpt = ercpt + 1;
        }
        if (myrb.Ipln == 0) 
        {
            chlTitle = chlTitle + "Obligatoire programme";
            ercpt = ercpt + 1;
        }
        if (ercpt > 0)
        {
            chlTitle = "!%2.REFUS, erreur saisie Rubrique(s)%! " + gsnTitle;
            return false;
        }
        return true;
    }
   
    private void OnChlBlurHandler(Plngen mypl, Rubvar myvar)
    {
        Console.WriteLine("ATTENTION : En Blur....");
        isRubCodeValid = HandleChlInput(mypl, myvar);
        Imessage = $"OnBlur active : {isRubCodeValid}";
        // Optionally trigger UI refresh or logging
    }
    private void OnChlFocusHandler(Plngen mypl, Rubvar myvar)
    {

    }

    private bool HandleChlInput(Plngen mypl, Rubvar myvar)
    {
        var input = myvar.Scdrub?.Trim();
        Jmessage = "";
        Console.WriteLine($"code entre traiter {input}");
        // Basic null/empty check
        if (string.IsNullOrEmpty(input))
        {
            Jmessage = "Le code est requis.";
            return false;
        }
        // Explicit length check
        if (input.Length != _lgcdu)
        {
            Jmessage = $"Le code doit contenir exactement {_lgcdu} chiffres.";
            return false;
        }
        // Digit-only check/No de poste peut ne pas etre numerique
        if (!Regex.IsMatch(input, @"^[0-9]+$")) // @"^[a-zA-Z0-9_\-\/\\|{}]+$"))
        {
            //(!Regex.IsMatch(input, @"^\d+$")) /numeric
            //(Regex.IsMatch(input, @"^[a-zA-Z0-9]+$")) /alphanumeric strict
            //(Regex.IsMatch(input, @"^[a-zA-Z0-9_\-\/\\|{}]+$") /add some others characters
            //(Regex.IsMatch(input, @"^[a-zA-Z0-9_\-\/\\|{}]{6}$")) //limit number to 6
            //(Regex.IsMatch(input, @"^[a-zA-Z0-9_\-\/\\|{}]{4,10}$")) //limit a range 4-10
            Jmessage = "Le code ne doit contenir que des chiffres.";
            return false;
        }
        // Uniqueness check
        var exists = mypl.Rubvars?.Any(uva => uva.Scdrub == input) ?? false;
        if (exists)
        {
            Jmessage = "Ce code rubrique existe déjà.";
            return false;
        }
        return true;
    }

    private void UpdateNbChanges()
    {
        NbChanges = _guard.GetPendingChangesCount();  // Child gets correct value
        NbChangesChanged.InvokeAsync(NbChanges);      // 🔥 Updates parent instantly
    }
    public void Dispose()  // ← ADD THIS
    {
        Console.WriteLine("🧹 Child Prubsaie cleaning up");
        _guard.DiscardUnconfirmedAdds<Plngen>();
        _guard.DiscardUnconfirmedAdds<Rubvar>();
        _guard.DiscardUnconfirmedAdds<Rubfmt>();
    }
    // private void OnLocationChanged(object sender, LocationChangedEventArgs e)
    // {
    //     //bool reussi = SaveCurEntities().Result;
    // }
    // public async Task<bool> SaveCurEntities()
    // {
    //     try
    //     {
    //         await curODContext.SaveDataAsync();
    //         _guard.save
    //         Console.WriteLine("Saved SUCCESS");
    //         //var wrkplns = curOrga.Plngens.Where(pl => pl.Ptyp == 3 && pl.Totyp == IMyAtr).ToList();
    //         //MyDaPlans = wrkplns;
    //         StateHasChanged();
    //         return true;
    //     }
    //     catch (Exception ex)
    //     {
    //         Console.WriteLine($"Saved ISSUE {ex.Message}");
    //         //Alert($"ECHEC Entities not SAVED");
    //         return false;
    //     }


    // private async Task ConfirmPlnEdit(Plngen item)
    // {
    //     if (!ValidatePln(item)) {
    //         Imessage = "infos plan non valide";
    //         return;
    //     }
    //     // 🔥 DEBUG: Log EXACT entity state
    //     Console.WriteLine($"🔍 SAVING: Id={item.Id}, Idorg={item.Idorg}, Rowguid={item.Rowguid}");
    //     _editOriginals.Remove(item.Rowguid);
    //     bool wasAddMode = isAddPln && !AllowMultipleEdits;
    //     if (wasAddMode)
    //     {
    //         await StartAddNewPlnAsync();  // Chain continues - NO SAVE YET
    //     }
    //     else
    //     {
    //         // 🔥 ONLY save for Edit mode or multi-edit
    //         if (curODContext.IsEntityTracked(item))
    //         {
    //             await _guard.FlushAsync();
    //         }

    //         if (!AllowMultipleEdits)
    //             ResetPlnEditState();
    //     }
    //     PlanRenderKey = Guid.NewGuid();
    //     await OnPendingStateChanged.InvokeAsync(new PendingState(
    //         _guard.HasPendingChanges(),
    //         _guard.GetPendingChangesCount()
    //     ));
    //     // In ANY child edit method:
    //     NbChanges = _guard.GetPendingChangesCount();
    //     await NbChangesChanged.InvokeAsync(NbChanges);  // Updates parent's _nbChanges
    //     item.Xadd1 = 0;
    //     item.Xedt1 = 0;
    //     Console.WriteLine($"passed confirmed {item?.Xedt1}");
    //     StateHasChanged();
    // }
    // }
}
