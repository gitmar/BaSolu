@page "/invoper"

@using System.ComponentModel.DataAnnotations
@using System.Dynamic
@using System.Security.Claims
@using System.Text
@using System.Web
@using BlazorBootstrap
@using Blazored.LocalStorage
@using GxAdm.Services
@using GxShared.Sess
@using GxShared.Others
@using GxShared.Identity
@using GxShared.Helpers
@using GxShared.ShdServices
@using GxWapi.DaModels
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.OData.Client
@using Newtonsoft.Json

@* @inject Default.Container _vcontext *@
@* @inject MyAuthStateProvider _authprovider *@
@inject IHttpClientFactory _httpFactorer
@inject ILocalStorageService _localStorage
@inject HttpClientService _clieManager
@inject IODataContextFactory _contextFactory
@inject LinkSerialiser _linkSerialiser
@inject NavigationManager _navmanager
@inject SessionContextService _sessionContext
@inject IJSRuntime _jsRun
@inject RendAgres _rendAgres

<PageTitle>OPERATEURS</PageTitle>
<h3>OPERATEURS</h3>
@if (!string.IsNullOrEmpty(Imessage))
{
    <div>
        @Imessage
    </div>
}
@if (ErrorsList.Any())
{
    foreach (var uner in ErrorsList)
    {
        Imessage = Imessage + uner.ToString();
    }
}
<AuthorizeView>
    <Authorized>
    <div class="d-flex flex-row">
            <EditForm Model="_invModel" OnValidSubmit="SendIndividualInvite" Context="invFormContext">
                <DataAnnotationsValidator />
                    <DataAnnotationsValidator />
                    <ValidationSummary />
                    <Tabs>
                        <Tab Title="Individuelle">
                            <Content>
                                <div class="row g-3">
                                    <!-- Common fields -->
                                    <div class="col-md-6">
                                        <label>Ref.appel:</label>
                                        <InputText @bind-Value="_invModel.Refapl" class="form-control" />
                                    </div>

                                    <div class="col-md-6">
                                        <label>Role:</label>
                                        <InputSelect @bind-Value="_invModel.Irole" class="form-select">
                                            <option value="0">Sélectionner...</option>
                                            @foreach (var role in _invRoles)
                                            {
                                                <option value="@role.Level">@role.Name</option>
                                            }
                                        </InputSelect>
                                    </div>

                                    <div class="col-md-6">
                                        <label>Qualité:</label>
                                        <InputSelect @bind-Value="_invModel.Utyp" class="form-select">
                                            <option value="0">Sélectionner...</option>
                                            @foreach (var ut in LsFixes.Where(uf => uf.Gvars == 36 && uf.Itb == 6 && uf.Elea != 0))
                                            {
                                                <option value="@ut.Elea">@ut.Liba</option>
                                            }
                                        </InputSelect>
                                    </div>

                                    @if (_invModel.Utyp > 3 && _invModel.Utyp <= 6)
                                    {
                                        <div class="col-md-6">
                                            <label>Raison:</label>
                                            <InputText @bind-Value="_invModel.TRaison" class="form-control" />
                                        </div>
                                    }
                                    <div class="col-md-6">
                                        <label>Email:</label>
                                        <InputText type="email" @bind-Value="_invModel.Email" class="form-control" />
                                    </div>
                                    <div class="col-md-6">
                                        <label>Nom:</label>
                                        <InputText @bind-Value="_invModel.FirstName" class="form-control" />
                                    </div>
                                    <div class="col-md-6">
                                        <label>Prenom(s):</label>
                                        <InputText @bind-Value="_invModel.LastName" class="form-control" />
                                    </div>
                                    <div class="col-md-6">
                                        <label>Téléphone:</label>
                                        <InputText @bind-Value="_invModel.PhoneNumber" class="form-control" />
                                    </div>

                                    <div class="col-md-6">
                                        <label>Services:</label>
                                        <InputSelect @bind-Value="_invModel.Ihie" class="form-select">
                                            <option value="0">Aucun</option>
                                            @foreach (var div in _lsDivs)
                                            {
                                                <option value="@div.Ihie">@div.Liba</option>
                                            }
                                        </InputSelect>
                                    </div>

                                    <div class="col-md-6">
                                        <label>Poste:</label>
                                        <InputSelect @bind-Value="_invModel.Ipst" class="form-select">
                                            <option value="0">Aucun</option>
                                            @foreach (var pst in _lsPsts)
                                            {
                                                <option value="@pst.Ipst">@pst.Liba</option>
                                            }
                                        </InputSelect>
                                    </div>
                                </div>

                                <div class="mt-4">
                                <Button color="ButtonColor.Primary" @onclick="() => SendIndividualInvite()">
                                        Envoyer Invitation Individuelle
                                    </Button>
                                </div>
                            </Content>
                        </Tab>
                        <Tab Title="De groupe">
                            <Content>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label>Ref.appel:</label>
                                        <InputText @bind-Value="_invModel.Refapl" class="form-control" />
                                    </div>

                                    <div class="col-md-6">
                                        <label>Role:</label>
                                        <InputSelect @bind-Value="_invModel.Irole" class="form-select">
                                            <option value="0">Sélectionner...</option>
                                            @foreach (var role in _invRoles)
                                            {
                                                <option value="@role.Level">@role.Name</option>
                                            }
                                        </InputSelect>
                                    </div>
                                    <div class="col-md-6">
                                        <label>Qualité:</label>
                                        <InputSelect @bind-Value="_invModel.Utyp" class="form-select">
                                            <option value="0">Sélectionner...</option>
                                            @foreach (var ut in LsFixes.Where(uf => uf.Gvars == 36 && uf.Itb == 6 && uf.Elea != 0))
                                            {
                                                <option value="@ut.Elea">@ut.Liba</option>
                                            }
                                        </InputSelect>
                                    </div>
                                    <div class="col-md-6">
                                        <label>Services:</label>
                                        <InputSelect @bind-Value="_invModel.Ihie" class="form-select">
                                            <option value="0">Aucun</option>
                                            @foreach (var div in _lsDivs)
                                            {
                                                <option value="@div.Ihie">@div.Liba</option>
                                            }
                                        </InputSelect>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <label>Recipients (email - nom):</label>
                                        <textarea class="form-control" rows="6" @bind="emailsInput"
                                                  placeholder="user1@example.com - John Doe&#10;user2@example.com - Jane Smith">
                                        </textarea>
                                        @if (invalidEmails.Any())
                                        {
                                            <div class="alert alert-warning mt-2">
                                                <strong>Emails invalides:</strong>
                                                <ul>
                                                    @foreach (var email in invalidEmails)
                                                    {
                                                        <li>@email</li>
                                                    }
                                                </ul>
                                            </div>
                                        }
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <Button color="ButtonColor.Primary" @onclick="()=> SendGroupInvite()"
                                            disabled="!CanSendGroupInvite()">
                                        Envoyer Invitations Groupe (@ValidGroupEmails.Count)
                                    </Button>
                                </div>
                            </Content>
                        </Tab>
                    </Tabs>
                </EditForm>
                @if (invalidEmails.Any())
                {
                    <Alert Color="AlertColor.Danger">
                        <strong>Invalid entries:</strong>
                        <ul>
                            @foreach (var line in invalidLines)
                            {
                                <li>@line</li>
                            }
                        </ul>
                    </Alert>
                }
    </div>
    </Authorized>
    <NotAuthorized>        
        <label>Non Autorise</label>
    </NotAuthorized>
</AuthorizeView>
<style>
    .inputfl {
    opacity: 0;
    width: 0.1;
    height: 0.1;
    position: absolute;
    }

    .disabled {
    pointer-events: none; /* Prevents clicking */
    opacity: 0.5; /*visual cue for disabled state */
    }

    .gpe-select {
    font-size: 24px;
    font-weight: bold;
    }

    .gpe-select option {
    font-size: 18px;
    font-weight: bold;
    }

    .my-container {
    background-color: yellow;
    }
</style>

@code {
    private bool isLoading = true;
    private string Imessage = "";

    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }
    private ClaimsPrincipal authUser;
    private bool isAuthenticated = false;
    [Parameter]
    public RenderFragment ChildContent { get; set; }

    private MyODataContext curODContext;
    private Gxorga curOrga = new Gxorga();
    private InviteRequest _invModel = new();
    private string emailsInput = "";
    private List<string> invalidEmails = new();
    // Errors
    private List<string> ErrorsList = new();
    // Data
    private List<Grole> _invRoles = new();
    private List<Gpdivh> _lsDivs = new();
    private List<Divpst> _lsPsts => _lsDivs
        .Where(d => d.Ihie == _invModel.Ihie)
        .SelectMany(d => d.Divpsts)
        .ToList();
    //GlobModels
    public Userbag _usrBag = new Userbag();
    int uMinrol = 0;
    public List<Gpfixe> LsFixes = new();
    private List<Grole> _usrRoles = new();
    private List<string> invalidLines = new();    
    private List<SimpleRecipient> ValidGroupEmails => ParseGroupEmails();
    private bool CanSendGroupInvite() => ValidGroupEmails.Any();

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        var authState = await AuthState;
        authUser = authState.User;
        isAuthenticated = authUser.Identity.IsAuthenticated;
        if (!isAuthenticated)
        {
            Console.WriteLine("Authentication in Astreintes Utilisateur ECHEC");
            return;
        }
        else
        {
            Console.WriteLine("Authentication in Astreintes SUCCESS");
        }
        await LoadInviteData();
        isLoading = false;
    }

    private async Task LoadInviteData()
    {
        // Load roles, divisions, fixes (your existing logic)
        _usrBag = await _sessionContext.GetUserbagAsync() ?? new Userbag();
        LsFixes = _usrBag.Ufixes.ToList();
        _lsDivs = await _rendAgres.LoadOrgaPostes();
        var json = await _clieManager.SendRequestAsync("AUTHClient", HttpMethod.Get, "usercontext/session");
        var result = JsonConvert.DeserializeObject<SessionDto>(json);
        if (result != null)
        {
            //Console.WriteLine($"Nb Roles : {result.Count}");
            _usrRoles = result.FullRoles;
            //Calcul de uMax role de utilisateur +1 si admin/lui-meme
            uMinrol = _usrRoles.Min(ur => ur.Level);
            if (authUser.IsInRole("Owner"))
            {
                uMinrol = uMinrol + 1; //saute en plus owner
            }
        }
        else
        {
            Console.WriteLine("Session : nulle");
            return;
        }
        //all orga roles
        var clcRoles = await _rendAgres.LoadOrgaRoles();
        var lsRoles = clcRoles.OrderBy(r => r.Level).ToList();
        //saute lui-meme
        _invRoles = lsRoles.Where(ur => ur.Level > uMinrol && (ur.Level < 10 || ur.Level > 40))
            .OrderBy(up => up.Level)
            .ToList();
        Console.WriteLine($"bon roles : {_invRoles.Count()}");
        _invModel.Utyp = 0; //cible
        //Imessage = "Donnees Grilles chargees";
        Console.WriteLine("Authentication ENTREE");
        try
        {
            curODContext = await _contextFactory.CreateAsync(); // Use factory
            var expand = "Tiewels";
            var dxorgas = await curODContext.LoadFilteredAsync<Gxorga>(expand: expand);
            curOrga = dxorgas.FirstOrDefault();
            if (curOrga == null)
            {
                Console.WriteLine("No organization found for the current user.");
                return;
            }
            //prise des colonnes //default/Ugpe = 1;
            _invModel.Idorg = curOrga.Idorg; // convert.toint16(user.findfirst("insidorg")?.value);                                                        //Console.WriteLine(usrBag.Lkorga.Idorg);
            _invModel.Raison = curOrga.Raison;
            //Console.WriteLine($"From Enrol Menu Nb.cols :{LsCols.Count} et tbEle {TbElems.Count}");
            Console.WriteLine($"orga recu {curOrga.Raison}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"stack trace : {ex.StackTrace} ex-mess : {ex.Message} and also in-mess: {ex.InnerException}");
        }
    }

    private async Task SendIndividualInvite()
    {
        Console.WriteLine("Sending Invite");
        try
        {
            Console.WriteLine("Envoie de Individuel");
            // Verify _invModel inputs
            bool siVerif = await VerifInputs(1);
            if (!siVerif)
            {
                Imessage = "Verification : " + Imessage;
                foreach(var uro in ErrorsList)
                {
                    Console.WriteLine($"verif issues : {uro}");
                }
                StateHasChanged();
                return;
            }
            // Individual
            Console.WriteLine("1 en cours....");
            await _clieManager.SetAuthorizationHeaderAsync("AUTHClient");
            var response = await _clieManager.SendRequestAsync("AUTHClient", HttpMethod.Post,
                "usercontext/generate-invite", new IndividualInviteRequest
                {
                    InviteData = _invModel
                });
            Imessage = "Succes Individual invite";
            StateHasChanged();
            // Success handling
        }
        catch (Exception ex)
        {
            // Error handling
        }
    }

    private async void SendGroupInvite()
    {
        // Verify _invModel inputs
        bool siVerif = await VerifInputs(2);
        if (!siVerif)
        {
            return;
        }
        // De groupe
        var validEmails = ValidGroupEmails;
        if (!validEmails.Any())
        {
            invalidEmails = new List<string> { "Aucun email valide" };
            return;
        }
        try
        {
            var groupInvite = new
            {
                Type = "Group",
                Refapl = _invModel.Refapl,
                Irole = _invModel.Irole,
                Utyp = _invModel.Utyp,
                Ihie = _invModel.Ihie,
                Recipients = validEmails
            };
            await _clieManager.SetAuthorizationHeaderAsync("AUTHClient");
            await _clieManager.SendRequestAsync("AUTHClient", HttpMethod.Post,
                "usercontext/generate-invite", new GroupInviteRequest
            {
                InviteData = _invModel,
                Recipients = ValidGroupEmails  // ✅ Compiles!
            });
        }
        catch (Exception ex)
        {
            // Error handling
        }
    }

    private List<SimpleRecipient> ParseGroupEmails()
    {
        var emails = new List<SimpleRecipient>();
        invalidEmails.Clear();

        var lines = emailsInput.Split(Environment.NewLine, StringSplitOptions.RemoveEmptyEntries)
            .Select(l => l.Trim()).Where(l => !string.IsNullOrWhiteSpace(l));

        foreach (var line in lines)
        {
            var parts = line.Split('-', 2, StringSplitOptions.TrimEntries);
            var email = parts[0].Trim();
            var name = parts.Length > 1 ? parts[1].Trim() : "";

            // ✅ Instance method call - works!
            if (IsValidEmail(email))
                emails.Add(new SimpleRecipient { Email = email, Name = name });
            else
                invalidEmails.Add(line);
        }
        return emails;
    }

    private bool IsValidEmail(string email)  // ✅ Instance method
    {
        if (string.IsNullOrWhiteSpace(email)) return false;
        return System.Text.RegularExpressions.Regex.IsMatch(email, @"^[^@\s]+@[^@\s]+\.[^@\s]+$");
    }
    private async Task<bool> VerifInputs(int gpe)
    {
        ErrorsList = new();
        //tous
        if (_invModel.Irole < 1)
        {
            ErrorsList.Add("Echec, Role obligatoire.");
        }
        if (_invModel.Utyp < 1)
        {
            ErrorsList.Add("Echec, Qualite obligatoire.");
        }
        if (gpe == 1)
        {
            if (String.IsNullOrEmpty(_invModel.FirstName))
            {
                ErrorsList.Add("Echec, Nom obligatoire.");
            }
            if (String.IsNullOrEmpty(_invModel.LastName))
            {
                ErrorsList.Add("Echec, Prenom(s) obligatoire.");
            }   
            if (!IsValidEmail(_invModel.Email))
            {
                ErrorsList.Add("Echec, Email obligatoire.");
            }
            if (String.IsNullOrEmpty(_invModel.PhoneNumber))
            {
                ErrorsList.Add("Echec, Phone obligatoire.");
            }
            if (_invModel.Utyp > 3 && _invModel.Utyp <= 6)
            {
                if (String.IsNullOrEmpty(_invModel.TRaison))
                {
                    ErrorsList.Add("Echec, Raison obligatoire.");
                }
            }
        }
        if (ErrorsList.Any())
        {
            return false;
        } else
        {
            return true;
        }
    }
}