@page "/zzarubmenu"
@inherits LayoutComponentBase
@layout FreeLayout

@using System.Security.Claims
@using BlazorBootstrap
@using Blazored.LocalStorage
@using GxAdm.ClieModels
@using GxAdm.Components.Admina.ARubs
@using GxAdm.Services
@using GxWapi.DaModels
@using GxShared.Sess
@using Microsoft.OData.Client
@using Newtonsoft.Json
@using Gx.Components
@using Gx.Components.Models

@inject NavigationManager _navmanager
@inject ILocalStorageService _localStorage
@inject HttpClientService _cliemanager
@inject IODataContextFactory _contextFactory
@inject SessionContextService _sessionContext
@inject RendAgres _rendAgres
@inject PendingChangesGuard _guard

@if (isLoading)
{
    <div class="text-center">
        <Spinner Color="SpinnerColor.Primary" Size="SpinnerSize.Large" />
        <p>SCHEMAS/APLANS Loading...</p>
    </div>
}
@if (!isLoading)
{
    <div class="gx-screen-layout">
        <div class="container gx-parent-container" style="height: 100vh;">
            <div class="d-flex flex-column" style="height: 100%;">
                <!-- Top Menu -->
                <GxNavMenu BrandText="A24soft Gx-Solutions"
                           MenuItems="@MenuItems"
                           YaGroup="false"
                           Groups="@Groupes"
                           MenuSelected="@_chxMenu"
                           MenuSelectedChanged="@SelMenu"
                           GroupSelected="@_chxGpe"
                           GroupSelectedChanged="@SelGpe"
                           OnBack="@NavigateBack" />
                <div class="row">
                    <div class="col-md-12 input-group align-middle">
                        <span class="text-uppercase text- text-success"><b>@strComp</b></span>
                        &nbsp;&nbsp;
                        <span class="separator">|| </span>
                        <Button class="btn btn-sm btn-secondary btnsz"
                                style="@(!allEnable ? "" : "display:none;")"
                                @onclick="ManEditAll">
                            Modifier
                        </Button>
                        <Button class="btn btn-sm btn-secondary btnsz"
                                style="@(allEnable ? "" : "display:none;")"
                                @onclick="ManCnclAll">
                            Annuler
                        </Button>
                        <span class="separator">|  </span>
                        <Button class="btn btn-sm btn-secondary btnsz"
                                style="@(allEnable ? "" : "display:none;")"
                                @onclick="ManSaveAll">
                            Enregistrer
                        </Button>
                        @if (!String.IsNullOrEmpty(MImessage))
                        {
                            <span class="bg-info bg-opacity-10" style="font-style:italic;color:red">&nbsp;--> @MImessage</span>
                        }
                    </div>
                </div>
                <!-- Main Content -->
                @if (curOrga != null && toChild != null && curODContext != null)
                {       
                    if (_chxMenu == 1)
                    { //grilles rubriques
                        <ZZRubgrils @ref="myrgrd"
                                  curOrga="@curOrga"
                                  toChild="@toChild"
                                  allEnable="@allEnable"
                                  curODContext="@curODContext">
                            <ChildContent>
                                @* <h2 class="child-box">Hello GRILLES</h2> *@
                            </ChildContent>
                        </ZZRubgrils>
                    }
                    else if (_chxMenu == 2)
                    { //echeance rubriques
                        <ZZRubechs @ref="myrech"
                                  curOrga="@curOrga"
                                  toChild="@toChild"
                                  allEnable="@allEnable"
                                  curODContext="@curODContext">
                            <ChildContent>
                                @* <h2 class="child-box">Hello GRILLES</h2> *@
                            </ChildContent>
                        </ZZRubechs>
                    }
                    else if (_chxMenu == 3)
                    { //schemas rubriques
                        <ZZRubposts @ref="myrpst"
                                 curOrga="@curOrga"
                                 toChild="@toChild"
                                 allEnable="@allEnable"
                                 curODContext="@curODContext">
                            <ChildContent>
                                @* <h2 class="child-box">Hello GRILLES</h2> *@
                            </ChildContent>
                        </ZZRubposts>
                    }
                    @* else if (_chxMenu == 4)
                    { //schemas rubriques
                      <AstrMenu @ref="myrmenu">
                      </AstrMenu>
                    } *@
                }
            </div>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-12">
            @if (_guard.HasPendingChanges())
            {
                <div class="alert alert-warning">
                    <strong>@pendingCount changes pending across all tabs</strong>
                </div>
            }
            <div class="d-flex gap-2 justify-content-end">
                <Button Color="ButtonColor.Primary"
                        @onclick="SaveAllAsync"
                        Enabled="@_guard.HasPendingChanges()">
                    Save All (@pendingCount changes)
                </Button>
                <Button Color="ButtonColor.Secondary"
                        @onclick="CancelAllChanges">
                    Cancel All Changes
                </Button>
            </div>
        </div>
    </div>
}
@code {
    private bool isLoading = true;
    public MyODataContext curODContext;
    public Gxorga curOrga = new Gxorga();
    public MyShareVars toChild = new MyShareVars();
    public RenderFragment ChildContent { get; set; }
    private bool allEnable = false;
    private string MImessage = "";

    private ZZRubgrils myrgrd;
    private ZZRubechs myrech;
    private ZZRubposts myrpst;
    private AstrMenu myrmenu;

    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }
    public ClaimsPrincipal authUser;
    public bool isAuthenticated = false;
    //in DATA
    public List<Gsgfix> LsTables = new List<Gsgfix>();

    private string _strOrga = "", _curSigle = "", strmeta = "", strmeta2 = "";
    //private int _lgcdu = 0;
    //entities load
    private IEnumerable<Gxorga> _lsOrgas = new List<Gxorga>();

    //GlobModels
    public Userbag _usrBag = new Userbag();
    public List<Gpfixe> LsFixes = new List<Gpfixe>();
    //public List<Upara> Uafls = new List<Upara>();
    public List<Gpdivh> LsDivs = new();
    public List<Gpvar> LsVars = new List<Gpvar>();
    public List<Gplan> LsPlans = new List<Gplan>();
    public List<Gpvar> LtTabls = new List<Gpvar>();
    public List<Gpvar> LsTabls = new List<Gpvar>();
    public List<Gpvar> TbElems = new List<Gpvar>();
    //Navigation
    private int _gIdTie = 0, _chxGpe = 0, _chxMenu = 1;
    private string strComp = "Plan GRILLE";
    //menus
    //private MenuModel menuModel = "GxMenuItem";
    public List<GxMenuItem> MenuItems = new()
    {
        new GxMenuItem { Id = 1, Text = "Grille", Icon = "bi bi-box-arrow-in-down" },
        new GxMenuItem { Id = 2, Text = "Echeancier", Icon = "bi bi-house-door" },
        new GxMenuItem { Id = 3, Text = "Organigramme", Icon = "bi bi-house-door" },
        new GxMenuItem { Id = 4, Text = "Saisies", Icon = "bi bi-house-door" },
        //new MenuItem { Id = 4, Text = "Mutation", Icon = "bi bi-arrow-repeat" },
    };
    public List<GxGroupe> Groupes = new();

    //modal management
    private string SidebarStyle = "width: 200px;";
    private bool IsOpen = true;
    private bool FirstLoadCompleted = false;
    private bool ContentLoaded { get; set; } = false;
    //Guard
    private int pendingCount => _guard.HasPendingChanges() ?
        curODContext.Context.Entities.Count(e => e.State != EntityStates.Unchanged) : 0;
    private async Task SaveAllAsync()
    {
        await _guard.FlushAsync();
        StateHasChanged();
    }
    private void CancelAllChanges()
    {
        _guard.CancelChangesAsync();
        StateHasChanged();
    }
    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        var authState = await AuthState;
        authUser = authState.User;
        isAuthenticated = authUser.Identity.IsAuthenticated;
        if (!isAuthenticated)
        {
            Console.WriteLine("Authentication in Astreintes Utilisateur ECHEC");
            return;
        }
        else
        {
            Console.WriteLine("Authentication in Astreintes SUCCESS");
        }
        _usrBag = await _sessionContext.GetUserbagAsync();
        _gIdTie = _usrBag.Usorga.Gdtie;
        //var idplnadm = _usrBag.Usorga.Schba;
        //LsDivs = _usrBag.Usorga.Uhies.Where(uh => uh.Id == idplnadm && uh.Sidiv == 1).ToList();
        // var noslims = LsVars.Where(uv => uv.Idhie == 0 && uv.Gvars == 21 && uv.Itb == 1 && uv.Elea == 1);
        // if (noslims.Any()) _lgcdu = noslims.FirstOrDefault().Ivala;
        LsVars = _usrBag.Usorga.Uvars.ToList();
        LsFixes = _usrBag.Ufixes.ToList();
        LsPlans = _usrBag.Usorga.Uplns.ToList();
        LtTabls = _usrBag.Usorga.Uvars.Where(tb => tb.Gvars == 4).ToList();
        LsTabls = _usrBag.Usorga.Uvars.Where(tb => tb.Gvars == 5).ToList();
        //ensemble des roles
        Console.WriteLine("Authentication ENTREE");
        ////EnrolVue.ShowSubmenu();
        await LoadSTROrgaAsync();
        //pita = 5;
        Console.WriteLine("TIERS A ETE TESTE");
        toChild.authUser = authUser;
        toChild.isAuthenticated = isAuthenticated;
        toChild.LsDivs = await _rendAgres.LoadOrgaPostes();
        toChild.LsVars = LsVars.ToList();
        toChild.LsFixes = LsFixes.ToList();
        toChild.LsPlans = LsPlans.ToList();
        toChild.LsTabls = LsTabls.ToList();
        isLoading = false;
    }
    //CRUD

    private async Task ManEditAll()
    {
        MImessage = "Edition en preparation...";
        if (_chxMenu == 1)
        { //grille
            await myrgrd.EdtAll();
        }
        if (_chxMenu == 2)
        { //echeancier
            await myrech.EdtAll();
        }
        if (_chxMenu == 3)
        { //schema
            await myrpst.EdtAll();
        }
        MImessage = "";
        allEnable = true;
    }
    private async Task ManCnclAll()
    {
        MImessage = "annulation en cours...";
        if (_chxMenu == 1)
        { //grille
            await myrgrd.CncAll();
        }
        if (_chxMenu == 2)
        { //echeancier
            await myrech.CncAll();
        }
        if (_chxMenu == 3)
        { //schema
            await myrpst.CncAll();
        }
        //reload
        LoadSTROrgaAsync();
        MImessage = "";
        allEnable = false;
    }
    private async Task LoadSTROrgaAsync()
    {
        int pisa = 2;
        try
        {
            curODContext = await _contextFactory.CreateAsync();
            _guard.AttachContext(curODContext);
            // 🔥 SINGLE QUERY - Get user's orga + ALL children
            curOrga = await curODContext.GetByKeyAsync<Gxorga>(
                _usrBag.Idorg,           // ✅ Key-based (no filter needed)
                "Gxorgas",
                "Gsgfixes,Gsglnes,Tiersps,Plngens($expand=Rubvars,Rubhies)"
            );
            if (curOrga == null)
            {
                Console.WriteLine("No organization found.");
                return;
            }

            Console.WriteLine($"✅ Orga: {curOrga.Raison}");
            Console.WriteLine($"   Gsgfixes: {curOrga.Gsgfixes?.Count() ?? 0}");
            Console.WriteLine($"   Plngens → Rubvars: {curOrga.Plngens?.Sum(p => p.Rubvars?.Count() ?? 0) ?? 0}");
            // curODContext = await _contextFactory.CreateAsync();
            // _guard.AttachContext(curODContext);
            // //curOrga et Gsgfixes, Gsglnes
            // var expand = "Gsgfixes," + "Gsglnes";
            // //Expression<Func<Gxorga, bool>> ogfilter = g => g.Idorg == _usrBag.Idorg;
            // var dxorgas = await curODContext.LoadFilteredAsync<Gxorga>(expand: expand);
            // pisa = 3;
            // curOrga = dxorgas.FirstOrDefault();
            // if (curOrga == null)
            // {
            //     Console.WriteLine("No organization found for the current user.");
            //     return;
            // }
            // Console.WriteLine($"orga recu {curOrga.Raison}");
            // //Console.WriteLine($"nb gsgfixes : {curOrga.Gsgfixes.Count()}");
            // //curOrga Plngens and rubvars
            // var expand2 = "Rubvars, Rubhies";
            // var dxplns = await curODContext.LoadFilteredAsync<Plngen>(expand: expand2);
            // pisa = 4;
            //Console.WriteLine($"nb de plans :  {dxplns.Count()}");


            // curODContext = await _contextFactory.CreateAsync();
            // //var token = await _localStorage.GetItemAsync<string>("blazToken");
            // //BON var expand = "Plngens($expand=Rubvars),Plngens($expand=Rubhies),Gsgfixes";
            // //var expand = "Gsgfixes,Gsglnes,Plngens,Plngens($expand=Rubvars),Plngens($expand=Rubhies)";
            // var expand = "Gsgfixes," + "Gsglnes," + "Plngens," +
            //  "Plngens($expand=Rubvars)," +
            //  "Plngens($expand=Rubhies)";
            // var dxorgas = await curODContext.LoadFilteredAsync<Gxorga>(expand: expand);
            // pisa = 3;
            // curOrga = dxorgas.FirstOrDefault();
            // if (curOrga == null)
            // {
            //     Console.WriteLine("No organization found for the current user.");
            //     return;
            // }
            // Console.WriteLine($"orga recu {curOrga.Raison}");
            //pisa = 4;
            //nsole.WriteLine($"nb pln test : {curOrga.Plngens.Count()}");
            //Console.WriteLine($"nb gsgfixes : {curOrga.Gsgfixes.Count()}");
            //Console.WriteLine($"nb gsglines : {curOrga.Gsglnes.Count()}");
            //Console.WriteLine($"nb rub tables MENU {curOrga.Gsgfixes.Count}");
            //var cplan = curOrga.Plngens.Where(upl => upl.Id == 20).FirstOrDefault();
            //Console.WriteLine($"nb rub cur plan :  {cplan.Rubvars.Count()}");

        }
        catch (Exception ex)
        {
            Console.WriteLine($"stack trace : {ex.StackTrace} place : {pisa} ex-mess : {ex.Message} and also in-mess: {ex.InnerException}");
        }
    }
    private async Task ManSaveAll()
    {
        MImessage = "enregistrement en cours...";
        if (_chxMenu == 1)
        { //grille
            //await myrgrd.SavAll();
        }
        if (_chxMenu == 2)
        { //echeancier
            //await myrech.SavAll();
        }
        if (_chxMenu == 3)
        { //schema
            //await myrpst.SavAll();
        }
        MImessage = "";
        allEnable = false;
    }
    // private async Task SelMenu(int noM)
    // {
    //     _chxMenu = noM;
    //     if (_chxMenu == 4) 
    //     {
    //         strComp = "Schemas";
    //         _navmanager.NavigateTo("/iagrmenu");
    //     }
    //     if (_chxMenu == 1) strComp = "Plan GRILLE";
    //     if (_chxMenu == 2) strComp = "Plan ECHEANCIER";
    //     if (_chxMenu == 3) strComp = "Plan ORGANIGRAMME";
    //     allEnable = false;
    //     StateHasChanged();
    //     await Task.Delay(800);
    // }
    private async Task LoadOrgaPostes()
    {
        //FmtPsts
        var indata = await _cliemanager.SendRequestAsync("AUTHClient", HttpMethod.Get, "lgauth/rubhiepsts");
        //Console.WriteLine($"21RECU DE LOGIN {strcall}");
        var inResu = JsonConvert.DeserializeObject<List<Gpdivh>>(indata);
        if (inResu.Any())
        {
            Console.WriteLine($"Nb Divs : {inResu.Count}");
            LsDivs = inResu.ToList();
        }
        else
        {
            Console.WriteLine("Nb Psts : null");
            LsDivs = new();
        }
        //Pdom 6tiers Patr1baseadm
        LsDivs = LsDivs.Where(ud => ud.Pdom == 6 && ud.Patr == 1).ToList();
    }
    private async Task SelMenu(int noM)
    {
        _chxMenu = noM;
        if (_chxMenu == 1) strComp = $"Plan GRILLE";
        if (_chxMenu == 2) strComp = $"Plan ECHEANCIER";
        if (_chxMenu == 3) strComp = $"Plan ORGANIGRAMME";
        if (_chxMenu == 4)
        {
            _navmanager.NavigateTo("/iagrmenu", replace: true);
            strComp = $"Saisies";
        }
        //if (_chxMenu == 5) strComp = "Colonnes";
        allEnable = false;
        StateHasChanged();
        await Task.Delay(1);
    }
    private async Task SelGpe(int noG)
    {
        _chxGpe = noG;
        //gpeLiba = "";
        //if (noG == 0) return;
        //var mygpe = LsGties.Where(gt => gt.Itb == 6 && gt.Elea == noG).FirstOrDefault();
        //LsCols = curOrga.Gsglnes.Where(ug => ug.Otyp == 5 && ug.Dtyp == 6 && ug.Totyp == Ugpe && ug.Jacc == 1).ToList();
        //Ugpe = noG;
        //Tgpe = mygpe.Gp2;
        //gpeLiba = LsGties.Where(ut => ut.Elea == mygpe.Elea).FirstOrDefault().Liba.ToUpperInvariant();
        StateHasChanged();
        Console.WriteLine("PAS 2");
        await Task.Delay(1);
    }
    private async Task Save()
    {
        await _guard.FlushAsync();  // ✅ Parallel batch saves
    }
    void NavigateBack()
    {
        _navmanager.NavigateTo("/");
    }
}
