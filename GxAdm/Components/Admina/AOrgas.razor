@page "/aorgas"
@layout FreeLayout

@using System
@using System.Reflection
@using System.Linq.Expressions
@using System.Web
@using System.ComponentModel.DataAnnotations
@using Newtonsoft.Json
@using System.Dynamic
@using BlazorBootstrap
@using Blazored.LocalStorage
@using System.Net.Http.Headers
@using System.Security.Claims
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.OData.Client
@using GxShared.Sess
@using GxShared.Others
@using GxShared.Identity
@using GxWapi.DaModels
@using GxAdm.ClieModels
@using GxAdm.Services
@using GxAdm.Services.Mform

@inject ILocalStorageService _localStorage
@inject NavigationManager _navmanager
@inject HttpClientService _cliemanager
@inject IODataContextFactory _contextFactory
@inject SessionContextService _sessionContext
@inject RendAgres _rendAgres;
@inject PendingChangesGuard _guard

@inject IHttpClientFactory _httpClientFactory

<PageTitle>INSTITUTION</PageTitle>
@* <h3>AOrgas</h3> *@
@if (edOrgContext == null)
{
    <div class="text-center">
        <Spinner Color="SpinnerColor.Primary" Size="SpinnerSize.Large" />
        <p>INSTITUTION Loading...</p>
    </div>
}
<div>
    @Imessage
</div>
<div>
    @Ierror
</div>
@if (edOrgContext != null)
{
    <AuthorizeView Context="authContext">
    <Authorized>
            <div class="row">
                <div class="col-md-10 input-group">
                    <button class="navbar-brand text-left text-white bg-dark bg-opacity-75 me-2 py-0 px-1" style="height:44px;" @onclick="NavigateBack">
                        A24soft Gx-Solutions
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary btnsz @(!allEnable ? "" : "d-none")" style="font-size: small" @onclick="() => EdtAll()">Modifier</button>
                </div>
            </div>
            <div class="container-fluid-fixed-top">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <label style="font-weight:bold"> Package :&nbsp;</label>
                            <label style="font-weight:bold;font-size:larger">@curOrga.Sidom</label>
                        </div>
                    </div>
                    <div class="row">
                        <Tabs>
                            <Tab Title="Structure">
                                 <Content>
                                    <EditForm EditContext="edOrgContext">
                                        <DataAnnotationsValidator />
                                        <ValidationSummary />
                                    <div class="col-md-2">
                                        @if(!isEdOrg)
                                        {
                                            <button class="btn btn-warning btn-sm" @onclick="() => EdtEOrg()">Edit</button>
                                        } else
                                        {
                                            <button class="btn btn-warning btn-sm" @onclick="() => ConfEOrg()">Confirm</button>
                                            <button class="btn btn-danger btn-sm" @onclick="() => CancEOrg()">Annul</button>
                                        }
                                    </div>
                                        <div class="table-responsive">
                                        <table class="table w-auto" style="margin-left:10px">
                                            <tbody>
                                                <tr>
                                                    <td>Raison sociale:</td>
                                                    <td class="text-right">
                                                        <InputText class="my-input" id="ograis" @bind-Value="curOrga.Raison" required
                                                                   style="font-weight:bold" readonly="@(isEdOrg ? null : "readonly")" placeholder="Enter sigle" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Sigle:</td>
                                                    <td class="text-right">
                                                        <InputText class="my-input" id="ogsig" @bind-Value="curOrga.Sigle" required
                                                                   style="font-weight:bold" readonly="@(isEdOrg ? null : "readonly")" placeholder="Enter sigle" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Nom Cible:</td>
                                                    <td class="text-right">
                                                        <InputText class="my-input" id="ogsigl" @bind-Value="curOrga.Stcible" required
                                                                   style="font-weight:bold" readonly="@(isEdOrg ? null : "readonly")" placeholder="Enter sigle" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Noeud Cible:</td>
                                                    <td class="text-right">
                                                        <InputNumber class="my-input" id="ognoeud" @bind-Value="curOrga.Jpoint" required
                                                                     style="font-weight:bold" readonly="@(isEdOrg ? null : "readonly")" placeholder="Enter sigle" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Si jeton:</td>
                                                    <td class="text-right">
                                                        <InputNumber class="my-input" id="ogjeta" @bind-Value="curOrga.Sijet" required
                                                                     style="font-weight:bold" readonly="@(isEdOrg ? null : "readonly")" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>No RCM:</td>
                                                    <td class="text-right">
                                                        <InputText class="my-input" id="ogrcm" @bind-Value="curOrga.Rcm"
                                                                   style="font-weight:bold" readonly="@(isEdOrg ? null : "readonly")" placeholder="Enter RCM" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>No IFU:</td>
                                                    <td class="text-right">
                                                        <InputText class="my-input" id="ogifu" @bind-Value="curOrga.Rifu"
                                                                   style="font-weight:bold" readonly="@(isEdOrg ? null : "readonly")" placeholder="Enter IFU" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Adresse:</td>
                                                    <td class="text-right">
                                                        <InputText class="my-input" id="ogadr" @bind-Value="curOrga.Adr"
                                                                   style="font-weight:bold" readonly="@(isEdOrg ? null : "readonly")" placeholder="Enter Adresse" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Adresse2:</td>
                                                    <td class="text-right">
                                                        <InputText class="my-input" id="ogadr2" @bind-Value="curOrga.Adr2"
                                                                   style="font-weight:bold" readonly="@(isEdOrg ? null : "readonly")" placeholder="Enter Adresse2" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Ville:</td>
                                                    <td class="text-right">
                                                        <InputText class="my-input" id="ogcity" @bind-Value="curOrga.Scity"
                                                                   style="font-weight:bold" readonly="@(isEdOrg ? null : "readonly")" placeholder="Enter CITY" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Province:</td>
                                                    <td class="text-right">
                                                        <InputText class="my-input" id="ogprov" @bind-Value="curOrga.Sprovi"
                                                                   style="font-weight:bold" readonly="@(isEdOrg ? null : "readonly")" placeholder="Enter PROVI" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Region:</td>
                                                    <td class="text-right">
                                                        <InputText class="my-input" id="ogreg" @bind-Value="curOrga.Sregio"
                                                                   style="font-weight:bold" readonly="@(isEdOrg ? null : "readonly")" placeholder="Enter REGION" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Pays:</td>
                                                    <td class="text-right">
                                                        <InputSelect id="ogpays" @bind-Value="curOrga.Ipays" disabled="@(!isEdOrg)">
                                                            <option value="0">-- Select a country --</option>
                                                            @foreach (var tob in curOrga.Gsglnes.Where(ug => ug.Otyp == 4 && ug.Pitb == 31))
                                                            {
                                                                <option value="@tob.Elea">@tob.Liba</option>
                                                            }
                                                        </InputSelect>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Telephone:</td>
                                                    <td class="text-right">
                                                        <InputText class="my-input" id="ogtele" @bind-Value="curOrga.Phone"
                                                                   style="font-weight:bold" readonly="@(isEdOrg ? null : "readonly")" placeholder="Enter TELE" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>WhatsApp:</td>
                                                    <td class="text-right">
                                                        <InputText class="my-input" id="ogwhats" @bind-Value="curOrga.Whatsapp"
                                                                   style="font-weight:bold" readonly="@(isEdOrg ? null : "readonly")" placeholder="Enter WhatsApp" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Siteweb:</td>
                                                    <td class="text-right">
                                                        <InputText class="my-input" id="ogsite" @bind-Value="curOrga.Weburl"
                                                                   style="font-weight:bold" readonly placeholder="Enter SITEWEB" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td colspan="3" style="border:0;font-weight:bold;">Administrateur</td>
                                                </tr>
                                                <tr>
                                                    <td>Telephone:</td>
                                                    <td class="text-right">
                                                        <InputText class="my-input" @bind-Value="curOrga.Phon2"
                                                                   style="font-weight:bold" readonly="@(isEdOrg ? null : "readonly")" placeholder="Enter Admin tele" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Email:</td>
                                                    <td class="text-right">
                                                        <InputText class="my-input" @bind-Value="curOrga.Email"
                                                                   style="font-weight:bold" readonly="@(isEdOrg ? null : "readonly")" placeholder="Enter Admin email" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Nom:</td>
                                                    <td class="text-right">
                                                        <InputText class="my-input" @bind-Value="curOrga.Rnom"
                                                                   style="font-weight:bold" readonly="@(isEdOrg ? null : "readonly")" placeholder="Enter Admin nom" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Prenom(s):</td>
                                                    <td class="text-right">
                                                        <InputText class="my-input" @bind-Value="curOrga.Rpnom"
                                                                   style="font-weight:bold" readonly="@(isEdOrg ? null : "readonly")" placeholder="Enter Admin prenom(s)" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Installe le :</td>
                                                    <td class="input-group">
                                                        <InputNumber class="my-input" @bind-Value="curOrga.Depexy"
                                                                     style="font-weight:bold;width:65px" readonly="@(isEdOrg ? null : "readonly")" placeholder="annee" />
                                                        <InputNumber class="my-input" @bind-Value="curOrga.Depexm"
                                                                     style="font-weight:bold;width:50px" readonly="@(isEdOrg ? null : "readonly")" placeholder="mois" />
                                                        <InputNumber class="my-input" @bind-Value="curOrga.Depexd"
                                                                     style="font-weight:bold;width:50px" readonly="@(isEdOrg ? null : "readonly")" placeholder="jour" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td colspan="2" style="border:0;font-weight:bold;">Exercice de travail</td>
                                                </tr>
                                                <tr>
                                                    <td>(Exo)Debut.:</td>
                                                    <td class="input-group">
                                                        <InputNumber class="my-input" @bind-Value="curOrga.Prvexy"
                                                                     style="font-weight:bold;width:65px" readonly="@(isEdOrg ? null : "readonly")" placeholder="annee" />
                                                        <InputNumber class="my-input" @bind-Value="curOrga.Prvexm"
                                                                     style="font-weight:bold;width:50px" readonly="@(isEdOrg ? null : "readonly")" placeholder="mois" />
                                                        <InputNumber class="my-input" @bind-Value="curOrga.Prvexd"
                                                                     style="font-weight:bold;width:50px" readonly="@(isEdOrg ? null : "readonly")" placeholder="jour" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>(Exo)Fin:</td>
                                                    <td class="input-group">
                                                        <InputNumber class="my-input" @bind-Value="curOrga.Finexy"
                                                                     style="font-weight:bold;width:65px" readonly="@(isEdOrg ? null : "readonly")" placeholder="annee" />
                                                        <InputNumber class="my-input" @bind-Value="curOrga.Finexm"
                                                                     style="font-weight:bold;width:50px" readonly="@(isEdOrg ? null : "readonly")" placeholder="mois" />
                                                        <InputNumber class="my-input" @bind-Value="curOrga.Finexd"
                                                                     style="font-weight:bold;width:50px" readonly="@(isEdOrg ? null : "readonly")" placeholder="jour" />
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        </div>
                                </EditForm>
                                </Content>
                            </Tab>
                            <Tab Title="Domaines">
                                <Content>
                                    <EditForm EditContext="edFixContext">
                                        <DataAnnotationsValidator />
                                    <div class="mb-3">
                                        <!-- Domaines grid -->
                                        <div class="row">
                                            <div class="form-group">
                                                <label style="font-weight:bold">Limites :</label>
                                                <InputSelect id="oglim" @bind-Value="Rubtto">
                                                    @foreach (var tob in LsFixes.Where(ut => ut.Gvars == 39 && ut.Itb == 1 && ut.Elea != 0))
                                                    {
                                                        <option value="@tob.Elea">@tob.Liba</option>
                                                    }
                                                </InputSelect>
                                            </div>
                                        </div>
                                        <Grid Data="@curOrga.Gsgfixes.Where(utl => utl.Gvars == 21 && utl.Itb == Rubtto && utl.Elea != 0)" 
                                                TItem="Gsgfix"
                                                Responsive="true">
                                            <GridColumns>
                                                <GridColumn TItem="Gsgfix" HeaderText="No">
                                                    <ChildContent Context="item">@item.Elea</ChildContent>
                                                </GridColumn>
                                                <GridColumn TItem="Gsgfix" HeaderText="Libelle">
                                                    <ChildContent Context="item">
                                                        @item.Liba
                                                        @if (Rubtto == 1)
                                                        {
                                                            <span>&nbsp;</span>
                                                            <span style="width:75px">
                                                                @if (item.Elea == 1)
                                                                {
                                                                    <span>(3..6)</span>
                                                                }
                                                                @if (item.Elea == 2)
                                                                {
                                                                    <span>(5..12)</span>
                                                                }
                                                                @if (item.Elea == 3)
                                                                {
                                                                    <span>(3..7)</span>
                                                                }
                                                                @if (item.Elea == 4)
                                                                {
                                                                    <span>(5..20)</span>
                                                                }
                                                                @if (item.Elea == 5)
                                                                {
                                                                    <span>(5..10)</span>
                                                                }
                                                                @if (item.Elea == 6)
                                                                {
                                                                    <span>(5..10)</span>
                                                                }
                                                                @if (item.Elea == 7)
                                                                {
                                                                    <span>(6..50)</span>
                                                                }
                                                                @if (item.Elea == 8)
                                                                {
                                                                    <span>(5..30)</span>
                                                                }
                                                            </span>
                                                        }
                                                    </ChildContent>
                                                </GridColumn>
                                                <GridColumn TItem="Gsgfix" HeaderText="Valeur">
                                                    <ChildContent Context="item">
                                                        <InputNumber class="my-input" @bind-Value="item.Ivala"
                                                                     style="font-weight:bold;width:50px" readonly="@(item.Rowguid == EdDomRowguid ? null : "readonly")" placeholder="annee" />
                                                    </ChildContent>
                                                </GridColumn>
                                                <GridColumn TItem="Gsgfix" HeaderText="Format">
                                                    <ChildContent Context="item">
                                                        @if (Rubtto == 1)
                                                        {
                                                            <span class="col-md-2">
                                                                @if (item.Elea != 1 && item.Elea != 2)
                                                                {
                                                                    <span>
                                                                        <InputText class="my-input" @bind-Value="item.Lgft"
                                                                                   style="font-weight:bold; width:100%" readonly="@(item.Rowguid == EdDomRowguid  ? null : "readonly")" />
                                                                    </span>
                                                                }
                                                                @if (item.Elea == 1 && item.Elea == 2)
                                                                {
                                                                    <span>
                                                                        <div>.....</div>
                                                                    </span>
                                                                }
                                                            </span>
                                                        }
                                                    </ChildContent>
                                                </GridColumn>
                                                <GridColumn TItem="Gsgfix" HeaderText="Actions">
                                                    <ChildContent Context="item">
                                                        @if (EdDomRowguid  != item.Rowguid)
                                                        {
                                                            <button class="btn btn-warning btn-sm @(!isEdDom && EdDomRowguid != item.Rowguid ? "" : "disabled-action")" @onclick="() => EditGdom(item)">Edit</button>
                                                        }
                                                        else
                                                        {
                                                            <button class="btn btn-warning btn-sm @(EdDomRowguid  == item.Rowguid ? "" : "disabled-action")" @onclick="() => ConfGdom(item)">Confirm</button>
                                                            <button class="btn btn-danger btn-sm @(EdDomRowguid  == item.Rowguid ? "" : "disabled-action")" @onclick="() => CancGdom(item)">Annul</button>
                                                        }
                                                    </ChildContent>
                                                </GridColumn>
                                            </GridColumns>
                                        </Grid>
                                    </div>
                                    </EditForm>
                                </Content>
                            </Tab>
                            <Tab Title="Filiations">
                                <Content>
                                    <EditForm EditContext="edFixContext">
                                        <DataAnnotationsValidator />
                                        <div class="mb-3">
                                            <!-- Filiation grid -->
                                        <div class="row">
                                            <label style="font-weight:bold"> Filiation -> Base</label>
                                        </div>
                                        <Grid Data="@curOrga.Gsgfixes.Where(uf => uf.Gvars == 3 && uf.Itb == 5 && uf.Elea != 0).OrderBy(uo => uo.Elea)"
                                                TItem="Gsgfix"
                                                Responsive="true">
                                            <GridColumns>
                                                <GridColumn TItem="Gsgfix" HeaderText="No">
                                                    <ChildContent Context="item">@item.Elea</ChildContent>
                                                </GridColumn>
                                                <GridColumn TItem="Gsgfix" HeaderText="Avec">
                                                    <ChildContent Context="item">
                                                        @item.Liba
                                                    </ChildContent>
                                                </GridColumn>
                                                <GridColumn TItem="Gsgfix" HeaderText="Libelle">
                                                    <ChildContent Context="item">
                                                            <InputText @bind-Value="@item.Sliba" style="width:100%"
                                                                   readonly="@(item.Rowguid == EdAflRowguid ? null : "readonly")" />
                                                    </ChildContent>
                                                </GridColumn>
                                                <GridColumn TItem="Gsgfix" HeaderText="Opt.">
                                                    <ChildContent Context="item">
                                                        <InputSelect id="ntop" @bind-Value="item.Ityp" disabled="@(!isEdAfl)">
                                                                    @foreach (var tob in LsFixes.Where(ut => ut.Gvars == 31 && ut.Itb == 2))
                                                                    {
                                                                        <option value="@tob.Elea">@tob.Liba</option>
                                                                    }
                                                                </InputSelect>
                                                    </ChildContent>
                                                </GridColumn>
                                                <GridColumn TItem="Gsgfix" HeaderText="Avis">
                                                    <ChildContent Context="item">
                                                        <div class="col-1">
                                                            <InputSelect id="ntav" @bind-Value="item.Jtyp" disabled="@(!isEdAfl)">
                                                                @foreach (var tob in LsFixes.Where(ut => ut.Gvars == 31 && ut.Itb == 6 && ut.Gp1 == 1))
                                                                {
                                                                    <option value="@tob.Elea">@tob.Liba</option>
                                                                }
                                                            </InputSelect>
                                                        </div>
                                                    </ChildContent>
                                                </GridColumn>
                                                <GridColumn TItem="Gsgfix" HeaderText="max.">
                                                    <ChildContent Context="item">
                                                        <InputNumber class="my-input" @bind-Value="item.Mtyp"
                                                                     style="font-weight:bold;width:60px" readonly="@(item.Rowguid == EdAflRowguid ? null : "readonly")" />
                                                    </ChildContent>
                                                </GridColumn>
                                                <GridColumn TItem="Gsgfix" HeaderText="notif.">
                                                    <ChildContent Context="item">
                                                            <InputSelect id="ntnf" @bind-Value="item.Ntyp" disabled="@(!isEdAfl)" style="width:100%">
                                                                @foreach (var tob in LsFixes.Where(ut => ut.Gvars == 31 && ut.Itb == 4 && ut.Gp1 == 1))
                                                                {
                                                                    <option value="@tob.Elea">@tob.Liba</option>
                                                                }
                                                            </InputSelect>
                                                    </ChildContent>
                                                </GridColumn>
                                                <GridColumn TItem="Gsgfix" HeaderText="Actions">
                                                    <ChildContent Context="item">
                                                        <div class="col-md-2 d-flex gap-2">
                                                            @if (EdAflRowguid  != item.Rowguid)
                                                            {
                                                                <button class="btn btn-warning btn-sm @(!isEdAfl && EdAflRowguid != item.Rowguid ? "" : "disabled-action")" @onclick="() => EditGafl(item)">Edit</button>
                                                            }
                                                            else
                                                            {
                                                                <button class="btn btn-warning btn-sm @(EdAflRowguid  == item.Rowguid ? "" : "disabled-action")" @onclick="() => ConfGafl(item)">Confirm</button>
                                                                <button class="btn btn-danger btn-sm @(EdAflRowguid  == item.Rowguid ? "" : "disabled-action")" @onclick="() => CancGafl(item)">Annul</button>
                                                            }
                                                        </div>
                                                    </ChildContent>
                                                </GridColumn>
                                            </GridColumns>
                                            </Grid>
                                        </div>
                                    </EditForm>
                                </Content>
                            </Tab>
                            <Tab Title="Colonnes">
                                <Content>
                                    <EditForm EditContext="edColContext">
                                        <DataAnnotationsValidator />
                                        <div class="mb-3">
                                            <!-- Colonnes grid -->
                                            <Grid Data="@curOrga.Gsglnes" TItem="Gsglne"
                                                  EditMode="EditMode.EditOnRowClick">
                                            <div class="row form-group">
                                        <div class="btn btn-group">
                                         <label style="font-weight:bold"> Filiation/Colonnes -> G.Tiers :</label>
                                        <InputSelect id="fltyp" @bind-Value="selTyp">
                                            <option value="0">choisir</option>
                                            @foreach (var tob in LsGties.ToList())
                                            {
                                                <option value="@tob.Gp2" @onclick="() => SelDomGtie(tob)">@tob.Liba</option>
                                            }
                                        </InputSelect>
                                        </div>
                                    </div>
                                    @if (selTyp > 0)
                                    {
                                    <div class="row form-group">
                                        <div class="input-group">
                                            @if (allEnable && isGenDelTfl)
                                            {
                                                <div class="row">
                                                    <label style="font-family:'Comic Sans MS';font-weight:bold;color:red">
                                                        @mesAflSup
                                                    </label>
                                                </div>
                                            }
                                            @if (allEnable && isGenAddTfl)
                                            {
                                                <div class="row">
                                                    <label style="font-family:'Comic Sans MS';font-weight:bold;color:red">
                                                        @mesAflGen
                                                    </label>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                    <Grid TItem="Gsgfix"
                                          Data="curOrga.Gsgfixes.Where(uf => uf.Gvars == 3 && uf.Itb == 5 && uf.Elea != 0).OrderBy(uo=>uo.Elea).ToList()"
                                          AllowDetailView="true"
                                          AllowRowClick="true"
                                          OnRowClick="OnGfixRowClick"
                                          Responsive="true">
                                        <GridColumns>
                                            <GridColumn TItem="Gsgfix" HeaderText="No">
                                                <ChildContent Context="item">@item.Elea</ChildContent>
                                            </GridColumn>
                                            <GridColumn TItem="Gsgfix" HeaderText="Avec">
                                                <ChildContent Context="item">
                                                    @item.Liba
                                                </ChildContent>
                                            </GridColumn>
                                            <GridColumn TItem="Gsgfix" HeaderText="Libelle">
                                                <ChildContent Context="item">
                                                    @item.Sliba
                                                </ChildContent>
                                            </GridColumn>
                                            <GridColumn TItem="Gsgfix" HeaderText="Opt">
                                                <ChildContent Context="item">
                                                    <div class="col-1">
                                                        <InputSelect id="ntop" @bind-Value="item.Ityp" disabled>
                                                            @foreach (var tob in LsFixes.Where(ut => ut.Gvars == 31 && ut.Itb == 2))
                                                            {
                                                                <option value="@tob.Elea">@tob.Liba</option>
                                                            }
                                                        </InputSelect>
                                                    </div>
                                                </ChildContent>
                                            </GridColumn>
                                            <GridColumn TItem="Gsgfix" HeaderText="Gen?">
                                                <ChildContent Context="item">
                                                    @if (GenerRowguid == item.Rowguid)
                                                    {
                                                        var curnbFlCols = curOrga.Gsglnes.Where(fl => fl.Otyp == 5 && fl.Dtyp == IMyBas && fl.Totyp == selTyp && fl.Tstyp == item.Elea).Count();
                                                        @if (isGenAddTfl)
                                                        {
                                                                        <button class="btn btn-sm btn-success @(GenerRowguid == item.Rowguid ? "" : "disabled-action")" @onclick="() => ConfOneGener(item)">
                                                                ✅ Confirm
                                                            </button>
                                                                        <button class="btn btn-sm btn-secondary @(GenerRowguid == item.Rowguid ? "" : "disabled-action")" @onclick="() => CncOneGener(item)">
                                                                ❌ Cancel
                                                            </button>
                                                        }
                                                        @if (isGenDelTfl)
                                                        {
                                                            <button class="btn btn-sm btn-success 
                                                            @(GenerRowguid == item.Rowguid ? "" : "disabled-action")" @onclick="() => ConfDelOneGener(item)">
                                                                ✅ Confirm
                                                            </button>
                                                            <button class="btn btn-sm btn-secondary 
                                                            @(GenerRowguid == item.Rowguid ? "" : "disabled-action")" @onclick="() => CncDelOneGener(item)">
                                                                ❌ Cancel
                                                            </button>
                                                        }
                                                    } else
                                                    {
                                                        var curnbFlCols = curOrga.Gsglnes.Where(fl => fl.Otyp == 5 && fl.Dtyp == IMyBas && fl.Totyp == selTyp && fl.Tstyp == item.Elea).Count();
                                                        @if (!isGenAddTfl || !isGenDelTfl)
                                                        {
                                                            @if (curnbFlCols > 0)
                                                            {
                                                                    <button class="btn btn-sm btn-danger
                                                                        @(GenerRowguid != item.Rowguid ? "" : "disabled-action")" 
                                                                        @onclick="() => PromptDelOneGener(item)">
                                                                    ❌ Supr.
                                                                </button>
                                                            }
                                                            else
                                                            {
                                                                    <button class="btn btn-sm btn-success 
                                                                        @(GenerRowguid != item.Rowguid ? "" : "disabled-action")"
                                                                        @onclick="() => PromptAddOneGener(item)">
                                                                        ✅ Genr. 
                                                                </button>
                                                            }
                                                        }
                                                    }
                                                </ChildContent>
                                            </GridColumn>
                                        </GridColumns>
                                        @if (icOpening == false)
                                        {
                                            <GridDetailView TItem="Gsgfix" Context="item">
                                                <Grid TItem="Gsglne"
                                                      Data="@gsgCols"
                                                      AllowFiltering="@isGlneFilteringEnabled"
                                                      AllowPaging="true"
                                                      Responsive="true">
                                                    <GridColumns>
                                                        <GridColumn TItem="Gsglne" HeaderText="No">
                                                            <ChildContent Context="r">
                                                                @r.Yrng
                                                            </ChildContent>
                                                        </GridColumn>
                                                        <GridColumn TItem="Gsglne" HeaderText="Origine">
                                                            <ChildContent Context="r">
                                                                <label>@r.Liba</label>
                                                            </ChildContent>
                                                        </GridColumn>
                                                        <GridColumn TItem="Gsglne" HeaderText="Courant">
                                                            <ChildContent Context="r">
                                                                @if (r.Rowguid == EdColRowguid)
                                                                { // show draftPln inputs
                                                                  <InputText @bind-Value="r.Oliba" />
                                                                }
                                                                else
                                                                { // show item as read-only
                                                                  <input @bind="r.Oliba" disabled="true" />
                                                                }
                                                            </ChildContent>
                                                        </GridColumn>
                                                        <GridColumn TItem="Gsglne" HeaderText="acc.">
                                                            <ChildContent Context="r">
                                                                <div class="col-1">
                                                                    @if (r.Rowguid == EdColRowguid)
                                                                    { // show draftPln inputs
                                                                      <input type="checkbox"
                                                                             checked="@(r.Jacc == 1)"
                                                                             @onchange="e => OnCheckboxChanged(e, r, nameof(r.Jacc))"
                                                                             class="form-check-input" />
                                                                    }
                                                                    else
                                                                    {
                                                                        <input type="checkbox"
                                                                               checked="@(r.Jacc == 1)"
                                                                               @onchange="e => OnCheckboxChanged(e, r, nameof(r.Jacc))"
                                                                               class="form-check-input"
                                                                               disabled />
                                                                    }
                                                                </div>
                                                            </ChildContent>
                                                        </GridColumn>
                                                        <GridColumn TItem="Gsglne" HeaderText="Rang">
                                                            <ChildContent Context="r">
                                                                <div class="col-1">
                                                                    @if (r.Rowguid == EdColRowguid)
                                                                    { // show draftPln inputs
                                                                      <InputNumber @bind-Value="r.Yrng"
                                                                                   style="font-weight:bold;width:60px" />
                                                                    }
                                                                    else
                                                                    { // show item as read-only
                                                                      <span style="font-weight:bold;width:60px" disabled="true">
                                                                          @r.Yrng
                                                                      </span>
                                                                    }
                                                                </div>
                                                            </ChildContent>
                                                        </GridColumn>
                                                        <GridColumn TItem="Gsglne" HeaderText="Eta">
                                                            <ChildContent Context="r">
                                                                <div class="col-1">
                                                                    @if (r.Rowguid == EdColRowguid)
                                                                    { // show draftPln inputs
                                                                      <InputSelect @bind-Value="r.Eta" style="width:auto" disabled="@selDisabled">
                                                                          <option class="ichx" value="0">?etat</option>
                                                                            @foreach (var tob in LsFixes.Where(ut => ut.Gvars == 32 && ut.Itb == 1 && ut.Elea != 0))
                                                                            {
                                                                                <option value="@tob.Elea">@tob.Liba</option>
                                                                            }
                                                                        </InputSelect>
                                                                    }
                                                                    else
                                                                    { // show item as read-only
                                                                      <select @bind="r.Eta" style="width:auto" disabled="true">
                                                                          <option class="ichx" value="0">?etat</option>
                                                                            @foreach (var tob in LsFixes.Where(ut => ut.Gvars == 32 && ut.Itb == 1 && ut.Elea != 0))
                                                                            {
                                                                                <option value="@tob.Elea">@tob.Liba</option>
                                                                            }
                                                                        </select>
                                                                    }
                                                                </div>
                                                            </ChildContent>
                                                        </GridColumn>
                                                        <GridColumn TItem="Gsglne" HeaderText="Actions">
                                                            <ChildContent Context="r">
                                                                            @if (EdColRowguid != r.Rowguid)
                                                                            {
                                                                                <button class="btn btn-warning btn-sm @(!isEdCol && EdColRowguid != r.Rowguid ? "" : "disabled-action")" @onclick="() => EditGcol(r)">Edit</button>
                                                                            }
                                                                            else
                                                                            {
                                                                                <button class="btn btn-warning btn-sm @(EdColRowguid == r.Rowguid ? "" : "disabled-action")" @onclick="() => ConfGcol(r)">Confirm</button>
                                                                                <button class="btn btn-danger btn-sm @(EdColRowguid == r.Rowguid ? "" : "disabled-action")" @onclick="() => CancGcol(r)">Annul</button>
                                                                            }
                                                            </ChildContent>
                                                        </GridColumn>
                                                    </GridColumns>
                                                </Grid>
                                            </GridDetailView>
                                        }
                                        else
                                        {
                                            <label>columns loading...</label>
                                        }
                                    </Grid>
                                    }
                                            </Grid>
                                        </div>
                                    </EditForm>
                                </Content>
                            </Tab>
                        </Tabs>
                    <!-- GLOBAL Save/Cancel - ONE button saves ALL tabs -->
                    <div class="row mt-3">
                        <div class="col-12">
                            @if (_guard.HasPendingChanges())
                            {
                                <div class="alert alert-warning">
                                    <strong>@pendingCount changes pending across all tabs</strong>
                                </div>
                            }
                            <div class="d-flex gap-2 justify-content-end">
                                <Button Color="ButtonColor.Primary"
                                        @onclick="SaveAllAsync"
                                        Enabled="@_guard.HasPendingChanges()">
                                    Save All (@pendingCount changes)
                                </Button>
                                <Button Color="ButtonColor.Secondary"
                                        @onclick="CancelAllChanges">
                                    Cancel All Changes
                                </Button>
                                 <Button Color="ButtonColor.Success"
                                        @onclick="TestSaveBatch">
                                    Test Save Batch
                                 </Button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </Authorized>
</AuthorizeView>
}
<style>
    .my-input::placeholder {
        font-family: 'Courier New', Courrier, monospace;
        font-size: 12px;
        font-weight: normal;
        font-style: italic;
        color:gray;
    }
    .padding-0 {
        padding-right: 0;
        padding-left: 0;
    }

    .table {
        border: 1px yellow;
        font-size: 15px;
        border-collapse: collapse;
        border-spacing: 0;
    }

        .table tr {
            height: 40px;
            padding: 0px;
            margin-top: -5px;
            border-left: 1px solid;
            border-bottom: 1px solid;
        }

        .table thead tr {
            height: 30px;
            font-weight: bold;
            font-style: italic;
        }

    .chkinput {
        vertical-align: middle;
        position: relative;
        bottom: 1px;
    }

    .chklabel {
        display: block;
    }

    .row-cols-7 > * {
        flex: 0 0 auto;
        width: 14.2857142857%; /* 100/7 */
    }

    .row-cols-8 > * {
        flex: 0 0 auto;
        width: 12.25%; /* 100/8 */
    }

    .btnhz {
        display: flex;
        justify-content: center;
    }

    .btsml {
        size: 15px;
        font-size: xx-small;
    }

    .btzi {
        display: inline-block;
    }

    .ermes {
        color: rgb(255, 127, 127);
    }

    .disabled-action {
        pointer-events: none;
        opacity: 0.5;
    }
</style>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }
    private ClaimsPrincipal authUser;
    private bool isAuthenticated = false;
    public MyODataContext _gODContext;

    public Gxorga curOrga = new Gxorga();
    private EditContext edOrgContext;
    private EditContext edFixContext;
    private EditContext edColContext;

    public string Title { get; set; }
    private string tbTitle = "Cible";
    public string _UserId = "";
    public int _UorgId = 0;
    private Userbag _usrBag = new Userbag();
    //initialisat
    private List<Gpfixe> LsFixes = new();
    private List<Gpfixe> LsGties = new();
    private List<Gpfixe> LsDoms = new();
    private List<Gpdivh> LsDivs = new();
    //colonnes

    private List<MyRolTable> _inRoles = new();
    private List<Grole> _invRoles = new();

    //private int curnbAfls => curOrga.Gsgfixes?.Where(x => x.Gvars == 5 && x.Totyp == selTyp).Count() ?? 0;
    //private int curnbCols => curOrga.Gsglnes?.Where(x => x.Otyp == 5 && x.Dtyp == IMyBas && x.Totyp == selTyp && x.Tstyp == 1).Count() ?? 0;

    //private MyAfilCol curGtyp = new();
    //private bool isMainGenerable => curnbAfls == 0 && selTyp != 0;
    private bool selDisabled => allEnable ? false: true;

    private bool isLoading = false, icOpening = false;
    private bool allEnable = false;
    //private bool isOrgEditing = false;
    //private bool isColEditing = false;
    //private bool isAflEditing = false;
    //private bool isDomEditing = false;

    private HttpClient _testclie;
    private int selTyp = 0;
    private int IMyBas = 0;
    private int Rubtto = 1;

    private ProgressBar progressBar;
    private string Imessage = "", Ierror = "";

    //variables AFIL Gfix
    //bool isDelingCbl = false;
    //bool isGenerCbl = false;

    Gsgfix newTfl = new();
    //Gxorga
    //bool isEdingOrg = false;

    //Editing
    bool isEdOrg = false;
    bool isEdDom = false;
    Guid EdDomRowguid = Guid.Empty;
    bool isEdAfl = false;
    Guid EdAflRowguid = Guid.Empty;
    bool isEdCol = false;
    Guid EdColRowguid = Guid.Empty;
    //Generating
    bool isGenAddTfl = false;
    bool isGenDelTfl = false;
    Guid GenerRowguid = Guid.Empty;


    Gsgfix? editingAfl = null;
    bool isEdingAfl = false;
    bool isDelingTfl = false;

    Gsglne? editingCol = null;
    bool isEdingCol = false;
    //GENERATION
    
    
    private MarkupString mesAflGen = new MarkupString(""), mesAflSup = new MarkupString("");

    //row GFIX
    Gsgfix curGfix = new();
    Guid GfixEdRowguid = Guid.Empty;
    //Gsgfix curFixVM = new(); 

    //row GLNE
    Gsglne curGlne = new();
    Guid GlneEdRowguid = Guid.Empty;
    Gsglne curColVM = new();
    List<Gsglne> gsgCols = new();
    //Gsglne newGlne = new();
    //Gsglne? draftGlne = new();
    bool isEdingGlne = false;
    bool adingGlne = false;
    Gsglne? editingGlne = null;
    private bool isGlneFilteringEnabled = false;
    private string savOliba = "", savOabg = "";
    private int? savYrng = 0, savJacc = 0, savJenr = 0, savEta = 0;
    //private string DisabledClass => isDisabled ? "disabled" : "";
    //Guard
    private int pendingCount => _guard.HasPendingChanges() ?
        _gODContext.Context.Entities.Count(e => e.State != EntityStates.Unchanged) : 0;

    private async Task SaveAllAsync()
    {
        await _guard.FlushAsync();
        StateHasChanged();
    }
    private void CancelAllChanges()
    {
        _guard.CancelChanges();
        StateHasChanged();
    }
    protected override async Task OnInitializedAsync()
    {
        //prise valeurs parent
        isLoading = true;
        var authState = await AuthState;
        authUser = authState.User;
        isAuthenticated = authUser.Identity.IsAuthenticated;
        if (!isAuthenticated)
        {
            Console.WriteLine("Authentication in Orga Utilisateur ECHEC");
            _navmanager.RegisterLocationChangingHandler(async args =>
            {
                args.PreventNavigation();
                _navmanager.NavigateTo("/login");
            });
            return;
        }
        else
        {
            Console.WriteLine("Authentication in Orga SUCCESS");
        }
        _usrBag = await _sessionContext.GetUserbagAsync();

        if (_usrBag?.Usorga == null || !_usrBag.Yauser)
        {
            Console.WriteLine($"Echec Invite, recommencez.login/support... {_usrBag?.Usorga?.Idorg} et {_usrBag?.Yauser}");
            return;
        }
        LsDivs = await _rendAgres.LoadOrgaPostes();
        LsFixes = _usrBag.Ufixes.ToList();
        LsGties = _usrBag.Ufixes
            .Where(ut => ut.Gvars == 36 && ut.Itb == 6 && ut.Elea != 0 && ut.Gp1 != 4 && ut.Elea != 9)
            .ToList();
        LsDoms = _usrBag.Ufixes
            .Where(ut => ut.Gvars == 36 && ut.Itb == 4 && ut.Gp1 == 3 && ut.Elea != 0)
            .ToList();
        _invRoles = await _rendAgres.LoadOrgaRoles();
        Console.WriteLine($"Roles disponibles : {_invRoles.Count}");
        //load WebApi entities
        // try
        // {
        //     _gODContext = await _contextFactory.CreateAsync(); // Use factory
        //     _guard.AttachContext(_gODContext);

        //     var expand = "Gsgfixes,Gsglnes";
        //     var dxorgas = await _gODContext.LoadFilteredAsync<Gxorga>(expand: expand);
        //     curOrga = dxorgas.FirstOrDefault();
        //     if (curOrga != null) 
        //     {
        //         Console.WriteLine("curOrga charge");
        //         edOrgContext = new EditContext(curOrga);
        //         edOrgContext.OnFieldChanged += HandleFieldChanged;
        //         //gsgCols = curOrga.Gsglnes.ToList();
        //         Console.WriteLine($"nb gfixes : {curOrga.Gsgfixes.Count}");
        //     } else
        //     {
        //         Console.WriteLine("INSTITUTION NON TROUVEE");
        //     }
        // }
        // catch (Exception ex)
        // {
        //     //strmeta = _entityManager.strmeta;
        //     Console.WriteLine($"1Probleme EntityManagment : {ex.Message}");
        // }
        // isLoading = false;

        // // int key = _usrBag.Idorg;/* the Idorg you want */

        // // try
        // // {
        // //     _gODContext = await _contextFactory.CreateAsync();
        // //     _guard.AttachContext(_gODContext);

        // //     string expand = "Gsgfixes,Gsglnes";

        // //     // Load just the entity by key
        // //     curOrga = await _gODContext.LoadFilteredAsync<Gxorga>(
        // //         filter: g => g.Idorg == key,  // ✅ lambda expression
        // //         expand: expand
        // //     ).ContinueWith(t => t.Result.FirstOrDefault());

        // //     if (curOrga != null)
        // //     {
        // //         Console.WriteLine("curOrga loaded");
        // //         edOrgContext = new EditContext(curOrga);
        // //         edOrgContext.OnFieldChanged += HandleFieldChanged;
        // //         Console.WriteLine($"nb gfixes : {curOrga.Gsgfixes.Count}");
        // //     }
        // //     else
        // //     {
        // //         Console.WriteLine("INSTITUTION NON TROUVEE");
        // //     }
        // // }
        // // catch (Exception ex)
        // // {
        // //     Console.WriteLine($"Problem EntityManagement: {ex.Message}");
        // // }

        try
        {
            _gODContext = await _contextFactory.CreateAsync();
            _guard.AttachContext(_gODContext);
            int key = _usrBag.Idorg;
            // ✅ Use key-based query instead of filtered collection
            curOrga = await _gODContext.GetByKeyAsync<Gxorga>(key, "Gxorgas", "Gsgfixes,Gsglnes");
            if (curOrga != null)
            {
                Console.WriteLine("curOrga loaded by key");

                // ✅ FIX: Handle DataServiceCollection properly
                if (curOrga.Gsgfixes is DataServiceCollection<Gsgfix> gsgfixesCollection)
                {
                    Console.WriteLine($"Gsgfixes collection count: {gsgfixesCollection.Count}");
                    // DataServiceCollection is already populated - don't replace it
                }
                else if (curOrga.Gsgfixes == null || !curOrga.Gsgfixes.Any())
                {
                    Console.WriteLine("Gsgfixes empty - initializing List");
                    curOrga.Gsgfixes = new();
                }

                if (curOrga.Gsglnes is DataServiceCollection<Gsglne> gsglnesCollection)
                {
                    Console.WriteLine($"Gsglnes collection count: {gsglnesCollection.Count}");
                }
                else if (curOrga.Gsglnes == null || !curOrga.Gsglnes.Any())
                {
                    curOrga.Gsglnes = new();
                }

                edOrgContext = new EditContext(curOrga);

                // ✅ Use first item or create dummy for EditContext
                var firstFix = curOrga.Gsgfixes?.FirstOrDefault();
                edFixContext = new EditContext(firstFix ?? new Gsgfix() { Idorg = key });

                var firstCol = curOrga.Gsglnes?.FirstOrDefault();
                edColContext = new EditContext(firstCol ?? new Gsglne() { Idorg = key });

                Console.WriteLine($"FINAL nb gfixes : {curOrga.Gsgfixes?.Count ?? 0}");

                var gsgfix = new Gsgfix();  // Your entity
                Console.WriteLine(gsgfix.GetType().GetProperties()
                    .Where(p => p.PropertyType == typeof(Gxorga))
                    .Select(p => p.Name)
                    .FirstOrDefault() ?? "NO NAVIGATION PROPERTY!");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Problem EntityManagement: {ex.Message}");
        }
    }

    void OnGfixRowClick(GridRowEventArgs<Gsgfix> args)
    {
        icOpening = true;
        Console.WriteLine($"OnGfixRowClick: {args.Item.Xseq}");
        curGfix = args.Item;
        if (curGfix?.Xseq == 0) return;
        //int typc = curGfix.Etyp ?? 0; // == 7 ? 2 : 1;  // g
        //Console.WriteLine($"totyp : {curGfix.Totyp} et tostyp : {curGfix.Etyp}");
        gsgCols = curOrga.Gsglnes.Where(ug => ug.Otyp == 5 && ug.Totyp == selTyp && ug.Tstyp == curGfix.Etyp).ToList();
        // curGfix.colsxVM = LsFixes
        //     .Where(fx => fx.Gvars == 65 && fx.Itb == typc)
        //     .OrderBy(cl => cl.Elea)
        //     .Select(uncol => CreateDraftCol(uncol))
        //     .ToList();
        icOpening = false;
        StateHasChanged();
    }
    // private Gsglne CreateDraftCol(dynamic uncol)  // Or type LsFixes item type
    // {
    //     //dynamic = consfix
    //     int yaTb = uncol.Gp1 != 0 ? 1 : 0;
    //     int ystyp = uncol.Elea; //remplace Elea
    //     var brouCol = new Gsglne();
    //     // //{
    //     //     Idorg = curOrga.Idorg,
    //     //     Pseq = uncol.Fxseq,
    //     //     Pele = uncol.Elea,
    //     //     Otyp = 5,
    //     //     Dtyp = 5,
    //     //     Totyp = selTyp,
    //     //     Tstyp = uncol.Elea,
    //     //     Eaut = 0,
    //     //     Scdrub = uncol.Scdrub,
    //     //     Elea = uncol.Elea,
    //     //     Liba = uncol.Liba,
    //     //     Abg = uncol.Abg,
    //     //     Ztyp = uncol.Gp2,
    //     //     Sitb = yaTb,
    //     //     Ztbl = uncol.Gp1,
    //     //     Zdpd = uncol.Gp4,
    //     //     Ktyp = uncol.Gp7,
    //     //     Inx1 = 1,
    //     //     Inx2 = 1
    //     // //};
    //     var lscols = curOrga.Gsglnes.Where(uc => uc.Otyp == 5 && uc.Pseq == uncol.Fxseq && uc.Totyp == selTyp && uc.Tstyp == ystyp).ToList();
    //     // Console.WriteLine($"current type : {selTyp}");
    //     if (lscols.Any())
    //     {
    //         var existcol = lscols.FirstOrDefault();
    //         brouCol.Idorg = curOrga.Idorg;
    //         brouCol.Pseq = uncol.Fxseq;
    //         brouCol.Pele = uncol.Elea;
    //         brouCol.Otyp = 5;
    //         brouCol.Dtyp = 5;
    //         brouCol.Totyp = selTyp;
    //         brouCol.Tstyp = uncol.Elea;
    //         brouCol.Eaut = 0;
    //         brouCol.Scdrub = uncol.Scdrub;
    //         brouCol.Elea = ystyp;
    //         //brouCol.Etyp = ystyp;
    //         brouCol.Liba = uncol.Liba;
    //         brouCol.Abg = uncol.Abg;
    //         brouCol.Ztyp = uncol.Gp2;
    //         brouCol.Sitb = yaTb;
    //         brouCol.Ztbl = uncol.Gp1;
    //         brouCol.Zdpd = uncol.Gp4;
    //         brouCol.Ktyp = uncol.Gp7;
    //         brouCol.Inx1 = 1;
    //         brouCol.Inx2 = 1;
    //         brouCol.Oliba = existcol.Oliba;
    //         brouCol.Oabg = existcol.Oabg;
    //         brouCol.Yrng = existcol.Yrng;
    //         brouCol.Jacc = existcol.Jacc;
    //         brouCol.Jenr = existcol.Jenr;
    //         brouCol.Eta = existcol.Eta;
    //         return brouCol;
    //     }
    //     // else
    //     // {
    //     //     brouCol.Oliba = uncol.Liba;
    //     //     brouCol.Oabg = uncol.Abg;
    //     //     brouCol.Yrng = uncol.Gp3;
    //     //     brouCol.Jacc = 0;
    //     //     brouCol.Jenr = 0;
    //     //     brouCol.Eta = 1;
    //     // }
    //     return null;
    //     // --iorig -> 2 vient de gxorga/consfix
    //     // --itb -> 12/13
    //     // --totyp -> pour les types tiers ou xuits
    //     // --pseq --> refer. element parent(niv.clef)
    //     // --pele -> refer. element parent(niv.nbre
    //     // --jacc -> 1si present dans accueil/inscr
    //     // --jenr -> 1si present dans enrolement
    //     // --eaut -> 0 supprimable
    //     // --scdrub -> scdrub
    //     // --rno -> 1..n refer. element interne
    //     // --yrng(gp3/ydpd) -> rang colonne 1..n
    //     // --ztyp(gp2/ztyp) -> type colonne 1 string, 2 number...
    //     // --sitb(test?/zgpe) -> si table apres test
    //     // --ztbl(gp1/zfro) --> refer. table
    //     // --zdpd(gp4/xdpd) -> refer. table liee (pays/region/ville...)
    //     // --ktyp(gp7/ktyp) -> integre
    //     // --vtyp(tgx/mtyp) -> visibilite
    //     // --inx1 -> enrolement
    //     // --inx2 -> validation
    //     // --scdrub --> refer.
    // }
    void SelDomGtie(Gpfixe myfix)
    {
        //IMyBas
        if (myfix.Elea == 0)
        {
            IMyBas = 0;
            return;
        }
        if (myfix.Elea <= 6)
        {
            IMyBas = 6;
        } else
        {
            IMyBas = 7;
        }
    }
    //EDITING Gsgfix (dom)
    void EditGdom(Gsgfix myafil)
    {
        myafil.Xedt1 = -1; //editing
        curGfix = myafil;
        if (myafil.Gvars == 21 && (myafil.Itb == 1 || myafil.Itb == 2 || myafil.Itb == 3))
        { //lim
            RefilGdom(myafil);
        } else if (myafil.Gvars == 3 && myafil.Itb == 5)
        { //afil
            RefilGafl(myafil);
        } else if (myafil.Gvars == 3 && myafil.Itb == 4)
        { //relat tiers
            RefilGrel(myafil);
        } else {
            return;
        }
        curGfix.Xedt1 = -1; //editing
        isEdingAfl = true;
        
        isEdDom = true;
        EdDomRowguid = myafil.Rowguid;

        GfixEdRowguid = myafil.Rowguid;
    }
    void CancGdom(Gsgfix mytfl)
    {
        EmptyGfix();

        GfixEdRowguid = Guid.Empty;
        
        isEdDom = false;
        EdDomRowguid = Guid.Empty;
        
        mytfl.Xedt1 = 0;
        isEdingAfl = false;
        editingAfl = null;
        curGfix = new();

    }
    private async Task ConfGdom(Gsgfix myfix)
    {
        if (myfix.Xseq != 0)
        {
            try
            {
                _gODContext.Context.AttachTo("Gsgfixes", myfix);
            }
            catch (InvalidOperationException)
            {
                // Already tracked, safe to ignore
            }
            _gODContext.Context.UpdateObject(myfix);
            GfixEdRowguid = Guid.Empty;
            
            isEdDom = false;
            EdDomRowguid = Guid.Empty;
            
            myfix.Xedt1 = 0;
            isEdingAfl = false;
            editingAfl = null;
            isEdingAfl = false;
            Console.WriteLine("Gsgfix marked as Modified");
        }
    }
    //EDITING Gsgfix (afl)
    void EditGafl(Gsgfix myafil)
    {
            myafil.Xedt1 = -1; //editing
            curGfix = myafil;
            if (myafil.Gvars == 21 && (myafil.Itb == 1 || myafil.Itb == 2 || myafil.Itb == 3))
            { //lim
                RefilGdom(myafil);
            }
            else if (myafil.Gvars == 3 && myafil.Itb == 5)
            { //afil
                RefilGafl(myafil);
            }
            else
            {
                return;
            }
            curGfix.Xedt1 = -1; //editing
            isEdingAfl = true;

            isEdAfl = true;
            EdAflRowguid = myafil.Rowguid;

            GfixEdRowguid = myafil.Rowguid;
    }
    void CancGafl(Gsgfix mytfl)
    {
        EmptyGfix();

        GfixEdRowguid = Guid.Empty;

        isEdAfl = false;
        EdAflRowguid = Guid.Empty;

        mytfl.Xedt1 = 0;
        isEdingAfl = false;
        editingAfl = null;
        curGfix = new();

    }
    private async Task ConfGafl(Gsgfix myfix)
    {
        if (myfix.Xseq != 0)
        {
            try
            {
                _gODContext.Context.AttachTo("Gsgfixes", myfix);
            }
            catch (InvalidOperationException)
            {
                // Already tracked, safe to ignore
            }
            _gODContext.Context.UpdateObject(myfix);
            GfixEdRowguid = Guid.Empty;

            isEdAfl = false;
            EdAflRowguid = Guid.Empty;

            myfix.Xedt1 = 0;
            isEdingAfl = false;
            editingAfl = null;
            isEdingAfl = false;
            Console.WriteLine("Gsgfix marked as Modified");
        }
    }
    void EditGcol(Gsglne mycol)
    {
        mycol.Xedt1 = 0;
        editingCol = mycol;
        savOliba = mycol.Oliba;
        savOabg = mycol.Oabg;
        savYrng = mycol.Yrng;
        savJacc = mycol.Jacc;
        savJenr = mycol.Jenr;
        savEta = mycol.Eta;
        // draftTfl = new Gsgfix
        // {
        //     Liba = myafil.Liba,
        //     Sliba = myafil.Sliba,
        //     Abg = myafil.Abg,
        //     Ityp = myafil.Ityp,
        //     Jtyp = myafil.Jtyp,
        //     Mtyp = myafil.Mtyp,
        //     Ntyp = myafil.Ntyp,
        //     Eta = myafil.Eta,
        // };
        // //init edition
        // draftTfl.Xedt1 = -1;
        mycol.Xedt1 = -1;
        isEdCol = true;
        EdColRowguid = mycol.Rowguid;

        
        isEdingCol = true;
        GlneEdRowguid = mycol.Rowguid;
    }
    void CancGcol(Gsglne mycol)
    {
        mycol.Xedt1 = 0;

        isEdCol = false;
        EdColRowguid = Guid.Empty;

        isEdingCol = false;
        editingCol = null;
        //draftTfl = null;
        GlneEdRowguid = Guid.Empty;
    }
    void ConfGcol(Gsglne mycol)
    {
        if (isEdingCol)
        {

            Console.WriteLine("ICI1");
            // var existcol = curOrga.Gsglnes.FirstOrDefault(ec => ec.Id == mycol.Id);
            // bool enAdding = false,
            bool yaeuModif = false;
            // if (existcol != null)
            // {
            Console.WriteLine("ICI2");
            //enAdding = true;
            //existcol = new();
            //existcol.Idorg = mycol.Idorg; yaeuModif = false;
            if (string.Compare(savOliba, mycol.Oliba) != 0)
            {
                //existcol.Oliba = mycol.Oliba;
                yaeuModif = true;
            }
            if (string.Compare(savOabg, mycol.Oabg) != 0)
            {
                //existcol.Oabg = mycol.Oabg;
                yaeuModif = true;
            }
            if (savYrng != mycol.Yrng)
            {
                //existcol.Yrng = mycol.Yrng; //rang colonne
                yaeuModif = true;
            }
            if (savJacc != mycol.Jacc)
            {
                //existcol.Jacc = mycol.Jacc; //rang colonne
                yaeuModif = true;
            }
            if (savJenr != mycol.Jenr)
            {
                //existcol.Jenr = mycol.Jenr; //rang colonne
                yaeuModif = true;
            }
            if (savEta != mycol.Eta)
            {
                //existcol.Eta = mycol.Eta; //rang colonne
                yaeuModif = true;
            }
            if (!yaeuModif)
            {
                return;
            }
            if (yaeuModif)
            {
                if (!_gODContext.GetAllTrackedEntities().Any(e => e.Entity == mycol))
                {
                    _gODContext.AttachTo("Gsglnes", mycol);
                }
                _gODContext.UpdateObject(mycol);
            }
        }
        mycol.Xedt1 = 0;

        isEdCol = false;
        EdColRowguid = Guid.Empty;

        isEdingCol = false;
        GlneEdRowguid = Guid.Empty;
        editingCol = null;
        //Console.WriteLine("A ETE MODIFIE");
    }

    static void CopyScalarProperties<T>(T source, T target)
    {
        var props = typeof(T).GetProperties()
            .Where(p => p.CanRead && p.CanWrite && 
                        !p.PropertyType.IsClass || p.PropertyType == typeof(string));

        foreach (var p in props)
            p.SetValue(target, p.GetValue(source));
    }

    void EmptyGfix()
    {
        curGfix = new();
    }
    void RefilGdom(Gsgfix myfix) //dom
    {
        curGfix = new Gsgfix
        {
            Liba = myfix.Liba,
            Sliba = myfix.Sliba,
            Abg = myfix.Abg,
            Ityp = myfix.Ityp,
            Jtyp = myfix.Jtyp,
            Mtyp = myfix.Mtyp,
            Ntyp = myfix.Ntyp,
            Eta = myfix.Eta,
        };
    }
    void RefilGafl(Gsgfix myfix) //afil
    {
        curGfix = new Gsgfix
        {
            Liba = myfix.Liba,
            Sliba = myfix.Sliba,
            Abg = myfix.Abg,
            Ityp = myfix.Ityp,
            Jtyp = myfix.Jtyp,
            Mtyp = myfix.Mtyp,
            Ntyp = myfix.Ntyp,
            Eta = myfix.Eta,
        };
    }
    void RefilGrel(Gsgfix myfix) //relat tiers
    {
        curGfix = new Gsgfix
        {
            Liba = myfix.Liba,
            Sliba = myfix.Sliba,
            Abg = myfix.Abg,
            Ityp = myfix.Ityp,
            Jtyp = myfix.Jtyp,
            Mtyp = myfix.Mtyp,
            Ntyp = myfix.Ntyp,
            Eta = myfix.Eta,
        };
    }
    //EDITING Gsglne (colonne)
    void EditGlne(Gsglne myclne)
    {
        myclne.Xedt1 = -1; //editing
        curGlne = myclne;
        RefilGlne(myclne);
        curColVM.Xedt1 = -1; //editing
        isEdingCol = true;
        GlneEdRowguid = myclne.Rowguid;
    }
    void CancGlne(Gsglne myclne)
    {
        EmptyGlne();

        GlneEdRowguid = Guid.Empty;

        myclne.Xedt1 = 0;
        isEdingCol = false;
        editingCol = null;
        curColVM = new();

    }
    // implicit relationship
    // void ConfGlne(Gsglne edited)
    // {
    //     if (edited == null)
    //         return;

    //     // 1️⃣ Find tracked instance by KEY
    //     var tracked = _gODContext
    //         .GetAllTrackedEntities()
    //         .Select(e => e.Entity)
    //         .OfType<Gsglne>()
    //         .FirstOrDefault(e => e.Idglne == edited.Idglne);

    //     // 2️⃣ Decide ADD vs UPDATE
    //     if (edited.Idglne == 0) // NEW
    //     {
    //         // FK-only: ensure FK is set
    //         edited.Idgfix = curGfix.Idgfix;

    //         _gODContext.Context.AddObject("Gsglnes", edited);
    //         tracked = edited;
    //     }
    //     else // EXISTING
    //     {
    //         if (tracked != null)
    //         {
    //             CopyScalarProperties(edited, tracked);
    //         }
    //         else
    //         {
    //             _gODContext.AttachTo("Gsglnes", edited);
    //             tracked = edited;
    //         }

    //         _gODContext.UpdateObject(tracked);
    //     }

    //     _guard.MarkDirty();
    //     GlneEdRowguid = Guid.Empty;
    // }
    //explicit navigation property
    // void ConfGlne(Gsglne edited)
    // {
    //     if (edited == null)
    //         return;

    //     // 1️⃣ Find tracked instance by KEY
    //     var tracked = _gODContext
    //         .GetAllTrackedEntities()
    //         .Select(e => e.Entity)
    //         .OfType<Gsglne>()
    //         .FirstOrDefault(e => e.Id == edited.Id);

    //     // 2️⃣ Decide ADD vs UPDATE
    //     if (edited.Id == 0) // NEW entity
    //     {
    //         // Ensure parent navigation is set
    //         edited.IdorgNavigation = curOrga;   // or edited.Gxorga = curOrga

    //         _gODContext.Context.AddObject("Gsglnes", edited);
    //         tracked = edited;
    //     }
    //     else // EXISTING entity
    //     {
    //         if (tracked != null)
    //         {
    //             CopyScalarProperties(edited, tracked);
    //         }
    //         else
    //         {
    //             _gODContext.AttachTo("Gsglnes", edited);
    //             tracked = edited;
    //         }

    //         _gODContext.UpdateObject(tracked);
    //     }

    //     _guard.MarkDirty();
    //     GlneEdRowguid = Guid.Empty;
    //     edited.Xedt1 = 0;
    //     isEdingCol = false;
    //     editingCol = null;
    // }
    void AddGlneWithNav(Gsglne newGlne)
    {
        if (!_gODContext.Context.Entities.Any(e => e.Entity == curGfix))
        {
            _gODContext.AttachTo("Gsgfixes", curGfix);
        }

        _gODContext.Context.AddRelatedObject(
            curOrga,
            "Gsglnes",
            newGlne
        );

        //_guard.MarkDirty();
    }

    void EmptyGlne()
    {
        curColVM = new();
    }
    void RefilGlne(Gsglne myclne)
    {
        curColVM = new Gsglne
            {
                Liba = myclne.Liba,
                Oliba = myclne.Oliba,
                Abg = myclne.Abg,
            //Ityp = myclne.Ityp,
                Jtyp = myclne.Jtyp,
            //Mtyp = myclne.Mtyp,
            //Ntyp = myclne.Ntyp,
                Eta = myclne.Eta,
            };
    }
    // void CancEdingOrg()
    // {

    // }
    //EDITING Gsglne

    
    // //DELETING
    // private void PromptTflDelete(Gsgfix myafil)
    // {
    //     if (myafil.Etyp == 1)
    //     {
    //         mesAflSup = "AVERTISSEMENT!... Supprimer les colonnes de la cible est dangereux";
    //         mesAflSup = mesAflSup + " ENROLER cette cible ou l-INTEGRER ne sera plus possible.";
    //     }
    //     else
    //     {
    //         mesAflSup = "AVERTISSEMENT!... Supprimer les colonnes d-un affilie";
    //         mesAflSup = mesAflSup + " ENROLER cet affilie ou l-INTEGRER ne sera plus possible.";
    //         mesAflSup = mesAflSup + "Il est Supprimer les colonnes des affilies inutiles";
    //     }
    //     myafil.Xdel1 = -1;
    //     isDelingTfl = true;
    //     //ConfirmingCblDeleteRowGuid = item.Rowguid;
    // }
    // private void CancelTflDelete(Gsgfix myafil)
    // {
    //     myafil.Xdel1 = 0;
    //     mesAflSup = "";
    //     isDelingTfl = false;
    //     //ConfirmingCblDeleteRowGuid = Guid.Empty;
    // }


    // //GENERATION

    // private void PromptDeleteGener(Gsgfix myafil)
    // {
    //     myafil.Xgen1 = 0;
    //     mesAflGen = "";
    //     isGenerTfl = false;
    // }
    // private async Task ConfirmAllGener(Gsgfix myafil)
    // {
    //     if (myafil == null || myafil.Etyp == 0)
    //     {
    //         mesAflGen = "type affilie absent";
    //         return;
    //     }
    //     Imessage = "Generation de colonnes cible...patience...";
    //     ReqgnModel reqModel = new ReqgnModel();
    //     reqModel.Idorg = curOrga.Idorg;
    //     reqModel.Orig = 1; //vient de 1consfix2gsgfix-atr/colonne
    //     reqModel.Pdomtie = IMyBas; //6tiers7produits
    //     reqModel.Ptyptie = selTyp; //1cible2operat3client4fournis5patern
    //     int xorig = Convert.ToInt16(myafil.Etyp); 
    //     if (xorig == 1)
    //     { //cible

    //         reqModel.Psupafl = 1; //-1tout afils, autre filiation no x (si parent cree)
    //         var cblcall = await _cliemanager.SendRequestAsync("AUTHClient", HttpMethod.Post, "lgauth/creacols", reqModel);
    //         var cblresp = JsonConvert.DeserializeObject<ResgnModel>(cblcall);
    //         if (cblresp != null)
    //         {

    //         }
    //         isGenerTfl = false;
    //     }
    //     else //autres afiliation
    //     { //afilie
    //         Imessage = "Generation de colonnes affiliation...patience...";
    //         reqModel.Psupafl = myafil.Elea; //si creer/>2autre filiation no x (si parent cree)
    //         var aflcall = await _cliemanager.SendRequestAsync("AUTHClient", HttpMethod.Post, "lgauth/creacols", reqModel);
    //         var aflresp = JsonConvert.DeserializeObject<ResgnModel>(aflcall);
    //         if (aflresp != null)
    //         {

    //         }
    //         isGenerTfl = false;
    //     }
    //     myafil.Xgen1 = 0;
    //     mesAflGen = "";
    //     NavigateBack();
    // }
    // void CancGcol(Gsglne mycol)
    // {
    //     mycol.Xedt1 = 0;
    //     isEdingCol = false;
    //     editingCol = null;
    //     //draftTfl = null;
    //     GlneEdRowguid = Guid.Empty;
    // }
    // void ConfGcol(Gsglne mycol)
    // {
    //     if (isEdingCol)
    //     {

    //         Console.WriteLine("ICI1");
    //         // var existcol = curOrga.Gsglnes.FirstOrDefault(ec => ec.Id == mycol.Id);
    //         // bool enAdding = false,
    //         bool yaeuModif = false;
    //         // if (existcol != null)
    //         // {
    //         Console.WriteLine("ICI2");
    //         //enAdding = true;
    //         //existcol = new();
    //         //existcol.Idorg = mycol.Idorg; yaeuModif = false;
    //         if (string.Compare(savOliba, mycol.Oliba) != 0)
    //         {
    //             //existcol.Oliba = mycol.Oliba;
    //             yaeuModif = true;
    //         }
    //         if (string.Compare(savOabg, mycol.Oabg) != 0)
    //         {
    //             //existcol.Oabg = mycol.Oabg;
    //             yaeuModif = true;
    //         }
    //         if (savYrng != mycol.Yrng)
    //         {
    //             //existcol.Yrng = mycol.Yrng; //rang colonne
    //             yaeuModif = true;
    //         }
    //         if (savJacc != mycol.Jacc)
    //         {
    //             //existcol.Jacc = mycol.Jacc; //rang colonne
    //             yaeuModif = true;
    //         }
    //         if (savJenr != mycol.Jenr)
    //         {
    //             //existcol.Jenr = mycol.Jenr; //rang colonne
    //             yaeuModif = true;
    //         }
    //         if (savEta != mycol.Eta)
    //         {
    //             //existcol.Eta = mycol.Eta; //rang colonne
    //             yaeuModif = true;
    //         }
    //         if (!yaeuModif)
    //         {
    //             return;
    //         }
    //         if (yaeuModif)
    //         {
    //             if (!_gODContext.GetAllTrackedEntities().Any(e => e.Entity == mycol))
    //             {
    //                 _gODContext.AttachTo("Gsglnes", mycol);
    //             }
    //             _gODContext.UpdateObject(mycol);
    //         }
    //     }
    //     mycol.Xedt1 = 0;
    //     isEdingCol = false;
    //     GlneEdRowguid = Guid.Empty;
    //     editingCol = null;
    //     //Console.WriteLine("A ETE MODIFIE");
    // }
    // GENERATION
    private async Task PromptAddOneGener(Gsgfix myacol)
    {
        if (myacol.Etyp == 1)
        {
            mesAflGen = (MarkupString)(
                "AVERTISSEMENT!... Ne generer les colonnes pour une cible que<br>" +
                "si vous en avez besoin. L'opération AUGMENTE la charge de traitement"
            );
        }
        else
        {
            mesAflGen = (MarkupString)(
                "AVERTISSEMENT!... Generer les colonnes d'un affilié vous permet de le gérer<br>" +
                "mais cela AUGMENTE le volume de votre base de données</p>"
            );
        }
        myacol.Xgen1 = 0;
        GenerRowguid = myacol.Rowguid;
        isGenAddTfl = true;
    }
    private async Task ConfOneGener(Gsgfix myacol)
    {
        if (myacol == null || myacol.Etyp == 0)
        {
            mesAflGen = new MarkupString("type affilie absent");
            return;
        }
        Imessage = $"Generation de colonnes pour {myacol.Liba}...patience...";
        ReqgnModel reqModel = new ReqgnModel();
        reqModel.Idorg = curOrga.Idorg;
        reqModel.Orig = 2; //vient de user ajout
        reqModel.Pdomtie = IMyBas; //6tiers7produits
        reqModel.Ptyptie = selTyp; //1cible2operat3client4fournis5patern
        reqModel.Psupafl = myacol.Elea; //1cible2cnj3par4enf5pai6flh
        await _cliemanager.SetAuthorizationHeaderAsync("AUTHClient");
        var cblcall = await _cliemanager.SendRequestAsync("AUTHClient", HttpMethod.Post, "usercontext/creaflcols", reqModel);
        var cblresp = JsonConvert.DeserializeObject<ResgnModel>(cblcall);
        if (cblresp != null)
        {

        }
        myacol.Xgen1 = 0;
        GenerRowguid = Guid.Empty;
        isGenAddTfl = false;
        mesAflGen = new MarkupString("");
        //NavigateBack();
    }
    private async Task CncOneGener(Gsgfix myacol)
    {
        myacol.Xgen1 = 0;
        mesAflGen = new MarkupString("");
        GenerRowguid = Guid.Empty;
        isGenAddTfl = false;
    }
    //DELETION
    private async Task PromptDelOneGener(Gsgfix myacol)
    {
        if (myacol.Etyp == 1)
        {
            mesAflSup = (MarkupString)(
                "AVERTISSEMENT!... Supprimer les colonnes pour une cible supprime toutes<br>" +
                "les colonnes des afiliés liés. Vous n-allez plus pouvoir les gérer"
            );
        }
        else
        {
            mesAflSup = (MarkupString)(
                "AVERTISSEMENT!... Si vous Supprimez les colonnes d-un afilié<br>" +
                "ne pourrez plus le gérer</p>"
            );
        }
        myacol.Xgen1 = 0;
        mesAflGen = new MarkupString("");
        GenerRowguid = myacol.Rowguid;
        isGenDelTfl = true;
    }
    private async Task ConfDelOneGener(Gsgfix myacol)
    {
        ReqgnModel reqModel = new ReqgnModel();
        reqModel.Idorg = curOrga.Idorg;
        reqModel.Orig = 2; //vient de user ajout
        reqModel.Pdomtie = IMyBas; //6tiers7produits
        reqModel.Ptyptie = selTyp; //1cible2operat3client4fournis5patern
        reqModel.Psupafl = myacol.Elea; //1cible2cnj3par4enf5pai6flh
        await _cliemanager.SetAuthorizationHeaderAsync("AUTHClient");
        var cblcall = await _cliemanager.SendRequestAsync("AUTHClient", HttpMethod.Post, "usercontext/supaflcols", reqModel);
        var cblresp = JsonConvert.DeserializeObject<ResgnModel>(cblcall);
        if (cblresp != null)
        {

        }
        myacol.Xgen1 = 0;
        mesAflGen = new MarkupString("");
        GenerRowguid = Guid.Empty;
        isGenDelTfl = false;
    }
    private async Task CncDelOneGener(Gsgfix myacol)
    {
        myacol.Xgen1 = 0;
        mesAflGen = new MarkupString("");
        GenerRowguid = Guid.Empty;
        isGenDelTfl = false;
    }
    //manage SAVING
    private async Task EdtAll()
    {
        allEnable = true;
    }
    //Gxorga (Gxorga)
    public async Task EdtEOrg()
    {
        isEdOrg = true;
    }
    public async Task CancEOrg()
    {
        isEdOrg = false;
    }
    private async Task ConfEOrg()
    {
        if (curOrga.Idorg != 0)
        {
            try
            {
                _gODContext.Context.AttachTo("Gxorgas", curOrga);
            }
            catch (InvalidOperationException)
            {
                // Already tracked, safe to ignore
            }

            _gODContext.Context.UpdateObject(curOrga);
            Console.WriteLine("Gxorga marked as Modified");
        }
        isEdOrg = false;
    }
    //Gsgfix (Doc and Afl)
    
    private async Task ConfEAfl(Gsgfix myfix)
    {
        if (myfix.Xseq != 0)
        {
            try
            {
                _gODContext.Context.AttachTo("Gsgfixes", myfix);
            }
            catch (InvalidOperationException)
            {
                // Already tracked, safe to ignore
            }
            _gODContext.Context.UpdateObject(myfix);
            GfixEdRowguid = Guid.Empty;
            myfix.Xedt1 = 0;
            isEdingAfl = false;
            editingAfl = null;
            Console.WriteLine("Gsgfix marked as Modified");
        }
    }
    public async Task ConfECol(Gsglne mycol)
    {
        if (mycol.Id != 0)
        {
            try
            {
                _gODContext.Context.AttachTo("Gsglnes", mycol);
            }
            catch (InvalidOperationException)
            {
                // Already tracked, safe to ignore
            }

            _gODContext.Context.UpdateObject(mycol);
            GlneEdRowguid = Guid.Empty;
            mycol.Xedt1 = 0;
            isEdingCol = false;
            editingCol = null;
            isEdingCol = false;
            Console.WriteLine("Gsglne marked as Modified");
        }      
    }

    
    public async Task SavAllAsync()
    {
        await _guard.FlushAsync();
        NavigateBack();
    }
    public async ValueTask DisposeAsync()
    {
        await _guard.DisposeAsync();
    }

    // public async Task SavAll()
    // {
    //     bool hasChanges = _gODContext.Context.Entities.Any(e =>
    //         e.State == EntityStates.Added ||
    //         e.State == EntityStates.Modified ||
    //         e.State == EntityStates.Deleted);
    //     if (!hasChanges)
    //         return;
    //     await _gODContext.Context.SaveChangesAsync();
    //     allEnable = false;
    // }
    private void ToggleGlneFiltering()
    {
        isGlneFilteringEnabled = !isGlneFilteringEnabled;
    }
    private void DoTabTitle(int noT, string stTitle)
    {
        if (noT == 0) tbTitle = "Cible";
        if (noT > 0) tbTitle = stTitle;
    }
    private void OnCheckboxChanged(Microsoft.AspNetCore.Components.ChangeEventArgs e, Gsglne scol, string propertyName)
    {
        // Example: toggle the property based on the checkbox value
        bool isChecked = e.Value is bool value && value;
        switch (propertyName)
        {
            case nameof(scol.Jacc):
                scol.Jacc = isChecked ? 1 : 0;
                break;
            case nameof(scol.Jenr):
                scol.Jenr = isChecked ? 1 : 0;
                break;
                // Add cases for other properties as needed
        }
        //_guard.MarkDirty();
        // Optionally, trigger any additional logic or state updates here
    }
    private void HandleFieldOrgChanged(object sender, FieldChangedEventArgs e)
    {
        //to display Confirm/Cancel
        //if (e.FieldIdentifier.Model is Gxorga) isEdingOrg = true;
        if (e.FieldIdentifier.Model is Gxorga)
        {
            //isEdingOrg = true;
            //_guard.MarkDirty();
        }
        //if (e.FieldIdentifier.Model is Gsglne) isColEditing = true;
        //if (e.FieldIdentifier.Model is Gsgfix afl)
        //{
        //    //1st entry
        //    if (afl.Gvars == 21 || afl.Gvars == 3 && afl.Itb == 4)
        //    {
        //        isDomEditing = true;
        //    }
        //    if (afl.Gvars == 3 && afl.Itb == 5)
        //    {
        //        isAflEditing = true;
        //    }
        //    Console.WriteLine($"Afl Value: {afl.Gvars}");
        //}
        Console.WriteLine($"Field edited: {e.FieldIdentifier.FieldName}");
    }
    private void HandleFieldFixChanged(object sender, FieldChangedEventArgs e)
    {
        //to display Confirm/Cancel
        if (e.FieldIdentifier.Model is Gsgfix) isEdingAfl = true;
        if (e.FieldIdentifier.Model is Gsgfix)
        {
            isEdingAfl = true;
            //_guard.MarkDirty();
        }
    }
    private void HandleFieldColChanged(object sender, FieldChangedEventArgs e)
    {
        //to display Confirm/Cancel
        if (e.FieldIdentifier.Model is Gsglne) isEdingCol = true;
        if (e.FieldIdentifier.Model is Gsglne)
        {
            isEdingCol = true;
            //_guard.MarkDirty();
        }
    }
    private async Task TestSaveBatch()
    {
        try
        {
            var _testclie = _httpClientFactory.CreateClient("ODaTestClient");
            // Parallel PUT/PATCH calls - no OData Client needed
            //var gsf = curGsglne;
            // gsf.Xseq = 834;
            // gsf.Liba = "Updated Liba1";
            // gsf.Abg = "UpdRefa1";
            //var gsl = new Gsglne();
            // gsl.Id = 197;
            // gsl.Liba = "Updated Liba2";
            // gsl.Abg = "UpdRefa2";
            var gsf = curOrga.Gsgfixes.FirstOrDefault();
            var gsl = curOrga.Gsglnes.FirstOrDefault();
            if (gsf == null || gsl == null)
            {
                Imessage = "Gsfixe/Gsglne est nulle";
                return;
            }
            gsf.Liba = "test update";
            gsl.Liba = "test update";
            Console.WriteLine($"gsf xseq : {gsf.Xseq} et gsl id {gsl.Id}");
            var tasks = new[]
            {
                _testclie.PutAsJsonAsync($"odata/Gsglnes({gsl.Id})", gsl),
                _testclie.PutAsJsonAsync($"odata/Gsgfixes({gsf.Xseq})", gsf)
                // Add more PUT/PATCH as needed
            };
            var responses = await Task.WhenAll(tasks);
            foreach (var response in responses)
            {
                response.EnsureSuccessStatusCode();
            }

            StateHasChanged();  // Refresh UI
        }
        catch (HttpRequestException ex)
        {
            // Handle individual failures
            Console.WriteLine($"Save failed: {ex.Message}");
        }
    }
    private async Task Save()
    {
        await _guard.FlushAsync();  // ✅ Parallel batch saves
    }
    void NavigateBack()
    {
        _navmanager.NavigateTo("/");
    }
}
