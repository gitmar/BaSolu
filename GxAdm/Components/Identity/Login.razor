@page "/login"

@using System.Security.Claims
@using System.Text
@using Blazored.LocalStorage
@using GxShared.Sess
@using GxShared.Helpers
@using GxShared.Identity
@using GxAdm.Services
@using GxWapi.DaModels
@using Newtonsoft.Json

@inject ILocalStorageService _localStorage  
@inject NavigationManager _navManager
@inject IServiceProvider _serviceProvider
@inject IHttpClientFactory _httpClientFactory
@inject SessionContextService _sessionContext
@inject HttpClientService _clieManager
@inject ClieAppState _appState

<PageTitle>Login</PageTitle>

@if (!string.IsNullOrEmpty(Imessage))
{
    <div class="alert alert-danger">@Imessage</div>
}
@if (isLoading)
{
    <div class="text-center">
        <Spinner Color="SpinnerColor.Primary" Size="SpinnerSize.Large" />
        <p>Admin Loading...</p>
    </div>
}
else
{
    <EditForm Model="loginModel" OnValidSubmit="HandleLoginAsync">
        <DataAnnotationsValidator />
        <ValidationSummary />
        @if (_yaconn)
        {
            @if (!canSupportLoad && !inAccepting)
            {
                <div class="mb-3">
                    <label>Email or Username :</label>
                    <InputText class="form-control" @bind-Value="loginModel.UsernameOrEmail" />
                </div>
                <div class="mb-3">
                    <label>Password :</label>
                    <InputText class="form-control" @bind-Value="loginModel.Password" type="password" />
                </div>
                <button class="btn btn-primary w-100" type="submit" disabled="@isBusy">
                    @if (isBusy)
                    {
                        <span>Connecting...</span>
                    }
                    else
                    {
                        <span>Login</span>
                    }
                </button>

                @if (!string.IsNullOrEmpty(Error))
                {
                    <div class="alert alert-danger mt-3">@Error</div>
                }
                @* <button class="btn btn-primary" type="submit">Login</button> *@
            }
            else
            {
                @if (!inAccepting)
                {
                    <div class="alert alert-info">
                        <strong>Info:</strong> Vous etes du Support, Veuillez choisir ou accepter @_logresult.OgRaison
                    </div>
                    <div class="mb-3">
                        <label>Institution :</label>
                        <InputSelect @bind-Value="loginModel.Idorg">
                            @foreach (var orga in _orgas)
                            {
                                <option value="@orga.Idorg">@orga.Raison</option>
                            }
                        </InputSelect>
                    </div>
                    <button class="btn btn-primary me-2" type="submit" @onclick="() => AccepterLoginAsync()">Accepter @_logresult.OgSigle</button>
                    <button class="btn btn-primary me-2" type="submit" @onclick="() => ReloadOrgaAsync()">Re_Charger Institution Choisie</button>
                }
                else
                {
                    <p>Admin Loading...</p>
                }
            }
        }
        else
        {
            <div class="nav-link text-danger">
                <i class="bi bi-exclamation-triangle-fill me-2" aria-hidden="true">Offline</i> server indisponible
            </div>
        }
        @if (!_yacors)
        {    
            <div class="nav-link text-danger">
                <i class="bi bi-exclamation-triangle-fill me-2" aria-hidden="true">CORS Error</i> Verifier la configuration CORS du serveur
            </div>
        }
        else
        {
            <div class="nav-link text-success">
                <i class="bi bi-exclamation-triangle-fill me-2" aria-hidden="true">CORS Success</i>
            </div>
        }
    </EditForm>
}
@code {
    private bool isLoading = false;
    [Inject]
    private MyAuthStateProvider _authProvider { get; set; }

    private LoginModel loginModel = new();
    private LoginResult _logresult = new();
    private string Imessage = "";

    private bool isBusy = false;
    private string? Error;

    private bool canSupportLoad = false;
    private bool inAccepting = false;
    private bool _yaconn = false;
    private bool _yacors = false;

    private HttpClient _dftClient;

    private Userbag _usrBag = new();
    private List<AdmOrga> _orgas = new();
    private string? _selectedOrgaId;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        _dftClient = _httpClientFactory.CreateClient("AUTHClient");
        //verified connection
        try
        {
            var response = await _dftClient.GetAsync("lgauth/health");
            _yaconn = response.IsSuccessStatusCode;
        }
        catch (Exception ex)
        {
            isLoading = false;
            return;
        }
        if (!_yaconn)
        {
            isLoading = false;
            return;
        }
        await AtestCors();
        isLoading = false;
    }
    private async Task HandleLoginAsync()
    {
        isLoading = true;
        Error = null;
        isBusy = true;
        bool yaErrors = false;
        Imessage = "";
        if (string.IsNullOrEmpty(loginModel.UsernameOrEmail))
        {
            Imessage = "Email ou UserName obligatoire";
            yaErrors = true;
        }
        if (string.IsNullOrEmpty(loginModel.Password))
        {
            Imessage = Imessage + " Mot de passe obligatoire";
            yaErrors = true;
        }
        if (yaErrors)
        {
            isBusy = false;
            isLoading = false;
            return;
        }
        try
        {
            loginModel.IsHelpLogin = false;
            //loginModel.UsernameOrEmail = loginModel.Username;
            //loginModel.Idorg = 0; selection
            //Console.WriteLine($"uname : {loginModel.Username} et {loginModel.Email}");
            var json = JsonConvert.SerializeObject(loginModel);
            var request = new HttpRequestMessage(HttpMethod.Post, "lgauth/login")
            {
                Content = new StringContent(json, Encoding.UTF8, "application/json")
            };
            var response = await _dftClient.SendAsync(request);
            response.EnsureSuccessStatusCode();
            var responseContent = await response.Content.ReadAsStringAsync();
            isBusy = false;
            _logresult = JsonConvert.DeserializeObject<LoginResult>(responseContent);

            if (_logresult == null || string.IsNullOrEmpty(_logresult.Atoken))
            {
                isBusy = false;
                Error = "Login failed. Check credentials.";
                Imessage = Imessage + " Invalid login response.";
                isLoading = false;
                return;
            }
            if (_logresult.SiSupport)
            {
                _orgas = _logresult.AllOrgas.ToList();
                canSupportLoad = true;
                isLoading = false;
                isBusy = false;
                Imessage = "";
                return;
            }
            if (!_logresult.SiAdmin && !_logresult.SiSupport)
            {
                isBusy = false;
                Error = "Login failed. Check credentials.";
                Imessage = Imessage + " Acces Refuse, Vous n-etes pas Autorise";
                return;
            }
            await AccepterLoginAsync();
            Console.WriteLine("12.");
        }
        catch (Exception ex)
        {
            Error = "Login failed. Check credentials.";
            isBusy = false;
            Imessage = $"Login failed: {ex.Message}";
        }
        isLoading = false;
    }
    private async Task ReloadOrgaAsync()
    {
        isLoading = true;
        Error = null;
        isBusy = true;
        Imessage = "";
        if (loginModel.Idorg == 0)
        {
            isBusy = false;
            Imessage = Imessage + " Organisation Mot de passe obligatoire";
            isLoading = false;
            return;
        }
        try
        {
            loginModel.IsHelpLogin = true;
            //loginModel.UsernameOrEmail = loginModel.Username;
            //Console.WriteLine($"uname : {loginModel.Username} et {loginModel.Email}");
            var json = JsonConvert.SerializeObject(loginModel);
            var request = new HttpRequestMessage(HttpMethod.Post, "lgauth/hlprelogin")
            {
                Content = new StringContent(json, Encoding.UTF8, "application/json")
            };
            var response = await _dftClient.SendAsync(request);
            response.EnsureSuccessStatusCode();
            var responseContent = await response.Content.ReadAsStringAsync();
            _logresult = JsonConvert.DeserializeObject<LoginResult>(responseContent);
            isBusy = false;
            if (_logresult == null || string.IsNullOrEmpty(_logresult.Atoken))
            {
                isBusy = false;
                Error = "Login failed. Check credentials.";
                Imessage = Imessage + " Invalid login response.";
                isLoading = false;
                return;
            }
            await AccepterLoginAsync();
            Console.WriteLine("12.");
        }
        catch (Exception ex)
        {
            Error = "Login failed. Check credentials.";
            isBusy = false;
            Imessage = $"Login failed: {ex.Message}";
        }
        isLoading = false;
    }
    private async Task AccepterLoginAsync()
    {
        inAccepting = true;
        canSupportLoad = false;
        Console.WriteLine("Tokens received.");
        if (_authProvider is MyAuthStateProvider provider)
        {
            Console.WriteLine("Refresh token stored.");
            var claims = _authProvider.ParseClaimsFromJwt(_logresult.Atoken);
            await _localStorage.SetItemAsync("blazToken", _logresult.Atoken);
            await _localStorage.SetItemAsync("blazRtoken", _logresult.Rtoken);
            await _localStorage.SetItemAsync("authToken", _logresult.Atoken);
            await _clieManager.SetAuthorizationHeaderAsync("AUTHClient");
            var userbagResponse = await _clieManager.SendRequestAsync("AUTHClient", HttpMethod.Get, $"usercontext/userbag");
            _usrBag = JsonConvert.DeserializeObject<Userbag>(userbagResponse);
            if (_usrBag == null || !_usrBag.Succeeded)
            {
                Imessage = Imessage + " Failed to load user context.";
                return;
            }
            var identity = new ClaimsIdentity(claims, "jwt");
            var user = new ClaimsPrincipal(identity);
            provider.NotifyUserAuthentication(user);
            await _sessionContext.PersistSessionAsync(_logresult, _usrBag); // ✅ handles everything
            if (_logresult.SiSupport)
            {
                loginModel.IsHelpLogin = true;
            }
            else
            {
                loginModel.IsHelpLogin = false;
            }
            _appState.UpdateDisplvalue(_usrBag.Graison, _usrBag.Usprof.Ufulnom);

            var puzzleSyncService = _serviceProvider.GetService<IPuzzleSyncService>();
            if (puzzleSyncService != null)
            {
                await puzzleSyncService.EnsureSessionIsFreshAsync();
                await puzzleSyncService.SyncPuzzleStateAsync();
            }
            else
            {
                Console.WriteLine("PuzzleSyncService could not be resolved.");
            }
            inAccepting = false;
            _navManager.NavigateTo("/");
        }
    }
    private async Task AtestCors()
    {
        //verified connection
        try
        {
            var response = await _dftClient.GetAsync("atest/cors");
            _yacors = response.IsSuccessStatusCode;
        }
        catch (Exception ex)
        {
            isLoading = false;
            return;
        }
        if (!_yacors)
        {
            isLoading = false;
            return;
        }
    }
}