@page "/admlogin"

@using System.Net.Http.Headers
@using System.Net.Http.Json
@using GxTier.Services
@using GxShared.GlobModels
@using GxShared.GlobModels.Auth
@using Blazored.LocalStorage
@using BlazorBootstrap
@using Newtonsoft.Json
@using Microsoft.Extensions.Configuration
@using System.Security.Claims
@using GxWapi.DaModels
@using GxTier.Helpers

@inject ILocalStorageService _localStorage
@inject IServiceProvider _serviceProvider
@inject HttpClientService _apiClient
@inject SessionContextService _sessionContext
@inject HttpClientService _clieManager
@inject NavigationManager _navmanager

<PageTitle>Login</PageTitle>

<h1>Login</h1>
<div class="row mb-2">
    message :
    <label style="font-weight: bold; color: red; background-color: yellow;">@Imessage</label>
</div>
<AuthorizeView>
    <Authorized>
        @if (canLogin)
        {
        @if (context.User.IsInRole("Admin") || context.User.IsInRole("Support"))
        {
            <div class="alert alert-success">
                You're logged in as @context.User.Identity?.Name
            </div>

            <!-- Admin UI goes here -->
            <div class="admin-panel">
                <h4>Welcome to the Admin Dashboard</h4>
                <p>Manage organisations, users, and system settings.</p>
                <!-- Add your admin tools here -->
                <div class="flex-outer">
                    <InputSelect @bind-Value="loginModel.Idorg">
                        <option value="">-- Select Organisation --</option>
                        @foreach (var orga in _orgas)
                        {
                            <option value="@orga.Idorg">@orga.Raison</option>
                        }
                    </InputSelect>

                    <InputText @bind-Value="loginModel.UsernameOrEmail" placeholder="Email" />
                    <InputText @bind-Value="loginModel.Password" type="password" placeholder="Password" />
                    <button @onclick="HandleLoginAsync">Login</button>
                </div>
            </div>
        }
        else
        {
            <div class="alert alert-warning">
                You are logged in, but do not have access to the Admin panel.
            </div>
            }
        } else
        {
            <div>Waiting for organisations list...</div>   
        }
    </Authorized>
    <NotAuthorized>
        <div class="alert alert-danger">
            You must be logged in to access this page.
        </div>
    </NotAuthorized>
</AuthorizeView>
@code {
    [Inject]
    private MyAuthStateProvider _authProvider { get; set; }
    private Userbag _usrBag = new Userbag();

    private LoginModel loginModel = new();
    private string? Imessage;
    private bool isLoading = true;
    private List<Gxorga> LsOrgas = new();

    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }

    private bool canLogin => !isLoading && _orgas.Any();

    private List<Gxorga> _orgas = new();
    private string? _selectedOrgaId;

    protected override async Task OnInitializedAsync()
    {
        // var claims = JwtHelper.DecodePayload(result.Atoken);
        // var role = claims.TryGetValue("role", out var r) ? r : "User";

        // switch (role)
        // {
        //     case "Admin":
        //         _navmanager.NavigateTo("/admlogin");
        //         break;
        //     case "Support":
        //         _navmanager.NavigateTo("/supportdashboard");
        //         break;
        //     default:
        //         _navmanager.NavigateTo("/userhome");
        //         break;
        // }
        Console.WriteLine($"nb orgas : {_orgas.Count()}");
        isLoading = true;
        await ChargerOrgasAsync();
        isLoading = false;
    }
    private async Task ChargerOrgasAsync()
    {
        var json = await _clieManager.SendRequestAsync("AUTHClient", HttpMethod.Get, "lgauth/allorgas");
        _orgas = JsonConvert.DeserializeObject<List<Gxorga>>(json);
        if (!_orgas.Any())
        {
            Imessage = "Failed to load user context.";
            return;
        }
    }
    private async Task HandleLoginAsync()
    {
        Imessage = null;

        try
        {
            loginModel.IsAdminLogin = true;
            var response = await _apiClient.SendRequestAsync("AUTHClient", HttpMethod.Post, "lgauth/login", loginModel);
            var result = JsonConvert.DeserializeObject<LoginResponse>(response);
            if (result == null || string.IsNullOrEmpty(result.Atoken))
            {
                Imessage = "Invalid login response.";
                return;
            }

            Console.WriteLine("Tokens received.");
            if (_authProvider is MyAuthStateProvider provider)
            {
                var claims = _authProvider.ParseClaimsFromJwt(result.Atoken);
                await _localStorage.SetItemAsStringAsync("blazToken", result.Atoken);
                await _localStorage.SetItemAsStringAsync("blazRtoken", result.Rtoken);

                var userbagResponse = await _apiClient.SendRequestAsync("AUTHClient", HttpMethod.Get, $"usercontext/userbag");
                var userbag = JsonConvert.DeserializeObject<Userbag>(userbagResponse);
                if (userbag == null || !userbag.Succeeded)
                {
                    Imessage = "Failed to load user context.";
                    return;
                }
                var identity = new ClaimsIdentity(claims, "jwt");
                var user = new ClaimsPrincipal(identity);
                provider.NotifyUserAuthentication(user);
                await _sessionContext.PersistSessionAsync(result, userbag); // ✅ handles everything

                var puzzleSyncService = _serviceProvider.GetService<IPuzzleSyncService>();
                if (puzzleSyncService != null)
                {
                    await puzzleSyncService.EnsureSessionIsFreshAsync();
                    await puzzleSyncService.SyncPuzzleStateAsync();
                }
                else
                {
                    Console.WriteLine("PuzzleSyncService could not be resolved.");
                }
                _navmanager.NavigateTo("/");
            }
        }
        catch (Exception ex)
        {
            Imessage = $"Unexpected error: {ex.Message}";
        }
    }
}